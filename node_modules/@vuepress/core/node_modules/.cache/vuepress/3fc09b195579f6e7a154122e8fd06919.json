{"remainingRequest":"F:\\fortivex\\vuepress-tutorial\\vuepress-tutorial\\node_modules\\babel-loader\\lib\\index.js??ref--3-1!F:\\fortivex\\vuepress-tutorial\\vuepress-tutorial\\node_modules\\docsearch.js\\dist\\cdn\\docsearch.min.js","dependencies":[{"path":"F:\\fortivex\\vuepress-tutorial\\vuepress-tutorial\\node_modules\\docsearch.js\\dist\\cdn\\docsearch.min.js","mtime":1765807959862},{"path":"F:\\fortivex\\vuepress-tutorial\\vuepress-tutorial\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1765807958813},{"path":"F:\\fortivex\\vuepress-tutorial\\vuepress-tutorial\\node_modules\\babel-loader\\lib\\index.js","mtime":1765807958345}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:cmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmVycm9yLmNhdXNlLmpzIik7CnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5wdXNoLmpzIik7CnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5yZWR1Y2UuanMiKTsKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LWJ1ZmZlci5kZXRhY2hlZC5qcyIpOwpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXktYnVmZmVyLnRyYW5zZmVyLmpzIik7CnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS1idWZmZXIudHJhbnNmZXItdG8tZml4ZWQtbGVuZ3RoLmpzIik7CnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5pdGVyYXRvci5jb25zdHJ1Y3Rvci5qcyIpOwpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuaXRlcmF0b3IuZXZlcnkuanMiKTsKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLml0ZXJhdG9yLmZpbHRlci5qcyIpOwpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuaXRlcmF0b3IuZmluZC5qcyIpOwpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuaXRlcmF0b3IuZm9yLWVhY2guanMiKTsKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLml0ZXJhdG9yLm1hcC5qcyIpOwpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuaXRlcmF0b3IudG8tYXJyYXkuanMiKTsKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmpzb24uc3RyaW5naWZ5LmpzIik7CnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS5hdC5qcyIpOwpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMudHlwZWQtYXJyYXkuZmluZC1sYXN0LmpzIik7CnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS5maW5kLWxhc3QtaW5kZXguanMiKTsKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnR5cGVkLWFycmF5LnNldC5qcyIpOwpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMudHlwZWQtYXJyYXkudG8tcmV2ZXJzZWQuanMiKTsKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnR5cGVkLWFycmF5LnRvLXNvcnRlZC5qcyIpOwpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMudHlwZWQtYXJyYXkud2l0aC5qcyIpOwpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXNuZXh0Lmpzb24ucGFyc2UuanMiKTsKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL3dlYi5pbW1lZGlhdGUuanMiKTsKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL3dlYi5zZWxmLmpzIik7Ci8qISBkb2NzZWFyY2ggMi42LjMgfCDCqSBBbGdvbGlhIHwgZ2l0aHViLmNvbS9hbGdvbGlhL2RvY3NlYXJjaCAqLwooZnVuY3Rpb24gd2VicGFja1VuaXZlcnNhbE1vZHVsZURlZmluaXRpb24ocm9vdCwgZmFjdG9yeSkgewogIGlmICh0eXBlb2YgZXhwb3J0cyA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIG1vZHVsZSA9PT0gIm9iamVjdCIpIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpO2Vsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgZGVmaW5lKFtdLCBmYWN0b3J5KTtlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyA9PT0gIm9iamVjdCIpIGV4cG9ydHNbImRvY3NlYXJjaCJdID0gZmFjdG9yeSgpO2Vsc2Ugcm9vdFsiZG9jc2VhcmNoIl0gPSBmYWN0b3J5KCk7Cn0pKHR5cGVvZiBzZWxmICE9PSAidW5kZWZpbmVkIiA/IHNlbGYgOiB0aGlzLCBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIGZ1bmN0aW9uIChtb2R1bGVzKSB7CiAgICB2YXIgaW5zdGFsbGVkTW9kdWxlcyA9IHt9OwogICAgZnVuY3Rpb24gX193ZWJwYWNrX3JlcXVpcmVfXyhtb2R1bGVJZCkgewogICAgICBpZiAoaW5zdGFsbGVkTW9kdWxlc1ttb2R1bGVJZF0pIHsKICAgICAgICByZXR1cm4gaW5zdGFsbGVkTW9kdWxlc1ttb2R1bGVJZF0uZXhwb3J0czsKICAgICAgfQogICAgICB2YXIgbW9kdWxlID0gaW5zdGFsbGVkTW9kdWxlc1ttb2R1bGVJZF0gPSB7CiAgICAgICAgaTogbW9kdWxlSWQsCiAgICAgICAgbDogZmFsc2UsCiAgICAgICAgZXhwb3J0czoge30KICAgICAgfTsKICAgICAgbW9kdWxlc1ttb2R1bGVJZF0uY2FsbChtb2R1bGUuZXhwb3J0cywgbW9kdWxlLCBtb2R1bGUuZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXyk7CiAgICAgIG1vZHVsZS5sID0gdHJ1ZTsKICAgICAgcmV0dXJuIG1vZHVsZS5leHBvcnRzOwogICAgfQogICAgX193ZWJwYWNrX3JlcXVpcmVfXy5tID0gbW9kdWxlczsKICAgIF9fd2VicGFja19yZXF1aXJlX18uYyA9IGluc3RhbGxlZE1vZHVsZXM7CiAgICBfX3dlYnBhY2tfcmVxdWlyZV9fLmQgPSBmdW5jdGlvbiAoZXhwb3J0cywgbmFtZSwgZ2V0dGVyKSB7CiAgICAgIGlmICghX193ZWJwYWNrX3JlcXVpcmVfXy5vKGV4cG9ydHMsIG5hbWUpKSB7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIG5hbWUsIHsKICAgICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsCiAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgZ2V0OiBnZXR0ZXIKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICAgIF9fd2VicGFja19yZXF1aXJlX18ubiA9IGZ1bmN0aW9uIChtb2R1bGUpIHsKICAgICAgdmFyIGdldHRlciA9IG1vZHVsZSAmJiBtb2R1bGUuX19lc01vZHVsZSA/IGZ1bmN0aW9uIGdldERlZmF1bHQoKSB7CiAgICAgICAgcmV0dXJuIG1vZHVsZVsiZGVmYXVsdCJdOwogICAgICB9IDogZnVuY3Rpb24gZ2V0TW9kdWxlRXhwb3J0cygpIHsKICAgICAgICByZXR1cm4gbW9kdWxlOwogICAgICB9OwogICAgICBfX3dlYnBhY2tfcmVxdWlyZV9fLmQoZ2V0dGVyLCAiYSIsIGdldHRlcik7CiAgICAgIHJldHVybiBnZXR0ZXI7CiAgICB9OwogICAgX193ZWJwYWNrX3JlcXVpcmVfXy5vID0gZnVuY3Rpb24gKG9iamVjdCwgcHJvcGVydHkpIHsKICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIHByb3BlcnR5KTsKICAgIH07CiAgICBfX3dlYnBhY2tfcmVxdWlyZV9fLnAgPSAiIjsKICAgIHJldHVybiBfX3dlYnBhY2tfcmVxdWlyZV9fKF9fd2VicGFja19yZXF1aXJlX18ucyA9IDIyKTsKICB9KFtmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgdmFyIERPTSA9IF9fd2VicGFja19yZXF1aXJlX18oMSk7CiAgICBmdW5jdGlvbiBlc2NhcGVSZWdFeHAoc3RyKSB7CiAgICAgIHJldHVybiBzdHIucmVwbGFjZSgvW1wtXFtcXVwvXHtcfVwoXClcKlwrXD9cLlxcXF5cJFx8XS9nLCAiXFwkJiIpOwogICAgfQogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGlzQXJyYXk6IG51bGwsCiAgICAgIGlzRnVuY3Rpb246IG51bGwsCiAgICAgIGlzT2JqZWN0OiBudWxsLAogICAgICBiaW5kOiBudWxsLAogICAgICBlYWNoOiBudWxsLAogICAgICBtYXA6IG51bGwsCiAgICAgIG1peGluOiBudWxsLAogICAgICBpc01zaWU6IGZ1bmN0aW9uIChhZ2VudFN0cmluZykgewogICAgICAgIGlmIChhZ2VudFN0cmluZyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBhZ2VudFN0cmluZyA9IG5hdmlnYXRvci51c2VyQWdlbnQ7CiAgICAgICAgfQogICAgICAgIGlmICgvKG1zaWV8dHJpZGVudCkvaS50ZXN0KGFnZW50U3RyaW5nKSkgewogICAgICAgICAgdmFyIG1hdGNoID0gYWdlbnRTdHJpbmcubWF0Y2goLyhtc2llIHxydjopKFxkKyguXGQrKT8pL2kpOwogICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgIHJldHVybiBtYXRjaFsyXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9LAogICAgICBlc2NhcGVSZWdFeENoYXJzOiBmdW5jdGlvbiAoc3RyKSB7CiAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKC9bXC1cW1xdXC9ce1x9XChcKVwqXCtcP1wuXFxcXlwkXHxdL2csICJcXCQmIik7CiAgICAgIH0sCiAgICAgIGlzTnVtYmVyOiBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICJudW1iZXIiOwogICAgICB9LAogICAgICB0b1N0cjogZnVuY3Rpb24gdG9TdHIocykgewogICAgICAgIHJldHVybiBzID09PSB1bmRlZmluZWQgfHwgcyA9PT0gbnVsbCA/ICIiIDogcyArICIiOwogICAgICB9LAogICAgICBjbG9uZURlZXA6IGZ1bmN0aW9uIGNsb25lRGVlcChvYmopIHsKICAgICAgICB2YXIgY2xvbmUgPSB0aGlzLm1peGluKHt9LCBvYmopOwogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICB0aGlzLmVhY2goY2xvbmUsIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKHNlbGYuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICBjbG9uZVtrZXldID0gW10uY29uY2F0KHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChzZWxmLmlzT2JqZWN0KHZhbHVlKSkgewogICAgICAgICAgICAgIGNsb25lW2tleV0gPSBzZWxmLmNsb25lRGVlcCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gY2xvbmU7CiAgICAgIH0sCiAgICAgIGVycm9yOiBmdW5jdGlvbiAobXNnKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZyk7CiAgICAgIH0sCiAgICAgIGV2ZXJ5OiBmdW5jdGlvbiAob2JqLCB0ZXN0KSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IHRydWU7CiAgICAgICAgaWYgKCFvYmopIHsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHRoaXMuZWFjaChvYmosIGZ1bmN0aW9uICh2YWwsIGtleSkgewogICAgICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgICAgICByZXN1bHQgPSB0ZXN0LmNhbGwobnVsbCwgdmFsLCBrZXksIG9iaikgJiYgcmVzdWx0OwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiAhIXJlc3VsdDsKICAgICAgfSwKICAgICAgYW55OiBmdW5jdGlvbiAob2JqLCB0ZXN0KSB7CiAgICAgICAgdmFyIGZvdW5kID0gZmFsc2U7CiAgICAgICAgaWYgKCFvYmopIHsKICAgICAgICAgIHJldHVybiBmb3VuZDsKICAgICAgICB9CiAgICAgICAgdGhpcy5lYWNoKG9iaiwgZnVuY3Rpb24gKHZhbCwga2V5KSB7CiAgICAgICAgICBpZiAodGVzdC5jYWxsKG51bGwsIHZhbCwga2V5LCBvYmopKSB7CiAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBmb3VuZDsKICAgICAgfSwKICAgICAgZ2V0VW5pcXVlSWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgY291bnRlciA9IDA7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBjb3VudGVyKys7CiAgICAgICAgfTsKICAgICAgfSgpLAogICAgICB0ZW1wbGF0aWZ5OiBmdW5jdGlvbiB0ZW1wbGF0aWZ5KG9iaikgewogICAgICAgIGlmICh0aGlzLmlzRnVuY3Rpb24ob2JqKSkgewogICAgICAgICAgcmV0dXJuIG9iajsKICAgICAgICB9CiAgICAgICAgdmFyICR0ZW1wbGF0ZSA9IERPTS5lbGVtZW50KG9iaik7CiAgICAgICAgaWYgKCR0ZW1wbGF0ZS5wcm9wKCJ0YWdOYW1lIikgPT09ICJTQ1JJUFQiKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gdGVtcGxhdGUoKSB7CiAgICAgICAgICAgIHJldHVybiAkdGVtcGxhdGUudGV4dCgpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIHRlbXBsYXRlKCkgewogICAgICAgICAgcmV0dXJuIFN0cmluZyhvYmopOwogICAgICAgIH07CiAgICAgIH0sCiAgICAgIGRlZmVyOiBmdW5jdGlvbiAoZm4pIHsKICAgICAgICBzZXRUaW1lb3V0KGZuLCAwKTsKICAgICAgfSwKICAgICAgbm9vcDogZnVuY3Rpb24gKCkge30sCiAgICAgIGZvcm1hdFByZWZpeDogZnVuY3Rpb24gKHByZWZpeCwgbm9QcmVmaXgpIHsKICAgICAgICByZXR1cm4gbm9QcmVmaXggPyAiIiA6IHByZWZpeCArICItIjsKICAgICAgfSwKICAgICAgY2xhc3NOYW1lOiBmdW5jdGlvbiAocHJlZml4LCBjbGF6eiwgc2tpcERvdCkgewogICAgICAgIHJldHVybiAoc2tpcERvdCA/ICIiIDogIi4iKSArIHByZWZpeCArIGNsYXp6OwogICAgICB9LAogICAgICBlc2NhcGVIaWdobGlnaHRlZFN0cmluZzogZnVuY3Rpb24gKHN0ciwgaGlnaGxpZ2h0UHJlVGFnLCBoaWdobGlnaHRQb3N0VGFnKSB7CiAgICAgICAgaGlnaGxpZ2h0UHJlVGFnID0gaGlnaGxpZ2h0UHJlVGFnIHx8ICI8ZW0+IjsKICAgICAgICB2YXIgcHJlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgcHJlLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGhpZ2hsaWdodFByZVRhZykpOwogICAgICAgIGhpZ2hsaWdodFBvc3RUYWcgPSBoaWdobGlnaHRQb3N0VGFnIHx8ICI8L2VtPiI7CiAgICAgICAgdmFyIHBvc3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICBwb3N0LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGhpZ2hsaWdodFBvc3RUYWcpKTsKICAgICAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgZGl2LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHN0cikpOwogICAgICAgIHJldHVybiBkaXYuaW5uZXJIVE1MLnJlcGxhY2UoUmVnRXhwKGVzY2FwZVJlZ0V4cChwcmUuaW5uZXJIVE1MKSwgImciKSwgaGlnaGxpZ2h0UHJlVGFnKS5yZXBsYWNlKFJlZ0V4cChlc2NhcGVSZWdFeHAocG9zdC5pbm5lckhUTUwpLCAiZyIpLCBoaWdobGlnaHRQb3N0VGFnKTsKICAgICAgfQogICAgfTsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGVsZW1lbnQ6IG51bGwKICAgIH07CiAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cykgewogICAgdmFyIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICB2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwogICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBmb3JFYWNoKG9iaiwgZm4sIGN0eCkgewogICAgICBpZiAodG9TdHJpbmcuY2FsbChmbikgIT09ICJbb2JqZWN0IEZ1bmN0aW9uXSIpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJpdGVyYXRvciBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICAgICAgfQogICAgICB2YXIgbCA9IG9iai5sZW5ndGg7CiAgICAgIGlmIChsID09PSArbCkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICBmbi5jYWxsKGN0eCwgb2JqW2ldLCBpLCBvYmopOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKHZhciBrIGluIG9iaikgewogICAgICAgICAgaWYgKGhhc093bi5jYWxsKG9iaiwgaykpIHsKICAgICAgICAgICAgZm4uY2FsbChjdHgsIG9ialtrXSwgaywgb2JqKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cykgewogICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBjbG9uZShvYmopIHsKICAgICAgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob2JqKSk7CiAgICB9OwogIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMpIHsKICAgIHZhciBnOwogICAgZyA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9KCk7CiAgICB0cnkgewogICAgICBnID0gZyB8fCBGdW5jdGlvbigicmV0dXJuIHRoaXMiKSgpIHx8ICgxLCBldmFsKSgidGhpcyIpOwogICAgfSBjYXRjaCAoZSkgewogICAgICBpZiAodHlwZW9mIHdpbmRvdyA9PT0gIm9iamVjdCIpIGcgPSB3aW5kb3c7CiAgICB9CiAgICBtb2R1bGUuZXhwb3J0cyA9IGc7CiAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgInVzZSBzdHJpY3QiOwoKICAgIHZhciBpbmhlcml0cyA9IF9fd2VicGFja19yZXF1aXJlX18oMTIpOwogICAgZnVuY3Rpb24gQWxnb2xpYVNlYXJjaEVycm9yKG1lc3NhZ2UsIGV4dHJhUHJvcGVydGllcykgewogICAgICB2YXIgZm9yRWFjaCA9IF9fd2VicGFja19yZXF1aXJlX18oMik7CiAgICAgIHZhciBlcnJvciA9IHRoaXM7CiAgICAgIGlmICh0eXBlb2YgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCB0aGlzLmNvbnN0cnVjdG9yKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBlcnJvci5zdGFjayA9IG5ldyBFcnJvcigpLnN0YWNrIHx8ICJDYW5ub3QgZ2V0IGEgc3RhY2t0cmFjZSwgYnJvd3NlciBpcyB0b28gb2xkIjsKICAgICAgfQogICAgICB0aGlzLm5hbWUgPSAiQWxnb2xpYVNlYXJjaEVycm9yIjsKICAgICAgdGhpcy5tZXNzYWdlID0gbWVzc2FnZSB8fCAiVW5rbm93biBlcnJvciI7CiAgICAgIGlmIChleHRyYVByb3BlcnRpZXMpIHsKICAgICAgICBmb3JFYWNoKGV4dHJhUHJvcGVydGllcywgZnVuY3Rpb24gYWRkVG9FcnJvck9iamVjdCh2YWx1ZSwga2V5KSB7CiAgICAgICAgICBlcnJvcltrZXldID0gdmFsdWU7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIGluaGVyaXRzKEFsZ29saWFTZWFyY2hFcnJvciwgRXJyb3IpOwogICAgZnVuY3Rpb24gY3JlYXRlQ3VzdG9tRXJyb3IobmFtZSwgbWVzc2FnZSkgewogICAgICBmdW5jdGlvbiBBbGdvbGlhU2VhcmNoQ3VzdG9tRXJyb3IoKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgICAgIGlmICh0eXBlb2YgYXJnc1swXSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgIGFyZ3MudW5zaGlmdChtZXNzYWdlKTsKICAgICAgICB9CiAgICAgICAgQWxnb2xpYVNlYXJjaEVycm9yLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIHRoaXMubmFtZSA9ICJBbGdvbGlhU2VhcmNoIiArIG5hbWUgKyAiRXJyb3IiOwogICAgICB9CiAgICAgIGluaGVyaXRzKEFsZ29saWFTZWFyY2hDdXN0b21FcnJvciwgQWxnb2xpYVNlYXJjaEVycm9yKTsKICAgICAgcmV0dXJuIEFsZ29saWFTZWFyY2hDdXN0b21FcnJvcjsKICAgIH0KICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBBbGdvbGlhU2VhcmNoRXJyb3I6IEFsZ29saWFTZWFyY2hFcnJvciwKICAgICAgVW5wYXJzYWJsZUpTT046IGNyZWF0ZUN1c3RvbUVycm9yKCJVbnBhcnNhYmxlSlNPTiIsICJDb3VsZCBub3QgcGFyc2UgdGhlIGluY29taW5nIHJlc3BvbnNlIGFzIEpTT04sIHNlZSBlcnIubW9yZSBmb3IgZGV0YWlscyIpLAogICAgICBSZXF1ZXN0VGltZW91dDogY3JlYXRlQ3VzdG9tRXJyb3IoIlJlcXVlc3RUaW1lb3V0IiwgIlJlcXVlc3QgdGltZWRvdXQgYmVmb3JlIGdldHRpbmcgYSByZXNwb25zZSIpLAogICAgICBOZXR3b3JrOiBjcmVhdGVDdXN0b21FcnJvcigiTmV0d29yayIsICJOZXR3b3JrIGlzc3VlLCBzZWUgZXJyLm1vcmUgZm9yIGRldGFpbHMiKSwKICAgICAgSlNPTlBTY3JpcHRGYWlsOiBjcmVhdGVDdXN0b21FcnJvcigiSlNPTlBTY3JpcHRGYWlsIiwgIjxzY3JpcHQ+IHdhcyBsb2FkZWQgYnV0IGRpZCBub3QgY2FsbCBvdXIgcHJvdmlkZWQgY2FsbGJhY2siKSwKICAgICAgSlNPTlBTY3JpcHRFcnJvcjogY3JlYXRlQ3VzdG9tRXJyb3IoIkpTT05QU2NyaXB0RXJyb3IiLCAiPHNjcmlwdD4gdW5hYmxlIHRvIGxvYWQgZHVlIHRvIGFuIGBlcnJvcmAgZXZlbnQgb24gaXQiKSwKICAgICAgVW5rbm93bjogY3JlYXRlQ3VzdG9tRXJyb3IoIlVua25vd24iLCAiVW5rbm93biBlcnJvciBvY2N1cmVkIikKICAgIH07CiAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cykgewogICAgdmFyIHRvU3RyaW5nID0ge30udG9TdHJpbmc7CiAgICBtb2R1bGUuZXhwb3J0cyA9IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24gKGFycikgewogICAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChhcnIpID09ICJbb2JqZWN0IEFycmF5XSI7CiAgICB9OwogIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgIHZhciBmb3JlYWNoID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsKICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gbWFwKGFyciwgZm4pIHsKICAgICAgdmFyIG5ld0FyciA9IFtdOwogICAgICBmb3JlYWNoKGFyciwgZnVuY3Rpb24gKGl0ZW0sIGl0ZW1JbmRleCkgewogICAgICAgIG5ld0Fyci5wdXNoKGZuKGl0ZW0sIGl0ZW1JbmRleCwgYXJyKSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gbmV3QXJyOwogICAgfTsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAoZnVuY3Rpb24gKHByb2Nlc3MpIHsKICAgICAgZXhwb3J0cyA9IG1vZHVsZS5leHBvcnRzID0gX193ZWJwYWNrX3JlcXVpcmVfXygzOSk7CiAgICAgIGV4cG9ydHMubG9nID0gbG9nOwogICAgICBleHBvcnRzLmZvcm1hdEFyZ3MgPSBmb3JtYXRBcmdzOwogICAgICBleHBvcnRzLnNhdmUgPSBzYXZlOwogICAgICBleHBvcnRzLmxvYWQgPSBsb2FkOwogICAgICBleHBvcnRzLnVzZUNvbG9ycyA9IHVzZUNvbG9yczsKICAgICAgZXhwb3J0cy5zdG9yYWdlID0gInVuZGVmaW5lZCIgIT0gdHlwZW9mIGNocm9tZSAmJiAidW5kZWZpbmVkIiAhPSB0eXBlb2YgY2hyb21lLnN0b3JhZ2UgPyBjaHJvbWUuc3RvcmFnZS5sb2NhbCA6IGxvY2Fsc3RvcmFnZSgpOwogICAgICBleHBvcnRzLmNvbG9ycyA9IFsibGlnaHRzZWFncmVlbiIsICJmb3Jlc3RncmVlbiIsICJnb2xkZW5yb2QiLCAiZG9kZ2VyYmx1ZSIsICJkYXJrb3JjaGlkIiwgImNyaW1zb24iXTsKICAgICAgZnVuY3Rpb24gdXNlQ29sb3JzKCkgewogICAgICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cucHJvY2VzcyAmJiB3aW5kb3cucHJvY2Vzcy50eXBlID09PSAicmVuZGVyZXIiKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZSAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGUuV2Via2l0QXBwZWFyYW5jZSB8fCB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cuY29uc29sZSAmJiAod2luZG93LmNvbnNvbGUuZmlyZWJ1ZyB8fCB3aW5kb3cuY29uc29sZS5leGNlcHRpb24gJiYgd2luZG93LmNvbnNvbGUudGFibGUpIHx8IHR5cGVvZiBuYXZpZ2F0b3IgIT09ICJ1bmRlZmluZWQiICYmIG5hdmlnYXRvci51c2VyQWdlbnQgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLm1hdGNoKC9maXJlZm94XC8oXGQrKS8pICYmIHBhcnNlSW50KFJlZ0V4cC4kMSwgMTApID49IDMxIHx8IHR5cGVvZiBuYXZpZ2F0b3IgIT09ICJ1bmRlZmluZWQiICYmIG5hdmlnYXRvci51c2VyQWdlbnQgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLm1hdGNoKC9hcHBsZXdlYmtpdFwvKFxkKykvKTsKICAgICAgfQogICAgICBleHBvcnRzLmZvcm1hdHRlcnMuaiA9IGZ1bmN0aW9uICh2KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh2KTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIHJldHVybiAiW1VuZXhwZWN0ZWRKU09OUGFyc2VFcnJvcl06ICIgKyBlcnIubWVzc2FnZTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGZ1bmN0aW9uIGZvcm1hdEFyZ3MoYXJncykgewogICAgICAgIHZhciB1c2VDb2xvcnMgPSB0aGlzLnVzZUNvbG9yczsKICAgICAgICBhcmdzWzBdID0gKHVzZUNvbG9ycyA/ICIlYyIgOiAiIikgKyB0aGlzLm5hbWVzcGFjZSArICh1c2VDb2xvcnMgPyAiICVjIiA6ICIgIikgKyBhcmdzWzBdICsgKHVzZUNvbG9ycyA/ICIlYyAiIDogIiAiKSArICIrIiArIGV4cG9ydHMuaHVtYW5pemUodGhpcy5kaWZmKTsKICAgICAgICBpZiAoIXVzZUNvbG9ycykgcmV0dXJuOwogICAgICAgIHZhciBjID0gImNvbG9yOiAiICsgdGhpcy5jb2xvcjsKICAgICAgICBhcmdzLnNwbGljZSgxLCAwLCBjLCAiY29sb3I6IGluaGVyaXQiKTsKICAgICAgICB2YXIgaW5kZXggPSAwOwogICAgICAgIHZhciBsYXN0QyA9IDA7CiAgICAgICAgYXJnc1swXS5yZXBsYWNlKC8lW2EtekEtWiVdL2csIGZ1bmN0aW9uIChtYXRjaCkgewogICAgICAgICAgaWYgKCIlJSIgPT09IG1hdGNoKSByZXR1cm47CiAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgaWYgKCIlYyIgPT09IG1hdGNoKSB7CiAgICAgICAgICAgIGxhc3RDID0gaW5kZXg7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgYXJncy5zcGxpY2UobGFzdEMsIDAsIGMpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGxvZygpIHsKICAgICAgICByZXR1cm4gIm9iamVjdCIgPT09IHR5cGVvZiBjb25zb2xlICYmIGNvbnNvbGUubG9nICYmIEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseS5jYWxsKGNvbnNvbGUubG9nLCBjb25zb2xlLCBhcmd1bWVudHMpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHNhdmUobmFtZXNwYWNlcykgewogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAobnVsbCA9PSBuYW1lc3BhY2VzKSB7CiAgICAgICAgICAgIGV4cG9ydHMuc3RvcmFnZS5yZW1vdmVJdGVtKCJkZWJ1ZyIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZXhwb3J0cy5zdG9yYWdlLmRlYnVnID0gbmFtZXNwYWNlczsKICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICB9CiAgICAgIGZ1bmN0aW9uIGxvYWQoKSB7CiAgICAgICAgdmFyIHI7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHIgPSBleHBvcnRzLnN0b3JhZ2UuZGVidWc7CiAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICBpZiAoIXIgJiYgdHlwZW9mIHByb2Nlc3MgIT09ICJ1bmRlZmluZWQiICYmICJlbnYiIGluIHByb2Nlc3MpIHsKICAgICAgICAgIHIgPSBPYmplY3QoewogICAgICAgICAgICBOT0RFX0VOVjogInByb2R1Y3Rpb24iCiAgICAgICAgICB9KS5ERUJVRzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHI7CiAgICAgIH0KICAgICAgZXhwb3J0cy5lbmFibGUobG9hZCgpKTsKICAgICAgZnVuY3Rpb24gbG9jYWxzdG9yYWdlKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICByZXR1cm4gd2luZG93LmxvY2FsU3RvcmFnZTsKICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICB9CiAgICB9KS5jYWxsKGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18oOSkpOwogIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMpIHsKICAgIHZhciBwcm9jZXNzID0gbW9kdWxlLmV4cG9ydHMgPSB7fTsKICAgIHZhciBjYWNoZWRTZXRUaW1lb3V0OwogICAgdmFyIGNhY2hlZENsZWFyVGltZW91dDsKICAgIGZ1bmN0aW9uIGRlZmF1bHRTZXRUaW1vdXQoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigic2V0VGltZW91dCBoYXMgbm90IGJlZW4gZGVmaW5lZCIpOwogICAgfQogICAgZnVuY3Rpb24gZGVmYXVsdENsZWFyVGltZW91dCgpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJjbGVhclRpbWVvdXQgaGFzIG5vdCBiZWVuIGRlZmluZWQiKTsKICAgIH0KICAgIChmdW5jdGlvbiAoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgaWYgKHR5cGVvZiBzZXRUaW1lb3V0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBjYWNoZWRTZXRUaW1lb3V0ID0gc2V0VGltZW91dDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2FjaGVkU2V0VGltZW91dCA9IGRlZmF1bHRTZXRUaW1vdXQ7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY2FjaGVkU2V0VGltZW91dCA9IGRlZmF1bHRTZXRUaW1vdXQ7CiAgICAgIH0KICAgICAgdHJ5IHsKICAgICAgICBpZiAodHlwZW9mIGNsZWFyVGltZW91dCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgY2FjaGVkQ2xlYXJUaW1lb3V0ID0gY2xlYXJUaW1lb3V0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjYWNoZWRDbGVhclRpbWVvdXQgPSBkZWZhdWx0Q2xlYXJUaW1lb3V0OwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNhY2hlZENsZWFyVGltZW91dCA9IGRlZmF1bHRDbGVhclRpbWVvdXQ7CiAgICAgIH0KICAgIH0pKCk7CiAgICBmdW5jdGlvbiBydW5UaW1lb3V0KGZ1bikgewogICAgICBpZiAoY2FjaGVkU2V0VGltZW91dCA9PT0gc2V0VGltZW91dCkgewogICAgICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1biwgMCk7CiAgICAgIH0KICAgICAgaWYgKChjYWNoZWRTZXRUaW1lb3V0ID09PSBkZWZhdWx0U2V0VGltb3V0IHx8ICFjYWNoZWRTZXRUaW1lb3V0KSAmJiBzZXRUaW1lb3V0KSB7CiAgICAgICAgY2FjaGVkU2V0VGltZW91dCA9IHNldFRpbWVvdXQ7CiAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuLCAwKTsKICAgICAgfQogICAgICB0cnkgewogICAgICAgIHJldHVybiBjYWNoZWRTZXRUaW1lb3V0KGZ1biwgMCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgcmV0dXJuIGNhY2hlZFNldFRpbWVvdXQuY2FsbChudWxsLCBmdW4sIDApOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHJldHVybiBjYWNoZWRTZXRUaW1lb3V0LmNhbGwodGhpcywgZnVuLCAwKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHJ1bkNsZWFyVGltZW91dChtYXJrZXIpIHsKICAgICAgaWYgKGNhY2hlZENsZWFyVGltZW91dCA9PT0gY2xlYXJUaW1lb3V0KSB7CiAgICAgICAgcmV0dXJuIGNsZWFyVGltZW91dChtYXJrZXIpOwogICAgICB9CiAgICAgIGlmICgoY2FjaGVkQ2xlYXJUaW1lb3V0ID09PSBkZWZhdWx0Q2xlYXJUaW1lb3V0IHx8ICFjYWNoZWRDbGVhclRpbWVvdXQpICYmIGNsZWFyVGltZW91dCkgewogICAgICAgIGNhY2hlZENsZWFyVGltZW91dCA9IGNsZWFyVGltZW91dDsKICAgICAgICByZXR1cm4gY2xlYXJUaW1lb3V0KG1hcmtlcik7CiAgICAgIH0KICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gY2FjaGVkQ2xlYXJUaW1lb3V0KG1hcmtlcik7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgcmV0dXJuIGNhY2hlZENsZWFyVGltZW91dC5jYWxsKG51bGwsIG1hcmtlcik7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgcmV0dXJuIGNhY2hlZENsZWFyVGltZW91dC5jYWxsKHRoaXMsIG1hcmtlcik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICB2YXIgcXVldWUgPSBbXTsKICAgIHZhciBkcmFpbmluZyA9IGZhbHNlOwogICAgdmFyIGN1cnJlbnRRdWV1ZTsKICAgIHZhciBxdWV1ZUluZGV4ID0gLTE7CiAgICBmdW5jdGlvbiBjbGVhblVwTmV4dFRpY2soKSB7CiAgICAgIGlmICghZHJhaW5pbmcgfHwgIWN1cnJlbnRRdWV1ZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBkcmFpbmluZyA9IGZhbHNlOwogICAgICBpZiAoY3VycmVudFF1ZXVlLmxlbmd0aCkgewogICAgICAgIHF1ZXVlID0gY3VycmVudFF1ZXVlLmNvbmNhdChxdWV1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcXVldWVJbmRleCA9IC0xOwogICAgICB9CiAgICAgIGlmIChxdWV1ZS5sZW5ndGgpIHsKICAgICAgICBkcmFpblF1ZXVlKCk7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGRyYWluUXVldWUoKSB7CiAgICAgIGlmIChkcmFpbmluZykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgdGltZW91dCA9IHJ1blRpbWVvdXQoY2xlYW5VcE5leHRUaWNrKTsKICAgICAgZHJhaW5pbmcgPSB0cnVlOwogICAgICB2YXIgbGVuID0gcXVldWUubGVuZ3RoOwogICAgICB3aGlsZSAobGVuKSB7CiAgICAgICAgY3VycmVudFF1ZXVlID0gcXVldWU7CiAgICAgICAgcXVldWUgPSBbXTsKICAgICAgICB3aGlsZSAoKytxdWV1ZUluZGV4IDwgbGVuKSB7CiAgICAgICAgICBpZiAoY3VycmVudFF1ZXVlKSB7CiAgICAgICAgICAgIGN1cnJlbnRRdWV1ZVtxdWV1ZUluZGV4XS5ydW4oKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcXVldWVJbmRleCA9IC0xOwogICAgICAgIGxlbiA9IHF1ZXVlLmxlbmd0aDsKICAgICAgfQogICAgICBjdXJyZW50UXVldWUgPSBudWxsOwogICAgICBkcmFpbmluZyA9IGZhbHNlOwogICAgICBydW5DbGVhclRpbWVvdXQodGltZW91dCk7CiAgICB9CiAgICBwcm9jZXNzLm5leHRUaWNrID0gZnVuY3Rpb24gKGZ1bikgewogICAgICB2YXIgYXJncyA9IG5ldyBBcnJheShhcmd1bWVudHMubGVuZ3RoIC0gMSk7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBhcmdzW2kgLSAxXSA9IGFyZ3VtZW50c1tpXTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcXVldWUucHVzaChuZXcgSXRlbShmdW4sIGFyZ3MpKTsKICAgICAgaWYgKHF1ZXVlLmxlbmd0aCA9PT0gMSAmJiAhZHJhaW5pbmcpIHsKICAgICAgICBydW5UaW1lb3V0KGRyYWluUXVldWUpOwogICAgICB9CiAgICB9OwogICAgZnVuY3Rpb24gSXRlbShmdW4sIGFycmF5KSB7CiAgICAgIHRoaXMuZnVuID0gZnVuOwogICAgICB0aGlzLmFycmF5ID0gYXJyYXk7CiAgICB9CiAgICBJdGVtLnByb3RvdHlwZS5ydW4gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuZnVuLmFwcGx5KG51bGwsIHRoaXMuYXJyYXkpOwogICAgfTsKICAgIHByb2Nlc3MudGl0bGUgPSAiYnJvd3NlciI7CiAgICBwcm9jZXNzLmJyb3dzZXIgPSB0cnVlOwogICAgcHJvY2Vzcy5lbnYgPSB7fTsKICAgIHByb2Nlc3MuYXJndiA9IFtdOwogICAgcHJvY2Vzcy52ZXJzaW9uID0gIiI7CiAgICBwcm9jZXNzLnZlcnNpb25zID0ge307CiAgICBmdW5jdGlvbiBub29wKCkge30KICAgIHByb2Nlc3Mub24gPSBub29wOwogICAgcHJvY2Vzcy5hZGRMaXN0ZW5lciA9IG5vb3A7CiAgICBwcm9jZXNzLm9uY2UgPSBub29wOwogICAgcHJvY2Vzcy5vZmYgPSBub29wOwogICAgcHJvY2Vzcy5yZW1vdmVMaXN0ZW5lciA9IG5vb3A7CiAgICBwcm9jZXNzLnJlbW92ZUFsbExpc3RlbmVycyA9IG5vb3A7CiAgICBwcm9jZXNzLmVtaXQgPSBub29wOwogICAgcHJvY2Vzcy5wcmVwZW5kTGlzdGVuZXIgPSBub29wOwogICAgcHJvY2Vzcy5wcmVwZW5kT25jZUxpc3RlbmVyID0gbm9vcDsKICAgIHByb2Nlc3MubGlzdGVuZXJzID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgcmV0dXJuIFtdOwogICAgfTsKICAgIHByb2Nlc3MuYmluZGluZyA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigicHJvY2Vzcy5iaW5kaW5nIGlzIG5vdCBzdXBwb3J0ZWQiKTsKICAgIH07CiAgICBwcm9jZXNzLmN3ZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICIvIjsKICAgIH07CiAgICBwcm9jZXNzLmNoZGlyID0gZnVuY3Rpb24gKGRpcikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoInByb2Nlc3MuY2hkaXIgaXMgbm90IHN1cHBvcnRlZCIpOwogICAgfTsKICAgIHByb2Nlc3MudW1hc2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAwOwogICAgfTsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgdmFyIGltbWVkaWF0ZSA9IF9fd2VicGFja19yZXF1aXJlX18oNTMpOwogICAgdmFyIHNwbGl0dGVyID0gL1xzKy87CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgb25TeW5jOiBvblN5bmMsCiAgICAgIG9uQXN5bmM6IG9uQXN5bmMsCiAgICAgIG9mZjogb2ZmLAogICAgICB0cmlnZ2VyOiB0cmlnZ2VyCiAgICB9OwogICAgZnVuY3Rpb24gb24obWV0aG9kLCB0eXBlcywgY2IsIGNvbnRleHQpIHsKICAgICAgdmFyIHR5cGU7CiAgICAgIGlmICghY2IpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICB0eXBlcyA9IHR5cGVzLnNwbGl0KHNwbGl0dGVyKTsKICAgICAgY2IgPSBjb250ZXh0ID8gYmluZENvbnRleHQoY2IsIGNvbnRleHQpIDogY2I7CiAgICAgIHRoaXMuX2NhbGxiYWNrcyA9IHRoaXMuX2NhbGxiYWNrcyB8fCB7fTsKICAgICAgd2hpbGUgKHR5cGUgPSB0eXBlcy5zaGlmdCgpKSB7CiAgICAgICAgdGhpcy5fY2FsbGJhY2tzW3R5cGVdID0gdGhpcy5fY2FsbGJhY2tzW3R5cGVdIHx8IHsKICAgICAgICAgIHN5bmM6IFtdLAogICAgICAgICAgYXN5bmM6IFtdCiAgICAgICAgfTsKICAgICAgICB0aGlzLl9jYWxsYmFja3NbdHlwZV1bbWV0aG9kXS5wdXNoKGNiKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGZ1bmN0aW9uIG9uQXN5bmModHlwZXMsIGNiLCBjb250ZXh0KSB7CiAgICAgIHJldHVybiBvbi5jYWxsKHRoaXMsICJhc3luYyIsIHR5cGVzLCBjYiwgY29udGV4dCk7CiAgICB9CiAgICBmdW5jdGlvbiBvblN5bmModHlwZXMsIGNiLCBjb250ZXh0KSB7CiAgICAgIHJldHVybiBvbi5jYWxsKHRoaXMsICJzeW5jIiwgdHlwZXMsIGNiLCBjb250ZXh0KTsKICAgIH0KICAgIGZ1bmN0aW9uIG9mZih0eXBlcykgewogICAgICB2YXIgdHlwZTsKICAgICAgaWYgKCF0aGlzLl9jYWxsYmFja3MpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICB0eXBlcyA9IHR5cGVzLnNwbGl0KHNwbGl0dGVyKTsKICAgICAgd2hpbGUgKHR5cGUgPSB0eXBlcy5zaGlmdCgpKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2NhbGxiYWNrc1t0eXBlXTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGZ1bmN0aW9uIHRyaWdnZXIodHlwZXMpIHsKICAgICAgdmFyIHR5cGU7CiAgICAgIHZhciBjYWxsYmFja3M7CiAgICAgIHZhciBhcmdzOwogICAgICB2YXIgc3luY0ZsdXNoOwogICAgICB2YXIgYXN5bmNGbHVzaDsKICAgICAgaWYgKCF0aGlzLl9jYWxsYmFja3MpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICB0eXBlcyA9IHR5cGVzLnNwbGl0KHNwbGl0dGVyKTsKICAgICAgYXJncyA9IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgd2hpbGUgKCh0eXBlID0gdHlwZXMuc2hpZnQoKSkgJiYgKGNhbGxiYWNrcyA9IHRoaXMuX2NhbGxiYWNrc1t0eXBlXSkpIHsKICAgICAgICBzeW5jRmx1c2ggPSBnZXRGbHVzaChjYWxsYmFja3Muc3luYywgdGhpcywgW3R5cGVdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgYXN5bmNGbHVzaCA9IGdldEZsdXNoKGNhbGxiYWNrcy5hc3luYywgdGhpcywgW3R5cGVdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgaWYgKHN5bmNGbHVzaCgpKSB7CiAgICAgICAgICBpbW1lZGlhdGUoYXN5bmNGbHVzaCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgZnVuY3Rpb24gZ2V0Rmx1c2goY2FsbGJhY2tzLCBjb250ZXh0LCBhcmdzKSB7CiAgICAgIHJldHVybiBmbHVzaDsKICAgICAgZnVuY3Rpb24gZmx1c2goKSB7CiAgICAgICAgdmFyIGNhbmNlbGxlZDsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gY2FsbGJhY2tzLmxlbmd0aDsgIWNhbmNlbGxlZCAmJiBpIDwgbGVuOyBpICs9IDEpIHsKICAgICAgICAgIGNhbmNlbGxlZCA9IGNhbGxiYWNrc1tpXS5hcHBseShjb250ZXh0LCBhcmdzKSA9PT0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiAhY2FuY2VsbGVkOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBiaW5kQ29udGV4dChmbiwgY29udGV4dCkgewogICAgICByZXR1cm4gZm4uYmluZCA/IGZuLmJpbmQoY29udGV4dCkgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgZm4uYXBwbHkoY29udGV4dCwgW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDApKTsKICAgICAgfTsKICAgIH0KICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgdmFyIF8gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDApOwogICAgdmFyIGNzcyA9IHsKICAgICAgd3JhcHBlcjogewogICAgICAgIHBvc2l0aW9uOiAicmVsYXRpdmUiLAogICAgICAgIGRpc3BsYXk6ICJpbmxpbmUtYmxvY2siCiAgICAgIH0sCiAgICAgIGhpbnQ6IHsKICAgICAgICBwb3NpdGlvbjogImFic29sdXRlIiwKICAgICAgICB0b3A6ICIwIiwKICAgICAgICBsZWZ0OiAiMCIsCiAgICAgICAgYm9yZGVyQ29sb3I6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgYm94U2hhZG93OiAibm9uZSIsCiAgICAgICAgb3BhY2l0eTogIjEiCiAgICAgIH0sCiAgICAgIGlucHV0OiB7CiAgICAgICAgcG9zaXRpb246ICJyZWxhdGl2ZSIsCiAgICAgICAgdmVydGljYWxBbGlnbjogInRvcCIsCiAgICAgICAgYmFja2dyb3VuZENvbG9yOiAidHJhbnNwYXJlbnQiCiAgICAgIH0sCiAgICAgIGlucHV0V2l0aE5vSGludDogewogICAgICAgIHBvc2l0aW9uOiAicmVsYXRpdmUiLAogICAgICAgIHZlcnRpY2FsQWxpZ246ICJ0b3AiCiAgICAgIH0sCiAgICAgIGRyb3Bkb3duOiB7CiAgICAgICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgICAgICAgdG9wOiAiMTAwJSIsCiAgICAgICAgbGVmdDogIjAiLAogICAgICAgIHpJbmRleDogIjEwMCIsCiAgICAgICAgZGlzcGxheTogIm5vbmUiCiAgICAgIH0sCiAgICAgIHN1Z2dlc3Rpb25zOiB7CiAgICAgICAgZGlzcGxheTogImJsb2NrIgogICAgICB9LAogICAgICBzdWdnZXN0aW9uOiB7CiAgICAgICAgd2hpdGVTcGFjZTogIm5vd3JhcCIsCiAgICAgICAgY3Vyc29yOiAicG9pbnRlciIKICAgICAgfSwKICAgICAgc3VnZ2VzdGlvbkNoaWxkOiB7CiAgICAgICAgd2hpdGVTcGFjZTogIm5vcm1hbCIKICAgICAgfSwKICAgICAgbHRyOiB7CiAgICAgICAgbGVmdDogIjAiLAogICAgICAgIHJpZ2h0OiAiYXV0byIKICAgICAgfSwKICAgICAgcnRsOiB7CiAgICAgICAgbGVmdDogImF1dG8iLAogICAgICAgIHJpZ2h0OiAiMCIKICAgICAgfSwKICAgICAgZGVmYXVsdENsYXNzZXM6IHsKICAgICAgICByb290OiAiYWxnb2xpYS1hdXRvY29tcGxldGUiLAogICAgICAgIHByZWZpeDogImFhIiwKICAgICAgICBub1ByZWZpeDogZmFsc2UsCiAgICAgICAgZHJvcGRvd25NZW51OiAiZHJvcGRvd24tbWVudSIsCiAgICAgICAgaW5wdXQ6ICJpbnB1dCIsCiAgICAgICAgaGludDogImhpbnQiLAogICAgICAgIHN1Z2dlc3Rpb25zOiAic3VnZ2VzdGlvbnMiLAogICAgICAgIHN1Z2dlc3Rpb246ICJzdWdnZXN0aW9uIiwKICAgICAgICBjdXJzb3I6ICJjdXJzb3IiLAogICAgICAgIGRhdGFzZXQ6ICJkYXRhc2V0IiwKICAgICAgICBlbXB0eTogImVtcHR5IgogICAgICB9LAogICAgICBhcHBlbmRUbzogewogICAgICAgIHdyYXBwZXI6IHsKICAgICAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICAgICAgekluZGV4OiAiMTAwIiwKICAgICAgICAgIGRpc3BsYXk6ICJub25lIgogICAgICAgIH0sCiAgICAgICAgaW5wdXQ6IHt9LAogICAgICAgIGlucHV0V2l0aE5vSGludDoge30sCiAgICAgICAgZHJvcGRvd246IHsKICAgICAgICAgIGRpc3BsYXk6ICJibG9jayIKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICBpZiAoXy5pc01zaWUoKSkgewogICAgICBfLm1peGluKGNzcy5pbnB1dCwgewogICAgICAgIGJhY2tncm91bmRJbWFnZTogInVybChkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhBUUFCQUlBQUFBQUFBUC8vL3lINUJBRUFBQUFBTEFBQUFBQUJBQUVBQUFJQlJBQTcpIgogICAgICB9KTsKICAgIH0KICAgIGlmIChfLmlzTXNpZSgpICYmIF8uaXNNc2llKCkgPD0gNykgewogICAgICBfLm1peGluKGNzcy5pbnB1dCwgewogICAgICAgIG1hcmdpblRvcDogIi0xcHgiCiAgICAgIH0pOwogICAgfQogICAgbW9kdWxlLmV4cG9ydHMgPSBjc3M7CiAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cykgewogICAgaWYgKHR5cGVvZiBPYmplY3QuY3JlYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gaW5oZXJpdHMoY3Rvciwgc3VwZXJDdG9yKSB7CiAgICAgICAgY3Rvci5zdXBlcl8gPSBzdXBlckN0b3I7CiAgICAgICAgY3Rvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ3Rvci5wcm90b3R5cGUsIHsKICAgICAgICAgIGNvbnN0cnVjdG9yOiB7CiAgICAgICAgICAgIHZhbHVlOiBjdG9yLAogICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBpbmhlcml0cyhjdG9yLCBzdXBlckN0b3IpIHsKICAgICAgICBjdG9yLnN1cGVyXyA9IHN1cGVyQ3RvcjsKICAgICAgICB2YXIgVGVtcEN0b3IgPSBmdW5jdGlvbiAoKSB7fTsKICAgICAgICBUZW1wQ3Rvci5wcm90b3R5cGUgPSBzdXBlckN0b3IucHJvdG90eXBlOwogICAgICAgIGN0b3IucHJvdG90eXBlID0gbmV3IFRlbXBDdG9yKCk7CiAgICAgICAgY3Rvci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjdG9yOwogICAgICB9OwogICAgfQogIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgIG1vZHVsZS5leHBvcnRzID0gYnVpbGRTZWFyY2hNZXRob2Q7CiAgICB2YXIgZXJyb3JzID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1KTsKICAgIGZ1bmN0aW9uIGJ1aWxkU2VhcmNoTWV0aG9kKHF1ZXJ5UGFyYW0sIHVybCkgewogICAgICByZXR1cm4gZnVuY3Rpb24gc2VhcmNoKHF1ZXJ5LCBhcmdzLCBjYWxsYmFjaykgewogICAgICAgIGlmICh0eXBlb2YgcXVlcnkgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGFyZ3MgPT09ICJvYmplY3QiIHx8IHR5cGVvZiBjYWxsYmFjayA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgIHRocm93IG5ldyBlcnJvcnMuQWxnb2xpYVNlYXJjaEVycm9yKCJpbmRleC5zZWFyY2ggdXNhZ2UgaXMgaW5kZXguc2VhcmNoKHF1ZXJ5LCBwYXJhbXMsIGNiKSIpOwogICAgICAgIH0KICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCB8fCB0eXBlb2YgcXVlcnkgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIGNhbGxiYWNrID0gcXVlcnk7CiAgICAgICAgICBxdWVyeSA9ICIiOwogICAgICAgIH0gZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSB8fCB0eXBlb2YgYXJncyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgY2FsbGJhY2sgPSBhcmdzOwogICAgICAgICAgYXJncyA9IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBxdWVyeSA9PT0gIm9iamVjdCIgJiYgcXVlcnkgIT09IG51bGwpIHsKICAgICAgICAgIGFyZ3MgPSBxdWVyeTsKICAgICAgICAgIHF1ZXJ5ID0gdW5kZWZpbmVkOwogICAgICAgIH0gZWxzZSBpZiAocXVlcnkgPT09IHVuZGVmaW5lZCB8fCBxdWVyeSA9PT0gbnVsbCkgewogICAgICAgICAgcXVlcnkgPSAiIjsKICAgICAgICB9CiAgICAgICAgdmFyIHBhcmFtcyA9ICIiOwogICAgICAgIGlmIChxdWVyeSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBwYXJhbXMgKz0gcXVlcnlQYXJhbSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudChxdWVyeSk7CiAgICAgICAgfQogICAgICAgIHZhciBhZGRpdGlvbmFsVUE7CiAgICAgICAgaWYgKGFyZ3MgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgaWYgKGFyZ3MuYWRkaXRpb25hbFVBKSB7CiAgICAgICAgICAgIGFkZGl0aW9uYWxVQSA9IGFyZ3MuYWRkaXRpb25hbFVBOwogICAgICAgICAgICBkZWxldGUgYXJncy5hZGRpdGlvbmFsVUE7CiAgICAgICAgICB9CiAgICAgICAgICBwYXJhbXMgPSB0aGlzLmFzLl9nZXRTZWFyY2hQYXJhbXMoYXJncywgcGFyYW1zKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuX3NlYXJjaChwYXJhbXMsIHVybCwgY2FsbGJhY2ssIGFkZGl0aW9uYWxVQSk7CiAgICAgIH07CiAgICB9CiAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBvbWl0KG9iaiwgdGVzdCkgewogICAgICB2YXIga2V5cyA9IF9fd2VicGFja19yZXF1aXJlX18oMzYpOwogICAgICB2YXIgZm9yZWFjaCA9IF9fd2VicGFja19yZXF1aXJlX18oMik7CiAgICAgIHZhciBmaWx0ZXJlZCA9IHt9OwogICAgICBmb3JlYWNoKGtleXMob2JqKSwgZnVuY3Rpb24gZG9GaWx0ZXIoa2V5TmFtZSkgewogICAgICAgIGlmICh0ZXN0KGtleU5hbWUpICE9PSB0cnVlKSB7CiAgICAgICAgICBmaWx0ZXJlZFtrZXlOYW1lXSA9IG9ialtrZXlOYW1lXTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gZmlsdGVyZWQ7CiAgICB9OwogIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMpIHsKICAgIChmdW5jdGlvbiAoZ2xvYmFsLCBmYWN0b3J5KSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShnbG9iYWwpOwogICAgfSkod2luZG93LCBmdW5jdGlvbiAod2luZG93KSB7CiAgICAgIHZhciBaZXB0byA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdW5kZWZpbmVkLAogICAgICAgICAga2V5LAogICAgICAgICAgJCwKICAgICAgICAgIGNsYXNzTGlzdCwKICAgICAgICAgIGVtcHR5QXJyYXkgPSBbXSwKICAgICAgICAgIGNvbmNhdCA9IGVtcHR5QXJyYXkuY29uY2F0LAogICAgICAgICAgZmlsdGVyID0gZW1wdHlBcnJheS5maWx0ZXIsCiAgICAgICAgICBzbGljZSA9IGVtcHR5QXJyYXkuc2xpY2UsCiAgICAgICAgICBkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudCwKICAgICAgICAgIGVsZW1lbnREaXNwbGF5ID0ge30sCiAgICAgICAgICBjbGFzc0NhY2hlID0ge30sCiAgICAgICAgICBjc3NOdW1iZXIgPSB7CiAgICAgICAgICAgICJjb2x1bW4tY291bnQiOiAxLAogICAgICAgICAgICBjb2x1bW5zOiAxLAogICAgICAgICAgICAiZm9udC13ZWlnaHQiOiAxLAogICAgICAgICAgICAibGluZS1oZWlnaHQiOiAxLAogICAgICAgICAgICBvcGFjaXR5OiAxLAogICAgICAgICAgICAiei1pbmRleCI6IDEsCiAgICAgICAgICAgIHpvb206IDEKICAgICAgICAgIH0sCiAgICAgICAgICBmcmFnbWVudFJFID0gL15ccyo8KFx3K3whKVtePl0qPi8sCiAgICAgICAgICBzaW5nbGVUYWdSRSA9IC9ePChcdyspXHMqXC8/Pig/OjxcL1wxPnwpJC8sCiAgICAgICAgICB0YWdFeHBhbmRlclJFID0gLzwoPyFhcmVhfGJyfGNvbHxlbWJlZHxocnxpbWd8aW5wdXR8bGlua3xtZXRhfHBhcmFtKSgoW1x3Ol0rKVtePl0qKVwvPi9naSwKICAgICAgICAgIHJvb3ROb2RlUkUgPSAvXig/OmJvZHl8aHRtbCkkL2ksCiAgICAgICAgICBjYXBpdGFsUkUgPSAvKFtBLVpdKS9nLAogICAgICAgICAgbWV0aG9kQXR0cmlidXRlcyA9IFsidmFsIiwgImNzcyIsICJodG1sIiwgInRleHQiLCAiZGF0YSIsICJ3aWR0aCIsICJoZWlnaHQiLCAib2Zmc2V0Il0sCiAgICAgICAgICBhZGphY2VuY3lPcGVyYXRvcnMgPSBbImFmdGVyIiwgInByZXBlbmQiLCAiYmVmb3JlIiwgImFwcGVuZCJdLAogICAgICAgICAgdGFibGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0YWJsZSIpLAogICAgICAgICAgdGFibGVSb3cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0ciIpLAogICAgICAgICAgY29udGFpbmVycyA9IHsKICAgICAgICAgICAgdHI6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRib2R5IiksCiAgICAgICAgICAgIHRib2R5OiB0YWJsZSwKICAgICAgICAgICAgdGhlYWQ6IHRhYmxlLAogICAgICAgICAgICB0Zm9vdDogdGFibGUsCiAgICAgICAgICAgIHRkOiB0YWJsZVJvdywKICAgICAgICAgICAgdGg6IHRhYmxlUm93LAogICAgICAgICAgICAiKiI6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCiAgICAgICAgICB9LAogICAgICAgICAgcmVhZHlSRSA9IC9jb21wbGV0ZXxsb2FkZWR8aW50ZXJhY3RpdmUvLAogICAgICAgICAgc2ltcGxlU2VsZWN0b3JSRSA9IC9eW1x3LV0qJC8sCiAgICAgICAgICBjbGFzczJ0eXBlID0ge30sCiAgICAgICAgICB0b1N0cmluZyA9IGNsYXNzMnR5cGUudG9TdHJpbmcsCiAgICAgICAgICB6ZXB0byA9IHt9LAogICAgICAgICAgY2FtZWxpemUsCiAgICAgICAgICB1bmlxLAogICAgICAgICAgdGVtcFBhcmVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpLAogICAgICAgICAgcHJvcE1hcCA9IHsKICAgICAgICAgICAgdGFiaW5kZXg6ICJ0YWJJbmRleCIsCiAgICAgICAgICAgIHJlYWRvbmx5OiAicmVhZE9ubHkiLAogICAgICAgICAgICBmb3I6ICJodG1sRm9yIiwKICAgICAgICAgICAgY2xhc3M6ICJjbGFzc05hbWUiLAogICAgICAgICAgICBtYXhsZW5ndGg6ICJtYXhMZW5ndGgiLAogICAgICAgICAgICBjZWxsc3BhY2luZzogImNlbGxTcGFjaW5nIiwKICAgICAgICAgICAgY2VsbHBhZGRpbmc6ICJjZWxsUGFkZGluZyIsCiAgICAgICAgICAgIHJvd3NwYW46ICJyb3dTcGFuIiwKICAgICAgICAgICAgY29sc3BhbjogImNvbFNwYW4iLAogICAgICAgICAgICB1c2VtYXA6ICJ1c2VNYXAiLAogICAgICAgICAgICBmcmFtZWJvcmRlcjogImZyYW1lQm9yZGVyIiwKICAgICAgICAgICAgY29udGVudGVkaXRhYmxlOiAiY29udGVudEVkaXRhYmxlIgogICAgICAgICAgfSwKICAgICAgICAgIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5IHx8IGZ1bmN0aW9uIChvYmplY3QpIHsKICAgICAgICAgICAgcmV0dXJuIG9iamVjdCBpbnN0YW5jZW9mIEFycmF5OwogICAgICAgICAgfTsKICAgICAgICB6ZXB0by5tYXRjaGVzID0gZnVuY3Rpb24gKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICAgICAgICBpZiAoIXNlbGVjdG9yIHx8ICFlbGVtZW50IHx8IGVsZW1lbnQubm9kZVR5cGUgIT09IDEpIHJldHVybiBmYWxzZTsKICAgICAgICAgIHZhciBtYXRjaGVzU2VsZWN0b3IgPSBlbGVtZW50Lm1hdGNoZXMgfHwgZWxlbWVudC53ZWJraXRNYXRjaGVzU2VsZWN0b3IgfHwgZWxlbWVudC5tb3pNYXRjaGVzU2VsZWN0b3IgfHwgZWxlbWVudC5vTWF0Y2hlc1NlbGVjdG9yIHx8IGVsZW1lbnQubWF0Y2hlc1NlbGVjdG9yOwogICAgICAgICAgaWYgKG1hdGNoZXNTZWxlY3RvcikgcmV0dXJuIG1hdGNoZXNTZWxlY3Rvci5jYWxsKGVsZW1lbnQsIHNlbGVjdG9yKTsKICAgICAgICAgIHZhciBtYXRjaCwKICAgICAgICAgICAgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlLAogICAgICAgICAgICB0ZW1wID0gIXBhcmVudDsKICAgICAgICAgIGlmICh0ZW1wKSAocGFyZW50ID0gdGVtcFBhcmVudCkuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgICBtYXRjaCA9IH56ZXB0by5xc2EocGFyZW50LCBzZWxlY3RvcikuaW5kZXhPZihlbGVtZW50KTsKICAgICAgICAgIHRlbXAgJiYgdGVtcFBhcmVudC5yZW1vdmVDaGlsZChlbGVtZW50KTsKICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHR5cGUob2JqKSB7CiAgICAgICAgICByZXR1cm4gb2JqID09IG51bGwgPyBTdHJpbmcob2JqKSA6IGNsYXNzMnR5cGVbdG9TdHJpbmcuY2FsbChvYmopXSB8fCAib2JqZWN0IjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgcmV0dXJuIHR5cGUodmFsdWUpID09ICJmdW5jdGlvbiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzV2luZG93KG9iaikgewogICAgICAgICAgcmV0dXJuIG9iaiAhPSBudWxsICYmIG9iaiA9PSBvYmoud2luZG93OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0RvY3VtZW50KG9iaikgewogICAgICAgICAgcmV0dXJuIG9iaiAhPSBudWxsICYmIG9iai5ub2RlVHlwZSA9PSBvYmouRE9DVU1FTlRfTk9ERTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNPYmplY3Qob2JqKSB7CiAgICAgICAgICByZXR1cm4gdHlwZShvYmopID09ICJvYmplY3QiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1BsYWluT2JqZWN0KG9iaikgewogICAgICAgICAgcmV0dXJuIGlzT2JqZWN0KG9iaikgJiYgIWlzV2luZG93KG9iaikgJiYgT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iaikgPT0gT2JqZWN0LnByb3RvdHlwZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGlrZUFycmF5KG9iaikgewogICAgICAgICAgdmFyIGxlbmd0aCA9ICEhb2JqICYmICJsZW5ndGgiIGluIG9iaiAmJiBvYmoubGVuZ3RoLAogICAgICAgICAgICB0eXBlID0gJC50eXBlKG9iaik7CiAgICAgICAgICByZXR1cm4gImZ1bmN0aW9uIiAhPSB0eXBlICYmICFpc1dpbmRvdyhvYmopICYmICgiYXJyYXkiID09IHR5cGUgfHwgbGVuZ3RoID09PSAwIHx8IHR5cGVvZiBsZW5ndGggPT0gIm51bWJlciIgJiYgbGVuZ3RoID4gMCAmJiBsZW5ndGggLSAxIGluIG9iaik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXBhY3QoYXJyYXkpIHsKICAgICAgICAgIHJldHVybiBmaWx0ZXIuY2FsbChhcnJheSwgZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICAgICAgcmV0dXJuIGl0ZW0gIT0gbnVsbDsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbGF0dGVuKGFycmF5KSB7CiAgICAgICAgICByZXR1cm4gYXJyYXkubGVuZ3RoID4gMCA/ICQuZm4uY29uY2F0LmFwcGx5KFtdLCBhcnJheSkgOiBhcnJheTsKICAgICAgICB9CiAgICAgICAgY2FtZWxpemUgPSBmdW5jdGlvbiAoc3RyKSB7CiAgICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UoLy0rKC4pPy9nLCBmdW5jdGlvbiAobWF0Y2gsIGNocikgewogICAgICAgICAgICByZXR1cm4gY2hyID8gY2hyLnRvVXBwZXJDYXNlKCkgOiAiIjsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gZGFzaGVyaXplKHN0cikgewogICAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKC86Oi9nLCAiLyIpLnJlcGxhY2UoLyhbQS1aXSspKFtBLVpdW2Etel0pL2csICIkMV8kMiIpLnJlcGxhY2UoLyhbYS16XGRdKShbQS1aXSkvZywgIiQxXyQyIikucmVwbGFjZSgvXy9nLCAiLSIpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgfQogICAgICAgIHVuaXEgPSBmdW5jdGlvbiAoYXJyYXkpIHsKICAgICAgICAgIHJldHVybiBmaWx0ZXIuY2FsbChhcnJheSwgZnVuY3Rpb24gKGl0ZW0sIGlkeCkgewogICAgICAgICAgICByZXR1cm4gYXJyYXkuaW5kZXhPZihpdGVtKSA9PSBpZHg7CiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNsYXNzUkUobmFtZSkgewogICAgICAgICAgcmV0dXJuIG5hbWUgaW4gY2xhc3NDYWNoZSA/IGNsYXNzQ2FjaGVbbmFtZV0gOiBjbGFzc0NhY2hlW25hbWVdID0gbmV3IFJlZ0V4cCgiKF58XFxzKSIgKyBuYW1lICsgIihcXHN8JCkiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWF5YmVBZGRQeChuYW1lLCB2YWx1ZSkgewogICAgICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAibnVtYmVyIiAmJiAhY3NzTnVtYmVyW2Rhc2hlcml6ZShuYW1lKV0gPyB2YWx1ZSArICJweCIgOiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVmYXVsdERpc3BsYXkobm9kZU5hbWUpIHsKICAgICAgICAgIHZhciBlbGVtZW50LCBkaXNwbGF5OwogICAgICAgICAgaWYgKCFlbGVtZW50RGlzcGxheVtub2RlTmFtZV0pIHsKICAgICAgICAgICAgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQobm9kZU5hbWUpOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGVsZW1lbnQpOwogICAgICAgICAgICBkaXNwbGF5ID0gZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50LCAiIikuZ2V0UHJvcGVydHlWYWx1ZSgiZGlzcGxheSIpOwogICAgICAgICAgICBlbGVtZW50LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgICAgIGRpc3BsYXkgPT0gIm5vbmUiICYmIChkaXNwbGF5ID0gImJsb2NrIik7CiAgICAgICAgICAgIGVsZW1lbnREaXNwbGF5W25vZGVOYW1lXSA9IGRpc3BsYXk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudERpc3BsYXlbbm9kZU5hbWVdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGlsZHJlbihlbGVtZW50KSB7CiAgICAgICAgICByZXR1cm4gImNoaWxkcmVuIiBpbiBlbGVtZW50ID8gc2xpY2UuY2FsbChlbGVtZW50LmNoaWxkcmVuKSA6ICQubWFwKGVsZW1lbnQuY2hpbGROb2RlcywgZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgcmV0dXJuIG5vZGU7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gWihkb20sIHNlbGVjdG9yKSB7CiAgICAgICAgICB2YXIgaSwKICAgICAgICAgICAgbGVuID0gZG9tID8gZG9tLmxlbmd0aCA6IDA7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHRoaXNbaV0gPSBkb21baV07CiAgICAgICAgICB0aGlzLmxlbmd0aCA9IGxlbjsKICAgICAgICAgIHRoaXMuc2VsZWN0b3IgPSBzZWxlY3RvciB8fCAiIjsKICAgICAgICB9CiAgICAgICAgemVwdG8uZnJhZ21lbnQgPSBmdW5jdGlvbiAoaHRtbCwgbmFtZSwgcHJvcGVydGllcykgewogICAgICAgICAgdmFyIGRvbSwgbm9kZXMsIGNvbnRhaW5lcjsKICAgICAgICAgIGlmIChzaW5nbGVUYWdSRS50ZXN0KGh0bWwpKSBkb20gPSAkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoUmVnRXhwLiQxKSk7CiAgICAgICAgICBpZiAoIWRvbSkgewogICAgICAgICAgICBpZiAoaHRtbC5yZXBsYWNlKSBodG1sID0gaHRtbC5yZXBsYWNlKHRhZ0V4cGFuZGVyUkUsICI8JDE+PC8kMj4iKTsKICAgICAgICAgICAgaWYgKG5hbWUgPT09IHVuZGVmaW5lZCkgbmFtZSA9IGZyYWdtZW50UkUudGVzdChodG1sKSAmJiBSZWdFeHAuJDE7CiAgICAgICAgICAgIGlmICghKG5hbWUgaW4gY29udGFpbmVycykpIG5hbWUgPSAiKiI7CiAgICAgICAgICAgIGNvbnRhaW5lciA9IGNvbnRhaW5lcnNbbmFtZV07CiAgICAgICAgICAgIGNvbnRhaW5lci5pbm5lckhUTUwgPSAiIiArIGh0bWw7CiAgICAgICAgICAgIGRvbSA9ICQuZWFjaChzbGljZS5jYWxsKGNvbnRhaW5lci5jaGlsZE5vZGVzKSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGNvbnRhaW5lci5yZW1vdmVDaGlsZCh0aGlzKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNQbGFpbk9iamVjdChwcm9wZXJ0aWVzKSkgewogICAgICAgICAgICBub2RlcyA9ICQoZG9tKTsKICAgICAgICAgICAgJC5lYWNoKHByb3BlcnRpZXMsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgICAgICAgaWYgKG1ldGhvZEF0dHJpYnV0ZXMuaW5kZXhPZihrZXkpID4gLTEpIG5vZGVzW2tleV0odmFsdWUpO2Vsc2Ugbm9kZXMuYXR0cihrZXksIHZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZG9tOwogICAgICAgIH07CiAgICAgICAgemVwdG8uWiA9IGZ1bmN0aW9uIChkb20sIHNlbGVjdG9yKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFooZG9tLCBzZWxlY3Rvcik7CiAgICAgICAgfTsKICAgICAgICB6ZXB0by5pc1ogPSBmdW5jdGlvbiAob2JqZWN0KSB7CiAgICAgICAgICByZXR1cm4gb2JqZWN0IGluc3RhbmNlb2YgemVwdG8uWjsKICAgICAgICB9OwogICAgICAgIHplcHRvLmluaXQgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRleHQpIHsKICAgICAgICAgIHZhciBkb207CiAgICAgICAgICBpZiAoIXNlbGVjdG9yKSByZXR1cm4gemVwdG8uWigpO2Vsc2UgaWYgKHR5cGVvZiBzZWxlY3RvciA9PSAic3RyaW5nIikgewogICAgICAgICAgICBzZWxlY3RvciA9IHNlbGVjdG9yLnRyaW0oKTsKICAgICAgICAgICAgaWYgKHNlbGVjdG9yWzBdID09ICI8IiAmJiBmcmFnbWVudFJFLnRlc3Qoc2VsZWN0b3IpKSBkb20gPSB6ZXB0by5mcmFnbWVudChzZWxlY3RvciwgUmVnRXhwLiQxLCBjb250ZXh0KSwgc2VsZWN0b3IgPSBudWxsO2Vsc2UgaWYgKGNvbnRleHQgIT09IHVuZGVmaW5lZCkgcmV0dXJuICQoY29udGV4dCkuZmluZChzZWxlY3Rvcik7ZWxzZSBkb20gPSB6ZXB0by5xc2EoZG9jdW1lbnQsIHNlbGVjdG9yKTsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNGdW5jdGlvbihzZWxlY3RvcikpIHJldHVybiAkKGRvY3VtZW50KS5yZWFkeShzZWxlY3Rvcik7ZWxzZSBpZiAoemVwdG8uaXNaKHNlbGVjdG9yKSkgcmV0dXJuIHNlbGVjdG9yO2Vsc2UgewogICAgICAgICAgICBpZiAoaXNBcnJheShzZWxlY3RvcikpIGRvbSA9IGNvbXBhY3Qoc2VsZWN0b3IpO2Vsc2UgaWYgKGlzT2JqZWN0KHNlbGVjdG9yKSkgZG9tID0gW3NlbGVjdG9yXSwgc2VsZWN0b3IgPSBudWxsO2Vsc2UgaWYgKGZyYWdtZW50UkUudGVzdChzZWxlY3RvcikpIGRvbSA9IHplcHRvLmZyYWdtZW50KHNlbGVjdG9yLnRyaW0oKSwgUmVnRXhwLiQxLCBjb250ZXh0KSwgc2VsZWN0b3IgPSBudWxsO2Vsc2UgaWYgKGNvbnRleHQgIT09IHVuZGVmaW5lZCkgcmV0dXJuICQoY29udGV4dCkuZmluZChzZWxlY3Rvcik7ZWxzZSBkb20gPSB6ZXB0by5xc2EoZG9jdW1lbnQsIHNlbGVjdG9yKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB6ZXB0by5aKGRvbSwgc2VsZWN0b3IpOwogICAgICAgIH07CiAgICAgICAgJCA9IGZ1bmN0aW9uIChzZWxlY3RvciwgY29udGV4dCkgewogICAgICAgICAgcmV0dXJuIHplcHRvLmluaXQoc2VsZWN0b3IsIGNvbnRleHQpOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gZXh0ZW5kKHRhcmdldCwgc291cmNlLCBkZWVwKSB7CiAgICAgICAgICBmb3IgKGtleSBpbiBzb3VyY2UpIGlmIChkZWVwICYmIChpc1BsYWluT2JqZWN0KHNvdXJjZVtrZXldKSB8fCBpc0FycmF5KHNvdXJjZVtrZXldKSkpIHsKICAgICAgICAgICAgaWYgKGlzUGxhaW5PYmplY3Qoc291cmNlW2tleV0pICYmICFpc1BsYWluT2JqZWN0KHRhcmdldFtrZXldKSkgdGFyZ2V0W2tleV0gPSB7fTsKICAgICAgICAgICAgaWYgKGlzQXJyYXkoc291cmNlW2tleV0pICYmICFpc0FycmF5KHRhcmdldFtrZXldKSkgdGFyZ2V0W2tleV0gPSBbXTsKICAgICAgICAgICAgZXh0ZW5kKHRhcmdldFtrZXldLCBzb3VyY2Vba2V5XSwgZGVlcCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHNvdXJjZVtrZXldICE9PSB1bmRlZmluZWQpIHRhcmdldFtrZXldID0gc291cmNlW2tleV07CiAgICAgICAgfQogICAgICAgICQuZXh0ZW5kID0gZnVuY3Rpb24gKHRhcmdldCkgewogICAgICAgICAgdmFyIGRlZXAsCiAgICAgICAgICAgIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICBpZiAodHlwZW9mIHRhcmdldCA9PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgZGVlcCA9IHRhcmdldDsKICAgICAgICAgICAgdGFyZ2V0ID0gYXJncy5zaGlmdCgpOwogICAgICAgICAgfQogICAgICAgICAgYXJncy5mb3JFYWNoKGZ1bmN0aW9uIChhcmcpIHsKICAgICAgICAgICAgZXh0ZW5kKHRhcmdldCwgYXJnLCBkZWVwKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgICB9OwogICAgICAgIHplcHRvLnFzYSA9IGZ1bmN0aW9uIChlbGVtZW50LCBzZWxlY3RvcikgewogICAgICAgICAgdmFyIGZvdW5kLAogICAgICAgICAgICBtYXliZUlEID0gc2VsZWN0b3JbMF0gPT0gIiMiLAogICAgICAgICAgICBtYXliZUNsYXNzID0gIW1heWJlSUQgJiYgc2VsZWN0b3JbMF0gPT0gIi4iLAogICAgICAgICAgICBuYW1lT25seSA9IG1heWJlSUQgfHwgbWF5YmVDbGFzcyA/IHNlbGVjdG9yLnNsaWNlKDEpIDogc2VsZWN0b3IsCiAgICAgICAgICAgIGlzU2ltcGxlID0gc2ltcGxlU2VsZWN0b3JSRS50ZXN0KG5hbWVPbmx5KTsKICAgICAgICAgIHJldHVybiBlbGVtZW50LmdldEVsZW1lbnRCeUlkICYmIGlzU2ltcGxlICYmIG1heWJlSUQgPyAoZm91bmQgPSBlbGVtZW50LmdldEVsZW1lbnRCeUlkKG5hbWVPbmx5KSkgPyBbZm91bmRdIDogW10gOiBlbGVtZW50Lm5vZGVUeXBlICE9PSAxICYmIGVsZW1lbnQubm9kZVR5cGUgIT09IDkgJiYgZWxlbWVudC5ub2RlVHlwZSAhPT0gMTEgPyBbXSA6IHNsaWNlLmNhbGwoaXNTaW1wbGUgJiYgIW1heWJlSUQgJiYgZWxlbWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lID8gbWF5YmVDbGFzcyA/IGVsZW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShuYW1lT25seSkgOiBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKHNlbGVjdG9yKSA6IGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbChzZWxlY3RvcikpOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gZmlsdGVyZWQobm9kZXMsIHNlbGVjdG9yKSB7CiAgICAgICAgICByZXR1cm4gc2VsZWN0b3IgPT0gbnVsbCA/ICQobm9kZXMpIDogJChub2RlcykuZmlsdGVyKHNlbGVjdG9yKTsKICAgICAgICB9CiAgICAgICAgJC5jb250YWlucyA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jb250YWlucyA/IGZ1bmN0aW9uIChwYXJlbnQsIG5vZGUpIHsKICAgICAgICAgIHJldHVybiBwYXJlbnQgIT09IG5vZGUgJiYgcGFyZW50LmNvbnRhaW5zKG5vZGUpOwogICAgICAgIH0gOiBmdW5jdGlvbiAocGFyZW50LCBub2RlKSB7CiAgICAgICAgICB3aGlsZSAobm9kZSAmJiAobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkpIGlmIChub2RlID09PSBwYXJlbnQpIHJldHVybiB0cnVlOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gZnVuY0FyZyhjb250ZXh0LCBhcmcsIGlkeCwgcGF5bG9hZCkgewogICAgICAgICAgcmV0dXJuIGlzRnVuY3Rpb24oYXJnKSA/IGFyZy5jYWxsKGNvbnRleHQsIGlkeCwgcGF5bG9hZCkgOiBhcmc7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldEF0dHJpYnV0ZShub2RlLCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgdmFsdWUgPT0gbnVsbCA/IG5vZGUucmVtb3ZlQXR0cmlidXRlKG5hbWUpIDogbm9kZS5zZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGFzc05hbWUobm9kZSwgdmFsdWUpIHsKICAgICAgICAgIHZhciBrbGFzcyA9IG5vZGUuY2xhc3NOYW1lIHx8ICIiLAogICAgICAgICAgICBzdmcgPSBrbGFzcyAmJiBrbGFzcy5iYXNlVmFsICE9PSB1bmRlZmluZWQ7CiAgICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHN2ZyA/IGtsYXNzLmJhc2VWYWwgOiBrbGFzczsKICAgICAgICAgIHN2ZyA/IGtsYXNzLmJhc2VWYWwgPSB2YWx1ZSA6IG5vZGUuY2xhc3NOYW1lID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2VyaWFsaXplVmFsdWUodmFsdWUpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSA/IHZhbHVlID09ICJ0cnVlIiB8fCAodmFsdWUgPT0gImZhbHNlIiA/IGZhbHNlIDogdmFsdWUgPT0gIm51bGwiID8gbnVsbCA6ICt2YWx1ZSArICIiID09IHZhbHVlID8gK3ZhbHVlIDogL15bXFtce10vLnRlc3QodmFsdWUpID8gJC5wYXJzZUpTT04odmFsdWUpIDogdmFsdWUpIDogdmFsdWU7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgJC50eXBlID0gdHlwZTsKICAgICAgICAkLmlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uOwogICAgICAgICQuaXNXaW5kb3cgPSBpc1dpbmRvdzsKICAgICAgICAkLmlzQXJyYXkgPSBpc0FycmF5OwogICAgICAgICQuaXNQbGFpbk9iamVjdCA9IGlzUGxhaW5PYmplY3Q7CiAgICAgICAgJC5pc0VtcHR5T2JqZWN0ID0gZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgdmFyIG5hbWU7CiAgICAgICAgICBmb3IgKG5hbWUgaW4gb2JqKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9OwogICAgICAgICQuaXNOdW1lcmljID0gZnVuY3Rpb24gKHZhbCkgewogICAgICAgICAgdmFyIG51bSA9IE51bWJlcih2YWwpLAogICAgICAgICAgICB0eXBlID0gdHlwZW9mIHZhbDsKICAgICAgICAgIHJldHVybiB2YWwgIT0gbnVsbCAmJiB0eXBlICE9ICJib29sZWFuIiAmJiAodHlwZSAhPSAic3RyaW5nIiB8fCB2YWwubGVuZ3RoKSAmJiAhaXNOYU4obnVtKSAmJiBpc0Zpbml0ZShudW0pIHx8IGZhbHNlOwogICAgICAgIH07CiAgICAgICAgJC5pbkFycmF5ID0gZnVuY3Rpb24gKGVsZW0sIGFycmF5LCBpKSB7CiAgICAgICAgICByZXR1cm4gZW1wdHlBcnJheS5pbmRleE9mLmNhbGwoYXJyYXksIGVsZW0sIGkpOwogICAgICAgIH07CiAgICAgICAgJC5jYW1lbENhc2UgPSBjYW1lbGl6ZTsKICAgICAgICAkLnRyaW0gPSBmdW5jdGlvbiAoc3RyKSB7CiAgICAgICAgICByZXR1cm4gc3RyID09IG51bGwgPyAiIiA6IFN0cmluZy5wcm90b3R5cGUudHJpbS5jYWxsKHN0cik7CiAgICAgICAgfTsKICAgICAgICAkLnV1aWQgPSAwOwogICAgICAgICQuc3VwcG9ydCA9IHt9OwogICAgICAgICQuZXhwciA9IHt9OwogICAgICAgICQubm9vcCA9IGZ1bmN0aW9uICgpIHt9OwogICAgICAgICQubWFwID0gZnVuY3Rpb24gKGVsZW1lbnRzLCBjYWxsYmFjaykgewogICAgICAgICAgdmFyIHZhbHVlLAogICAgICAgICAgICB2YWx1ZXMgPSBbXSwKICAgICAgICAgICAgaSwKICAgICAgICAgICAga2V5OwogICAgICAgICAgaWYgKGxpa2VBcnJheShlbGVtZW50cykpIGZvciAoaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrKGVsZW1lbnRzW2ldLCBpKTsKICAgICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHZhbHVlcy5wdXNoKHZhbHVlKTsKICAgICAgICAgIH0gZWxzZSBmb3IgKGtleSBpbiBlbGVtZW50cykgewogICAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrKGVsZW1lbnRzW2tleV0sIGtleSk7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB2YWx1ZXMucHVzaCh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmxhdHRlbih2YWx1ZXMpOwogICAgICAgIH07CiAgICAgICAgJC5lYWNoID0gZnVuY3Rpb24gKGVsZW1lbnRzLCBjYWxsYmFjaykgewogICAgICAgICAgdmFyIGksIGtleTsKICAgICAgICAgIGlmIChsaWtlQXJyYXkoZWxlbWVudHMpKSB7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgaWYgKGNhbGxiYWNrLmNhbGwoZWxlbWVudHNbaV0sIGksIGVsZW1lbnRzW2ldKSA9PT0gZmFsc2UpIHJldHVybiBlbGVtZW50czsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZvciAoa2V5IGluIGVsZW1lbnRzKSBpZiAoY2FsbGJhY2suY2FsbChlbGVtZW50c1trZXldLCBrZXksIGVsZW1lbnRzW2tleV0pID09PSBmYWxzZSkgcmV0dXJuIGVsZW1lbnRzOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnRzOwogICAgICAgIH07CiAgICAgICAgJC5ncmVwID0gZnVuY3Rpb24gKGVsZW1lbnRzLCBjYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIGZpbHRlci5jYWxsKGVsZW1lbnRzLCBjYWxsYmFjayk7CiAgICAgICAgfTsKICAgICAgICBpZiAod2luZG93LkpTT04pICQucGFyc2VKU09OID0gSlNPTi5wYXJzZTsKICAgICAgICAkLmVhY2goIkJvb2xlYW4gTnVtYmVyIFN0cmluZyBGdW5jdGlvbiBBcnJheSBEYXRlIFJlZ0V4cCBPYmplY3QgRXJyb3IiLnNwbGl0KCIgIiksIGZ1bmN0aW9uIChpLCBuYW1lKSB7CiAgICAgICAgICBjbGFzczJ0eXBlWyJbb2JqZWN0ICIgKyBuYW1lICsgIl0iXSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICB9KTsKICAgICAgICAkLmZuID0gewogICAgICAgICAgY29uc3RydWN0b3I6IHplcHRvLlosCiAgICAgICAgICBsZW5ndGg6IDAsCiAgICAgICAgICBmb3JFYWNoOiBlbXB0eUFycmF5LmZvckVhY2gsCiAgICAgICAgICByZWR1Y2U6IGVtcHR5QXJyYXkucmVkdWNlLAogICAgICAgICAgcHVzaDogZW1wdHlBcnJheS5wdXNoLAogICAgICAgICAgc29ydDogZW1wdHlBcnJheS5zb3J0LAogICAgICAgICAgc3BsaWNlOiBlbXB0eUFycmF5LnNwbGljZSwKICAgICAgICAgIGluZGV4T2Y6IGVtcHR5QXJyYXkuaW5kZXhPZiwKICAgICAgICAgIGNvbmNhdDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgaSwKICAgICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgICBhcmdzID0gW107CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YWx1ZSA9IGFyZ3VtZW50c1tpXTsKICAgICAgICAgICAgICBhcmdzW2ldID0gemVwdG8uaXNaKHZhbHVlKSA/IHZhbHVlLnRvQXJyYXkoKSA6IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb25jYXQuYXBwbHkoemVwdG8uaXNaKHRoaXMpID8gdGhpcy50b0FycmF5KCkgOiB0aGlzLCBhcmdzKTsKICAgICAgICAgIH0sCiAgICAgICAgICBtYXA6IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICByZXR1cm4gJCgkLm1hcCh0aGlzLCBmdW5jdGlvbiAoZWwsIGkpIHsKICAgICAgICAgICAgICByZXR1cm4gZm4uY2FsbChlbCwgaSwgZWwpOwogICAgICAgICAgICB9KSk7CiAgICAgICAgICB9LAogICAgICAgICAgc2xpY2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuICQoc2xpY2UuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICAgICAgICB9LAogICAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICBpZiAocmVhZHlSRS50ZXN0KGRvY3VtZW50LnJlYWR5U3RhdGUpICYmIGRvY3VtZW50LmJvZHkpIGNhbGxiYWNrKCQpO2Vsc2UgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBjYWxsYmFjaygkKTsKICAgICAgICAgICAgfSwgZmFsc2UpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0sCiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChpZHgpIHsKICAgICAgICAgICAgcmV0dXJuIGlkeCA9PT0gdW5kZWZpbmVkID8gc2xpY2UuY2FsbCh0aGlzKSA6IHRoaXNbaWR4ID49IDAgPyBpZHggOiBpZHggKyB0aGlzLmxlbmd0aF07CiAgICAgICAgICB9LAogICAgICAgICAgdG9BcnJheTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXQoKTsKICAgICAgICAgIH0sCiAgICAgICAgICBzaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxlbmd0aDsKICAgICAgICAgIH0sCiAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSAhPSBudWxsKSB0aGlzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGhpcyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKICAgICAgICAgIGVhY2g6IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICBlbXB0eUFycmF5LmV2ZXJ5LmNhbGwodGhpcywgZnVuY3Rpb24gKGVsLCBpZHgpIHsKICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suY2FsbChlbCwgaWR4LCBlbCkgIT09IGZhbHNlOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9LAogICAgICAgICAgZmlsdGVyOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oc2VsZWN0b3IpKSByZXR1cm4gdGhpcy5ub3QodGhpcy5ub3Qoc2VsZWN0b3IpKTsKICAgICAgICAgICAgcmV0dXJuICQoZmlsdGVyLmNhbGwodGhpcywgZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgICByZXR1cm4gemVwdG8ubWF0Y2hlcyhlbGVtZW50LCBzZWxlY3Rvcik7CiAgICAgICAgICAgIH0pKTsKICAgICAgICAgIH0sCiAgICAgICAgICBhZGQ6IGZ1bmN0aW9uIChzZWxlY3RvciwgY29udGV4dCkgewogICAgICAgICAgICByZXR1cm4gJCh1bmlxKHRoaXMuY29uY2F0KCQoc2VsZWN0b3IsIGNvbnRleHQpKSkpOwogICAgICAgICAgfSwKICAgICAgICAgIGlzOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGVuZ3RoID4gMCAmJiB6ZXB0by5tYXRjaGVzKHRoaXNbMF0sIHNlbGVjdG9yKTsKICAgICAgICAgIH0sCiAgICAgICAgICBub3Q6IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICAgICAgICB2YXIgbm9kZXMgPSBbXTsKICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oc2VsZWN0b3IpICYmIHNlbGVjdG9yLmNhbGwgIT09IHVuZGVmaW5lZCkgdGhpcy5lYWNoKGZ1bmN0aW9uIChpZHgpIHsKICAgICAgICAgICAgICBpZiAoIXNlbGVjdG9yLmNhbGwodGhpcywgaWR4KSkgbm9kZXMucHVzaCh0aGlzKTsKICAgICAgICAgICAgfSk7ZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGV4Y2x1ZGVzID0gdHlwZW9mIHNlbGVjdG9yID09ICJzdHJpbmciID8gdGhpcy5maWx0ZXIoc2VsZWN0b3IpIDogbGlrZUFycmF5KHNlbGVjdG9yKSAmJiBpc0Z1bmN0aW9uKHNlbGVjdG9yLml0ZW0pID8gc2xpY2UuY2FsbChzZWxlY3RvcikgOiAkKHNlbGVjdG9yKTsKICAgICAgICAgICAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24gKGVsKSB7CiAgICAgICAgICAgICAgICBpZiAoZXhjbHVkZXMuaW5kZXhPZihlbCkgPCAwKSBub2Rlcy5wdXNoKGVsKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gJChub2Rlcyk7CiAgICAgICAgICB9LAogICAgICAgICAgaGFzOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICByZXR1cm4gaXNPYmplY3Qoc2VsZWN0b3IpID8gJC5jb250YWlucyh0aGlzLCBzZWxlY3RvcikgOiAkKHRoaXMpLmZpbmQoc2VsZWN0b3IpLnNpemUoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgZXE6IGZ1bmN0aW9uIChpZHgpIHsKICAgICAgICAgICAgcmV0dXJuIGlkeCA9PT0gLTEgPyB0aGlzLnNsaWNlKGlkeCkgOiB0aGlzLnNsaWNlKGlkeCwgK2lkeCArIDEpOwogICAgICAgICAgfSwKICAgICAgICAgIGZpcnN0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBlbCA9IHRoaXNbMF07CiAgICAgICAgICAgIHJldHVybiBlbCAmJiAhaXNPYmplY3QoZWwpID8gZWwgOiAkKGVsKTsKICAgICAgICAgIH0sCiAgICAgICAgICBsYXN0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBlbCA9IHRoaXNbdGhpcy5sZW5ndGggLSAxXTsKICAgICAgICAgICAgcmV0dXJuIGVsICYmICFpc09iamVjdChlbCkgPyBlbCA6ICQoZWwpOwogICAgICAgICAgfSwKICAgICAgICAgIGZpbmQ6IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICAgICAgICB2YXIgcmVzdWx0LAogICAgICAgICAgICAgICR0aGlzID0gdGhpczsKICAgICAgICAgICAgaWYgKCFzZWxlY3RvcikgcmVzdWx0ID0gJCgpO2Vsc2UgaWYgKHR5cGVvZiBzZWxlY3RvciA9PSAib2JqZWN0IikgcmVzdWx0ID0gJChzZWxlY3RvcikuZmlsdGVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB2YXIgbm9kZSA9IHRoaXM7CiAgICAgICAgICAgICAgcmV0dXJuIGVtcHR5QXJyYXkuc29tZS5jYWxsKCR0aGlzLCBmdW5jdGlvbiAocGFyZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJC5jb250YWlucyhwYXJlbnQsIG5vZGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTtlbHNlIGlmICh0aGlzLmxlbmd0aCA9PSAxKSByZXN1bHQgPSAkKHplcHRvLnFzYSh0aGlzWzBdLCBzZWxlY3RvcikpO2Vsc2UgcmVzdWx0ID0gdGhpcy5tYXAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHJldHVybiB6ZXB0by5xc2EodGhpcywgc2VsZWN0b3IpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0sCiAgICAgICAgICBjbG9zZXN0OiBmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRleHQpIHsKICAgICAgICAgICAgdmFyIG5vZGVzID0gW10sCiAgICAgICAgICAgICAgY29sbGVjdGlvbiA9IHR5cGVvZiBzZWxlY3RvciA9PSAib2JqZWN0IiAmJiAkKHNlbGVjdG9yKTsKICAgICAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uIChfLCBub2RlKSB7CiAgICAgICAgICAgICAgd2hpbGUgKG5vZGUgJiYgIShjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5pbmRleE9mKG5vZGUpID49IDAgOiB6ZXB0by5tYXRjaGVzKG5vZGUsIHNlbGVjdG9yKSkpIG5vZGUgPSBub2RlICE9PSBjb250ZXh0ICYmICFpc0RvY3VtZW50KG5vZGUpICYmIG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgICAgICBpZiAobm9kZSAmJiBub2Rlcy5pbmRleE9mKG5vZGUpIDwgMCkgbm9kZXMucHVzaChub2RlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiAkKG5vZGVzKTsKICAgICAgICAgIH0sCiAgICAgICAgICBwYXJlbnRzOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgICAgICAgdmFyIGFuY2VzdG9ycyA9IFtdLAogICAgICAgICAgICAgIG5vZGVzID0gdGhpczsKICAgICAgICAgICAgd2hpbGUgKG5vZGVzLmxlbmd0aCA+IDApIG5vZGVzID0gJC5tYXAobm9kZXMsIGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgICAgaWYgKChub2RlID0gbm9kZS5wYXJlbnROb2RlKSAmJiAhaXNEb2N1bWVudChub2RlKSAmJiBhbmNlc3RvcnMuaW5kZXhPZihub2RlKSA8IDApIHsKICAgICAgICAgICAgICAgIGFuY2VzdG9ycy5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIGZpbHRlcmVkKGFuY2VzdG9ycywgc2VsZWN0b3IpOwogICAgICAgICAgfSwKICAgICAgICAgIHBhcmVudDogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgICAgICAgIHJldHVybiBmaWx0ZXJlZCh1bmlxKHRoaXMucGx1Y2soInBhcmVudE5vZGUiKSksIHNlbGVjdG9yKTsKICAgICAgICAgIH0sCiAgICAgICAgICBjaGlsZHJlbjogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgICAgICAgIHJldHVybiBmaWx0ZXJlZCh0aGlzLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkcmVuKHRoaXMpOwogICAgICAgICAgICB9KSwgc2VsZWN0b3IpOwogICAgICAgICAgfSwKICAgICAgICAgIGNvbnRlbnRzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29udGVudERvY3VtZW50IHx8IHNsaWNlLmNhbGwodGhpcy5jaGlsZE5vZGVzKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgc2libGluZ3M6IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICAgICAgICByZXR1cm4gZmlsdGVyZWQodGhpcy5tYXAoZnVuY3Rpb24gKGksIGVsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZpbHRlci5jYWxsKGNoaWxkcmVuKGVsLnBhcmVudE5vZGUpLCBmdW5jdGlvbiAoY2hpbGQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjaGlsZCAhPT0gZWw7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pLCBzZWxlY3Rvcik7CiAgICAgICAgICB9LAogICAgICAgICAgZW1wdHk6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgdGhpcy5pbm5lckhUTUwgPSAiIjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgcGx1Y2s6IGZ1bmN0aW9uIChwcm9wZXJ0eSkgewogICAgICAgICAgICByZXR1cm4gJC5tYXAodGhpcywgZnVuY3Rpb24gKGVsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVsW3Byb3BlcnR5XTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgc2hvdzogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB0aGlzLnN0eWxlLmRpc3BsYXkgPT0gIm5vbmUiICYmICh0aGlzLnN0eWxlLmRpc3BsYXkgPSAiIik7CiAgICAgICAgICAgICAgaWYgKGdldENvbXB1dGVkU3R5bGUodGhpcywgIiIpLmdldFByb3BlcnR5VmFsdWUoImRpc3BsYXkiKSA9PSAibm9uZSIpIHRoaXMuc3R5bGUuZGlzcGxheSA9IGRlZmF1bHREaXNwbGF5KHRoaXMubm9kZU5hbWUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICByZXBsYWNlV2l0aDogZnVuY3Rpb24gKG5ld0NvbnRlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYmVmb3JlKG5ld0NvbnRlbnQpLnJlbW92ZSgpOwogICAgICAgICAgfSwKICAgICAgICAgIHdyYXA6IGZ1bmN0aW9uIChzdHJ1Y3R1cmUpIHsKICAgICAgICAgICAgdmFyIGZ1bmMgPSBpc0Z1bmN0aW9uKHN0cnVjdHVyZSk7CiAgICAgICAgICAgIGlmICh0aGlzWzBdICYmICFmdW5jKSB2YXIgZG9tID0gJChzdHJ1Y3R1cmUpLmdldCgwKSwKICAgICAgICAgICAgICBjbG9uZSA9IGRvbS5wYXJlbnROb2RlIHx8IHRoaXMubGVuZ3RoID4gMTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaW5kZXgpIHsKICAgICAgICAgICAgICAkKHRoaXMpLndyYXBBbGwoZnVuYyA/IHN0cnVjdHVyZS5jYWxsKHRoaXMsIGluZGV4KSA6IGNsb25lID8gZG9tLmNsb25lTm9kZSh0cnVlKSA6IGRvbSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKICAgICAgICAgIHdyYXBBbGw6IGZ1bmN0aW9uIChzdHJ1Y3R1cmUpIHsKICAgICAgICAgICAgaWYgKHRoaXNbMF0pIHsKICAgICAgICAgICAgICAkKHRoaXNbMF0pLmJlZm9yZShzdHJ1Y3R1cmUgPSAkKHN0cnVjdHVyZSkpOwogICAgICAgICAgICAgIHZhciBjaGlsZHJlbjsKICAgICAgICAgICAgICB3aGlsZSAoKGNoaWxkcmVuID0gc3RydWN0dXJlLmNoaWxkcmVuKCkpLmxlbmd0aCkgc3RydWN0dXJlID0gY2hpbGRyZW4uZmlyc3QoKTsKICAgICAgICAgICAgICAkKHN0cnVjdHVyZSkuYXBwZW5kKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfSwKICAgICAgICAgIHdyYXBJbm5lcjogZnVuY3Rpb24gKHN0cnVjdHVyZSkgewogICAgICAgICAgICB2YXIgZnVuYyA9IGlzRnVuY3Rpb24oc3RydWN0dXJlKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaW5kZXgpIHsKICAgICAgICAgICAgICB2YXIgc2VsZiA9ICQodGhpcyksCiAgICAgICAgICAgICAgICBjb250ZW50cyA9IHNlbGYuY29udGVudHMoKSwKICAgICAgICAgICAgICAgIGRvbSA9IGZ1bmMgPyBzdHJ1Y3R1cmUuY2FsbCh0aGlzLCBpbmRleCkgOiBzdHJ1Y3R1cmU7CiAgICAgICAgICAgICAgY29udGVudHMubGVuZ3RoID8gY29udGVudHMud3JhcEFsbChkb20pIDogc2VsZi5hcHBlbmQoZG9tKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgdW53cmFwOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMucGFyZW50KCkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgJCh0aGlzKS5yZXBsYWNlV2l0aCgkKHRoaXMpLmNoaWxkcmVuKCkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9LAogICAgICAgICAgY2xvbmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jbG9uZU5vZGUodHJ1ZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKICAgICAgICAgIGhpZGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3NzKCJkaXNwbGF5IiwgIm5vbmUiKTsKICAgICAgICAgIH0sCiAgICAgICAgICB0b2dnbGU6IGZ1bmN0aW9uIChzZXR0aW5nKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHZhciBlbCA9ICQodGhpcyk7CiAgICAgICAgICAgICAgKHNldHRpbmcgPT09IHVuZGVmaW5lZCA/IGVsLmNzcygiZGlzcGxheSIpID09ICJub25lIiA6IHNldHRpbmcpID8gZWwuc2hvdygpIDogZWwuaGlkZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBwcmV2OiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgICAgICAgcmV0dXJuICQodGhpcy5wbHVjaygicHJldmlvdXNFbGVtZW50U2libGluZyIpKS5maWx0ZXIoc2VsZWN0b3IgfHwgIioiKTsKICAgICAgICAgIH0sCiAgICAgICAgICBuZXh0OiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgICAgICAgcmV0dXJuICQodGhpcy5wbHVjaygibmV4dEVsZW1lbnRTaWJsaW5nIikpLmZpbHRlcihzZWxlY3RvciB8fCAiKiIpOwogICAgICAgICAgfSwKICAgICAgICAgIGh0bWw6IGZ1bmN0aW9uIChodG1sKSB7CiAgICAgICAgICAgIHJldHVybiAwIGluIGFyZ3VtZW50cyA/IHRoaXMuZWFjaChmdW5jdGlvbiAoaWR4KSB7CiAgICAgICAgICAgICAgdmFyIG9yaWdpbkh0bWwgPSB0aGlzLmlubmVySFRNTDsKICAgICAgICAgICAgICAkKHRoaXMpLmVtcHR5KCkuYXBwZW5kKGZ1bmNBcmcodGhpcywgaHRtbCwgaWR4LCBvcmlnaW5IdG1sKSk7CiAgICAgICAgICAgIH0pIDogMCBpbiB0aGlzID8gdGhpc1swXS5pbm5lckhUTUwgOiBudWxsOwogICAgICAgICAgfSwKICAgICAgICAgIHRleHQ6IGZ1bmN0aW9uICh0ZXh0KSB7CiAgICAgICAgICAgIHJldHVybiAwIGluIGFyZ3VtZW50cyA/IHRoaXMuZWFjaChmdW5jdGlvbiAoaWR4KSB7CiAgICAgICAgICAgICAgdmFyIG5ld1RleHQgPSBmdW5jQXJnKHRoaXMsIHRleHQsIGlkeCwgdGhpcy50ZXh0Q29udGVudCk7CiAgICAgICAgICAgICAgdGhpcy50ZXh0Q29udGVudCA9IG5ld1RleHQgPT0gbnVsbCA/ICIiIDogIiIgKyBuZXdUZXh0OwogICAgICAgICAgICB9KSA6IDAgaW4gdGhpcyA/IHRoaXMucGx1Y2soInRleHRDb250ZW50Iikuam9pbigiIikgOiBudWxsOwogICAgICAgICAgfSwKICAgICAgICAgIGF0dHI6IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgcmVzdWx0OwogICAgICAgICAgICByZXR1cm4gdHlwZW9mIG5hbWUgPT0gInN0cmluZyIgJiYgISgxIGluIGFyZ3VtZW50cykgPyAwIGluIHRoaXMgJiYgdGhpc1swXS5ub2RlVHlwZSA9PSAxICYmIChyZXN1bHQgPSB0aGlzWzBdLmdldEF0dHJpYnV0ZShuYW1lKSkgIT0gbnVsbCA/IHJlc3VsdCA6IHVuZGVmaW5lZCA6IHRoaXMuZWFjaChmdW5jdGlvbiAoaWR4KSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMubm9kZVR5cGUgIT09IDEpIHJldHVybjsKICAgICAgICAgICAgICBpZiAoaXNPYmplY3QobmFtZSkpIGZvciAoa2V5IGluIG5hbWUpIHNldEF0dHJpYnV0ZSh0aGlzLCBrZXksIG5hbWVba2V5XSk7ZWxzZSBzZXRBdHRyaWJ1dGUodGhpcywgbmFtZSwgZnVuY0FyZyh0aGlzLCB2YWx1ZSwgaWR4LCB0aGlzLmdldEF0dHJpYnV0ZShuYW1lKSkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICByZW1vdmVBdHRyOiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB0aGlzLm5vZGVUeXBlID09PSAxICYmIG5hbWUuc3BsaXQoIiAiKS5mb3JFYWNoKGZ1bmN0aW9uIChhdHRyaWJ1dGUpIHsKICAgICAgICAgICAgICAgIHNldEF0dHJpYnV0ZSh0aGlzLCBhdHRyaWJ1dGUpOwogICAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBwcm9wOiBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgbmFtZSA9IHByb3BNYXBbbmFtZV0gfHwgbmFtZTsKICAgICAgICAgICAgcmV0dXJuIDEgaW4gYXJndW1lbnRzID8gdGhpcy5lYWNoKGZ1bmN0aW9uIChpZHgpIHsKICAgICAgICAgICAgICB0aGlzW25hbWVdID0gZnVuY0FyZyh0aGlzLCB2YWx1ZSwgaWR4LCB0aGlzW25hbWVdKTsKICAgICAgICAgICAgfSkgOiB0aGlzWzBdICYmIHRoaXNbMF1bbmFtZV07CiAgICAgICAgICB9LAogICAgICAgICAgcmVtb3ZlUHJvcDogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgbmFtZSA9IHByb3BNYXBbbmFtZV0gfHwgbmFtZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgZGVsZXRlIHRoaXNbbmFtZV07CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKICAgICAgICAgIGRhdGE6IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgYXR0ck5hbWUgPSAiZGF0YS0iICsgbmFtZS5yZXBsYWNlKGNhcGl0YWxSRSwgIi0kMSIpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHZhciBkYXRhID0gMSBpbiBhcmd1bWVudHMgPyB0aGlzLmF0dHIoYXR0ck5hbWUsIHZhbHVlKSA6IHRoaXMuYXR0cihhdHRyTmFtZSk7CiAgICAgICAgICAgIHJldHVybiBkYXRhICE9PSBudWxsID8gZGVzZXJpYWxpemVWYWx1ZShkYXRhKSA6IHVuZGVmaW5lZDsKICAgICAgICAgIH0sCiAgICAgICAgICB2YWw6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAoMCBpbiBhcmd1bWVudHMpIHsKICAgICAgICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgdmFsdWUgPSAiIjsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChpZHgpIHsKICAgICAgICAgICAgICAgIHRoaXMudmFsdWUgPSBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIHRoaXMudmFsdWUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiB0aGlzWzBdICYmICh0aGlzWzBdLm11bHRpcGxlID8gJCh0aGlzWzBdKS5maW5kKCJvcHRpb24iKS5maWx0ZXIoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0ZWQ7CiAgICAgICAgICAgICAgfSkucGx1Y2soInZhbHVlIikgOiB0aGlzWzBdLnZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIG9mZnNldDogZnVuY3Rpb24gKGNvb3JkaW5hdGVzKSB7CiAgICAgICAgICAgIGlmIChjb29yZGluYXRlcykgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaW5kZXgpIHsKICAgICAgICAgICAgICB2YXIgJHRoaXMgPSAkKHRoaXMpLAogICAgICAgICAgICAgICAgY29vcmRzID0gZnVuY0FyZyh0aGlzLCBjb29yZGluYXRlcywgaW5kZXgsICR0aGlzLm9mZnNldCgpKSwKICAgICAgICAgICAgICAgIHBhcmVudE9mZnNldCA9ICR0aGlzLm9mZnNldFBhcmVudCgpLm9mZnNldCgpLAogICAgICAgICAgICAgICAgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICAgIHRvcDogY29vcmRzLnRvcCAtIHBhcmVudE9mZnNldC50b3AsCiAgICAgICAgICAgICAgICAgIGxlZnQ6IGNvb3Jkcy5sZWZ0IC0gcGFyZW50T2Zmc2V0LmxlZnQKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgaWYgKCR0aGlzLmNzcygicG9zaXRpb24iKSA9PSAic3RhdGljIikgcHJvcHNbInBvc2l0aW9uIl0gPSAicmVsYXRpdmUiOwogICAgICAgICAgICAgICR0aGlzLmNzcyhwcm9wcyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoIXRoaXMubGVuZ3RoKSByZXR1cm4gbnVsbDsKICAgICAgICAgICAgaWYgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCAhPT0gdGhpc1swXSAmJiAhJC5jb250YWlucyhkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIHRoaXNbMF0pKSByZXR1cm4gewogICAgICAgICAgICAgIHRvcDogMCwKICAgICAgICAgICAgICBsZWZ0OiAwCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBvYmogPSB0aGlzWzBdLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGxlZnQ6IG9iai5sZWZ0ICsgd2luZG93LnBhZ2VYT2Zmc2V0LAogICAgICAgICAgICAgIHRvcDogb2JqLnRvcCArIHdpbmRvdy5wYWdlWU9mZnNldCwKICAgICAgICAgICAgICB3aWR0aDogTWF0aC5yb3VuZChvYmoud2lkdGgpLAogICAgICAgICAgICAgIGhlaWdodDogTWF0aC5yb3VuZChvYmouaGVpZ2h0KQogICAgICAgICAgICB9OwogICAgICAgICAgfSwKICAgICAgICAgIGNzczogZnVuY3Rpb24gKHByb3BlcnR5LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDIpIHsKICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXNbMF07CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm9wZXJ0eSA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgaWYgKCFlbGVtZW50KSByZXR1cm47CiAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudC5zdHlsZVtjYW1lbGl6ZShwcm9wZXJ0eSldIHx8IGdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgIiIpLmdldFByb3BlcnR5VmFsdWUocHJvcGVydHkpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShwcm9wZXJ0eSkpIHsKICAgICAgICAgICAgICAgIGlmICghZWxlbWVudCkgcmV0dXJuOwogICAgICAgICAgICAgICAgdmFyIHByb3BzID0ge307CiAgICAgICAgICAgICAgICB2YXIgY29tcHV0ZWRTdHlsZSA9IGdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgIiIpOwogICAgICAgICAgICAgICAgJC5lYWNoKHByb3BlcnR5LCBmdW5jdGlvbiAoXywgcHJvcCkgewogICAgICAgICAgICAgICAgICBwcm9wc1twcm9wXSA9IGVsZW1lbnQuc3R5bGVbY2FtZWxpemUocHJvcCldIHx8IGNvbXB1dGVkU3R5bGUuZ2V0UHJvcGVydHlWYWx1ZShwcm9wKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHByb3BzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY3NzID0gIiI7CiAgICAgICAgICAgIGlmICh0eXBlKHByb3BlcnR5KSA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgIGlmICghdmFsdWUgJiYgdmFsdWUgIT09IDApIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0eWxlLnJlbW92ZVByb3BlcnR5KGRhc2hlcml6ZShwcm9wZXJ0eSkpOwogICAgICAgICAgICAgIH0pO2Vsc2UgY3NzID0gZGFzaGVyaXplKHByb3BlcnR5KSArICI6IiArIG1heWJlQWRkUHgocHJvcGVydHksIHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBmb3IgKGtleSBpbiBwcm9wZXJ0eSkgaWYgKCFwcm9wZXJ0eVtrZXldICYmIHByb3BlcnR5W2tleV0gIT09IDApIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0eWxlLnJlbW92ZVByb3BlcnR5KGRhc2hlcml6ZShrZXkpKTsKICAgICAgICAgICAgICB9KTtlbHNlIGNzcyArPSBkYXNoZXJpemUoa2V5KSArICI6IiArIG1heWJlQWRkUHgoa2V5LCBwcm9wZXJ0eVtrZXldKSArICI7IjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB0aGlzLnN0eWxlLmNzc1RleHQgKz0gIjsiICsgY3NzOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBpbmRleDogZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQgPyB0aGlzLmluZGV4T2YoJChlbGVtZW50KVswXSkgOiB0aGlzLnBhcmVudCgpLmNoaWxkcmVuKCkuaW5kZXhPZih0aGlzWzBdKTsKICAgICAgICAgIH0sCiAgICAgICAgICBoYXNDbGFzczogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgaWYgKCFuYW1lKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHJldHVybiBlbXB0eUFycmF5LnNvbWUuY2FsbCh0aGlzLCBmdW5jdGlvbiAoZWwpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy50ZXN0KGNsYXNzTmFtZShlbCkpOwogICAgICAgICAgICB9LCBjbGFzc1JFKG5hbWUpKTsKICAgICAgICAgIH0sCiAgICAgICAgICBhZGRDbGFzczogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgaWYgKCFuYW1lKSByZXR1cm4gdGhpczsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaWR4KSB7CiAgICAgICAgICAgICAgaWYgKCEoImNsYXNzTmFtZSIgaW4gdGhpcykpIHJldHVybjsKICAgICAgICAgICAgICBjbGFzc0xpc3QgPSBbXTsKICAgICAgICAgICAgICB2YXIgY2xzID0gY2xhc3NOYW1lKHRoaXMpLAogICAgICAgICAgICAgICAgbmV3TmFtZSA9IGZ1bmNBcmcodGhpcywgbmFtZSwgaWR4LCBjbHMpOwogICAgICAgICAgICAgIG5ld05hbWUuc3BsaXQoL1xzKy9nKS5mb3JFYWNoKGZ1bmN0aW9uIChrbGFzcykgewogICAgICAgICAgICAgICAgaWYgKCEkKHRoaXMpLmhhc0NsYXNzKGtsYXNzKSkgY2xhc3NMaXN0LnB1c2goa2xhc3MpOwogICAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgICAgICAgIGNsYXNzTGlzdC5sZW5ndGggJiYgY2xhc3NOYW1lKHRoaXMsIGNscyArIChjbHMgPyAiICIgOiAiIikgKyBjbGFzc0xpc3Quam9pbigiICIpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGlkeCkgewogICAgICAgICAgICAgIGlmICghKCJjbGFzc05hbWUiIGluIHRoaXMpKSByZXR1cm47CiAgICAgICAgICAgICAgaWYgKG5hbWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGNsYXNzTmFtZSh0aGlzLCAiIik7CiAgICAgICAgICAgICAgY2xhc3NMaXN0ID0gY2xhc3NOYW1lKHRoaXMpOwogICAgICAgICAgICAgIGZ1bmNBcmcodGhpcywgbmFtZSwgaWR4LCBjbGFzc0xpc3QpLnNwbGl0KC9ccysvZykuZm9yRWFjaChmdW5jdGlvbiAoa2xhc3MpIHsKICAgICAgICAgICAgICAgIGNsYXNzTGlzdCA9IGNsYXNzTGlzdC5yZXBsYWNlKGNsYXNzUkUoa2xhc3MpLCAiICIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGNsYXNzTmFtZSh0aGlzLCBjbGFzc0xpc3QudHJpbSgpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uIChuYW1lLCB3aGVuKSB7CiAgICAgICAgICAgIGlmICghbmFtZSkgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGlkeCkgewogICAgICAgICAgICAgIHZhciAkdGhpcyA9ICQodGhpcyksCiAgICAgICAgICAgICAgICBuYW1lcyA9IGZ1bmNBcmcodGhpcywgbmFtZSwgaWR4LCBjbGFzc05hbWUodGhpcykpOwogICAgICAgICAgICAgIG5hbWVzLnNwbGl0KC9ccysvZykuZm9yRWFjaChmdW5jdGlvbiAoa2xhc3MpIHsKICAgICAgICAgICAgICAgICh3aGVuID09PSB1bmRlZmluZWQgPyAhJHRoaXMuaGFzQ2xhc3Moa2xhc3MpIDogd2hlbikgPyAkdGhpcy5hZGRDbGFzcyhrbGFzcykgOiAkdGhpcy5yZW1vdmVDbGFzcyhrbGFzcyk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKICAgICAgICAgIHNjcm9sbFRvcDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5sZW5ndGgpIHJldHVybjsKICAgICAgICAgICAgdmFyIGhhc1Njcm9sbFRvcCA9ICJzY3JvbGxUb3AiIGluIHRoaXNbMF07CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gaGFzU2Nyb2xsVG9wID8gdGhpc1swXS5zY3JvbGxUb3AgOiB0aGlzWzBdLnBhZ2VZT2Zmc2V0OwogICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGhhc1Njcm9sbFRvcCA/IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB0aGlzLnNjcm9sbFRvcCA9IHZhbHVlOwogICAgICAgICAgICB9IDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHRoaXMuc2Nyb2xsVG8odGhpcy5zY3JvbGxYLCB2YWx1ZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKICAgICAgICAgIHNjcm9sbExlZnQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAoIXRoaXMubGVuZ3RoKSByZXR1cm47CiAgICAgICAgICAgIHZhciBoYXNTY3JvbGxMZWZ0ID0gInNjcm9sbExlZnQiIGluIHRoaXNbMF07CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gaGFzU2Nyb2xsTGVmdCA/IHRoaXNbMF0uc2Nyb2xsTGVmdCA6IHRoaXNbMF0ucGFnZVhPZmZzZXQ7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goaGFzU2Nyb2xsTGVmdCA/IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB0aGlzLnNjcm9sbExlZnQgPSB2YWx1ZTsKICAgICAgICAgICAgfSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB0aGlzLnNjcm9sbFRvKHZhbHVlLCB0aGlzLnNjcm9sbFkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBwb3NpdGlvbjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoIXRoaXMubGVuZ3RoKSByZXR1cm47CiAgICAgICAgICAgIHZhciBlbGVtID0gdGhpc1swXSwKICAgICAgICAgICAgICBvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCgpLAogICAgICAgICAgICAgIG9mZnNldCA9IHRoaXMub2Zmc2V0KCksCiAgICAgICAgICAgICAgcGFyZW50T2Zmc2V0ID0gcm9vdE5vZGVSRS50ZXN0KG9mZnNldFBhcmVudFswXS5ub2RlTmFtZSkgPyB7CiAgICAgICAgICAgICAgICB0b3A6IDAsCiAgICAgICAgICAgICAgICBsZWZ0OiAwCiAgICAgICAgICAgICAgfSA6IG9mZnNldFBhcmVudC5vZmZzZXQoKTsKICAgICAgICAgICAgb2Zmc2V0LnRvcCAtPSBwYXJzZUZsb2F0KCQoZWxlbSkuY3NzKCJtYXJnaW4tdG9wIikpIHx8IDA7CiAgICAgICAgICAgIG9mZnNldC5sZWZ0IC09IHBhcnNlRmxvYXQoJChlbGVtKS5jc3MoIm1hcmdpbi1sZWZ0IikpIHx8IDA7CiAgICAgICAgICAgIHBhcmVudE9mZnNldC50b3AgKz0gcGFyc2VGbG9hdCgkKG9mZnNldFBhcmVudFswXSkuY3NzKCJib3JkZXItdG9wLXdpZHRoIikpIHx8IDA7CiAgICAgICAgICAgIHBhcmVudE9mZnNldC5sZWZ0ICs9IHBhcnNlRmxvYXQoJChvZmZzZXRQYXJlbnRbMF0pLmNzcygiYm9yZGVyLWxlZnQtd2lkdGgiKSkgfHwgMDsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICB0b3A6IG9mZnNldC50b3AgLSBwYXJlbnRPZmZzZXQudG9wLAogICAgICAgICAgICAgIGxlZnQ6IG9mZnNldC5sZWZ0IC0gcGFyZW50T2Zmc2V0LmxlZnQKICAgICAgICAgICAgfTsKICAgICAgICAgIH0sCiAgICAgICAgICBvZmZzZXRQYXJlbnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy5vZmZzZXRQYXJlbnQgfHwgZG9jdW1lbnQuYm9keTsKICAgICAgICAgICAgICB3aGlsZSAocGFyZW50ICYmICFyb290Tm9kZVJFLnRlc3QocGFyZW50Lm5vZGVOYW1lKSAmJiAkKHBhcmVudCkuY3NzKCJwb3NpdGlvbiIpID09ICJzdGF0aWMiKSBwYXJlbnQgPSBwYXJlbnQub2Zmc2V0UGFyZW50OwogICAgICAgICAgICAgIHJldHVybiBwYXJlbnQ7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgJC5mbi5kZXRhY2ggPSAkLmZuLnJlbW92ZTsKICAgICAgICBbIndpZHRoIiwgImhlaWdodCJdLmZvckVhY2goZnVuY3Rpb24gKGRpbWVuc2lvbikgewogICAgICAgICAgdmFyIGRpbWVuc2lvblByb3BlcnR5ID0gZGltZW5zaW9uLnJlcGxhY2UoLy4vLCBmdW5jdGlvbiAobSkgewogICAgICAgICAgICByZXR1cm4gbVswXS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgfSk7CiAgICAgICAgICAkLmZuW2RpbWVuc2lvbl0gPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgdmFyIG9mZnNldCwKICAgICAgICAgICAgICBlbCA9IHRoaXNbMF07CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gaXNXaW5kb3coZWwpID8gZWxbImlubmVyIiArIGRpbWVuc2lvblByb3BlcnR5XSA6IGlzRG9jdW1lbnQoZWwpID8gZWwuZG9jdW1lbnRFbGVtZW50WyJzY3JvbGwiICsgZGltZW5zaW9uUHJvcGVydHldIDogKG9mZnNldCA9IHRoaXMub2Zmc2V0KCkpICYmIG9mZnNldFtkaW1lbnNpb25dO2Vsc2UgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaWR4KSB7CiAgICAgICAgICAgICAgZWwgPSAkKHRoaXMpOwogICAgICAgICAgICAgIGVsLmNzcyhkaW1lbnNpb24sIGZ1bmNBcmcodGhpcywgdmFsdWUsIGlkeCwgZWxbZGltZW5zaW9uXSgpKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKICAgICAgICB9KTsKICAgICAgICBmdW5jdGlvbiB0cmF2ZXJzZU5vZGUobm9kZSwgZnVuKSB7CiAgICAgICAgICBmdW4obm9kZSk7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gbm9kZS5jaGlsZE5vZGVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB0cmF2ZXJzZU5vZGUobm9kZS5jaGlsZE5vZGVzW2ldLCBmdW4pOwogICAgICAgIH0KICAgICAgICBhZGphY2VuY3lPcGVyYXRvcnMuZm9yRWFjaChmdW5jdGlvbiAob3BlcmF0b3IsIG9wZXJhdG9ySW5kZXgpIHsKICAgICAgICAgIHZhciBpbnNpZGUgPSBvcGVyYXRvckluZGV4ICUgMjsKICAgICAgICAgICQuZm5bb3BlcmF0b3JdID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXJnVHlwZSwKICAgICAgICAgICAgICBub2RlcyA9ICQubWFwKGFyZ3VtZW50cywgZnVuY3Rpb24gKGFyZykgewogICAgICAgICAgICAgICAgdmFyIGFyciA9IFtdOwogICAgICAgICAgICAgICAgYXJnVHlwZSA9IHR5cGUoYXJnKTsKICAgICAgICAgICAgICAgIGlmIChhcmdUeXBlID09ICJhcnJheSIpIHsKICAgICAgICAgICAgICAgICAgYXJnLmZvckVhY2goZnVuY3Rpb24gKGVsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsLm5vZGVUeXBlICE9PSB1bmRlZmluZWQpIHJldHVybiBhcnIucHVzaChlbCk7ZWxzZSBpZiAoJC56ZXB0by5pc1ooZWwpKSByZXR1cm4gYXJyID0gYXJyLmNvbmNhdChlbC5nZXQoKSk7CiAgICAgICAgICAgICAgICAgICAgYXJyID0gYXJyLmNvbmNhdCh6ZXB0by5mcmFnbWVudChlbCkpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFycjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhcmdUeXBlID09ICJvYmplY3QiIHx8IGFyZyA9PSBudWxsID8gYXJnIDogemVwdG8uZnJhZ21lbnQoYXJnKTsKICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICBwYXJlbnQsCiAgICAgICAgICAgICAgY29weUJ5Q2xvbmUgPSB0aGlzLmxlbmd0aCA+IDE7CiAgICAgICAgICAgIGlmIChub2Rlcy5sZW5ndGggPCAxKSByZXR1cm4gdGhpczsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoXywgdGFyZ2V0KSB7CiAgICAgICAgICAgICAgcGFyZW50ID0gaW5zaWRlID8gdGFyZ2V0IDogdGFyZ2V0LnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgdGFyZ2V0ID0gb3BlcmF0b3JJbmRleCA9PSAwID8gdGFyZ2V0Lm5leHRTaWJsaW5nIDogb3BlcmF0b3JJbmRleCA9PSAxID8gdGFyZ2V0LmZpcnN0Q2hpbGQgOiBvcGVyYXRvckluZGV4ID09IDIgPyB0YXJnZXQgOiBudWxsOwogICAgICAgICAgICAgIHZhciBwYXJlbnRJbkRvY3VtZW50ID0gJC5jb250YWlucyhkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIHBhcmVudCk7CiAgICAgICAgICAgICAgbm9kZXMuZm9yRWFjaChmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICAgICAgaWYgKGNvcHlCeUNsb25lKSBub2RlID0gbm9kZS5jbG9uZU5vZGUodHJ1ZSk7ZWxzZSBpZiAoIXBhcmVudCkgcmV0dXJuICQobm9kZSkucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIHRhcmdldCk7CiAgICAgICAgICAgICAgICBpZiAocGFyZW50SW5Eb2N1bWVudCkgdHJhdmVyc2VOb2RlKG5vZGUsIGZ1bmN0aW9uIChlbCkgewogICAgICAgICAgICAgICAgICBpZiAoZWwubm9kZU5hbWUgIT0gbnVsbCAmJiBlbC5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpID09PSAiU0NSSVBUIiAmJiAoIWVsLnR5cGUgfHwgZWwudHlwZSA9PT0gInRleHQvamF2YXNjcmlwdCIpICYmICFlbC5zcmMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gZWwub3duZXJEb2N1bWVudCA/IGVsLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcgOiB3aW5kb3c7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0WyJldmFsIl0uY2FsbCh0YXJnZXQsIGVsLmlubmVySFRNTCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICAkLmZuW2luc2lkZSA/IG9wZXJhdG9yICsgIlRvIiA6ICJpbnNlcnQiICsgKG9wZXJhdG9ySW5kZXggPyAiQmVmb3JlIiA6ICJBZnRlciIpXSA9IGZ1bmN0aW9uIChodG1sKSB7CiAgICAgICAgICAgICQoaHRtbClbb3BlcmF0b3JdKHRoaXMpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH07CiAgICAgICAgfSk7CiAgICAgICAgemVwdG8uWi5wcm90b3R5cGUgPSBaLnByb3RvdHlwZSA9ICQuZm47CiAgICAgICAgemVwdG8udW5pcSA9IHVuaXE7CiAgICAgICAgemVwdG8uZGVzZXJpYWxpemVWYWx1ZSA9IGRlc2VyaWFsaXplVmFsdWU7CiAgICAgICAgJC56ZXB0byA9IHplcHRvOwogICAgICAgIHJldHVybiAkOwogICAgICB9KCk7CiAgICAgIChmdW5jdGlvbiAoJCkgewogICAgICAgIHZhciBfemlkID0gMSwKICAgICAgICAgIHVuZGVmaW5lZCwKICAgICAgICAgIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLAogICAgICAgICAgaXNGdW5jdGlvbiA9ICQuaXNGdW5jdGlvbiwKICAgICAgICAgIGlzU3RyaW5nID0gZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICByZXR1cm4gdHlwZW9mIG9iaiA9PSAic3RyaW5nIjsKICAgICAgICAgIH0sCiAgICAgICAgICBoYW5kbGVycyA9IHt9LAogICAgICAgICAgc3BlY2lhbEV2ZW50cyA9IHt9LAogICAgICAgICAgZm9jdXNpblN1cHBvcnRlZCA9ICJvbmZvY3VzaW4iIGluIHdpbmRvdywKICAgICAgICAgIGZvY3VzID0gewogICAgICAgICAgICBmb2N1czogImZvY3VzaW4iLAogICAgICAgICAgICBibHVyOiAiZm9jdXNvdXQiCiAgICAgICAgICB9LAogICAgICAgICAgaG92ZXIgPSB7CiAgICAgICAgICAgIG1vdXNlZW50ZXI6ICJtb3VzZW92ZXIiLAogICAgICAgICAgICBtb3VzZWxlYXZlOiAibW91c2VvdXQiCiAgICAgICAgICB9OwogICAgICAgIHNwZWNpYWxFdmVudHMuY2xpY2sgPSBzcGVjaWFsRXZlbnRzLm1vdXNlZG93biA9IHNwZWNpYWxFdmVudHMubW91c2V1cCA9IHNwZWNpYWxFdmVudHMubW91c2Vtb3ZlID0gIk1vdXNlRXZlbnRzIjsKICAgICAgICBmdW5jdGlvbiB6aWQoZWxlbWVudCkgewogICAgICAgICAgcmV0dXJuIGVsZW1lbnQuX3ppZCB8fCAoZWxlbWVudC5femlkID0gX3ppZCsrKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEhhbmRsZXJzKGVsZW1lbnQsIGV2ZW50LCBmbiwgc2VsZWN0b3IpIHsKICAgICAgICAgIGV2ZW50ID0gcGFyc2UoZXZlbnQpOwogICAgICAgICAgaWYgKGV2ZW50Lm5zKSB2YXIgbWF0Y2hlciA9IG1hdGNoZXJGb3IoZXZlbnQubnMpOwogICAgICAgICAgcmV0dXJuIChoYW5kbGVyc1t6aWQoZWxlbWVudCldIHx8IFtdKS5maWx0ZXIoZnVuY3Rpb24gKGhhbmRsZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGhhbmRsZXIgJiYgKCFldmVudC5lIHx8IGhhbmRsZXIuZSA9PSBldmVudC5lKSAmJiAoIWV2ZW50Lm5zIHx8IG1hdGNoZXIudGVzdChoYW5kbGVyLm5zKSkgJiYgKCFmbiB8fCB6aWQoaGFuZGxlci5mbikgPT09IHppZChmbikpICYmICghc2VsZWN0b3IgfHwgaGFuZGxlci5zZWwgPT0gc2VsZWN0b3IpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBhcnNlKGV2ZW50KSB7CiAgICAgICAgICB2YXIgcGFydHMgPSAoIiIgKyBldmVudCkuc3BsaXQoIi4iKTsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGU6IHBhcnRzWzBdLAogICAgICAgICAgICBuczogcGFydHMuc2xpY2UoMSkuc29ydCgpLmpvaW4oIiAiKQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWF0Y2hlckZvcihucykgewogICAgICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoIig/Ol58ICkiICsgbnMucmVwbGFjZSgiICIsICIgLiogPyIpICsgIig/OiB8JCkiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXZlbnRDYXB0dXJlKGhhbmRsZXIsIGNhcHR1cmVTZXR0aW5nKSB7CiAgICAgICAgICByZXR1cm4gaGFuZGxlci5kZWwgJiYgIWZvY3VzaW5TdXBwb3J0ZWQgJiYgaGFuZGxlci5lIGluIGZvY3VzIHx8ICEhY2FwdHVyZVNldHRpbmc7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlYWxFdmVudCh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gaG92ZXJbdHlwZV0gfHwgZm9jdXNpblN1cHBvcnRlZCAmJiBmb2N1c1t0eXBlXSB8fCB0eXBlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGQoZWxlbWVudCwgZXZlbnRzLCBmbiwgZGF0YSwgc2VsZWN0b3IsIGRlbGVnYXRvciwgY2FwdHVyZSkgewogICAgICAgICAgdmFyIGlkID0gemlkKGVsZW1lbnQpLAogICAgICAgICAgICBzZXQgPSBoYW5kbGVyc1tpZF0gfHwgKGhhbmRsZXJzW2lkXSA9IFtdKTsKICAgICAgICAgIGV2ZW50cy5zcGxpdCgvXHMvKS5mb3JFYWNoKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICBpZiAoZXZlbnQgPT0gInJlYWR5IikgcmV0dXJuICQoZG9jdW1lbnQpLnJlYWR5KGZuKTsKICAgICAgICAgICAgdmFyIGhhbmRsZXIgPSBwYXJzZShldmVudCk7CiAgICAgICAgICAgIGhhbmRsZXIuZm4gPSBmbjsKICAgICAgICAgICAgaGFuZGxlci5zZWwgPSBzZWxlY3RvcjsKICAgICAgICAgICAgaWYgKGhhbmRsZXIuZSBpbiBob3ZlcikgZm4gPSBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgIHZhciByZWxhdGVkID0gZS5yZWxhdGVkVGFyZ2V0OwogICAgICAgICAgICAgIGlmICghcmVsYXRlZCB8fCByZWxhdGVkICE9PSB0aGlzICYmICEkLmNvbnRhaW5zKHRoaXMsIHJlbGF0ZWQpKSByZXR1cm4gaGFuZGxlci5mbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9OwogICAgICAgICAgICBoYW5kbGVyLmRlbCA9IGRlbGVnYXRvcjsKICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gZGVsZWdhdG9yIHx8IGZuOwogICAgICAgICAgICBoYW5kbGVyLnByb3h5ID0gZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICBlID0gY29tcGF0aWJsZShlKTsKICAgICAgICAgICAgICBpZiAoZS5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpKSByZXR1cm47CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHZhciBkYXRhUHJvcERlc2NyaXB0b3IgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsICJkYXRhIik7CiAgICAgICAgICAgICAgICBpZiAoIWRhdGFQcm9wRGVzY3JpcHRvciB8fCBkYXRhUHJvcERlc2NyaXB0b3Iud3JpdGFibGUpIGUuZGF0YSA9IGRhdGE7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gY2FsbGJhY2suYXBwbHkoZWxlbWVudCwgZS5fYXJncyA9PSB1bmRlZmluZWQgPyBbZV0gOiBbZV0uY29uY2F0KGUuX2FyZ3MpKTsKICAgICAgICAgICAgICBpZiAocmVzdWx0ID09PSBmYWxzZSkgZS5wcmV2ZW50RGVmYXVsdCgpLCBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGhhbmRsZXIuaSA9IHNldC5sZW5ndGg7CiAgICAgICAgICAgIHNldC5wdXNoKGhhbmRsZXIpOwogICAgICAgICAgICBpZiAoImFkZEV2ZW50TGlzdGVuZXIiIGluIGVsZW1lbnQpIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihyZWFsRXZlbnQoaGFuZGxlci5lKSwgaGFuZGxlci5wcm94eSwgZXZlbnRDYXB0dXJlKGhhbmRsZXIsIGNhcHR1cmUpKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW1vdmUoZWxlbWVudCwgZXZlbnRzLCBmbiwgc2VsZWN0b3IsIGNhcHR1cmUpIHsKICAgICAgICAgIHZhciBpZCA9IHppZChlbGVtZW50KTsKICAgICAgICAgIChldmVudHMgfHwgIiIpLnNwbGl0KC9ccy8pLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIGZpbmRIYW5kbGVycyhlbGVtZW50LCBldmVudCwgZm4sIHNlbGVjdG9yKS5mb3JFYWNoKGZ1bmN0aW9uIChoYW5kbGVyKSB7CiAgICAgICAgICAgICAgZGVsZXRlIGhhbmRsZXJzW2lkXVtoYW5kbGVyLmldOwogICAgICAgICAgICAgIGlmICgicmVtb3ZlRXZlbnRMaXN0ZW5lciIgaW4gZWxlbWVudCkgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKHJlYWxFdmVudChoYW5kbGVyLmUpLCBoYW5kbGVyLnByb3h5LCBldmVudENhcHR1cmUoaGFuZGxlciwgY2FwdHVyZSkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICAkLmV2ZW50ID0gewogICAgICAgICAgYWRkOiBhZGQsCiAgICAgICAgICByZW1vdmU6IHJlbW92ZQogICAgICAgIH07CiAgICAgICAgJC5wcm94eSA9IGZ1bmN0aW9uIChmbiwgY29udGV4dCkgewogICAgICAgICAgdmFyIGFyZ3MgPSAyIGluIGFyZ3VtZW50cyAmJiBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICAgICAgICBpZiAoaXNGdW5jdGlvbihmbikpIHsKICAgICAgICAgICAgdmFyIHByb3h5Rm4gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZuLmFwcGx5KGNvbnRleHQsIGFyZ3MgPyBhcmdzLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpIDogYXJndW1lbnRzKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcHJveHlGbi5femlkID0gemlkKGZuKTsKICAgICAgICAgICAgcmV0dXJuIHByb3h5Rm47CiAgICAgICAgICB9IGVsc2UgaWYgKGlzU3RyaW5nKGNvbnRleHQpKSB7CiAgICAgICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICAgICAgYXJncy51bnNoaWZ0KGZuW2NvbnRleHRdLCBmbik7CiAgICAgICAgICAgICAgcmV0dXJuICQucHJveHkuYXBwbHkobnVsbCwgYXJncyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuICQucHJveHkoZm5bY29udGV4dF0sIGZuKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiZXhwZWN0ZWQgZnVuY3Rpb24iKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgICQuZm4uYmluZCA9IGZ1bmN0aW9uIChldmVudCwgZGF0YSwgY2FsbGJhY2spIHsKICAgICAgICAgIHJldHVybiB0aGlzLm9uKGV2ZW50LCBkYXRhLCBjYWxsYmFjayk7CiAgICAgICAgfTsKICAgICAgICAkLmZuLnVuYmluZCA9IGZ1bmN0aW9uIChldmVudCwgY2FsbGJhY2spIHsKICAgICAgICAgIHJldHVybiB0aGlzLm9mZihldmVudCwgY2FsbGJhY2spOwogICAgICAgIH07CiAgICAgICAgJC5mbi5vbmUgPSBmdW5jdGlvbiAoZXZlbnQsIHNlbGVjdG9yLCBkYXRhLCBjYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIHRoaXMub24oZXZlbnQsIHNlbGVjdG9yLCBkYXRhLCBjYWxsYmFjaywgMSk7CiAgICAgICAgfTsKICAgICAgICB2YXIgcmV0dXJuVHJ1ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9LAogICAgICAgICAgcmV0dXJuRmFsc2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0sCiAgICAgICAgICBpZ25vcmVQcm9wZXJ0aWVzID0gL14oW0EtWl18cmV0dXJuVmFsdWUkfGxheWVyW1hZXSR8d2Via2l0TW92ZW1lbnRbWFldJCkvLAogICAgICAgICAgZXZlbnRNZXRob2RzID0gewogICAgICAgICAgICBwcmV2ZW50RGVmYXVsdDogImlzRGVmYXVsdFByZXZlbnRlZCIsCiAgICAgICAgICAgIHN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbjogImlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkIiwKICAgICAgICAgICAgc3RvcFByb3BhZ2F0aW9uOiAiaXNQcm9wYWdhdGlvblN0b3BwZWQiCiAgICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNvbXBhdGlibGUoZXZlbnQsIHNvdXJjZSkgewogICAgICAgICAgaWYgKHNvdXJjZSB8fCAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgIHNvdXJjZSB8fCAoc291cmNlID0gZXZlbnQpOwogICAgICAgICAgICAkLmVhY2goZXZlbnRNZXRob2RzLCBmdW5jdGlvbiAobmFtZSwgcHJlZGljYXRlKSB7CiAgICAgICAgICAgICAgdmFyIHNvdXJjZU1ldGhvZCA9IHNvdXJjZVtuYW1lXTsKICAgICAgICAgICAgICBldmVudFtuYW1lXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXNbcHJlZGljYXRlXSA9IHJldHVyblRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gc291cmNlTWV0aG9kICYmIHNvdXJjZU1ldGhvZC5hcHBseShzb3VyY2UsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBldmVudFtwcmVkaWNhdGVdID0gcmV0dXJuRmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBldmVudC50aW1lU3RhbXAgfHwgKGV2ZW50LnRpbWVTdGFtcCA9IERhdGUubm93KCkpOwogICAgICAgICAgICBpZiAoc291cmNlLmRlZmF1bHRQcmV2ZW50ZWQgIT09IHVuZGVmaW5lZCA/IHNvdXJjZS5kZWZhdWx0UHJldmVudGVkIDogInJldHVyblZhbHVlIiBpbiBzb3VyY2UgPyBzb3VyY2UucmV0dXJuVmFsdWUgPT09IGZhbHNlIDogc291cmNlLmdldFByZXZlbnREZWZhdWx0ICYmIHNvdXJjZS5nZXRQcmV2ZW50RGVmYXVsdCgpKSBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQgPSByZXR1cm5UcnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVQcm94eShldmVudCkgewogICAgICAgICAgdmFyIGtleSwKICAgICAgICAgICAgcHJveHkgPSB7CiAgICAgICAgICAgICAgb3JpZ2luYWxFdmVudDogZXZlbnQKICAgICAgICAgICAgfTsKICAgICAgICAgIGZvciAoa2V5IGluIGV2ZW50KSBpZiAoIWlnbm9yZVByb3BlcnRpZXMudGVzdChrZXkpICYmIGV2ZW50W2tleV0gIT09IHVuZGVmaW5lZCkgcHJveHlba2V5XSA9IGV2ZW50W2tleV07CiAgICAgICAgICByZXR1cm4gY29tcGF0aWJsZShwcm94eSwgZXZlbnQpOwogICAgICAgIH0KICAgICAgICAkLmZuLmRlbGVnYXRlID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spIHsKICAgICAgICAgIHJldHVybiB0aGlzLm9uKGV2ZW50LCBzZWxlY3RvciwgY2FsbGJhY2spOwogICAgICAgIH07CiAgICAgICAgJC5mbi51bmRlbGVnYXRlID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spIHsKICAgICAgICAgIHJldHVybiB0aGlzLm9mZihldmVudCwgc2VsZWN0b3IsIGNhbGxiYWNrKTsKICAgICAgICB9OwogICAgICAgICQuZm4ubGl2ZSA9IGZ1bmN0aW9uIChldmVudCwgY2FsbGJhY2spIHsKICAgICAgICAgICQoZG9jdW1lbnQuYm9keSkuZGVsZWdhdGUodGhpcy5zZWxlY3RvciwgZXZlbnQsIGNhbGxiYWNrKTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgJC5mbi5kaWUgPSBmdW5jdGlvbiAoZXZlbnQsIGNhbGxiYWNrKSB7CiAgICAgICAgICAkKGRvY3VtZW50LmJvZHkpLnVuZGVsZWdhdGUodGhpcy5zZWxlY3RvciwgZXZlbnQsIGNhbGxiYWNrKTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgJC5mbi5vbiA9IGZ1bmN0aW9uIChldmVudCwgc2VsZWN0b3IsIGRhdGEsIGNhbGxiYWNrLCBvbmUpIHsKICAgICAgICAgIHZhciBhdXRvUmVtb3ZlLAogICAgICAgICAgICBkZWxlZ2F0b3IsCiAgICAgICAgICAgICR0aGlzID0gdGhpczsKICAgICAgICAgIGlmIChldmVudCAmJiAhaXNTdHJpbmcoZXZlbnQpKSB7CiAgICAgICAgICAgICQuZWFjaChldmVudCwgZnVuY3Rpb24gKHR5cGUsIGZuKSB7CiAgICAgICAgICAgICAgJHRoaXMub24odHlwZSwgc2VsZWN0b3IsIGRhdGEsIGZuLCBvbmUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuICR0aGlzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc1N0cmluZyhzZWxlY3RvcikgJiYgIWlzRnVuY3Rpb24oY2FsbGJhY2spICYmIGNhbGxiYWNrICE9PSBmYWxzZSkgY2FsbGJhY2sgPSBkYXRhLCBkYXRhID0gc2VsZWN0b3IsIHNlbGVjdG9yID0gdW5kZWZpbmVkOwogICAgICAgICAgaWYgKGNhbGxiYWNrID09PSB1bmRlZmluZWQgfHwgZGF0YSA9PT0gZmFsc2UpIGNhbGxiYWNrID0gZGF0YSwgZGF0YSA9IHVuZGVmaW5lZDsKICAgICAgICAgIGlmIChjYWxsYmFjayA9PT0gZmFsc2UpIGNhbGxiYWNrID0gcmV0dXJuRmFsc2U7CiAgICAgICAgICByZXR1cm4gJHRoaXMuZWFjaChmdW5jdGlvbiAoXywgZWxlbWVudCkgewogICAgICAgICAgICBpZiAob25lKSBhdXRvUmVtb3ZlID0gZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICByZW1vdmUoZWxlbWVudCwgZS50eXBlLCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChzZWxlY3RvcikgZGVsZWdhdG9yID0gZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICB2YXIgZXZ0LAogICAgICAgICAgICAgICAgbWF0Y2ggPSAkKGUudGFyZ2V0KS5jbG9zZXN0KHNlbGVjdG9yLCBlbGVtZW50KS5nZXQoMCk7CiAgICAgICAgICAgICAgaWYgKG1hdGNoICYmIG1hdGNoICE9PSBlbGVtZW50KSB7CiAgICAgICAgICAgICAgICBldnQgPSAkLmV4dGVuZChjcmVhdGVQcm94eShlKSwgewogICAgICAgICAgICAgICAgICBjdXJyZW50VGFyZ2V0OiBtYXRjaCwKICAgICAgICAgICAgICAgICAgbGl2ZUZpcmVkOiBlbGVtZW50CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiAoYXV0b1JlbW92ZSB8fCBjYWxsYmFjaykuYXBwbHkobWF0Y2gsIFtldnRdLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGFkZChlbGVtZW50LCBldmVudCwgY2FsbGJhY2ssIGRhdGEsIHNlbGVjdG9yLCBkZWxlZ2F0b3IgfHwgYXV0b1JlbW92ZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgICQuZm4ub2ZmID0gZnVuY3Rpb24gKGV2ZW50LCBzZWxlY3RvciwgY2FsbGJhY2spIHsKICAgICAgICAgIHZhciAkdGhpcyA9IHRoaXM7CiAgICAgICAgICBpZiAoZXZlbnQgJiYgIWlzU3RyaW5nKGV2ZW50KSkgewogICAgICAgICAgICAkLmVhY2goZXZlbnQsIGZ1bmN0aW9uICh0eXBlLCBmbikgewogICAgICAgICAgICAgICR0aGlzLm9mZih0eXBlLCBzZWxlY3RvciwgZm4pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuICR0aGlzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc1N0cmluZyhzZWxlY3RvcikgJiYgIWlzRnVuY3Rpb24oY2FsbGJhY2spICYmIGNhbGxiYWNrICE9PSBmYWxzZSkgY2FsbGJhY2sgPSBzZWxlY3Rvciwgc2VsZWN0b3IgPSB1bmRlZmluZWQ7CiAgICAgICAgICBpZiAoY2FsbGJhY2sgPT09IGZhbHNlKSBjYWxsYmFjayA9IHJldHVybkZhbHNlOwogICAgICAgICAgcmV0dXJuICR0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZW1vdmUodGhpcywgZXZlbnQsIGNhbGxiYWNrLCBzZWxlY3Rvcik7CiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgICQuZm4udHJpZ2dlciA9IGZ1bmN0aW9uIChldmVudCwgYXJncykgewogICAgICAgICAgZXZlbnQgPSBpc1N0cmluZyhldmVudCkgfHwgJC5pc1BsYWluT2JqZWN0KGV2ZW50KSA/ICQuRXZlbnQoZXZlbnQpIDogY29tcGF0aWJsZShldmVudCk7CiAgICAgICAgICBldmVudC5fYXJncyA9IGFyZ3M7CiAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgaW4gZm9jdXMgJiYgdHlwZW9mIHRoaXNbZXZlbnQudHlwZV0gPT0gImZ1bmN0aW9uIikgdGhpc1tldmVudC50eXBlXSgpO2Vsc2UgaWYgKCJkaXNwYXRjaEV2ZW50IiBpbiB0aGlzKSB0aGlzLmRpc3BhdGNoRXZlbnQoZXZlbnQpO2Vsc2UgJCh0aGlzKS50cmlnZ2VySGFuZGxlcihldmVudCwgYXJncyk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgICQuZm4udHJpZ2dlckhhbmRsZXIgPSBmdW5jdGlvbiAoZXZlbnQsIGFyZ3MpIHsKICAgICAgICAgIHZhciBlLCByZXN1bHQ7CiAgICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24gKGksIGVsZW1lbnQpIHsKICAgICAgICAgICAgZSA9IGNyZWF0ZVByb3h5KGlzU3RyaW5nKGV2ZW50KSA/ICQuRXZlbnQoZXZlbnQpIDogZXZlbnQpOwogICAgICAgICAgICBlLl9hcmdzID0gYXJnczsKICAgICAgICAgICAgZS50YXJnZXQgPSBlbGVtZW50OwogICAgICAgICAgICAkLmVhY2goZmluZEhhbmRsZXJzKGVsZW1lbnQsIGV2ZW50LnR5cGUgfHwgZXZlbnQpLCBmdW5jdGlvbiAoaSwgaGFuZGxlcikgewogICAgICAgICAgICAgIHJlc3VsdCA9IGhhbmRsZXIucHJveHkoZSk7CiAgICAgICAgICAgICAgaWYgKGUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9OwogICAgICAgICgiZm9jdXNpbiBmb2N1c291dCBmb2N1cyBibHVyIGxvYWQgcmVzaXplIHNjcm9sbCB1bmxvYWQgY2xpY2sgZGJsY2xpY2sgIiArICJtb3VzZWRvd24gbW91c2V1cCBtb3VzZW1vdmUgbW91c2VvdmVyIG1vdXNlb3V0IG1vdXNlZW50ZXIgbW91c2VsZWF2ZSAiICsgImNoYW5nZSBzZWxlY3Qga2V5ZG93biBrZXlwcmVzcyBrZXl1cCBlcnJvciIpLnNwbGl0KCIgIikuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICQuZm5bZXZlbnRdID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHJldHVybiAwIGluIGFyZ3VtZW50cyA/IHRoaXMuYmluZChldmVudCwgY2FsbGJhY2spIDogdGhpcy50cmlnZ2VyKGV2ZW50KTsKICAgICAgICAgIH07CiAgICAgICAgfSk7CiAgICAgICAgJC5FdmVudCA9IGZ1bmN0aW9uICh0eXBlLCBwcm9wcykgewogICAgICAgICAgaWYgKCFpc1N0cmluZyh0eXBlKSkgcHJvcHMgPSB0eXBlLCB0eXBlID0gcHJvcHMudHlwZTsKICAgICAgICAgIHZhciBldmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KHNwZWNpYWxFdmVudHNbdHlwZV0gfHwgIkV2ZW50cyIpLAogICAgICAgICAgICBidWJibGVzID0gdHJ1ZTsKICAgICAgICAgIGlmIChwcm9wcykgZm9yICh2YXIgbmFtZSBpbiBwcm9wcykgbmFtZSA9PSAiYnViYmxlcyIgPyBidWJibGVzID0gISFwcm9wc1tuYW1lXSA6IGV2ZW50W25hbWVdID0gcHJvcHNbbmFtZV07CiAgICAgICAgICBldmVudC5pbml0RXZlbnQodHlwZSwgYnViYmxlcywgdHJ1ZSk7CiAgICAgICAgICByZXR1cm4gY29tcGF0aWJsZShldmVudCk7CiAgICAgICAgfTsKICAgICAgfSkoWmVwdG8pOwogICAgICAoZnVuY3Rpb24gKCQpIHsKICAgICAgICB2YXIgY2FjaGUgPSBbXSwKICAgICAgICAgIHRpbWVvdXQ7CiAgICAgICAgJC5mbi5yZW1vdmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgIGlmICh0aGlzLnRhZ05hbWUgPT09ICJJTUciKSB7CiAgICAgICAgICAgICAgICBjYWNoZS5wdXNoKHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5zcmMgPSAiZGF0YTppbWFnZS9naWY7YmFzZTY0LFIwbEdPRGxoQVFBQkFBRC9BQ3dBQUFBQUFRQUJBQUFDQURzPSI7CiAgICAgICAgICAgICAgICBpZiAodGltZW91dCkgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICAgICAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICBjYWNoZSA9IFtdOwogICAgICAgICAgICAgICAgfSwgNmU0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICB9KShaZXB0byk7CiAgICAgIChmdW5jdGlvbiAoJCkgewogICAgICAgIHZhciBkYXRhID0ge30sCiAgICAgICAgICBkYXRhQXR0ciA9ICQuZm4uZGF0YSwKICAgICAgICAgIGNhbWVsaXplID0gJC5jYW1lbENhc2UsCiAgICAgICAgICBleHAgPSAkLmV4cGFuZG8gPSAiWmVwdG8iICsgK25ldyBEYXRlKCksCiAgICAgICAgICBlbXB0eUFycmF5ID0gW107CiAgICAgICAgZnVuY3Rpb24gZ2V0RGF0YShub2RlLCBuYW1lKSB7CiAgICAgICAgICB2YXIgaWQgPSBub2RlW2V4cF0sCiAgICAgICAgICAgIHN0b3JlID0gaWQgJiYgZGF0YVtpZF07CiAgICAgICAgICBpZiAobmFtZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gc3RvcmUgfHwgc2V0RGF0YShub2RlKTtlbHNlIHsKICAgICAgICAgICAgaWYgKHN0b3JlKSB7CiAgICAgICAgICAgICAgaWYgKG5hbWUgaW4gc3RvcmUpIHJldHVybiBzdG9yZVtuYW1lXTsKICAgICAgICAgICAgICB2YXIgY2FtZWxOYW1lID0gY2FtZWxpemUobmFtZSk7CiAgICAgICAgICAgICAgaWYgKGNhbWVsTmFtZSBpbiBzdG9yZSkgcmV0dXJuIHN0b3JlW2NhbWVsTmFtZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRhdGFBdHRyLmNhbGwoJChub2RlKSwgbmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldERhdGEobm9kZSwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgIHZhciBpZCA9IG5vZGVbZXhwXSB8fCAobm9kZVtleHBdID0gKyskLnV1aWQpLAogICAgICAgICAgICBzdG9yZSA9IGRhdGFbaWRdIHx8IChkYXRhW2lkXSA9IGF0dHJpYnV0ZURhdGEobm9kZSkpOwogICAgICAgICAgaWYgKG5hbWUgIT09IHVuZGVmaW5lZCkgc3RvcmVbY2FtZWxpemUobmFtZSldID0gdmFsdWU7CiAgICAgICAgICByZXR1cm4gc3RvcmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dHJpYnV0ZURhdGEobm9kZSkgewogICAgICAgICAgdmFyIHN0b3JlID0ge307CiAgICAgICAgICAkLmVhY2gobm9kZS5hdHRyaWJ1dGVzIHx8IGVtcHR5QXJyYXksIGZ1bmN0aW9uIChpLCBhdHRyKSB7CiAgICAgICAgICAgIGlmIChhdHRyLm5hbWUuaW5kZXhPZigiZGF0YS0iKSA9PSAwKSBzdG9yZVtjYW1lbGl6ZShhdHRyLm5hbWUucmVwbGFjZSgiZGF0YS0iLCAiIikpXSA9ICQuemVwdG8uZGVzZXJpYWxpemVWYWx1ZShhdHRyLnZhbHVlKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIHN0b3JlOwogICAgICAgIH0KICAgICAgICAkLmZuLmRhdGEgPSBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gdW5kZWZpbmVkID8gJC5pc1BsYWluT2JqZWN0KG5hbWUpID8gdGhpcy5lYWNoKGZ1bmN0aW9uIChpLCBub2RlKSB7CiAgICAgICAgICAgICQuZWFjaChuYW1lLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAgIHNldERhdGEobm9kZSwga2V5LCB2YWx1ZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSkgOiAwIGluIHRoaXMgPyBnZXREYXRhKHRoaXNbMF0sIG5hbWUpIDogdW5kZWZpbmVkIDogdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2V0RGF0YSh0aGlzLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgICQuZGF0YSA9IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgcmV0dXJuICQoZWxlbSkuZGF0YShuYW1lLCB2YWx1ZSk7CiAgICAgICAgfTsKICAgICAgICAkLmhhc0RhdGEgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgdmFyIGlkID0gZWxlbVtleHBdLAogICAgICAgICAgICBzdG9yZSA9IGlkICYmIGRhdGFbaWRdOwogICAgICAgICAgcmV0dXJuIHN0b3JlID8gISQuaXNFbXB0eU9iamVjdChzdG9yZSkgOiBmYWxzZTsKICAgICAgICB9OwogICAgICAgICQuZm4ucmVtb3ZlRGF0YSA9IGZ1bmN0aW9uIChuYW1lcykgewogICAgICAgICAgaWYgKHR5cGVvZiBuYW1lcyA9PSAic3RyaW5nIikgbmFtZXMgPSBuYW1lcy5zcGxpdCgvXHMrLyk7CiAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGlkID0gdGhpc1tleHBdLAogICAgICAgICAgICAgIHN0b3JlID0gaWQgJiYgZGF0YVtpZF07CiAgICAgICAgICAgIGlmIChzdG9yZSkgJC5lYWNoKG5hbWVzIHx8IHN0b3JlLCBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgICAgZGVsZXRlIHN0b3JlW25hbWVzID8gY2FtZWxpemUodGhpcykgOiBrZXldOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgWyJyZW1vdmUiLCAiZW1wdHkiXS5mb3JFYWNoKGZ1bmN0aW9uIChtZXRob2ROYW1lKSB7CiAgICAgICAgICB2YXIgb3JpZ0ZuID0gJC5mblttZXRob2ROYW1lXTsKICAgICAgICAgICQuZm5bbWV0aG9kTmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50cyA9IHRoaXMuZmluZCgiKiIpOwogICAgICAgICAgICBpZiAobWV0aG9kTmFtZSA9PT0gInJlbW92ZSIpIGVsZW1lbnRzID0gZWxlbWVudHMuYWRkKHRoaXMpOwogICAgICAgICAgICBlbGVtZW50cy5yZW1vdmVEYXRhKCk7CiAgICAgICAgICAgIHJldHVybiBvcmlnRm4uY2FsbCh0aGlzKTsKICAgICAgICAgIH07CiAgICAgICAgfSk7CiAgICAgIH0pKFplcHRvKTsKICAgICAgcmV0dXJuIFplcHRvOwogICAgfSk7CiAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgInVzZSBzdHJpY3QiOwoKICAgIHZhciBuYW1lc3BhY2UgPSAiYXV0b2NvbXBsZXRlOiI7CiAgICB2YXIgXyA9IF9fd2VicGFja19yZXF1aXJlX18oMCk7CiAgICB2YXIgRE9NID0gX193ZWJwYWNrX3JlcXVpcmVfXygxKTsKICAgIGZ1bmN0aW9uIEV2ZW50QnVzKG8pIHsKICAgICAgaWYgKCFvIHx8ICFvLmVsKSB7CiAgICAgICAgXy5lcnJvcigiRXZlbnRCdXMgaW5pdGlhbGl6ZWQgd2l0aG91dCBlbCIpOwogICAgICB9CiAgICAgIHRoaXMuJGVsID0gRE9NLmVsZW1lbnQoby5lbCk7CiAgICB9CiAgICBfLm1peGluKEV2ZW50QnVzLnByb3RvdHlwZSwgewogICAgICB0cmlnZ2VyOiBmdW5jdGlvbiAodHlwZSwgc3VnZ2VzdGlvbiwgZGF0YXNldCwgY29udGV4dCkgewogICAgICAgIHZhciBldmVudCA9IF8uRXZlbnQobmFtZXNwYWNlICsgdHlwZSk7CiAgICAgICAgdGhpcy4kZWwudHJpZ2dlcihldmVudCwgW3N1Z2dlc3Rpb24sIGRhdGFzZXQsIGNvbnRleHRdKTsKICAgICAgICByZXR1cm4gZXZlbnQ7CiAgICAgIH0KICAgIH0pOwogICAgbW9kdWxlLmV4cG9ydHMgPSBFdmVudEJ1czsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIHdyYXBwZXI6ICc8c3BhbiBjbGFzcz0iJVJPT1QlIj48L3NwYW4+JywKICAgICAgZHJvcGRvd246ICc8c3BhbiBjbGFzcz0iJVBSRUZJWCUlRFJPUERPV05fTUVOVSUiPjwvc3Bhbj4nLAogICAgICBkYXRhc2V0OiAnPGRpdiBjbGFzcz0iJVBSRUZJWCUlREFUQVNFVCUtJUNMQVNTJSI+PC9kaXY+JywKICAgICAgc3VnZ2VzdGlvbnM6ICc8c3BhbiBjbGFzcz0iJVBSRUZJWCUlU1VHR0VTVElPTlMlIj48L3NwYW4+JywKICAgICAgc3VnZ2VzdGlvbjogJzxkaXYgY2xhc3M9IiVQUkVGSVglJVNVR0dFU1RJT04lIj48L2Rpdj4nCiAgICB9OwogIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gIjAuMzYuMCI7CiAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgInVzZSBzdHJpY3QiOwoKICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gcGFyc2VBbGdvbGlhQ2xpZW50VmVyc2lvbihhZ2VudCkgewogICAgICB2YXIgcGFyc2VkID0gYWdlbnQubWF0Y2goL0FsZ29saWEgZm9yIHZhbmlsbGEgSmF2YVNjcmlwdCAoXGQrXC4pKFxkK1wuKShcZCspLyk7CiAgICAgIGlmIChwYXJzZWQpIHJldHVybiBbcGFyc2VkWzFdLCBwYXJzZWRbMl0sIHBhcnNlZFszXV07CiAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9OwogIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICAgIHZhbHVlOiB0cnVlCiAgICB9KTsKICAgIHZhciBfemVwdG8gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDE1KTsKICAgIHZhciBfemVwdG8yID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfemVwdG8pOwogICAgZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsKICAgICAgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsKICAgICAgICBkZWZhdWx0OiBvYmoKICAgICAgfTsKICAgIH0KICAgIGV4cG9ydHMuZGVmYXVsdCA9IF96ZXB0bzIuZGVmYXVsdDsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgICB2YWx1ZTogdHJ1ZQogICAgfSk7CiAgICBleHBvcnRzLmRlZmF1bHQgPSAiMi42LjMiOwogIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICB2YXIgX21haW4gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIzKTsKICAgIHZhciBfbWFpbjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9tYWluKTsKICAgIGZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7CiAgICAgIHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7CiAgICAgICAgZGVmYXVsdDogb2JqCiAgICAgIH07CiAgICB9CiAgICBtb2R1bGUuZXhwb3J0cyA9IF9tYWluMi5kZWZhdWx0OwogIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICAgIHZhbHVlOiB0cnVlCiAgICB9KTsKICAgIHZhciBfdG9GYWN0b3J5ID0gX193ZWJwYWNrX3JlcXVpcmVfXygyNCk7CiAgICB2YXIgX3RvRmFjdG9yeTIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF90b0ZhY3RvcnkpOwogICAgdmFyIF9Eb2NTZWFyY2ggPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDI1KTsKICAgIHZhciBfRG9jU2VhcmNoMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX0RvY1NlYXJjaCk7CiAgICB2YXIgX3ZlcnNpb24gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIxKTsKICAgIHZhciBfdmVyc2lvbjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF92ZXJzaW9uKTsKICAgIGZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7CiAgICAgIHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7CiAgICAgICAgZGVmYXVsdDogb2JqCiAgICAgIH07CiAgICB9CiAgICB2YXIgZG9jc2VhcmNoID0gKDAsIF90b0ZhY3RvcnkyLmRlZmF1bHQpKF9Eb2NTZWFyY2gyLmRlZmF1bHQpOwogICAgZG9jc2VhcmNoLnZlcnNpb24gPSBfdmVyc2lvbjIuZGVmYXVsdDsKICAgIGV4cG9ydHMuZGVmYXVsdCA9IGRvY3NlYXJjaDsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgdmFyIF9iaW5kID0gRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQ7CiAgICBmdW5jdGlvbiB0b0ZhY3RvcnkoQ2xhc3MpIHsKICAgICAgdmFyIEZhY3RvcnkgPSBmdW5jdGlvbiBGYWN0b3J5KCkgewogICAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gQXJyYXkoX2xlbiksIF9rZXkgPSAwOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IChfYmluZC5hcHBseShDbGFzcywgW251bGxdLmNvbmNhdChhcmdzKSkpKCk7CiAgICAgIH07CiAgICAgIEZhY3RvcnkuX19wcm90b19fID0gQ2xhc3M7CiAgICAgIEZhY3RvcnkucHJvdG90eXBlID0gQ2xhc3MucHJvdG90eXBlOwogICAgICByZXR1cm4gRmFjdG9yeTsKICAgIH0KICAgIG1vZHVsZS5leHBvcnRzID0gdG9GYWN0b3J5OwogIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICAgIHZhbHVlOiB0cnVlCiAgICB9KTsKICAgIHZhciBfZXh0ZW5kcyA9IE9iamVjdC5hc3NpZ24gfHwgZnVuY3Rpb24gKHRhcmdldCkgewogICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBzb3VyY2UgPSBhcmd1bWVudHNbaV07CiAgICAgICAgZm9yICh2YXIga2V5IGluIHNvdXJjZSkgewogICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzb3VyY2UsIGtleSkpIHsKICAgICAgICAgICAgdGFyZ2V0W2tleV0gPSBzb3VyY2Vba2V5XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH07CiAgICB2YXIgX2NyZWF0ZUNsYXNzID0gZnVuY3Rpb24gKCkgewogICAgICBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOwogICAgICAgICAgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOwogICAgICAgICAgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOwogICAgICAgICAgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7CiAgICAgICAgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsKICAgICAgICBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsKICAgICAgICByZXR1cm4gQ29uc3RydWN0b3I7CiAgICAgIH07CiAgICB9KCk7CiAgICB2YXIgX2hvZ2FuID0gX193ZWJwYWNrX3JlcXVpcmVfXygyNik7CiAgICB2YXIgX2hvZ2FuMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX2hvZ2FuKTsKICAgIHZhciBfbGl0ZSA9IF9fd2VicGFja19yZXF1aXJlX18oMjkpOwogICAgdmFyIF9saXRlMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX2xpdGUpOwogICAgdmFyIF9hdXRvY29tcGxldGUgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQ5KTsKICAgIHZhciBfYXV0b2NvbXBsZXRlMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX2F1dG9jb21wbGV0ZSk7CiAgICB2YXIgX3RlbXBsYXRlcyA9IF9fd2VicGFja19yZXF1aXJlX18oNjQpOwogICAgdmFyIF90ZW1wbGF0ZXMyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfdGVtcGxhdGVzKTsKICAgIHZhciBfdXRpbHMgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDY1KTsKICAgIHZhciBfdXRpbHMyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfdXRpbHMpOwogICAgdmFyIF92ZXJzaW9uID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMSk7CiAgICB2YXIgX3ZlcnNpb24yID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfdmVyc2lvbik7CiAgICB2YXIgX3plcHRvID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMCk7CiAgICB2YXIgX3plcHRvMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3plcHRvKTsKICAgIGZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7CiAgICAgIHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7CiAgICAgICAgZGVmYXVsdDogb2JqCiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7CiAgICAgIGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7CiAgICAgIH0KICAgIH0KICAgIHZhciB1c2FnZSA9ICJVc2FnZTpcbiAgZG9jdW1lbnRhdGlvblNlYXJjaCh7XG4gIGFwaUtleSxcbiAgaW5kZXhOYW1lLFxuICBpbnB1dFNlbGVjdG9yLFxuICBbIGFwcElkIF0sXG4gIFsgYWxnb2xpYU9wdGlvbnMue2hpdHNQZXJQYWdlfSBdXG4gIFsgYXV0b2NvbXBsZXRlT3B0aW9ucy57aGludCxkZWJ1Z30gXVxufSkiOwogICAgdmFyIERvY1NlYXJjaCA9IGZ1bmN0aW9uICgpIHsKICAgICAgZnVuY3Rpb24gRG9jU2VhcmNoKF9yZWYpIHsKICAgICAgICB2YXIgYXBpS2V5ID0gX3JlZi5hcGlLZXksCiAgICAgICAgICBpbmRleE5hbWUgPSBfcmVmLmluZGV4TmFtZSwKICAgICAgICAgIGlucHV0U2VsZWN0b3IgPSBfcmVmLmlucHV0U2VsZWN0b3IsCiAgICAgICAgICBfcmVmJGFwcElkID0gX3JlZi5hcHBJZCwKICAgICAgICAgIGFwcElkID0gX3JlZiRhcHBJZCA9PT0gdW5kZWZpbmVkID8gIkJINEQ5T0QxNkEiIDogX3JlZiRhcHBJZCwKICAgICAgICAgIF9yZWYkZGVidWcgPSBfcmVmLmRlYnVnLAogICAgICAgICAgZGVidWcgPSBfcmVmJGRlYnVnID09PSB1bmRlZmluZWQgPyBmYWxzZSA6IF9yZWYkZGVidWcsCiAgICAgICAgICBfcmVmJGFsZ29saWFPcHRpb25zID0gX3JlZi5hbGdvbGlhT3B0aW9ucywKICAgICAgICAgIGFsZ29saWFPcHRpb25zID0gX3JlZiRhbGdvbGlhT3B0aW9ucyA9PT0gdW5kZWZpbmVkID8ge30gOiBfcmVmJGFsZ29saWFPcHRpb25zLAogICAgICAgICAgX3JlZiRxdWVyeURhdGFDYWxsYmFjID0gX3JlZi5xdWVyeURhdGFDYWxsYmFjaywKICAgICAgICAgIHF1ZXJ5RGF0YUNhbGxiYWNrID0gX3JlZiRxdWVyeURhdGFDYWxsYmFjID09PSB1bmRlZmluZWQgPyBudWxsIDogX3JlZiRxdWVyeURhdGFDYWxsYmFjLAogICAgICAgICAgX3JlZiRhdXRvY29tcGxldGVPcHRpID0gX3JlZi5hdXRvY29tcGxldGVPcHRpb25zLAogICAgICAgICAgYXV0b2NvbXBsZXRlT3B0aW9ucyA9IF9yZWYkYXV0b2NvbXBsZXRlT3B0aSA9PT0gdW5kZWZpbmVkID8gewogICAgICAgICAgICBkZWJ1ZzogZmFsc2UsCiAgICAgICAgICAgIGhpbnQ6IGZhbHNlLAogICAgICAgICAgICBhdXRvc2VsZWN0OiB0cnVlCiAgICAgICAgICB9IDogX3JlZiRhdXRvY29tcGxldGVPcHRpLAogICAgICAgICAgX3JlZiR0cmFuc2Zvcm1EYXRhID0gX3JlZi50cmFuc2Zvcm1EYXRhLAogICAgICAgICAgdHJhbnNmb3JtRGF0YSA9IF9yZWYkdHJhbnNmb3JtRGF0YSA9PT0gdW5kZWZpbmVkID8gZmFsc2UgOiBfcmVmJHRyYW5zZm9ybURhdGEsCiAgICAgICAgICBfcmVmJHF1ZXJ5SG9vayA9IF9yZWYucXVlcnlIb29rLAogICAgICAgICAgcXVlcnlIb29rID0gX3JlZiRxdWVyeUhvb2sgPT09IHVuZGVmaW5lZCA/IGZhbHNlIDogX3JlZiRxdWVyeUhvb2ssCiAgICAgICAgICBfcmVmJGhhbmRsZVNlbGVjdGVkID0gX3JlZi5oYW5kbGVTZWxlY3RlZCwKICAgICAgICAgIGhhbmRsZVNlbGVjdGVkID0gX3JlZiRoYW5kbGVTZWxlY3RlZCA9PT0gdW5kZWZpbmVkID8gZmFsc2UgOiBfcmVmJGhhbmRsZVNlbGVjdGVkLAogICAgICAgICAgX3JlZiRlbmhhbmNlZFNlYXJjaEluID0gX3JlZi5lbmhhbmNlZFNlYXJjaElucHV0LAogICAgICAgICAgZW5oYW5jZWRTZWFyY2hJbnB1dCA9IF9yZWYkZW5oYW5jZWRTZWFyY2hJbiA9PT0gdW5kZWZpbmVkID8gZmFsc2UgOiBfcmVmJGVuaGFuY2VkU2VhcmNoSW4sCiAgICAgICAgICBfcmVmJGxheW91dCA9IF9yZWYubGF5b3V0LAogICAgICAgICAgbGF5b3V0ID0gX3JlZiRsYXlvdXQgPT09IHVuZGVmaW5lZCA/ICJjb2xsdW1ucyIgOiBfcmVmJGxheW91dDsKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgRG9jU2VhcmNoKTsKICAgICAgICBEb2NTZWFyY2guY2hlY2tBcmd1bWVudHMoewogICAgICAgICAgYXBpS2V5OiBhcGlLZXksCiAgICAgICAgICBpbmRleE5hbWU6IGluZGV4TmFtZSwKICAgICAgICAgIGlucHV0U2VsZWN0b3I6IGlucHV0U2VsZWN0b3IsCiAgICAgICAgICBkZWJ1ZzogZGVidWcsCiAgICAgICAgICBhbGdvbGlhT3B0aW9uczogYWxnb2xpYU9wdGlvbnMsCiAgICAgICAgICBxdWVyeURhdGFDYWxsYmFjazogcXVlcnlEYXRhQ2FsbGJhY2ssCiAgICAgICAgICBhdXRvY29tcGxldGVPcHRpb25zOiBhdXRvY29tcGxldGVPcHRpb25zLAogICAgICAgICAgdHJhbnNmb3JtRGF0YTogdHJhbnNmb3JtRGF0YSwKICAgICAgICAgIHF1ZXJ5SG9vazogcXVlcnlIb29rLAogICAgICAgICAgaGFuZGxlU2VsZWN0ZWQ6IGhhbmRsZVNlbGVjdGVkLAogICAgICAgICAgZW5oYW5jZWRTZWFyY2hJbnB1dDogZW5oYW5jZWRTZWFyY2hJbnB1dCwKICAgICAgICAgIGxheW91dDogbGF5b3V0CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5hcGlLZXkgPSBhcGlLZXk7CiAgICAgICAgdGhpcy5hcHBJZCA9IGFwcElkOwogICAgICAgIHRoaXMuaW5kZXhOYW1lID0gaW5kZXhOYW1lOwogICAgICAgIHRoaXMuaW5wdXQgPSBEb2NTZWFyY2guZ2V0SW5wdXRGcm9tU2VsZWN0b3IoaW5wdXRTZWxlY3Rvcik7CiAgICAgICAgdGhpcy5hbGdvbGlhT3B0aW9ucyA9IF9leHRlbmRzKHsKICAgICAgICAgIGhpdHNQZXJQYWdlOiA1CiAgICAgICAgfSwgYWxnb2xpYU9wdGlvbnMpOwogICAgICAgIHRoaXMucXVlcnlEYXRhQ2FsbGJhY2sgPSBxdWVyeURhdGFDYWxsYmFjayB8fCBudWxsOwogICAgICAgIHZhciBhdXRvY29tcGxldGVPcHRpb25zRGVidWcgPSBhdXRvY29tcGxldGVPcHRpb25zICYmIGF1dG9jb21wbGV0ZU9wdGlvbnMuZGVidWcgPyBhdXRvY29tcGxldGVPcHRpb25zLmRlYnVnIDogZmFsc2U7CiAgICAgICAgYXV0b2NvbXBsZXRlT3B0aW9ucy5kZWJ1ZyA9IGRlYnVnIHx8IGF1dG9jb21wbGV0ZU9wdGlvbnNEZWJ1ZzsKICAgICAgICB0aGlzLmF1dG9jb21wbGV0ZU9wdGlvbnMgPSBhdXRvY29tcGxldGVPcHRpb25zOwogICAgICAgIHRoaXMuYXV0b2NvbXBsZXRlT3B0aW9ucy5jc3NDbGFzc2VzID0gdGhpcy5hdXRvY29tcGxldGVPcHRpb25zLmNzc0NsYXNzZXMgfHwge307CiAgICAgICAgdGhpcy5hdXRvY29tcGxldGVPcHRpb25zLmNzc0NsYXNzZXMucHJlZml4ID0gdGhpcy5hdXRvY29tcGxldGVPcHRpb25zLmNzc0NsYXNzZXMucHJlZml4IHx8ICJkcyI7CiAgICAgICAgdmFyIGlucHV0QXJpYUxhYmVsID0gdGhpcy5pbnB1dCAmJiB0eXBlb2YgdGhpcy5pbnB1dC5hdHRyID09PSAiZnVuY3Rpb24iICYmIHRoaXMuaW5wdXQuYXR0cigiYXJpYS1sYWJlbCIpOwogICAgICAgIHRoaXMuYXV0b2NvbXBsZXRlT3B0aW9ucy5hcmlhTGFiZWwgPSB0aGlzLmF1dG9jb21wbGV0ZU9wdGlvbnMuYXJpYUxhYmVsIHx8IGlucHV0QXJpYUxhYmVsIHx8ICJzZWFyY2ggaW5wdXQiOwogICAgICAgIHRoaXMuaXNTaW1wbGVMYXlvdXQgPSBsYXlvdXQgPT09ICJzaW1wbGUiOwogICAgICAgIHRoaXMuY2xpZW50ID0gKDAsIF9saXRlMi5kZWZhdWx0KSh0aGlzLmFwcElkLCB0aGlzLmFwaUtleSk7CiAgICAgICAgdGhpcy5jbGllbnQuYWRkQWxnb2xpYUFnZW50KCJkb2NzZWFyY2guanMgIiArIF92ZXJzaW9uMi5kZWZhdWx0KTsKICAgICAgICBpZiAoZW5oYW5jZWRTZWFyY2hJbnB1dCkgewogICAgICAgICAgdGhpcy5pbnB1dCA9IERvY1NlYXJjaC5pbmplY3RTZWFyY2hCb3godGhpcy5pbnB1dCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuYXV0b2NvbXBsZXRlID0gKDAsIF9hdXRvY29tcGxldGUyLmRlZmF1bHQpKHRoaXMuaW5wdXQsIGF1dG9jb21wbGV0ZU9wdGlvbnMsIFt7CiAgICAgICAgICBzb3VyY2U6IHRoaXMuZ2V0QXV0b2NvbXBsZXRlU291cmNlKHRyYW5zZm9ybURhdGEsIHF1ZXJ5SG9vayksCiAgICAgICAgICB0ZW1wbGF0ZXM6IHsKICAgICAgICAgICAgc3VnZ2VzdGlvbjogRG9jU2VhcmNoLmdldFN1Z2dlc3Rpb25UZW1wbGF0ZSh0aGlzLmlzU2ltcGxlTGF5b3V0KSwKICAgICAgICAgICAgZm9vdGVyOiBfdGVtcGxhdGVzMi5kZWZhdWx0LmZvb3RlciwKICAgICAgICAgICAgZW1wdHk6IERvY1NlYXJjaC5nZXRFbXB0eVRlbXBsYXRlKCkKICAgICAgICAgIH0KICAgICAgICB9XSk7CiAgICAgICAgdmFyIGN1c3RvbUhhbmRsZVNlbGVjdGVkID0gaGFuZGxlU2VsZWN0ZWQ7CiAgICAgICAgdGhpcy5oYW5kbGVTZWxlY3RlZCA9IGN1c3RvbUhhbmRsZVNlbGVjdGVkIHx8IHRoaXMuaGFuZGxlU2VsZWN0ZWQ7CiAgICAgICAgaWYgKGN1c3RvbUhhbmRsZVNlbGVjdGVkKSB7CiAgICAgICAgICAoMCwgX3plcHRvMi5kZWZhdWx0KSgiLmFsZ29saWEtYXV0b2NvbXBsZXRlIikub24oImNsaWNrIiwgIi5kcy1zdWdnZXN0aW9ucyBhIiwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgdGhpcy5hdXRvY29tcGxldGUub24oImF1dG9jb21wbGV0ZTpzZWxlY3RlZCIsIHRoaXMuaGFuZGxlU2VsZWN0ZWQuYmluZChudWxsLCB0aGlzLmF1dG9jb21wbGV0ZS5hdXRvY29tcGxldGUpKTsKICAgICAgICB0aGlzLmF1dG9jb21wbGV0ZS5vbigiYXV0b2NvbXBsZXRlOnNob3duIiwgdGhpcy5oYW5kbGVTaG93bi5iaW5kKG51bGwsIHRoaXMuaW5wdXQpKTsKICAgICAgICBpZiAoZW5oYW5jZWRTZWFyY2hJbnB1dCkgewogICAgICAgICAgRG9jU2VhcmNoLmJpbmRTZWFyY2hCb3hFdmVudCgpOwogICAgICAgIH0KICAgICAgfQogICAgICBfY3JlYXRlQ2xhc3MoRG9jU2VhcmNoLCBbewogICAgICAgIGtleTogImdldEF1dG9jb21wbGV0ZVNvdXJjZSIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldEF1dG9jb21wbGV0ZVNvdXJjZSh0cmFuc2Zvcm1EYXRhLCBxdWVyeUhvb2spIHsKICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHF1ZXJ5LCBjYWxsYmFjaykgewogICAgICAgICAgICBpZiAocXVlcnlIb29rKSB7CiAgICAgICAgICAgICAgcXVlcnkgPSBxdWVyeUhvb2socXVlcnkpIHx8IHF1ZXJ5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIF90aGlzLmNsaWVudC5zZWFyY2goW3sKICAgICAgICAgICAgICBpbmRleE5hbWU6IF90aGlzLmluZGV4TmFtZSwKICAgICAgICAgICAgICBxdWVyeTogcXVlcnksCiAgICAgICAgICAgICAgcGFyYW1zOiBfdGhpcy5hbGdvbGlhT3B0aW9ucwogICAgICAgICAgICB9XSkudGhlbihmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgIGlmIChfdGhpcy5xdWVyeURhdGFDYWxsYmFjayAmJiB0eXBlb2YgX3RoaXMucXVlcnlEYXRhQ2FsbGJhY2sgPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgX3RoaXMucXVlcnlEYXRhQ2FsbGJhY2soZGF0YSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBoaXRzID0gZGF0YS5yZXN1bHRzWzBdLmhpdHM7CiAgICAgICAgICAgICAgaWYgKHRyYW5zZm9ybURhdGEpIHsKICAgICAgICAgICAgICAgIGhpdHMgPSB0cmFuc2Zvcm1EYXRhKGhpdHMpIHx8IGhpdHM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhbGxiYWNrKERvY1NlYXJjaC5mb3JtYXRIaXRzKGhpdHMpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIGtleTogImhhbmRsZVNlbGVjdGVkIiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gaGFuZGxlU2VsZWN0ZWQoaW5wdXQsIGV2ZW50LCBzdWdnZXN0aW9uLCBkYXRhc2V0TnVtYmVyKSB7CiAgICAgICAgICB2YXIgY29udGV4dCA9IGFyZ3VtZW50cy5sZW5ndGggPiA0ICYmIGFyZ3VtZW50c1s0XSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzRdIDoge307CiAgICAgICAgICBpZiAoY29udGV4dC5zZWxlY3Rpb25NZXRob2QgPT09ICJjbGljayIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaW5wdXQuc2V0VmFsKCIiKTsKICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5hc3NpZ24oc3VnZ2VzdGlvbi51cmwpOwogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIGtleTogImhhbmRsZVNob3duIiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gaGFuZGxlU2hvd24oaW5wdXQpIHsKICAgICAgICAgIHZhciBtaWRkbGVPZklucHV0ID0gaW5wdXQub2Zmc2V0KCkubGVmdCArIGlucHV0LndpZHRoKCkgLyAyOwogICAgICAgICAgdmFyIG1pZGRsZU9mV2luZG93ID0gKDAsIF96ZXB0bzIuZGVmYXVsdCkoZG9jdW1lbnQpLndpZHRoKCkgLyAyOwogICAgICAgICAgaWYgKGlzTmFOKG1pZGRsZU9mV2luZG93KSkgewogICAgICAgICAgICBtaWRkbGVPZldpbmRvdyA9IDkwMDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhbGlnbkNsYXNzID0gbWlkZGxlT2ZJbnB1dCAtIG1pZGRsZU9mV2luZG93ID49IDAgPyAiYWxnb2xpYS1hdXRvY29tcGxldGUtcmlnaHQiIDogImFsZ29saWEtYXV0b2NvbXBsZXRlLWxlZnQiOwogICAgICAgICAgdmFyIG90aGVyQWxpZ25DbGFzcyA9IG1pZGRsZU9mSW5wdXQgLSBtaWRkbGVPZldpbmRvdyA8IDAgPyAiYWxnb2xpYS1hdXRvY29tcGxldGUtcmlnaHQiIDogImFsZ29saWEtYXV0b2NvbXBsZXRlLWxlZnQiOwogICAgICAgICAgdmFyIGF1dG9jb21wbGV0ZVdyYXBwZXIgPSAoMCwgX3plcHRvMi5kZWZhdWx0KSgiLmFsZ29saWEtYXV0b2NvbXBsZXRlIik7CiAgICAgICAgICBpZiAoIWF1dG9jb21wbGV0ZVdyYXBwZXIuaGFzQ2xhc3MoYWxpZ25DbGFzcykpIHsKICAgICAgICAgICAgYXV0b2NvbXBsZXRlV3JhcHBlci5hZGRDbGFzcyhhbGlnbkNsYXNzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhdXRvY29tcGxldGVXcmFwcGVyLmhhc0NsYXNzKG90aGVyQWxpZ25DbGFzcykpIHsKICAgICAgICAgICAgYXV0b2NvbXBsZXRlV3JhcHBlci5yZW1vdmVDbGFzcyhvdGhlckFsaWduQ2xhc3MpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfV0sIFt7CiAgICAgICAga2V5OiAiY2hlY2tBcmd1bWVudHMiLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBjaGVja0FyZ3VtZW50cyhhcmdzKSB7CiAgICAgICAgICBpZiAoIWFyZ3MuYXBpS2V5IHx8ICFhcmdzLmluZGV4TmFtZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IodXNhZ2UpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBhcmdzLmlucHV0U2VsZWN0b3IgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXJyb3I6IGlucHV0U2VsZWN0b3I6IiArIGFyZ3MuaW5wdXRTZWxlY3RvciArICIgIG11c3QgYmUgYSBzdHJpbmcuIEVhY2ggc2VsZWN0b3IgbXVzdCBtYXRjaCBvbmx5IG9uZSBlbGVtZW50IGFuZCBzZXBhcmF0ZWQgYnkgJywnIik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIURvY1NlYXJjaC5nZXRJbnB1dEZyb21TZWxlY3RvcihhcmdzLmlucHV0U2VsZWN0b3IpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXJyb3I6IE5vIGlucHV0IGVsZW1lbnQgaW4gdGhlIHBhZ2UgbWF0Y2hlcyAiICsgYXJncy5pbnB1dFNlbGVjdG9yKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIHsKICAgICAgICBrZXk6ICJpbmplY3RTZWFyY2hCb3giLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBpbmplY3RTZWFyY2hCb3goaW5wdXQpIHsKICAgICAgICAgIGlucHV0LmJlZm9yZShfdGVtcGxhdGVzMi5kZWZhdWx0LnNlYXJjaEJveCk7CiAgICAgICAgICB2YXIgbmV3SW5wdXQgPSBpbnB1dC5wcmV2KCkucHJldigpLmZpbmQoImlucHV0Iik7CiAgICAgICAgICBpbnB1dC5yZW1vdmUoKTsKICAgICAgICAgIHJldHVybiBuZXdJbnB1dDsKICAgICAgICB9CiAgICAgIH0sIHsKICAgICAgICBrZXk6ICJiaW5kU2VhcmNoQm94RXZlbnQiLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBiaW5kU2VhcmNoQm94RXZlbnQoKSB7CiAgICAgICAgICAoMCwgX3plcHRvMi5kZWZhdWx0KSgnLnNlYXJjaGJveCBbdHlwZT0icmVzZXQiXScpLm9uKCJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgKDAsIF96ZXB0bzIuZGVmYXVsdCkoImlucHV0I2RvY3NlYXJjaCIpLmZvY3VzKCk7CiAgICAgICAgICAgICgwLCBfemVwdG8yLmRlZmF1bHQpKHRoaXMpLmFkZENsYXNzKCJoaWRlIik7CiAgICAgICAgICAgIF9hdXRvY29tcGxldGUyLmRlZmF1bHQuYXV0b2NvbXBsZXRlLnNldFZhbCgiIik7CiAgICAgICAgICB9KTsKICAgICAgICAgICgwLCBfemVwdG8yLmRlZmF1bHQpKCJpbnB1dCNkb2NzZWFyY2giKS5vbigia2V5dXAiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBzZWFyY2hib3ggPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCJpbnB1dCNkb2NzZWFyY2giKTsKICAgICAgICAgICAgdmFyIHJlc2V0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnNlYXJjaGJveCBbdHlwZT0icmVzZXQiXScpOwogICAgICAgICAgICByZXNldC5jbGFzc05hbWUgPSAic2VhcmNoYm94X19yZXNldCI7CiAgICAgICAgICAgIGlmIChzZWFyY2hib3gudmFsdWUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgcmVzZXQuY2xhc3NOYW1lICs9ICIgaGlkZSI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIGtleTogImdldElucHV0RnJvbVNlbGVjdG9yIiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0SW5wdXRGcm9tU2VsZWN0b3Ioc2VsZWN0b3IpIHsKICAgICAgICAgIHZhciBpbnB1dCA9ICgwLCBfemVwdG8yLmRlZmF1bHQpKHNlbGVjdG9yKS5maWx0ZXIoImlucHV0Iik7CiAgICAgICAgICByZXR1cm4gaW5wdXQubGVuZ3RoID8gKDAsIF96ZXB0bzIuZGVmYXVsdCkoaW5wdXRbMF0pIDogbnVsbDsKICAgICAgICB9CiAgICAgIH0sIHsKICAgICAgICBrZXk6ICJmb3JtYXRIaXRzIiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gZm9ybWF0SGl0cyhyZWNlaXZlZEhpdHMpIHsKICAgICAgICAgIHZhciBjbG9uZWRIaXRzID0gX3V0aWxzMi5kZWZhdWx0LmRlZXBDbG9uZShyZWNlaXZlZEhpdHMpOwogICAgICAgICAgdmFyIGhpdHMgPSBjbG9uZWRIaXRzLm1hcChmdW5jdGlvbiAoaGl0KSB7CiAgICAgICAgICAgIGlmIChoaXQuX2hpZ2hsaWdodFJlc3VsdCkgewogICAgICAgICAgICAgIGhpdC5faGlnaGxpZ2h0UmVzdWx0ID0gX3V0aWxzMi5kZWZhdWx0Lm1lcmdlS2V5V2l0aFBhcmVudChoaXQuX2hpZ2hsaWdodFJlc3VsdCwgImhpZXJhcmNoeSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBfdXRpbHMyLmRlZmF1bHQubWVyZ2VLZXlXaXRoUGFyZW50KGhpdCwgImhpZXJhcmNoeSIpOwogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgZ3JvdXBlZEhpdHMgPSBfdXRpbHMyLmRlZmF1bHQuZ3JvdXBCeShoaXRzLCAibHZsMCIpOwogICAgICAgICAgX3plcHRvMi5kZWZhdWx0LmVhY2goZ3JvdXBlZEhpdHMsIGZ1bmN0aW9uIChsZXZlbCwgY29sbGVjdGlvbikgewogICAgICAgICAgICB2YXIgZ3JvdXBlZEhpdHNCeUx2bDEgPSBfdXRpbHMyLmRlZmF1bHQuZ3JvdXBCeShjb2xsZWN0aW9uLCAibHZsMSIpOwogICAgICAgICAgICB2YXIgZmxhdHRlbmVkSGl0cyA9IF91dGlsczIuZGVmYXVsdC5mbGF0dGVuQW5kRmxhZ0ZpcnN0KGdyb3VwZWRIaXRzQnlMdmwxLCAiaXNTdWJDYXRlZ29yeUhlYWRlciIpOwogICAgICAgICAgICBncm91cGVkSGl0c1tsZXZlbF0gPSBmbGF0dGVuZWRIaXRzOwogICAgICAgICAgfSk7CiAgICAgICAgICBncm91cGVkSGl0cyA9IF91dGlsczIuZGVmYXVsdC5mbGF0dGVuQW5kRmxhZ0ZpcnN0KGdyb3VwZWRIaXRzLCAiaXNDYXRlZ29yeUhlYWRlciIpOwogICAgICAgICAgcmV0dXJuIGdyb3VwZWRIaXRzLm1hcChmdW5jdGlvbiAoaGl0KSB7CiAgICAgICAgICAgIHZhciB1cmwgPSBEb2NTZWFyY2guZm9ybWF0VVJMKGhpdCk7CiAgICAgICAgICAgIHZhciBjYXRlZ29yeSA9IF91dGlsczIuZGVmYXVsdC5nZXRIaWdobGlnaHRlZFZhbHVlKGhpdCwgImx2bDAiKTsKICAgICAgICAgICAgdmFyIHN1YmNhdGVnb3J5ID0gX3V0aWxzMi5kZWZhdWx0LmdldEhpZ2hsaWdodGVkVmFsdWUoaGl0LCAibHZsMSIpIHx8IGNhdGVnb3J5OwogICAgICAgICAgICB2YXIgZGlzcGxheVRpdGxlID0gX3V0aWxzMi5kZWZhdWx0LmNvbXBhY3QoW191dGlsczIuZGVmYXVsdC5nZXRIaWdobGlnaHRlZFZhbHVlKGhpdCwgImx2bDIiKSB8fCBzdWJjYXRlZ29yeSwgX3V0aWxzMi5kZWZhdWx0LmdldEhpZ2hsaWdodGVkVmFsdWUoaGl0LCAibHZsMyIpLCBfdXRpbHMyLmRlZmF1bHQuZ2V0SGlnaGxpZ2h0ZWRWYWx1ZShoaXQsICJsdmw0IiksIF91dGlsczIuZGVmYXVsdC5nZXRIaWdobGlnaHRlZFZhbHVlKGhpdCwgImx2bDUiKSwgX3V0aWxzMi5kZWZhdWx0LmdldEhpZ2hsaWdodGVkVmFsdWUoaGl0LCAibHZsNiIpXSkuam9pbignPHNwYW4gY2xhc3M9ImFhLXN1Z2dlc3Rpb24tdGl0bGUtc2VwYXJhdG9yIiBhcmlhLWhpZGRlbj0idHJ1ZSI+IOKAuiA8L3NwYW4+Jyk7CiAgICAgICAgICAgIHZhciB0ZXh0ID0gX3V0aWxzMi5kZWZhdWx0LmdldFNuaXBwZXRlZFZhbHVlKGhpdCwgImNvbnRlbnQiKTsKICAgICAgICAgICAgdmFyIGlzVGV4dE9yU3ViY2F0ZWdvcnlOb25FbXB0eSA9IHN1YmNhdGVnb3J5ICYmIHN1YmNhdGVnb3J5ICE9PSAiIiB8fCBkaXNwbGF5VGl0bGUgJiYgZGlzcGxheVRpdGxlICE9PSAiIjsKICAgICAgICAgICAgdmFyIGlzTHZsMUVtcHR5T3JEdXBsaWNhdGUgPSAhc3ViY2F0ZWdvcnkgfHwgc3ViY2F0ZWdvcnkgPT09ICIiIHx8IHN1YmNhdGVnb3J5ID09PSBjYXRlZ29yeTsKICAgICAgICAgICAgdmFyIGlzTHZsMiA9IGRpc3BsYXlUaXRsZSAmJiBkaXNwbGF5VGl0bGUgIT09ICIiICYmIGRpc3BsYXlUaXRsZSAhPT0gc3ViY2F0ZWdvcnk7CiAgICAgICAgICAgIHZhciBpc0x2bDEgPSAhaXNMdmwyICYmIHN1YmNhdGVnb3J5ICYmIHN1YmNhdGVnb3J5ICE9PSAiIiAmJiBzdWJjYXRlZ29yeSAhPT0gY2F0ZWdvcnk7CiAgICAgICAgICAgIHZhciBpc0x2bDAgPSAhaXNMdmwxICYmICFpc0x2bDI7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgaXNMdmwwOiBpc0x2bDAsCiAgICAgICAgICAgICAgaXNMdmwxOiBpc0x2bDEsCiAgICAgICAgICAgICAgaXNMdmwyOiBpc0x2bDIsCiAgICAgICAgICAgICAgaXNMdmwxRW1wdHlPckR1cGxpY2F0ZTogaXNMdmwxRW1wdHlPckR1cGxpY2F0ZSwKICAgICAgICAgICAgICBpc0NhdGVnb3J5SGVhZGVyOiBoaXQuaXNDYXRlZ29yeUhlYWRlciwKICAgICAgICAgICAgICBpc1N1YkNhdGVnb3J5SGVhZGVyOiBoaXQuaXNTdWJDYXRlZ29yeUhlYWRlciwKICAgICAgICAgICAgICBpc1RleHRPclN1YmNhdGVnb3J5Tm9uRW1wdHk6IGlzVGV4dE9yU3ViY2F0ZWdvcnlOb25FbXB0eSwKICAgICAgICAgICAgICBjYXRlZ29yeTogY2F0ZWdvcnksCiAgICAgICAgICAgICAgc3ViY2F0ZWdvcnk6IHN1YmNhdGVnb3J5LAogICAgICAgICAgICAgIHRpdGxlOiBkaXNwbGF5VGl0bGUsCiAgICAgICAgICAgICAgdGV4dDogdGV4dCwKICAgICAgICAgICAgICB1cmw6IHVybAogICAgICAgICAgICB9OwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAga2V5OiAiZm9ybWF0VVJMIiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gZm9ybWF0VVJMKGhpdCkgewogICAgICAgICAgdmFyIHVybCA9IGhpdC51cmwsCiAgICAgICAgICAgIGFuY2hvciA9IGhpdC5hbmNob3I7CiAgICAgICAgICBpZiAodXJsKSB7CiAgICAgICAgICAgIHZhciBjb250YWluc0FuY2hvciA9IHVybC5pbmRleE9mKCIjIikgIT09IC0xOwogICAgICAgICAgICBpZiAoY29udGFpbnNBbmNob3IpIHJldHVybiB1cmw7ZWxzZSBpZiAoYW5jaG9yKSByZXR1cm4gaGl0LnVybCArICIjIiArIGhpdC5hbmNob3I7CiAgICAgICAgICAgIHJldHVybiB1cmw7CiAgICAgICAgICB9IGVsc2UgaWYgKGFuY2hvcikgcmV0dXJuICIjIiArIGhpdC5hbmNob3I7CiAgICAgICAgICBjb25zb2xlLndhcm4oIm5vIGFuY2hvciBub3IgdXJsIGZvciA6ICIsIEpTT04uc3RyaW5naWZ5KGhpdCkpOwogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAga2V5OiAiZ2V0RW1wdHlUZW1wbGF0ZSIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldEVtcHR5VGVtcGxhdGUoKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgICAgICAgcmV0dXJuIF9ob2dhbjIuZGVmYXVsdC5jb21waWxlKF90ZW1wbGF0ZXMyLmRlZmF1bHQuZW1wdHkpLnJlbmRlcihhcmdzKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAga2V5OiAiZ2V0U3VnZ2VzdGlvblRlbXBsYXRlIiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0U3VnZ2VzdGlvblRlbXBsYXRlKGlzU2ltcGxlTGF5b3V0KSB7CiAgICAgICAgICB2YXIgc3RyaW5nVGVtcGxhdGUgPSBpc1NpbXBsZUxheW91dCA/IF90ZW1wbGF0ZXMyLmRlZmF1bHQuc3VnZ2VzdGlvblNpbXBsZSA6IF90ZW1wbGF0ZXMyLmRlZmF1bHQuc3VnZ2VzdGlvbjsKICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IF9ob2dhbjIuZGVmYXVsdC5jb21waWxlKHN0cmluZ1RlbXBsYXRlKTsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc3VnZ2VzdGlvbikgewogICAgICAgICAgICByZXR1cm4gdGVtcGxhdGUucmVuZGVyKHN1Z2dlc3Rpb24pOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH1dKTsKICAgICAgcmV0dXJuIERvY1NlYXJjaDsKICAgIH0oKTsKICAgIGV4cG9ydHMuZGVmYXVsdCA9IERvY1NlYXJjaDsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICB2YXIgSG9nYW4gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDI3KTsKICAgIEhvZ2FuLlRlbXBsYXRlID0gX193ZWJwYWNrX3JlcXVpcmVfXygyOCkuVGVtcGxhdGU7CiAgICBIb2dhbi50ZW1wbGF0ZSA9IEhvZ2FuLlRlbXBsYXRlOwogICAgbW9kdWxlLmV4cG9ydHMgPSBIb2dhbjsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAoZnVuY3Rpb24gKEhvZ2FuKSB7CiAgICAgIHZhciBySXNXaGl0ZXNwYWNlID0gL1xTLywKICAgICAgICByUXVvdCA9IC9cIi9nLAogICAgICAgIHJOZXdsaW5lID0gL1xuL2csCiAgICAgICAgckNyID0gL1xyL2csCiAgICAgICAgclNsYXNoID0gL1xcL2csCiAgICAgICAgckxpbmVTZXAgPSAvXHUyMDI4LywKICAgICAgICByUGFyYWdyYXBoU2VwID0gL1x1MjAyOS87CiAgICAgIEhvZ2FuLnRhZ3MgPSB7CiAgICAgICAgIiMiOiAxLAogICAgICAgICJeIjogMiwKICAgICAgICAiPCI6IDMsCiAgICAgICAgJDogNCwKICAgICAgICAiLyI6IDUsCiAgICAgICAgIiEiOiA2LAogICAgICAgICI+IjogNywKICAgICAgICAiPSI6IDgsCiAgICAgICAgX3Y6IDksCiAgICAgICAgInsiOiAxMCwKICAgICAgICAiJiI6IDExLAogICAgICAgIF90OiAxMgogICAgICB9OwogICAgICBIb2dhbi5zY2FuID0gZnVuY3Rpb24gc2Nhbih0ZXh0LCBkZWxpbWl0ZXJzKSB7CiAgICAgICAgdmFyIGxlbiA9IHRleHQubGVuZ3RoLAogICAgICAgICAgSU5fVEVYVCA9IDAsCiAgICAgICAgICBJTl9UQUdfVFlQRSA9IDEsCiAgICAgICAgICBJTl9UQUcgPSAyLAogICAgICAgICAgc3RhdGUgPSBJTl9URVhULAogICAgICAgICAgdGFnVHlwZSA9IG51bGwsCiAgICAgICAgICB0YWcgPSBudWxsLAogICAgICAgICAgYnVmID0gIiIsCiAgICAgICAgICB0b2tlbnMgPSBbXSwKICAgICAgICAgIHNlZW5UYWcgPSBmYWxzZSwKICAgICAgICAgIGkgPSAwLAogICAgICAgICAgbGluZVN0YXJ0ID0gMCwKICAgICAgICAgIG90YWcgPSAie3siLAogICAgICAgICAgY3RhZyA9ICJ9fSI7CiAgICAgICAgZnVuY3Rpb24gYWRkQnVmKCkgewogICAgICAgICAgaWYgKGJ1Zi5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgICB0YWc6ICJfdCIsCiAgICAgICAgICAgICAgdGV4dDogbmV3IFN0cmluZyhidWYpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBidWYgPSAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGluZUlzV2hpdGVzcGFjZSgpIHsKICAgICAgICAgIHZhciBpc0FsbFdoaXRlc3BhY2UgPSB0cnVlOwogICAgICAgICAgZm9yICh2YXIgaiA9IGxpbmVTdGFydDsgaiA8IHRva2Vucy5sZW5ndGg7IGorKykgewogICAgICAgICAgICBpc0FsbFdoaXRlc3BhY2UgPSBIb2dhbi50YWdzW3Rva2Vuc1tqXS50YWddIDwgSG9nYW4udGFnc1siX3YiXSB8fCB0b2tlbnNbal0udGFnID09ICJfdCIgJiYgdG9rZW5zW2pdLnRleHQubWF0Y2gocklzV2hpdGVzcGFjZSkgPT09IG51bGw7CiAgICAgICAgICAgIGlmICghaXNBbGxXaGl0ZXNwYWNlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaXNBbGxXaGl0ZXNwYWNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaWx0ZXJMaW5lKGhhdmVTZWVuVGFnLCBub05ld0xpbmUpIHsKICAgICAgICAgIGFkZEJ1ZigpOwogICAgICAgICAgaWYgKGhhdmVTZWVuVGFnICYmIGxpbmVJc1doaXRlc3BhY2UoKSkgewogICAgICAgICAgICBmb3IgKHZhciBqID0gbGluZVN0YXJ0LCBuZXh0OyBqIDwgdG9rZW5zLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgaWYgKHRva2Vuc1tqXS50ZXh0KSB7CiAgICAgICAgICAgICAgICBpZiAoKG5leHQgPSB0b2tlbnNbaiArIDFdKSAmJiBuZXh0LnRhZyA9PSAiPiIpIHsKICAgICAgICAgICAgICAgICAgbmV4dC5pbmRlbnQgPSB0b2tlbnNbal0udGV4dC50b1N0cmluZygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdG9rZW5zLnNwbGljZShqLCAxKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoIW5vTmV3TGluZSkgewogICAgICAgICAgICB0b2tlbnMucHVzaCh7CiAgICAgICAgICAgICAgdGFnOiAiXG4iCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgc2VlblRhZyA9IGZhbHNlOwogICAgICAgICAgbGluZVN0YXJ0ID0gdG9rZW5zLmxlbmd0aDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hhbmdlRGVsaW1pdGVycyh0ZXh0LCBpbmRleCkgewogICAgICAgICAgdmFyIGNsb3NlID0gIj0iICsgY3RhZywKICAgICAgICAgICAgY2xvc2VJbmRleCA9IHRleHQuaW5kZXhPZihjbG9zZSwgaW5kZXgpLAogICAgICAgICAgICBkZWxpbWl0ZXJzID0gdHJpbSh0ZXh0LnN1YnN0cmluZyh0ZXh0LmluZGV4T2YoIj0iLCBpbmRleCkgKyAxLCBjbG9zZUluZGV4KSkuc3BsaXQoIiAiKTsKICAgICAgICAgIG90YWcgPSBkZWxpbWl0ZXJzWzBdOwogICAgICAgICAgY3RhZyA9IGRlbGltaXRlcnNbZGVsaW1pdGVycy5sZW5ndGggLSAxXTsKICAgICAgICAgIHJldHVybiBjbG9zZUluZGV4ICsgY2xvc2UubGVuZ3RoIC0gMTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlbGltaXRlcnMpIHsKICAgICAgICAgIGRlbGltaXRlcnMgPSBkZWxpbWl0ZXJzLnNwbGl0KCIgIik7CiAgICAgICAgICBvdGFnID0gZGVsaW1pdGVyc1swXTsKICAgICAgICAgIGN0YWcgPSBkZWxpbWl0ZXJzWzFdOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGlmIChzdGF0ZSA9PSBJTl9URVhUKSB7CiAgICAgICAgICAgIGlmICh0YWdDaGFuZ2Uob3RhZywgdGV4dCwgaSkpIHsKICAgICAgICAgICAgICAtLWk7CiAgICAgICAgICAgICAgYWRkQnVmKCk7CiAgICAgICAgICAgICAgc3RhdGUgPSBJTl9UQUdfVFlQRTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAodGV4dC5jaGFyQXQoaSkgPT0gIlxuIikgewogICAgICAgICAgICAgICAgZmlsdGVyTGluZShzZWVuVGFnKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYnVmICs9IHRleHQuY2hhckF0KGkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZSA9PSBJTl9UQUdfVFlQRSkgewogICAgICAgICAgICBpICs9IG90YWcubGVuZ3RoIC0gMTsKICAgICAgICAgICAgdGFnID0gSG9nYW4udGFnc1t0ZXh0LmNoYXJBdChpICsgMSldOwogICAgICAgICAgICB0YWdUeXBlID0gdGFnID8gdGV4dC5jaGFyQXQoaSArIDEpIDogIl92IjsKICAgICAgICAgICAgaWYgKHRhZ1R5cGUgPT0gIj0iKSB7CiAgICAgICAgICAgICAgaSA9IGNoYW5nZURlbGltaXRlcnModGV4dCwgaSk7CiAgICAgICAgICAgICAgc3RhdGUgPSBJTl9URVhUOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICh0YWcpIHsKICAgICAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3RhdGUgPSBJTl9UQUc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2VlblRhZyA9IGk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodGFnQ2hhbmdlKGN0YWcsIHRleHQsIGkpKSB7CiAgICAgICAgICAgICAgdG9rZW5zLnB1c2goewogICAgICAgICAgICAgICAgdGFnOiB0YWdUeXBlLAogICAgICAgICAgICAgICAgbjogdHJpbShidWYpLAogICAgICAgICAgICAgICAgb3RhZzogb3RhZywKICAgICAgICAgICAgICAgIGN0YWc6IGN0YWcsCiAgICAgICAgICAgICAgICBpOiB0YWdUeXBlID09ICIvIiA/IHNlZW5UYWcgLSBvdGFnLmxlbmd0aCA6IGkgKyBjdGFnLmxlbmd0aAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGJ1ZiA9ICIiOwogICAgICAgICAgICAgIGkgKz0gY3RhZy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHN0YXRlID0gSU5fVEVYVDsKICAgICAgICAgICAgICBpZiAodGFnVHlwZSA9PSAieyIpIHsKICAgICAgICAgICAgICAgIGlmIChjdGFnID09ICJ9fSIpIHsKICAgICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY2xlYW5UcmlwbGVTdGFjaGUodG9rZW5zW3Rva2Vucy5sZW5ndGggLSAxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGJ1ZiArPSB0ZXh0LmNoYXJBdChpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmaWx0ZXJMaW5lKHNlZW5UYWcsIHRydWUpOwogICAgICAgIHJldHVybiB0b2tlbnM7CiAgICAgIH07CiAgICAgIGZ1bmN0aW9uIGNsZWFuVHJpcGxlU3RhY2hlKHRva2VuKSB7CiAgICAgICAgaWYgKHRva2VuLm4uc3Vic3RyKHRva2VuLm4ubGVuZ3RoIC0gMSkgPT09ICJ9IikgewogICAgICAgICAgdG9rZW4ubiA9IHRva2VuLm4uc3Vic3RyaW5nKDAsIHRva2VuLm4ubGVuZ3RoIC0gMSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIHRyaW0ocykgewogICAgICAgIGlmIChzLnRyaW0pIHsKICAgICAgICAgIHJldHVybiBzLnRyaW0oKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHMucmVwbGFjZSgvXlxzKnxccyokL2csICIiKTsKICAgICAgfQogICAgICBmdW5jdGlvbiB0YWdDaGFuZ2UodGFnLCB0ZXh0LCBpbmRleCkgewogICAgICAgIGlmICh0ZXh0LmNoYXJBdChpbmRleCkgIT0gdGFnLmNoYXJBdCgwKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpID0gMSwgbCA9IHRhZy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIGlmICh0ZXh0LmNoYXJBdChpbmRleCArIGkpICE9IHRhZy5jaGFyQXQoaSkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICB2YXIgYWxsb3dlZEluU3VwZXIgPSB7CiAgICAgICAgX3Q6IHRydWUsCiAgICAgICAgIlxuIjogdHJ1ZSwKICAgICAgICAkOiB0cnVlLAogICAgICAgICIvIjogdHJ1ZQogICAgICB9OwogICAgICBmdW5jdGlvbiBidWlsZFRyZWUodG9rZW5zLCBraW5kLCBzdGFjaywgY3VzdG9tVGFncykgewogICAgICAgIHZhciBpbnN0cnVjdGlvbnMgPSBbXSwKICAgICAgICAgIG9wZW5lciA9IG51bGwsCiAgICAgICAgICB0YWlsID0gbnVsbCwKICAgICAgICAgIHRva2VuID0gbnVsbDsKICAgICAgICB0YWlsID0gc3RhY2tbc3RhY2subGVuZ3RoIC0gMV07CiAgICAgICAgd2hpbGUgKHRva2Vucy5sZW5ndGggPiAwKSB7CiAgICAgICAgICB0b2tlbiA9IHRva2Vucy5zaGlmdCgpOwogICAgICAgICAgaWYgKHRhaWwgJiYgdGFpbC50YWcgPT0gIjwiICYmICEodG9rZW4udGFnIGluIGFsbG93ZWRJblN1cGVyKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIklsbGVnYWwgY29udGVudCBpbiA8IHN1cGVyIHRhZy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChIb2dhbi50YWdzW3Rva2VuLnRhZ10gPD0gSG9nYW4udGFnc1siJCJdIHx8IGlzT3BlbmVyKHRva2VuLCBjdXN0b21UYWdzKSkgewogICAgICAgICAgICBzdGFjay5wdXNoKHRva2VuKTsKICAgICAgICAgICAgdG9rZW4ubm9kZXMgPSBidWlsZFRyZWUodG9rZW5zLCB0b2tlbi50YWcsIHN0YWNrLCBjdXN0b21UYWdzKTsKICAgICAgICAgIH0gZWxzZSBpZiAodG9rZW4udGFnID09ICIvIikgewogICAgICAgICAgICBpZiAoc3RhY2subGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDbG9zaW5nIHRhZyB3aXRob3V0IG9wZW5lcjogLyIgKyB0b2tlbi5uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvcGVuZXIgPSBzdGFjay5wb3AoKTsKICAgICAgICAgICAgaWYgKHRva2VuLm4gIT0gb3BlbmVyLm4gJiYgIWlzQ2xvc2VyKHRva2VuLm4sIG9wZW5lci5uLCBjdXN0b21UYWdzKSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTmVzdGluZyBlcnJvcjogIiArIG9wZW5lci5uICsgIiB2cy4gIiArIHRva2VuLm4pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9wZW5lci5lbmQgPSB0b2tlbi5pOwogICAgICAgICAgICByZXR1cm4gaW5zdHJ1Y3Rpb25zOwogICAgICAgICAgfSBlbHNlIGlmICh0b2tlbi50YWcgPT0gIlxuIikgewogICAgICAgICAgICB0b2tlbi5sYXN0ID0gdG9rZW5zLmxlbmd0aCA9PSAwIHx8IHRva2Vuc1swXS50YWcgPT0gIlxuIjsKICAgICAgICAgIH0KICAgICAgICAgIGluc3RydWN0aW9ucy5wdXNoKHRva2VuKTsKICAgICAgICB9CiAgICAgICAgaWYgKHN0YWNrLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigibWlzc2luZyBjbG9zaW5nIHRhZzogIiArIHN0YWNrLnBvcCgpLm4pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaW5zdHJ1Y3Rpb25zOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzT3BlbmVyKHRva2VuLCB0YWdzKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0YWdzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgaWYgKHRhZ3NbaV0ubyA9PSB0b2tlbi5uKSB7CiAgICAgICAgICAgIHRva2VuLnRhZyA9ICIjIjsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzQ2xvc2VyKGNsb3NlLCBvcGVuLCB0YWdzKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0YWdzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgaWYgKHRhZ3NbaV0uYyA9PSBjbG9zZSAmJiB0YWdzW2ldLm8gPT0gb3BlbikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc3RyaW5naWZ5U3Vic3RpdHV0aW9ucyhvYmopIHsKICAgICAgICB2YXIgaXRlbXMgPSBbXTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgICAgICBpdGVtcy5wdXNoKCciJyArIGVzYyhrZXkpICsgJyI6IGZ1bmN0aW9uKGMscCx0LGkpIHsnICsgb2JqW2tleV0gKyAifSIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gInsgIiArIGl0ZW1zLmpvaW4oIiwiKSArICIgfSI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc3RyaW5naWZ5UGFydGlhbHMoY29kZU9iaikgewogICAgICAgIHZhciBwYXJ0aWFscyA9IFtdOwogICAgICAgIGZvciAodmFyIGtleSBpbiBjb2RlT2JqLnBhcnRpYWxzKSB7CiAgICAgICAgICBwYXJ0aWFscy5wdXNoKCciJyArIGVzYyhrZXkpICsgJyI6e25hbWU6IicgKyBlc2MoY29kZU9iai5wYXJ0aWFsc1trZXldLm5hbWUpICsgJyIsICcgKyBzdHJpbmdpZnlQYXJ0aWFscyhjb2RlT2JqLnBhcnRpYWxzW2tleV0pICsgIn0iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICJwYXJ0aWFsczogeyIgKyBwYXJ0aWFscy5qb2luKCIsIikgKyAifSwgc3ViczogIiArIHN0cmluZ2lmeVN1YnN0aXR1dGlvbnMoY29kZU9iai5zdWJzKTsKICAgICAgfQogICAgICBIb2dhbi5zdHJpbmdpZnkgPSBmdW5jdGlvbiAoY29kZU9iaiwgdGV4dCwgb3B0aW9ucykgewogICAgICAgIHJldHVybiAie2NvZGU6IGZ1bmN0aW9uIChjLHAsaSkgeyAiICsgSG9nYW4ud3JhcE1haW4oY29kZU9iai5jb2RlKSArICIgfSwiICsgc3RyaW5naWZ5UGFydGlhbHMoY29kZU9iaikgKyAifSI7CiAgICAgIH07CiAgICAgIHZhciBzZXJpYWxObyA9IDA7CiAgICAgIEhvZ2FuLmdlbmVyYXRlID0gZnVuY3Rpb24gKHRyZWUsIHRleHQsIG9wdGlvbnMpIHsKICAgICAgICBzZXJpYWxObyA9IDA7CiAgICAgICAgdmFyIGNvbnRleHQgPSB7CiAgICAgICAgICBjb2RlOiAiIiwKICAgICAgICAgIHN1YnM6IHt9LAogICAgICAgICAgcGFydGlhbHM6IHt9CiAgICAgICAgfTsKICAgICAgICBIb2dhbi53YWxrKHRyZWUsIGNvbnRleHQpOwogICAgICAgIGlmIChvcHRpb25zLmFzU3RyaW5nKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdpZnkoY29udGV4dCwgdGV4dCwgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLm1ha2VUZW1wbGF0ZShjb250ZXh0LCB0ZXh0LCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgSG9nYW4ud3JhcE1haW4gPSBmdW5jdGlvbiAoY29kZSkgewogICAgICAgIHJldHVybiAndmFyIHQ9dGhpczt0LmIoaT1pfHwiIik7JyArIGNvZGUgKyAicmV0dXJuIHQuZmwoKTsiOwogICAgICB9OwogICAgICBIb2dhbi50ZW1wbGF0ZSA9IEhvZ2FuLlRlbXBsYXRlOwogICAgICBIb2dhbi5tYWtlVGVtcGxhdGUgPSBmdW5jdGlvbiAoY29kZU9iaiwgdGV4dCwgb3B0aW9ucykgewogICAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoaXMubWFrZVBhcnRpYWxzKGNvZGVPYmopOwogICAgICAgIHRlbXBsYXRlLmNvZGUgPSBuZXcgRnVuY3Rpb24oImMiLCAicCIsICJpIiwgdGhpcy53cmFwTWFpbihjb2RlT2JqLmNvZGUpKTsKICAgICAgICByZXR1cm4gbmV3IHRoaXMudGVtcGxhdGUodGVtcGxhdGUsIHRleHQsIHRoaXMsIG9wdGlvbnMpOwogICAgICB9OwogICAgICBIb2dhbi5tYWtlUGFydGlhbHMgPSBmdW5jdGlvbiAoY29kZU9iaikgewogICAgICAgIHZhciBrZXksCiAgICAgICAgICB0ZW1wbGF0ZSA9IHsKICAgICAgICAgICAgc3Viczoge30sCiAgICAgICAgICAgIHBhcnRpYWxzOiBjb2RlT2JqLnBhcnRpYWxzLAogICAgICAgICAgICBuYW1lOiBjb2RlT2JqLm5hbWUKICAgICAgICAgIH07CiAgICAgICAgZm9yIChrZXkgaW4gdGVtcGxhdGUucGFydGlhbHMpIHsKICAgICAgICAgIHRlbXBsYXRlLnBhcnRpYWxzW2tleV0gPSB0aGlzLm1ha2VQYXJ0aWFscyh0ZW1wbGF0ZS5wYXJ0aWFsc1trZXldKTsKICAgICAgICB9CiAgICAgICAgZm9yIChrZXkgaW4gY29kZU9iai5zdWJzKSB7CiAgICAgICAgICB0ZW1wbGF0ZS5zdWJzW2tleV0gPSBuZXcgRnVuY3Rpb24oImMiLCAicCIsICJ0IiwgImkiLCBjb2RlT2JqLnN1YnNba2V5XSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgICAgfTsKICAgICAgZnVuY3Rpb24gZXNjKHMpIHsKICAgICAgICByZXR1cm4gcy5yZXBsYWNlKHJTbGFzaCwgIlxcXFwiKS5yZXBsYWNlKHJRdW90LCAnXFwiJykucmVwbGFjZShyTmV3bGluZSwgIlxcbiIpLnJlcGxhY2UockNyLCAiXFxyIikucmVwbGFjZShyTGluZVNlcCwgIlxcdTIwMjgiKS5yZXBsYWNlKHJQYXJhZ3JhcGhTZXAsICJcXHUyMDI5Iik7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY2hvb3NlTWV0aG9kKHMpIHsKICAgICAgICByZXR1cm4gfnMuaW5kZXhPZigiLiIpID8gImQiIDogImYiOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNyZWF0ZVBhcnRpYWwobm9kZSwgY29udGV4dCkgewogICAgICAgIHZhciBwcmVmaXggPSAiPCIgKyAoY29udGV4dC5wcmVmaXggfHwgIiIpOwogICAgICAgIHZhciBzeW0gPSBwcmVmaXggKyBub2RlLm4gKyBzZXJpYWxObysrOwogICAgICAgIGNvbnRleHQucGFydGlhbHNbc3ltXSA9IHsKICAgICAgICAgIG5hbWU6IG5vZGUubiwKICAgICAgICAgIHBhcnRpYWxzOiB7fQogICAgICAgIH07CiAgICAgICAgY29udGV4dC5jb2RlICs9ICd0LmIodC5ycCgiJyArIGVzYyhzeW0pICsgJyIsYyxwLCInICsgKG5vZGUuaW5kZW50IHx8ICIiKSArICciKSk7JzsKICAgICAgICByZXR1cm4gc3ltOwogICAgICB9CiAgICAgIEhvZ2FuLmNvZGVnZW4gPSB7CiAgICAgICAgIiMiOiBmdW5jdGlvbiAobm9kZSwgY29udGV4dCkgewogICAgICAgICAgY29udGV4dC5jb2RlICs9ICJpZih0LnModC4iICsgY2hvb3NlTWV0aG9kKG5vZGUubikgKyAnKCInICsgZXNjKG5vZGUubikgKyAnIixjLHAsMSksJyArICJjLHAsMCwiICsgbm9kZS5pICsgIiwiICsgbm9kZS5lbmQgKyAnLCInICsgbm9kZS5vdGFnICsgIiAiICsgbm9kZS5jdGFnICsgJyIpKXsnICsgInQucnMoYyxwLCIgKyAiZnVuY3Rpb24oYyxwLHQpeyI7CiAgICAgICAgICBIb2dhbi53YWxrKG5vZGUubm9kZXMsIGNvbnRleHQpOwogICAgICAgICAgY29udGV4dC5jb2RlICs9ICJ9KTtjLnBvcCgpO30iOwogICAgICAgIH0sCiAgICAgICAgIl4iOiBmdW5jdGlvbiAobm9kZSwgY29udGV4dCkgewogICAgICAgICAgY29udGV4dC5jb2RlICs9ICJpZighdC5zKHQuIiArIGNob29zZU1ldGhvZChub2RlLm4pICsgJygiJyArIGVzYyhub2RlLm4pICsgJyIsYyxwLDEpLGMscCwxLDAsMCwiIikpeyc7CiAgICAgICAgICBIb2dhbi53YWxrKG5vZGUubm9kZXMsIGNvbnRleHQpOwogICAgICAgICAgY29udGV4dC5jb2RlICs9ICJ9OyI7CiAgICAgICAgfSwKICAgICAgICAiPiI6IGNyZWF0ZVBhcnRpYWwsCiAgICAgICAgIjwiOiBmdW5jdGlvbiAobm9kZSwgY29udGV4dCkgewogICAgICAgICAgdmFyIGN0eCA9IHsKICAgICAgICAgICAgcGFydGlhbHM6IHt9LAogICAgICAgICAgICBjb2RlOiAiIiwKICAgICAgICAgICAgc3Viczoge30sCiAgICAgICAgICAgIGluUGFydGlhbDogdHJ1ZQogICAgICAgICAgfTsKICAgICAgICAgIEhvZ2FuLndhbGsobm9kZS5ub2RlcywgY3R4KTsKICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IGNvbnRleHQucGFydGlhbHNbY3JlYXRlUGFydGlhbChub2RlLCBjb250ZXh0KV07CiAgICAgICAgICB0ZW1wbGF0ZS5zdWJzID0gY3R4LnN1YnM7CiAgICAgICAgICB0ZW1wbGF0ZS5wYXJ0aWFscyA9IGN0eC5wYXJ0aWFsczsKICAgICAgICB9LAogICAgICAgICQ6IGZ1bmN0aW9uIChub2RlLCBjb250ZXh0KSB7CiAgICAgICAgICB2YXIgY3R4ID0gewogICAgICAgICAgICBzdWJzOiB7fSwKICAgICAgICAgICAgY29kZTogIiIsCiAgICAgICAgICAgIHBhcnRpYWxzOiBjb250ZXh0LnBhcnRpYWxzLAogICAgICAgICAgICBwcmVmaXg6IG5vZGUubgogICAgICAgICAgfTsKICAgICAgICAgIEhvZ2FuLndhbGsobm9kZS5ub2RlcywgY3R4KTsKICAgICAgICAgIGNvbnRleHQuc3Vic1tub2RlLm5dID0gY3R4LmNvZGU7CiAgICAgICAgICBpZiAoIWNvbnRleHQuaW5QYXJ0aWFsKSB7CiAgICAgICAgICAgIGNvbnRleHQuY29kZSArPSAndC5zdWIoIicgKyBlc2Mobm9kZS5uKSArICciLGMscCxpKTsnOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIlxuIjogZnVuY3Rpb24gKG5vZGUsIGNvbnRleHQpIHsKICAgICAgICAgIGNvbnRleHQuY29kZSArPSB3cml0ZSgnIlxcbiInICsgKG5vZGUubGFzdCA/ICIiIDogIiArIGkiKSk7CiAgICAgICAgfSwKICAgICAgICBfdjogZnVuY3Rpb24gKG5vZGUsIGNvbnRleHQpIHsKICAgICAgICAgIGNvbnRleHQuY29kZSArPSAidC5iKHQudih0LiIgKyBjaG9vc2VNZXRob2Qobm9kZS5uKSArICcoIicgKyBlc2Mobm9kZS5uKSArICciLGMscCwwKSkpOyc7CiAgICAgICAgfSwKICAgICAgICBfdDogZnVuY3Rpb24gKG5vZGUsIGNvbnRleHQpIHsKICAgICAgICAgIGNvbnRleHQuY29kZSArPSB3cml0ZSgnIicgKyBlc2Mobm9kZS50ZXh0KSArICciJyk7CiAgICAgICAgfSwKICAgICAgICAieyI6IHRyaXBsZVN0YWNoZSwKICAgICAgICAiJiI6IHRyaXBsZVN0YWNoZQogICAgICB9OwogICAgICBmdW5jdGlvbiB0cmlwbGVTdGFjaGUobm9kZSwgY29udGV4dCkgewogICAgICAgIGNvbnRleHQuY29kZSArPSAidC5iKHQudCh0LiIgKyBjaG9vc2VNZXRob2Qobm9kZS5uKSArICcoIicgKyBlc2Mobm9kZS5uKSArICciLGMscCwwKSkpOyc7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gd3JpdGUocykgewogICAgICAgIHJldHVybiAidC5iKCIgKyBzICsgIik7IjsKICAgICAgfQogICAgICBIb2dhbi53YWxrID0gZnVuY3Rpb24gKG5vZGVsaXN0LCBjb250ZXh0KSB7CiAgICAgICAgdmFyIGZ1bmM7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBub2RlbGlzdC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIGZ1bmMgPSBIb2dhbi5jb2RlZ2VuW25vZGVsaXN0W2ldLnRhZ107CiAgICAgICAgICBmdW5jICYmIGZ1bmMobm9kZWxpc3RbaV0sIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgfTsKICAgICAgSG9nYW4ucGFyc2UgPSBmdW5jdGlvbiAodG9rZW5zLCB0ZXh0LCBvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgcmV0dXJuIGJ1aWxkVHJlZSh0b2tlbnMsICIiLCBbXSwgb3B0aW9ucy5zZWN0aW9uVGFncyB8fCBbXSk7CiAgICAgIH07CiAgICAgIEhvZ2FuLmNhY2hlID0ge307CiAgICAgIEhvZ2FuLmNhY2hlS2V5ID0gZnVuY3Rpb24gKHRleHQsIG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gW3RleHQsICEhb3B0aW9ucy5hc1N0cmluZywgISFvcHRpb25zLmRpc2FibGVMYW1iZGEsIG9wdGlvbnMuZGVsaW1pdGVycywgISFvcHRpb25zLm1vZGVsR2V0XS5qb2luKCJ8fCIpOwogICAgICB9OwogICAgICBIb2dhbi5jb21waWxlID0gZnVuY3Rpb24gKHRleHQsIG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICB2YXIga2V5ID0gSG9nYW4uY2FjaGVLZXkodGV4dCwgb3B0aW9ucyk7CiAgICAgICAgdmFyIHRlbXBsYXRlID0gdGhpcy5jYWNoZVtrZXldOwogICAgICAgIGlmICh0ZW1wbGF0ZSkgewogICAgICAgICAgdmFyIHBhcnRpYWxzID0gdGVtcGxhdGUucGFydGlhbHM7CiAgICAgICAgICBmb3IgKHZhciBuYW1lIGluIHBhcnRpYWxzKSB7CiAgICAgICAgICAgIGRlbGV0ZSBwYXJ0aWFsc1tuYW1lXS5pbnN0YW5jZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgICAgICB9CiAgICAgICAgdGVtcGxhdGUgPSB0aGlzLmdlbmVyYXRlKHRoaXMucGFyc2UodGhpcy5zY2FuKHRleHQsIG9wdGlvbnMuZGVsaW1pdGVycyksIHRleHQsIG9wdGlvbnMpLCB0ZXh0LCBvcHRpb25zKTsKICAgICAgICByZXR1cm4gdGhpcy5jYWNoZVtrZXldID0gdGVtcGxhdGU7CiAgICAgIH07CiAgICB9KSh0cnVlID8gZXhwb3J0cyA6IEhvZ2FuKTsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICB2YXIgSG9nYW4gPSB7fTsKICAgIChmdW5jdGlvbiAoSG9nYW4pIHsKICAgICAgSG9nYW4uVGVtcGxhdGUgPSBmdW5jdGlvbiAoY29kZU9iaiwgdGV4dCwgY29tcGlsZXIsIG9wdGlvbnMpIHsKICAgICAgICBjb2RlT2JqID0gY29kZU9iaiB8fCB7fTsKICAgICAgICB0aGlzLnIgPSBjb2RlT2JqLmNvZGUgfHwgdGhpcy5yOwogICAgICAgIHRoaXMuYyA9IGNvbXBpbGVyOwogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgdGhpcy50ZXh0ID0gdGV4dCB8fCAiIjsKICAgICAgICB0aGlzLnBhcnRpYWxzID0gY29kZU9iai5wYXJ0aWFscyB8fCB7fTsKICAgICAgICB0aGlzLnN1YnMgPSBjb2RlT2JqLnN1YnMgfHwge307CiAgICAgICAgdGhpcy5idWYgPSAiIjsKICAgICAgfTsKICAgICAgSG9nYW4uVGVtcGxhdGUucHJvdG90eXBlID0gewogICAgICAgIHI6IGZ1bmN0aW9uIChjb250ZXh0LCBwYXJ0aWFscywgaW5kZW50KSB7CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfSwKICAgICAgICB2OiBob2dhbkVzY2FwZSwKICAgICAgICB0OiBjb2VyY2VUb1N0cmluZywKICAgICAgICByZW5kZXI6IGZ1bmN0aW9uIHJlbmRlcihjb250ZXh0LCBwYXJ0aWFscywgaW5kZW50KSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5yaShbY29udGV4dF0sIHBhcnRpYWxzIHx8IHt9LCBpbmRlbnQpOwogICAgICAgIH0sCiAgICAgICAgcmk6IGZ1bmN0aW9uIChjb250ZXh0LCBwYXJ0aWFscywgaW5kZW50KSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5yKGNvbnRleHQsIHBhcnRpYWxzLCBpbmRlbnQpOwogICAgICAgIH0sCiAgICAgICAgZXA6IGZ1bmN0aW9uIChzeW1ib2wsIHBhcnRpYWxzKSB7CiAgICAgICAgICB2YXIgcGFydGlhbCA9IHRoaXMucGFydGlhbHNbc3ltYm9sXTsKICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHBhcnRpYWxzW3BhcnRpYWwubmFtZV07CiAgICAgICAgICBpZiAocGFydGlhbC5pbnN0YW5jZSAmJiBwYXJ0aWFsLmJhc2UgPT0gdGVtcGxhdGUpIHsKICAgICAgICAgICAgcmV0dXJuIHBhcnRpYWwuaW5zdGFuY2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHRlbXBsYXRlID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5jKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJObyBjb21waWxlciBhdmFpbGFibGUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGVtcGxhdGUgPSB0aGlzLmMuY29tcGlsZSh0ZW1wbGF0ZSwgdGhpcy5vcHRpb25zKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnBhcnRpYWxzW3N5bWJvbF0uYmFzZSA9IHRlbXBsYXRlOwogICAgICAgICAgaWYgKHBhcnRpYWwuc3VicykgewogICAgICAgICAgICBpZiAoIXBhcnRpYWxzLnN0YWNrVGV4dCkgcGFydGlhbHMuc3RhY2tUZXh0ID0ge307CiAgICAgICAgICAgIGZvciAoa2V5IGluIHBhcnRpYWwuc3VicykgewogICAgICAgICAgICAgIGlmICghcGFydGlhbHMuc3RhY2tUZXh0W2tleV0pIHsKICAgICAgICAgICAgICAgIHBhcnRpYWxzLnN0YWNrVGV4dFtrZXldID0gdGhpcy5hY3RpdmVTdWIgIT09IHVuZGVmaW5lZCAmJiBwYXJ0aWFscy5zdGFja1RleHRbdGhpcy5hY3RpdmVTdWJdID8gcGFydGlhbHMuc3RhY2tUZXh0W3RoaXMuYWN0aXZlU3ViXSA6IHRoaXMudGV4dDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGVtcGxhdGUgPSBjcmVhdGVTcGVjaWFsaXplZFBhcnRpYWwodGVtcGxhdGUsIHBhcnRpYWwuc3VicywgcGFydGlhbC5wYXJ0aWFscywgdGhpcy5zdGFja1N1YnMsIHRoaXMuc3RhY2tQYXJ0aWFscywgcGFydGlhbHMuc3RhY2tUZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMucGFydGlhbHNbc3ltYm9sXS5pbnN0YW5jZSA9IHRlbXBsYXRlOwogICAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgICAgIH0sCiAgICAgICAgcnA6IGZ1bmN0aW9uIChzeW1ib2wsIGNvbnRleHQsIHBhcnRpYWxzLCBpbmRlbnQpIHsKICAgICAgICAgIHZhciBwYXJ0aWFsID0gdGhpcy5lcChzeW1ib2wsIHBhcnRpYWxzKTsKICAgICAgICAgIGlmICghcGFydGlhbCkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcGFydGlhbC5yaShjb250ZXh0LCBwYXJ0aWFscywgaW5kZW50KTsKICAgICAgICB9LAogICAgICAgIHJzOiBmdW5jdGlvbiAoY29udGV4dCwgcGFydGlhbHMsIHNlY3Rpb24pIHsKICAgICAgICAgIHZhciB0YWlsID0gY29udGV4dFtjb250ZXh0Lmxlbmd0aCAtIDFdOwogICAgICAgICAgaWYgKCFpc0FycmF5KHRhaWwpKSB7CiAgICAgICAgICAgIHNlY3Rpb24oY29udGV4dCwgcGFydGlhbHMsIHRoaXMpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRhaWwubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29udGV4dC5wdXNoKHRhaWxbaV0pOwogICAgICAgICAgICBzZWN0aW9uKGNvbnRleHQsIHBhcnRpYWxzLCB0aGlzKTsKICAgICAgICAgICAgY29udGV4dC5wb3AoKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHM6IGZ1bmN0aW9uICh2YWwsIGN0eCwgcGFydGlhbHMsIGludmVydGVkLCBzdGFydCwgZW5kLCB0YWdzKSB7CiAgICAgICAgICB2YXIgcGFzczsKICAgICAgICAgIGlmIChpc0FycmF5KHZhbCkgJiYgdmFsLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHZhbCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhbCA9IHRoaXMubXModmFsLCBjdHgsIHBhcnRpYWxzLCBpbnZlcnRlZCwgc3RhcnQsIGVuZCwgdGFncyk7CiAgICAgICAgICB9CiAgICAgICAgICBwYXNzID0gISF2YWw7CiAgICAgICAgICBpZiAoIWludmVydGVkICYmIHBhc3MgJiYgY3R4KSB7CiAgICAgICAgICAgIGN0eC5wdXNoKHR5cGVvZiB2YWwgPT0gIm9iamVjdCIgPyB2YWwgOiBjdHhbY3R4Lmxlbmd0aCAtIDFdKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBwYXNzOwogICAgICAgIH0sCiAgICAgICAgZDogZnVuY3Rpb24gKGtleSwgY3R4LCBwYXJ0aWFscywgcmV0dXJuRm91bmQpIHsKICAgICAgICAgIHZhciBmb3VuZCwKICAgICAgICAgICAgbmFtZXMgPSBrZXkuc3BsaXQoIi4iKSwKICAgICAgICAgICAgdmFsID0gdGhpcy5mKG5hbWVzWzBdLCBjdHgsIHBhcnRpYWxzLCByZXR1cm5Gb3VuZCksCiAgICAgICAgICAgIGRvTW9kZWxHZXQgPSB0aGlzLm9wdGlvbnMubW9kZWxHZXQsCiAgICAgICAgICAgIGN4ID0gbnVsbDsKICAgICAgICAgIGlmIChrZXkgPT09ICIuIiAmJiBpc0FycmF5KGN0eFtjdHgubGVuZ3RoIC0gMl0pKSB7CiAgICAgICAgICAgIHZhbCA9IGN0eFtjdHgubGVuZ3RoIC0gMV07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IG5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgZm91bmQgPSBmaW5kSW5TY29wZShuYW1lc1tpXSwgdmFsLCBkb01vZGVsR2V0KTsKICAgICAgICAgICAgICBpZiAoZm91bmQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgY3ggPSB2YWw7CiAgICAgICAgICAgICAgICB2YWwgPSBmb3VuZDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFsID0gIiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmV0dXJuRm91bmQgJiYgIXZhbCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXJldHVybkZvdW5kICYmIHR5cGVvZiB2YWwgPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBjdHgucHVzaChjeCk7CiAgICAgICAgICAgIHZhbCA9IHRoaXMubXYodmFsLCBjdHgsIHBhcnRpYWxzKTsKICAgICAgICAgICAgY3R4LnBvcCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICB9LAogICAgICAgIGY6IGZ1bmN0aW9uIChrZXksIGN0eCwgcGFydGlhbHMsIHJldHVybkZvdW5kKSB7CiAgICAgICAgICB2YXIgdmFsID0gZmFsc2UsCiAgICAgICAgICAgIHYgPSBudWxsLAogICAgICAgICAgICBmb3VuZCA9IGZhbHNlLAogICAgICAgICAgICBkb01vZGVsR2V0ID0gdGhpcy5vcHRpb25zLm1vZGVsR2V0OwogICAgICAgICAgZm9yICh2YXIgaSA9IGN0eC5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICB2ID0gY3R4W2ldOwogICAgICAgICAgICB2YWwgPSBmaW5kSW5TY29wZShrZXksIHYsIGRvTW9kZWxHZXQpOwogICAgICAgICAgICBpZiAodmFsICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICBmb3VuZCA9IHRydWU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghZm91bmQpIHsKICAgICAgICAgICAgcmV0dXJuIHJldHVybkZvdW5kID8gZmFsc2UgOiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghcmV0dXJuRm91bmQgJiYgdHlwZW9mIHZhbCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhbCA9IHRoaXMubXYodmFsLCBjdHgsIHBhcnRpYWxzKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgfSwKICAgICAgICBsczogZnVuY3Rpb24gKGZ1bmMsIGN4LCBwYXJ0aWFscywgdGV4dCwgdGFncykgewogICAgICAgICAgdmFyIG9sZFRhZ3MgPSB0aGlzLm9wdGlvbnMuZGVsaW1pdGVyczsKICAgICAgICAgIHRoaXMub3B0aW9ucy5kZWxpbWl0ZXJzID0gdGFnczsKICAgICAgICAgIHRoaXMuYih0aGlzLmN0KGNvZXJjZVRvU3RyaW5nKGZ1bmMuY2FsbChjeCwgdGV4dCkpLCBjeCwgcGFydGlhbHMpKTsKICAgICAgICAgIHRoaXMub3B0aW9ucy5kZWxpbWl0ZXJzID0gb2xkVGFnczsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAogICAgICAgIGN0OiBmdW5jdGlvbiAodGV4dCwgY3gsIHBhcnRpYWxzKSB7CiAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmRpc2FibGVMYW1iZGEpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJMYW1iZGEgZmVhdHVyZXMgZGlzYWJsZWQuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpcy5jLmNvbXBpbGUodGV4dCwgdGhpcy5vcHRpb25zKS5yZW5kZXIoY3gsIHBhcnRpYWxzKTsKICAgICAgICB9LAogICAgICAgIGI6IGZ1bmN0aW9uIChzKSB7CiAgICAgICAgICB0aGlzLmJ1ZiArPSBzOwogICAgICAgIH0sCiAgICAgICAgZmw6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciByID0gdGhpcy5idWY7CiAgICAgICAgICB0aGlzLmJ1ZiA9ICIiOwogICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgfSwKICAgICAgICBtczogZnVuY3Rpb24gKGZ1bmMsIGN0eCwgcGFydGlhbHMsIGludmVydGVkLCBzdGFydCwgZW5kLCB0YWdzKSB7CiAgICAgICAgICB2YXIgdGV4dFNvdXJjZSwKICAgICAgICAgICAgY3ggPSBjdHhbY3R4Lmxlbmd0aCAtIDFdLAogICAgICAgICAgICByZXN1bHQgPSBmdW5jLmNhbGwoY3gpOwogICAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQgPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpZiAoaW52ZXJ0ZWQpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0ZXh0U291cmNlID0gdGhpcy5hY3RpdmVTdWIgJiYgdGhpcy5zdWJzVGV4dCAmJiB0aGlzLnN1YnNUZXh0W3RoaXMuYWN0aXZlU3ViXSA/IHRoaXMuc3Vic1RleHRbdGhpcy5hY3RpdmVTdWJdIDogdGhpcy50ZXh0OwogICAgICAgICAgICAgIHJldHVybiB0aGlzLmxzKHJlc3VsdCwgY3gsIHBhcnRpYWxzLCB0ZXh0U291cmNlLnN1YnN0cmluZyhzdGFydCwgZW5kKSwgdGFncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSwKICAgICAgICBtdjogZnVuY3Rpb24gKGZ1bmMsIGN0eCwgcGFydGlhbHMpIHsKICAgICAgICAgIHZhciBjeCA9IGN0eFtjdHgubGVuZ3RoIC0gMV07CiAgICAgICAgICB2YXIgcmVzdWx0ID0gZnVuYy5jYWxsKGN4KTsKICAgICAgICAgIGlmICh0eXBlb2YgcmVzdWx0ID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3QoY29lcmNlVG9TdHJpbmcocmVzdWx0LmNhbGwoY3gpKSwgY3gsIHBhcnRpYWxzKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSwKICAgICAgICBzdWI6IGZ1bmN0aW9uIChuYW1lLCBjb250ZXh0LCBwYXJ0aWFscywgaW5kZW50KSB7CiAgICAgICAgICB2YXIgZiA9IHRoaXMuc3Vic1tuYW1lXTsKICAgICAgICAgIGlmIChmKSB7CiAgICAgICAgICAgIHRoaXMuYWN0aXZlU3ViID0gbmFtZTsKICAgICAgICAgICAgZihjb250ZXh0LCBwYXJ0aWFscywgdGhpcywgaW5kZW50KTsKICAgICAgICAgICAgdGhpcy5hY3RpdmVTdWIgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICAgIGZ1bmN0aW9uIGZpbmRJblNjb3BlKGtleSwgc2NvcGUsIGRvTW9kZWxHZXQpIHsKICAgICAgICB2YXIgdmFsOwogICAgICAgIGlmIChzY29wZSAmJiB0eXBlb2Ygc2NvcGUgPT0gIm9iamVjdCIpIHsKICAgICAgICAgIGlmIChzY29wZVtrZXldICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdmFsID0gc2NvcGVba2V5XTsKICAgICAgICAgIH0gZWxzZSBpZiAoZG9Nb2RlbEdldCAmJiBzY29wZS5nZXQgJiYgdHlwZW9mIHNjb3BlLmdldCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhbCA9IHNjb3BlLmdldChrZXkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNyZWF0ZVNwZWNpYWxpemVkUGFydGlhbChpbnN0YW5jZSwgc3VicywgcGFydGlhbHMsIHN0YWNrU3Vicywgc3RhY2tQYXJ0aWFscywgc3RhY2tUZXh0KSB7CiAgICAgICAgZnVuY3Rpb24gUGFydGlhbFRlbXBsYXRlKCkge30KICAgICAgICBQYXJ0aWFsVGVtcGxhdGUucHJvdG90eXBlID0gaW5zdGFuY2U7CiAgICAgICAgZnVuY3Rpb24gU3Vic3RpdHV0aW9ucygpIHt9CiAgICAgICAgU3Vic3RpdHV0aW9ucy5wcm90b3R5cGUgPSBpbnN0YW5jZS5zdWJzOwogICAgICAgIHZhciBrZXk7CiAgICAgICAgdmFyIHBhcnRpYWwgPSBuZXcgUGFydGlhbFRlbXBsYXRlKCk7CiAgICAgICAgcGFydGlhbC5zdWJzID0gbmV3IFN1YnN0aXR1dGlvbnMoKTsKICAgICAgICBwYXJ0aWFsLnN1YnNUZXh0ID0ge307CiAgICAgICAgcGFydGlhbC5idWYgPSAiIjsKICAgICAgICBzdGFja1N1YnMgPSBzdGFja1N1YnMgfHwge307CiAgICAgICAgcGFydGlhbC5zdGFja1N1YnMgPSBzdGFja1N1YnM7CiAgICAgICAgcGFydGlhbC5zdWJzVGV4dCA9IHN0YWNrVGV4dDsKICAgICAgICBmb3IgKGtleSBpbiBzdWJzKSB7CiAgICAgICAgICBpZiAoIXN0YWNrU3Vic1trZXldKSBzdGFja1N1YnNba2V5XSA9IHN1YnNba2V5XTsKICAgICAgICB9CiAgICAgICAgZm9yIChrZXkgaW4gc3RhY2tTdWJzKSB7CiAgICAgICAgICBwYXJ0aWFsLnN1YnNba2V5XSA9IHN0YWNrU3Vic1trZXldOwogICAgICAgIH0KICAgICAgICBzdGFja1BhcnRpYWxzID0gc3RhY2tQYXJ0aWFscyB8fCB7fTsKICAgICAgICBwYXJ0aWFsLnN0YWNrUGFydGlhbHMgPSBzdGFja1BhcnRpYWxzOwogICAgICAgIGZvciAoa2V5IGluIHBhcnRpYWxzKSB7CiAgICAgICAgICBpZiAoIXN0YWNrUGFydGlhbHNba2V5XSkgc3RhY2tQYXJ0aWFsc1trZXldID0gcGFydGlhbHNba2V5XTsKICAgICAgICB9CiAgICAgICAgZm9yIChrZXkgaW4gc3RhY2tQYXJ0aWFscykgewogICAgICAgICAgcGFydGlhbC5wYXJ0aWFsc1trZXldID0gc3RhY2tQYXJ0aWFsc1trZXldOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcGFydGlhbDsKICAgICAgfQogICAgICB2YXIgckFtcCA9IC8mL2csCiAgICAgICAgckx0ID0gLzwvZywKICAgICAgICByR3QgPSAvPi9nLAogICAgICAgIHJBcG9zID0gL1wnL2csCiAgICAgICAgclF1b3QgPSAvXCIvZywKICAgICAgICBoQ2hhcnMgPSAvWyY8PlwiXCddLzsKICAgICAgZnVuY3Rpb24gY29lcmNlVG9TdHJpbmcodmFsKSB7CiAgICAgICAgcmV0dXJuIFN0cmluZyh2YWwgPT09IG51bGwgfHwgdmFsID09PSB1bmRlZmluZWQgPyAiIiA6IHZhbCk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaG9nYW5Fc2NhcGUoc3RyKSB7CiAgICAgICAgc3RyID0gY29lcmNlVG9TdHJpbmcoc3RyKTsKICAgICAgICByZXR1cm4gaENoYXJzLnRlc3Qoc3RyKSA/IHN0ci5yZXBsYWNlKHJBbXAsICImYW1wOyIpLnJlcGxhY2Uockx0LCAiJmx0OyIpLnJlcGxhY2Uockd0LCAiJmd0OyIpLnJlcGxhY2UockFwb3MsICImIzM5OyIpLnJlcGxhY2UoclF1b3QsICImcXVvdDsiKSA6IHN0cjsKICAgICAgfQogICAgICB2YXIgaXNBcnJheSA9IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24gKGEpIHsKICAgICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGEpID09PSAiW29iamVjdCBBcnJheV0iOwogICAgICB9OwogICAgfSkodHJ1ZSA/IGV4cG9ydHMgOiBIb2dhbik7CiAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgInVzZSBzdHJpY3QiOwoKICAgIHZhciBBbGdvbGlhU2VhcmNoQ29yZSA9IF9fd2VicGFja19yZXF1aXJlX18oMzApOwogICAgdmFyIGNyZWF0ZUFsZ29saWFzZWFyY2ggPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQxKTsKICAgIG1vZHVsZS5leHBvcnRzID0gY3JlYXRlQWxnb2xpYXNlYXJjaChBbGdvbGlhU2VhcmNoQ29yZSwgIihsaXRlKSAiKTsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IEFsZ29saWFTZWFyY2hDb3JlOwogICAgdmFyIGVycm9ycyA9IF9fd2VicGFja19yZXF1aXJlX18oNSk7CiAgICB2YXIgZXhpdFByb21pc2UgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMxKTsKICAgIHZhciBJbmRleENvcmUgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMyKTsKICAgIHZhciBzdG9yZSA9IF9fd2VicGFja19yZXF1aXJlX18oMzgpOwogICAgdmFyIE1BWF9BUElfS0VZX0xFTkdUSCA9IDUwMDsKICAgIHZhciBSRVNFVF9BUFBfREFUQV9USU1FUiA9IE9iamVjdCh7CiAgICAgIE5PREVfRU5WOiAicHJvZHVjdGlvbiIKICAgIH0pLlJFU0VUX0FQUF9EQVRBX1RJTUVSICYmIHBhcnNlSW50KE9iamVjdCh7CiAgICAgIE5PREVfRU5WOiAicHJvZHVjdGlvbiIKICAgIH0pLlJFU0VUX0FQUF9EQVRBX1RJTUVSLCAxMCkgfHwgNjAgKiAyICogMWUzOwogICAgZnVuY3Rpb24gQWxnb2xpYVNlYXJjaENvcmUoYXBwbGljYXRpb25JRCwgYXBpS2V5LCBvcHRzKSB7CiAgICAgIHZhciBkZWJ1ZyA9IF9fd2VicGFja19yZXF1aXJlX18oOCkoImFsZ29saWFzZWFyY2giKTsKICAgICAgdmFyIGNsb25lID0gX193ZWJwYWNrX3JlcXVpcmVfXygzKTsKICAgICAgdmFyIGlzQXJyYXkgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpOwogICAgICB2YXIgbWFwID0gX193ZWJwYWNrX3JlcXVpcmVfXyg3KTsKICAgICAgdmFyIHVzYWdlID0gIlVzYWdlOiBhbGdvbGlhc2VhcmNoKGFwcGxpY2F0aW9uSUQsIGFwaUtleSwgb3B0cykiOwogICAgICBpZiAob3B0cy5fYWxsb3dFbXB0eUNyZWRlbnRpYWxzICE9PSB0cnVlICYmICFhcHBsaWNhdGlvbklEKSB7CiAgICAgICAgdGhyb3cgbmV3IGVycm9ycy5BbGdvbGlhU2VhcmNoRXJyb3IoIlBsZWFzZSBwcm92aWRlIGFuIGFwcGxpY2F0aW9uIElELiAiICsgdXNhZ2UpOwogICAgICB9CiAgICAgIGlmIChvcHRzLl9hbGxvd0VtcHR5Q3JlZGVudGlhbHMgIT09IHRydWUgJiYgIWFwaUtleSkgewogICAgICAgIHRocm93IG5ldyBlcnJvcnMuQWxnb2xpYVNlYXJjaEVycm9yKCJQbGVhc2UgcHJvdmlkZSBhbiBBUEkga2V5LiAiICsgdXNhZ2UpOwogICAgICB9CiAgICAgIHRoaXMuYXBwbGljYXRpb25JRCA9IGFwcGxpY2F0aW9uSUQ7CiAgICAgIHRoaXMuYXBpS2V5ID0gYXBpS2V5OwogICAgICB0aGlzLmhvc3RzID0gewogICAgICAgIHJlYWQ6IFtdLAogICAgICAgIHdyaXRlOiBbXQogICAgICB9OwogICAgICBvcHRzID0gb3B0cyB8fCB7fTsKICAgICAgdGhpcy5fdGltZW91dHMgPSBvcHRzLnRpbWVvdXRzIHx8IHsKICAgICAgICBjb25uZWN0OiAxICogMWUzLAogICAgICAgIHJlYWQ6IDIgKiAxZTMsCiAgICAgICAgd3JpdGU6IDMwICogMWUzCiAgICAgIH07CiAgICAgIGlmIChvcHRzLnRpbWVvdXQpIHsKICAgICAgICB0aGlzLl90aW1lb3V0cy5jb25uZWN0ID0gdGhpcy5fdGltZW91dHMucmVhZCA9IHRoaXMuX3RpbWVvdXRzLndyaXRlID0gb3B0cy50aW1lb3V0OwogICAgICB9CiAgICAgIHZhciBwcm90b2NvbCA9IG9wdHMucHJvdG9jb2wgfHwgImh0dHBzOiI7CiAgICAgIGlmICghLzokLy50ZXN0KHByb3RvY29sKSkgewogICAgICAgIHByb3RvY29sID0gcHJvdG9jb2wgKyAiOiI7CiAgICAgIH0KICAgICAgaWYgKHByb3RvY29sICE9PSAiaHR0cDoiICYmIHByb3RvY29sICE9PSAiaHR0cHM6IikgewogICAgICAgIHRocm93IG5ldyBlcnJvcnMuQWxnb2xpYVNlYXJjaEVycm9yKCJwcm90b2NvbCBtdXN0IGJlIGBodHRwOmAgb3IgYGh0dHBzOmAgKHdhcyBgIiArIG9wdHMucHJvdG9jb2wgKyAiYCkiKTsKICAgICAgfQogICAgICB0aGlzLl9jaGVja0FwcElkRGF0YSgpOwogICAgICBpZiAoIW9wdHMuaG9zdHMpIHsKICAgICAgICB2YXIgZGVmYXVsdEhvc3RzID0gbWFwKHRoaXMuX3NodWZmbGVSZXN1bHQsIGZ1bmN0aW9uIChob3N0TnVtYmVyKSB7CiAgICAgICAgICByZXR1cm4gYXBwbGljYXRpb25JRCArICItIiArIGhvc3ROdW1iZXIgKyAiLmFsZ29saWFuZXQuY29tIjsKICAgICAgICB9KTsKICAgICAgICB2YXIgbWFpblN1ZmZpeCA9IChvcHRzLmRzbiA9PT0gZmFsc2UgPyAiIiA6ICItZHNuIikgKyAiLmFsZ29saWEubmV0IjsKICAgICAgICB0aGlzLmhvc3RzLnJlYWQgPSBbdGhpcy5hcHBsaWNhdGlvbklEICsgbWFpblN1ZmZpeF0uY29uY2F0KGRlZmF1bHRIb3N0cyk7CiAgICAgICAgdGhpcy5ob3N0cy53cml0ZSA9IFt0aGlzLmFwcGxpY2F0aW9uSUQgKyAiLmFsZ29saWEubmV0Il0uY29uY2F0KGRlZmF1bHRIb3N0cyk7CiAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShvcHRzLmhvc3RzKSkgewogICAgICAgIHRoaXMuaG9zdHMucmVhZCA9IGNsb25lKG9wdHMuaG9zdHMpOwogICAgICAgIHRoaXMuaG9zdHMud3JpdGUgPSBjbG9uZShvcHRzLmhvc3RzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmhvc3RzLnJlYWQgPSBjbG9uZShvcHRzLmhvc3RzLnJlYWQpOwogICAgICAgIHRoaXMuaG9zdHMud3JpdGUgPSBjbG9uZShvcHRzLmhvc3RzLndyaXRlKTsKICAgICAgfQogICAgICB0aGlzLmhvc3RzLnJlYWQgPSBtYXAodGhpcy5ob3N0cy5yZWFkLCBwcmVwYXJlSG9zdChwcm90b2NvbCkpOwogICAgICB0aGlzLmhvc3RzLndyaXRlID0gbWFwKHRoaXMuaG9zdHMud3JpdGUsIHByZXBhcmVIb3N0KHByb3RvY29sKSk7CiAgICAgIHRoaXMuZXh0cmFIZWFkZXJzID0ge307CiAgICAgIHRoaXMuY2FjaGUgPSBvcHRzLl9jYWNoZSB8fCB7fTsKICAgICAgdGhpcy5fdWEgPSBvcHRzLl91YTsKICAgICAgdGhpcy5fdXNlQ2FjaGUgPSBvcHRzLl91c2VDYWNoZSA9PT0gdW5kZWZpbmVkIHx8IG9wdHMuX2NhY2hlID8gdHJ1ZSA6IG9wdHMuX3VzZUNhY2hlOwogICAgICB0aGlzLl91c2VSZXF1ZXN0Q2FjaGUgPSB0aGlzLl91c2VDYWNoZSAmJiBvcHRzLl91c2VSZXF1ZXN0Q2FjaGU7CiAgICAgIHRoaXMuX3VzZUZhbGxiYWNrID0gb3B0cy51c2VGYWxsYmFjayA9PT0gdW5kZWZpbmVkID8gdHJ1ZSA6IG9wdHMudXNlRmFsbGJhY2s7CiAgICAgIHRoaXMuX3NldFRpbWVvdXQgPSBvcHRzLl9zZXRUaW1lb3V0OwogICAgICBkZWJ1ZygiaW5pdCBkb25lLCAlaiIsIHRoaXMpOwogICAgfQogICAgQWxnb2xpYVNlYXJjaENvcmUucHJvdG90eXBlLmluaXRJbmRleCA9IGZ1bmN0aW9uIChpbmRleE5hbWUpIHsKICAgICAgcmV0dXJuIG5ldyBJbmRleENvcmUodGhpcywgaW5kZXhOYW1lKTsKICAgIH07CiAgICBBbGdvbGlhU2VhcmNoQ29yZS5wcm90b3R5cGUuc2V0RXh0cmFIZWFkZXIgPSBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgdGhpcy5leHRyYUhlYWRlcnNbbmFtZS50b0xvd2VyQ2FzZSgpXSA9IHZhbHVlOwogICAgfTsKICAgIEFsZ29saWFTZWFyY2hDb3JlLnByb3RvdHlwZS5nZXRFeHRyYUhlYWRlciA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIHJldHVybiB0aGlzLmV4dHJhSGVhZGVyc1tuYW1lLnRvTG93ZXJDYXNlKCldOwogICAgfTsKICAgIEFsZ29saWFTZWFyY2hDb3JlLnByb3RvdHlwZS51bnNldEV4dHJhSGVhZGVyID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgZGVsZXRlIHRoaXMuZXh0cmFIZWFkZXJzW25hbWUudG9Mb3dlckNhc2UoKV07CiAgICB9OwogICAgQWxnb2xpYVNlYXJjaENvcmUucHJvdG90eXBlLmFkZEFsZ29saWFBZ2VudCA9IGZ1bmN0aW9uIChhbGdvbGlhQWdlbnQpIHsKICAgICAgaWYgKHRoaXMuX3VhLmluZGV4T2YoIjsiICsgYWxnb2xpYUFnZW50KSA9PT0gLTEpIHsKICAgICAgICB0aGlzLl91YSArPSAiOyIgKyBhbGdvbGlhQWdlbnQ7CiAgICAgIH0KICAgIH07CiAgICBBbGdvbGlhU2VhcmNoQ29yZS5wcm90b3R5cGUuX2pzb25SZXF1ZXN0ID0gZnVuY3Rpb24gKGluaXRpYWxPcHRzKSB7CiAgICAgIHRoaXMuX2NoZWNrQXBwSWREYXRhKCk7CiAgICAgIHZhciByZXF1ZXN0RGVidWcgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDgpKCJhbGdvbGlhc2VhcmNoOiIgKyBpbml0aWFsT3B0cy51cmwpOwogICAgICB2YXIgYm9keTsKICAgICAgdmFyIGNhY2hlSUQ7CiAgICAgIHZhciBhZGRpdGlvbmFsVUEgPSBpbml0aWFsT3B0cy5hZGRpdGlvbmFsVUEgfHwgIiI7CiAgICAgIHZhciBjYWNoZSA9IGluaXRpYWxPcHRzLmNhY2hlOwogICAgICB2YXIgY2xpZW50ID0gdGhpczsKICAgICAgdmFyIHRyaWVzID0gMDsKICAgICAgdmFyIHVzaW5nRmFsbGJhY2sgPSBmYWxzZTsKICAgICAgdmFyIGhhc0ZhbGxiYWNrID0gY2xpZW50Ll91c2VGYWxsYmFjayAmJiBjbGllbnQuX3JlcXVlc3QuZmFsbGJhY2sgJiYgaW5pdGlhbE9wdHMuZmFsbGJhY2s7CiAgICAgIHZhciBoZWFkZXJzOwogICAgICBpZiAodGhpcy5hcGlLZXkubGVuZ3RoID4gTUFYX0FQSV9LRVlfTEVOR1RIICYmIGluaXRpYWxPcHRzLmJvZHkgIT09IHVuZGVmaW5lZCAmJiAoaW5pdGlhbE9wdHMuYm9keS5wYXJhbXMgIT09IHVuZGVmaW5lZCB8fCBpbml0aWFsT3B0cy5ib2R5LnJlcXVlc3RzICE9PSB1bmRlZmluZWQpKSB7CiAgICAgICAgaW5pdGlhbE9wdHMuYm9keS5hcGlLZXkgPSB0aGlzLmFwaUtleTsKICAgICAgICBoZWFkZXJzID0gdGhpcy5fY29tcHV0ZVJlcXVlc3RIZWFkZXJzKHsKICAgICAgICAgIGFkZGl0aW9uYWxVQTogYWRkaXRpb25hbFVBLAogICAgICAgICAgd2l0aEFwaUtleTogZmFsc2UsCiAgICAgICAgICBoZWFkZXJzOiBpbml0aWFsT3B0cy5oZWFkZXJzCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaGVhZGVycyA9IHRoaXMuX2NvbXB1dGVSZXF1ZXN0SGVhZGVycyh7CiAgICAgICAgICBhZGRpdGlvbmFsVUE6IGFkZGl0aW9uYWxVQSwKICAgICAgICAgIGhlYWRlcnM6IGluaXRpYWxPcHRzLmhlYWRlcnMKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoaW5pdGlhbE9wdHMuYm9keSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgYm9keSA9IHNhZmVKU09OU3RyaW5naWZ5KGluaXRpYWxPcHRzLmJvZHkpOwogICAgICB9CiAgICAgIHJlcXVlc3REZWJ1ZygicmVxdWVzdCBzdGFydCIpOwogICAgICB2YXIgZGVidWdEYXRhID0gW107CiAgICAgIGZ1bmN0aW9uIGRvUmVxdWVzdChyZXF1ZXN0ZXIsIHJlcU9wdHMpIHsKICAgICAgICBjbGllbnQuX2NoZWNrQXBwSWREYXRhKCk7CiAgICAgICAgdmFyIHN0YXJ0VGltZSA9IG5ldyBEYXRlKCk7CiAgICAgICAgaWYgKGNsaWVudC5fdXNlQ2FjaGUgJiYgIWNsaWVudC5fdXNlUmVxdWVzdENhY2hlKSB7CiAgICAgICAgICBjYWNoZUlEID0gaW5pdGlhbE9wdHMudXJsOwogICAgICAgIH0KICAgICAgICBpZiAoY2xpZW50Ll91c2VDYWNoZSAmJiAhY2xpZW50Ll91c2VSZXF1ZXN0Q2FjaGUgJiYgYm9keSkgewogICAgICAgICAgY2FjaGVJRCArPSAiX2JvZHlfIiArIHJlcU9wdHMuYm9keTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzQ2FjaGVWYWxpZFdpdGhDdXJyZW50SUQoIWNsaWVudC5fdXNlUmVxdWVzdENhY2hlLCBjYWNoZSwgY2FjaGVJRCkpIHsKICAgICAgICAgIHJlcXVlc3REZWJ1Zygic2VydmluZyByZXNwb25zZSBmcm9tIGNhY2hlIik7CiAgICAgICAgICB2YXIgcmVzcG9uc2VUZXh0ID0gY2FjaGVbY2FjaGVJRF07CiAgICAgICAgICByZXR1cm4gY2xpZW50Ll9wcm9taXNlLnJlc29sdmUoewogICAgICAgICAgICBib2R5OiBKU09OLnBhcnNlKHJlc3BvbnNlVGV4dCksCiAgICAgICAgICAgIHJlc3BvbnNlVGV4dDogcmVzcG9uc2VUZXh0CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKHRyaWVzID49IGNsaWVudC5ob3N0c1tpbml0aWFsT3B0cy5ob3N0VHlwZV0ubGVuZ3RoKSB7CiAgICAgICAgICBpZiAoIWhhc0ZhbGxiYWNrIHx8IHVzaW5nRmFsbGJhY2spIHsKICAgICAgICAgICAgcmVxdWVzdERlYnVnKCJjb3VsZCBub3QgZ2V0IGFueSByZXNwb25zZSIpOwogICAgICAgICAgICByZXR1cm4gY2xpZW50Ll9wcm9taXNlLnJlamVjdChuZXcgZXJyb3JzLkFsZ29saWFTZWFyY2hFcnJvcigiQ2Fubm90IGNvbm5lY3QgdG8gdGhlIEFsZ29saWFTZWFyY2ggQVBJLiIgKyAiIFNlbmQgYW4gZW1haWwgdG8gc3VwcG9ydEBhbGdvbGlhLmNvbSB0byByZXBvcnQgYW5kIHJlc29sdmUgdGhlIGlzc3VlLiIgKyAiIEFwcGxpY2F0aW9uIGlkIHdhczogIiArIGNsaWVudC5hcHBsaWNhdGlvbklELCB7CiAgICAgICAgICAgICAgZGVidWdEYXRhOiBkZWJ1Z0RhdGEKICAgICAgICAgICAgfSkpOwogICAgICAgICAgfQogICAgICAgICAgcmVxdWVzdERlYnVnKCJzd2l0Y2hpbmcgdG8gZmFsbGJhY2siKTsKICAgICAgICAgIHRyaWVzID0gMDsKICAgICAgICAgIHJlcU9wdHMubWV0aG9kID0gaW5pdGlhbE9wdHMuZmFsbGJhY2subWV0aG9kOwogICAgICAgICAgcmVxT3B0cy51cmwgPSBpbml0aWFsT3B0cy5mYWxsYmFjay51cmw7CiAgICAgICAgICByZXFPcHRzLmpzb25Cb2R5ID0gaW5pdGlhbE9wdHMuZmFsbGJhY2suYm9keTsKICAgICAgICAgIGlmIChyZXFPcHRzLmpzb25Cb2R5KSB7CiAgICAgICAgICAgIHJlcU9wdHMuYm9keSA9IHNhZmVKU09OU3RyaW5naWZ5KHJlcU9wdHMuanNvbkJvZHkpOwogICAgICAgICAgfQogICAgICAgICAgaGVhZGVycyA9IGNsaWVudC5fY29tcHV0ZVJlcXVlc3RIZWFkZXJzKHsKICAgICAgICAgICAgYWRkaXRpb25hbFVBOiBhZGRpdGlvbmFsVUEsCiAgICAgICAgICAgIGhlYWRlcnM6IGluaXRpYWxPcHRzLmhlYWRlcnMKICAgICAgICAgIH0pOwogICAgICAgICAgcmVxT3B0cy50aW1lb3V0cyA9IGNsaWVudC5fZ2V0VGltZW91dHNGb3JSZXF1ZXN0KGluaXRpYWxPcHRzLmhvc3RUeXBlKTsKICAgICAgICAgIGNsaWVudC5fc2V0SG9zdEluZGV4QnlUeXBlKDAsIGluaXRpYWxPcHRzLmhvc3RUeXBlKTsKICAgICAgICAgIHVzaW5nRmFsbGJhY2sgPSB0cnVlOwogICAgICAgICAgcmV0dXJuIGRvUmVxdWVzdChjbGllbnQuX3JlcXVlc3QuZmFsbGJhY2ssIHJlcU9wdHMpOwogICAgICAgIH0KICAgICAgICB2YXIgY3VycmVudEhvc3QgPSBjbGllbnQuX2dldEhvc3RCeVR5cGUoaW5pdGlhbE9wdHMuaG9zdFR5cGUpOwogICAgICAgIHZhciB1cmwgPSBjdXJyZW50SG9zdCArIHJlcU9wdHMudXJsOwogICAgICAgIHZhciBvcHRpb25zID0gewogICAgICAgICAgYm9keTogcmVxT3B0cy5ib2R5LAogICAgICAgICAganNvbkJvZHk6IHJlcU9wdHMuanNvbkJvZHksCiAgICAgICAgICBtZXRob2Q6IHJlcU9wdHMubWV0aG9kLAogICAgICAgICAgaGVhZGVyczogaGVhZGVycywKICAgICAgICAgIHRpbWVvdXRzOiByZXFPcHRzLnRpbWVvdXRzLAogICAgICAgICAgZGVidWc6IHJlcXVlc3REZWJ1ZywKICAgICAgICAgIGZvcmNlQXV0aEhlYWRlcnM6IHJlcU9wdHMuZm9yY2VBdXRoSGVhZGVycwogICAgICAgIH07CiAgICAgICAgcmVxdWVzdERlYnVnKCJtZXRob2Q6ICVzLCB1cmw6ICVzLCBoZWFkZXJzOiAlaiwgdGltZW91dHM6ICVkIiwgb3B0aW9ucy5tZXRob2QsIHVybCwgb3B0aW9ucy5oZWFkZXJzLCBvcHRpb25zLnRpbWVvdXRzKTsKICAgICAgICBpZiAocmVxdWVzdGVyID09PSBjbGllbnQuX3JlcXVlc3QuZmFsbGJhY2spIHsKICAgICAgICAgIHJlcXVlc3REZWJ1ZygidXNpbmcgZmFsbGJhY2siKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlcXVlc3Rlci5jYWxsKGNsaWVudCwgdXJsLCBvcHRpb25zKS50aGVuKHN1Y2Nlc3MsIHRyeUZhbGxiYWNrKTsKICAgICAgICBmdW5jdGlvbiBzdWNjZXNzKGh0dHBSZXNwb25zZSkgewogICAgICAgICAgdmFyIHN0YXR1cyA9IGh0dHBSZXNwb25zZSAmJiBodHRwUmVzcG9uc2UuYm9keSAmJiBodHRwUmVzcG9uc2UuYm9keS5tZXNzYWdlICYmIGh0dHBSZXNwb25zZS5ib2R5LnN0YXR1cyB8fCBodHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSB8fCBodHRwUmVzcG9uc2UgJiYgaHR0cFJlc3BvbnNlLmJvZHkgJiYgMjAwOwogICAgICAgICAgcmVxdWVzdERlYnVnKCJyZWNlaXZlZCByZXNwb25zZTogc3RhdHVzQ29kZTogJXMsIGNvbXB1dGVkIHN0YXR1c0NvZGU6ICVkLCBoZWFkZXJzOiAlaiIsIGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlLCBzdGF0dXMsIGh0dHBSZXNwb25zZS5oZWFkZXJzKTsKICAgICAgICAgIHZhciBodHRwUmVzcG9uc2VPayA9IE1hdGguZmxvb3Ioc3RhdHVzIC8gMTAwKSA9PT0gMjsKICAgICAgICAgIHZhciBlbmRUaW1lID0gbmV3IERhdGUoKTsKICAgICAgICAgIGRlYnVnRGF0YS5wdXNoKHsKICAgICAgICAgICAgY3VycmVudEhvc3Q6IGN1cnJlbnRIb3N0LAogICAgICAgICAgICBoZWFkZXJzOiByZW1vdmVDcmVkZW50aWFscyhoZWFkZXJzKSwKICAgICAgICAgICAgY29udGVudDogYm9keSB8fCBudWxsLAogICAgICAgICAgICBjb250ZW50TGVuZ3RoOiBib2R5ICE9PSB1bmRlZmluZWQgPyBib2R5Lmxlbmd0aCA6IG51bGwsCiAgICAgICAgICAgIG1ldGhvZDogcmVxT3B0cy5tZXRob2QsCiAgICAgICAgICAgIHRpbWVvdXRzOiByZXFPcHRzLnRpbWVvdXRzLAogICAgICAgICAgICB1cmw6IHJlcU9wdHMudXJsLAogICAgICAgICAgICBzdGFydFRpbWU6IHN0YXJ0VGltZSwKICAgICAgICAgICAgZW5kVGltZTogZW5kVGltZSwKICAgICAgICAgICAgZHVyYXRpb246IGVuZFRpbWUgLSBzdGFydFRpbWUsCiAgICAgICAgICAgIHN0YXR1c0NvZGU6IHN0YXR1cwogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAoaHR0cFJlc3BvbnNlT2spIHsKICAgICAgICAgICAgaWYgKGNsaWVudC5fdXNlQ2FjaGUgJiYgIWNsaWVudC5fdXNlUmVxdWVzdENhY2hlICYmIGNhY2hlKSB7CiAgICAgICAgICAgICAgY2FjaGVbY2FjaGVJRF0gPSBodHRwUmVzcG9uc2UucmVzcG9uc2VUZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgcmVzcG9uc2VUZXh0OiBodHRwUmVzcG9uc2UucmVzcG9uc2VUZXh0LAogICAgICAgICAgICAgIGJvZHk6IGh0dHBSZXNwb25zZS5ib2R5CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hvdWxkUmV0cnkgPSBNYXRoLmZsb29yKHN0YXR1cyAvIDEwMCkgIT09IDQ7CiAgICAgICAgICBpZiAoc2hvdWxkUmV0cnkpIHsKICAgICAgICAgICAgdHJpZXMgKz0gMTsKICAgICAgICAgICAgcmV0dXJuIHJldHJ5UmVxdWVzdCgpOwogICAgICAgICAgfQogICAgICAgICAgcmVxdWVzdERlYnVnKCJ1bnJlY292ZXJhYmxlIGVycm9yIik7CiAgICAgICAgICB2YXIgdW5yZWNvdmVyYWJsZUVycm9yID0gbmV3IGVycm9ycy5BbGdvbGlhU2VhcmNoRXJyb3IoaHR0cFJlc3BvbnNlLmJvZHkgJiYgaHR0cFJlc3BvbnNlLmJvZHkubWVzc2FnZSwgewogICAgICAgICAgICBkZWJ1Z0RhdGE6IGRlYnVnRGF0YSwKICAgICAgICAgICAgc3RhdHVzQ29kZTogc3RhdHVzCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBjbGllbnQuX3Byb21pc2UucmVqZWN0KHVucmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyeUZhbGxiYWNrKGVycikgewogICAgICAgICAgcmVxdWVzdERlYnVnKCJlcnJvcjogJXMsIHN0YWNrOiAlcyIsIGVyci5tZXNzYWdlLCBlcnIuc3RhY2spOwogICAgICAgICAgdmFyIGVuZFRpbWUgPSBuZXcgRGF0ZSgpOwogICAgICAgICAgZGVidWdEYXRhLnB1c2goewogICAgICAgICAgICBjdXJyZW50SG9zdDogY3VycmVudEhvc3QsCiAgICAgICAgICAgIGhlYWRlcnM6IHJlbW92ZUNyZWRlbnRpYWxzKGhlYWRlcnMpLAogICAgICAgICAgICBjb250ZW50OiBib2R5IHx8IG51bGwsCiAgICAgICAgICAgIGNvbnRlbnRMZW5ndGg6IGJvZHkgIT09IHVuZGVmaW5lZCA/IGJvZHkubGVuZ3RoIDogbnVsbCwKICAgICAgICAgICAgbWV0aG9kOiByZXFPcHRzLm1ldGhvZCwKICAgICAgICAgICAgdGltZW91dHM6IHJlcU9wdHMudGltZW91dHMsCiAgICAgICAgICAgIHVybDogcmVxT3B0cy51cmwsCiAgICAgICAgICAgIHN0YXJ0VGltZTogc3RhcnRUaW1lLAogICAgICAgICAgICBlbmRUaW1lOiBlbmRUaW1lLAogICAgICAgICAgICBkdXJhdGlvbjogZW5kVGltZSAtIHN0YXJ0VGltZQogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAoIShlcnIgaW5zdGFuY2VvZiBlcnJvcnMuQWxnb2xpYVNlYXJjaEVycm9yKSkgewogICAgICAgICAgICBlcnIgPSBuZXcgZXJyb3JzLlVua25vd24oZXJyICYmIGVyci5tZXNzYWdlLCBlcnIpOwogICAgICAgICAgfQogICAgICAgICAgdHJpZXMgKz0gMTsKICAgICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBlcnJvcnMuVW5rbm93biB8fCBlcnIgaW5zdGFuY2VvZiBlcnJvcnMuVW5wYXJzYWJsZUpTT04gfHwgdHJpZXMgPj0gY2xpZW50Lmhvc3RzW2luaXRpYWxPcHRzLmhvc3RUeXBlXS5sZW5ndGggJiYgKHVzaW5nRmFsbGJhY2sgfHwgIWhhc0ZhbGxiYWNrKSkgewogICAgICAgICAgICBlcnIuZGVidWdEYXRhID0gZGVidWdEYXRhOwogICAgICAgICAgICByZXR1cm4gY2xpZW50Ll9wcm9taXNlLnJlamVjdChlcnIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIGVycm9ycy5SZXF1ZXN0VGltZW91dCkgewogICAgICAgICAgICByZXR1cm4gcmV0cnlSZXF1ZXN0V2l0aEhpZ2hlclRpbWVvdXQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXRyeVJlcXVlc3QoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlSZXF1ZXN0KCkgewogICAgICAgICAgcmVxdWVzdERlYnVnKCJyZXRyeWluZyByZXF1ZXN0Iik7CiAgICAgICAgICBjbGllbnQuX2luY3JlbWVudEhvc3RJbmRleChpbml0aWFsT3B0cy5ob3N0VHlwZSk7CiAgICAgICAgICByZXR1cm4gZG9SZXF1ZXN0KHJlcXVlc3RlciwgcmVxT3B0cyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJldHJ5UmVxdWVzdFdpdGhIaWdoZXJUaW1lb3V0KCkgewogICAgICAgICAgcmVxdWVzdERlYnVnKCJyZXRyeWluZyByZXF1ZXN0IHdpdGggaGlnaGVyIHRpbWVvdXQiKTsKICAgICAgICAgIGNsaWVudC5faW5jcmVtZW50SG9zdEluZGV4KGluaXRpYWxPcHRzLmhvc3RUeXBlKTsKICAgICAgICAgIGNsaWVudC5faW5jcmVtZW50VGltZW91dE11bHRpcGxlcigpOwogICAgICAgICAgcmVxT3B0cy50aW1lb3V0cyA9IGNsaWVudC5fZ2V0VGltZW91dHNGb3JSZXF1ZXN0KGluaXRpYWxPcHRzLmhvc3RUeXBlKTsKICAgICAgICAgIHJldHVybiBkb1JlcXVlc3QocmVxdWVzdGVyLCByZXFPcHRzKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaXNDYWNoZVZhbGlkV2l0aEN1cnJlbnRJRCh1c2VSZXF1ZXN0Q2FjaGUsIGN1cnJlbnRDYWNoZSwgY3VycmVudENhY2hlSUQpIHsKICAgICAgICByZXR1cm4gY2xpZW50Ll91c2VDYWNoZSAmJiB1c2VSZXF1ZXN0Q2FjaGUgJiYgY3VycmVudENhY2hlICYmIGN1cnJlbnRDYWNoZVtjdXJyZW50Q2FjaGVJRF0gIT09IHVuZGVmaW5lZDsKICAgICAgfQogICAgICBmdW5jdGlvbiBpbnRlcm9wQ2FsbGJhY2tSZXR1cm4ocmVxdWVzdCwgY2FsbGJhY2spIHsKICAgICAgICBpZiAoaXNDYWNoZVZhbGlkV2l0aEN1cnJlbnRJRChjbGllbnQuX3VzZVJlcXVlc3RDYWNoZSwgY2FjaGUsIGNhY2hlSUQpKSB7CiAgICAgICAgICByZXF1ZXN0LmNhdGNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZGVsZXRlIGNhY2hlW2NhY2hlSURdOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgaW5pdGlhbE9wdHMuY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIHJlcXVlc3QudGhlbihmdW5jdGlvbiBva0NiKGNvbnRlbnQpIHsKICAgICAgICAgICAgZXhpdFByb21pc2UoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGluaXRpYWxPcHRzLmNhbGxiYWNrKG51bGwsIGNhbGxiYWNrKGNvbnRlbnQpKTsKICAgICAgICAgICAgfSwgY2xpZW50Ll9zZXRUaW1lb3V0IHx8IHNldFRpbWVvdXQpOwogICAgICAgICAgfSwgZnVuY3Rpb24gbm9va0NiKGVycikgewogICAgICAgICAgICBleGl0UHJvbWlzZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgaW5pdGlhbE9wdHMuY2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgfSwgY2xpZW50Ll9zZXRUaW1lb3V0IHx8IHNldFRpbWVvdXQpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiByZXF1ZXN0LnRoZW4oY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoY2xpZW50Ll91c2VDYWNoZSAmJiBjbGllbnQuX3VzZVJlcXVlc3RDYWNoZSkgewogICAgICAgIGNhY2hlSUQgPSBpbml0aWFsT3B0cy51cmw7CiAgICAgIH0KICAgICAgaWYgKGNsaWVudC5fdXNlQ2FjaGUgJiYgY2xpZW50Ll91c2VSZXF1ZXN0Q2FjaGUgJiYgYm9keSkgewogICAgICAgIGNhY2hlSUQgKz0gIl9ib2R5XyIgKyBib2R5OwogICAgICB9CiAgICAgIGlmIChpc0NhY2hlVmFsaWRXaXRoQ3VycmVudElEKGNsaWVudC5fdXNlUmVxdWVzdENhY2hlLCBjYWNoZSwgY2FjaGVJRCkpIHsKICAgICAgICByZXF1ZXN0RGVidWcoInNlcnZpbmcgcmVxdWVzdCBmcm9tIGNhY2hlIik7CiAgICAgICAgdmFyIG1heWJlUHJvbWlzZUZvckNhY2hlID0gY2FjaGVbY2FjaGVJRF07CiAgICAgICAgdmFyIHByb21pc2VGb3JDYWNoZSA9IHR5cGVvZiBtYXliZVByb21pc2VGb3JDYWNoZS50aGVuICE9PSAiZnVuY3Rpb24iID8gY2xpZW50Ll9wcm9taXNlLnJlc29sdmUoewogICAgICAgICAgcmVzcG9uc2VUZXh0OiBtYXliZVByb21pc2VGb3JDYWNoZQogICAgICAgIH0pIDogbWF5YmVQcm9taXNlRm9yQ2FjaGU7CiAgICAgICAgcmV0dXJuIGludGVyb3BDYWxsYmFja1JldHVybihwcm9taXNlRm9yQ2FjaGUsIGZ1bmN0aW9uIChjb250ZW50KSB7CiAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShjb250ZW50LnJlc3BvbnNlVGV4dCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgdmFyIHJlcXVlc3QgPSBkb1JlcXVlc3QoY2xpZW50Ll9yZXF1ZXN0LCB7CiAgICAgICAgdXJsOiBpbml0aWFsT3B0cy51cmwsCiAgICAgICAgbWV0aG9kOiBpbml0aWFsT3B0cy5tZXRob2QsCiAgICAgICAgYm9keTogYm9keSwKICAgICAgICBqc29uQm9keTogaW5pdGlhbE9wdHMuYm9keSwKICAgICAgICB0aW1lb3V0czogY2xpZW50Ll9nZXRUaW1lb3V0c0ZvclJlcXVlc3QoaW5pdGlhbE9wdHMuaG9zdFR5cGUpLAogICAgICAgIGZvcmNlQXV0aEhlYWRlcnM6IGluaXRpYWxPcHRzLmZvcmNlQXV0aEhlYWRlcnMKICAgICAgfSk7CiAgICAgIGlmIChjbGllbnQuX3VzZUNhY2hlICYmIGNsaWVudC5fdXNlUmVxdWVzdENhY2hlICYmIGNhY2hlKSB7CiAgICAgICAgY2FjaGVbY2FjaGVJRF0gPSByZXF1ZXN0OwogICAgICB9CiAgICAgIHJldHVybiBpbnRlcm9wQ2FsbGJhY2tSZXR1cm4ocmVxdWVzdCwgZnVuY3Rpb24gKGNvbnRlbnQpIHsKICAgICAgICByZXR1cm4gY29udGVudC5ib2R5OwogICAgICB9KTsKICAgIH07CiAgICBBbGdvbGlhU2VhcmNoQ29yZS5wcm90b3R5cGUuX2dldFNlYXJjaFBhcmFtcyA9IGZ1bmN0aW9uIChhcmdzLCBwYXJhbXMpIHsKICAgICAgaWYgKGFyZ3MgPT09IHVuZGVmaW5lZCB8fCBhcmdzID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHBhcmFtczsKICAgICAgfQogICAgICBmb3IgKHZhciBrZXkgaW4gYXJncykgewogICAgICAgIGlmIChrZXkgIT09IG51bGwgJiYgYXJnc1trZXldICE9PSB1bmRlZmluZWQgJiYgYXJncy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICBwYXJhbXMgKz0gcGFyYW1zID09PSAiIiA/ICIiIDogIiYiOwogICAgICAgICAgcGFyYW1zICs9IGtleSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoYXJnc1trZXldKSA9PT0gIltvYmplY3QgQXJyYXldIiA/IHNhZmVKU09OU3RyaW5naWZ5KGFyZ3Nba2V5XSkgOiBhcmdzW2tleV0pOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcGFyYW1zOwogICAgfTsKICAgIEFsZ29saWFTZWFyY2hDb3JlLnByb3RvdHlwZS5fY29tcHV0ZVJlcXVlc3RIZWFkZXJzID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgdmFyIGZvckVhY2ggPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIpOwogICAgICB2YXIgdWEgPSBvcHRpb25zLmFkZGl0aW9uYWxVQSA/IHRoaXMuX3VhICsgIjsiICsgb3B0aW9ucy5hZGRpdGlvbmFsVUEgOiB0aGlzLl91YTsKICAgICAgdmFyIHJlcXVlc3RIZWFkZXJzID0gewogICAgICAgICJ4LWFsZ29saWEtYWdlbnQiOiB1YSwKICAgICAgICAieC1hbGdvbGlhLWFwcGxpY2F0aW9uLWlkIjogdGhpcy5hcHBsaWNhdGlvbklECiAgICAgIH07CiAgICAgIGlmIChvcHRpb25zLndpdGhBcGlLZXkgIT09IGZhbHNlKSB7CiAgICAgICAgcmVxdWVzdEhlYWRlcnNbIngtYWxnb2xpYS1hcGkta2V5Il0gPSB0aGlzLmFwaUtleTsKICAgICAgfQogICAgICBpZiAodGhpcy51c2VyVG9rZW4pIHsKICAgICAgICByZXF1ZXN0SGVhZGVyc1sieC1hbGdvbGlhLXVzZXJ0b2tlbiJdID0gdGhpcy51c2VyVG9rZW47CiAgICAgIH0KICAgICAgaWYgKHRoaXMuc2VjdXJpdHlUYWdzKSB7CiAgICAgICAgcmVxdWVzdEhlYWRlcnNbIngtYWxnb2xpYS10YWdmaWx0ZXJzIl0gPSB0aGlzLnNlY3VyaXR5VGFnczsKICAgICAgfQogICAgICBmb3JFYWNoKHRoaXMuZXh0cmFIZWFkZXJzLCBmdW5jdGlvbiBhZGRUb1JlcXVlc3RIZWFkZXJzKHZhbHVlLCBrZXkpIHsKICAgICAgICByZXF1ZXN0SGVhZGVyc1trZXldID0gdmFsdWU7CiAgICAgIH0pOwogICAgICBpZiAob3B0aW9ucy5oZWFkZXJzKSB7CiAgICAgICAgZm9yRWFjaChvcHRpb25zLmhlYWRlcnMsIGZ1bmN0aW9uIGFkZFRvUmVxdWVzdEhlYWRlcnModmFsdWUsIGtleSkgewogICAgICAgICAgcmVxdWVzdEhlYWRlcnNba2V5XSA9IHZhbHVlOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiByZXF1ZXN0SGVhZGVyczsKICAgIH07CiAgICBBbGdvbGlhU2VhcmNoQ29yZS5wcm90b3R5cGUuc2VhcmNoID0gZnVuY3Rpb24gKHF1ZXJpZXMsIG9wdHMsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBpc0FycmF5ID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KTsKICAgICAgdmFyIG1hcCA9IF9fd2VicGFja19yZXF1aXJlX18oNyk7CiAgICAgIHZhciB1c2FnZSA9ICJVc2FnZTogY2xpZW50LnNlYXJjaChhcnJheU9mUXVlcmllc1ssIGNhbGxiYWNrXSkiOwogICAgICBpZiAoIWlzQXJyYXkocXVlcmllcykpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IodXNhZ2UpOwogICAgICB9CiAgICAgIGlmICh0eXBlb2Ygb3B0cyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIGNhbGxiYWNrID0gb3B0czsKICAgICAgICBvcHRzID0ge307CiAgICAgIH0gZWxzZSBpZiAob3B0cyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgb3B0cyA9IHt9OwogICAgICB9CiAgICAgIHZhciBjbGllbnQgPSB0aGlzOwogICAgICB2YXIgcG9zdE9iaiA9IHsKICAgICAgICByZXF1ZXN0czogbWFwKHF1ZXJpZXMsIGZ1bmN0aW9uIHByZXBhcmVSZXF1ZXN0KHF1ZXJ5KSB7CiAgICAgICAgICB2YXIgcGFyYW1zID0gIiI7CiAgICAgICAgICBpZiAocXVlcnkucXVlcnkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBwYXJhbXMgKz0gInF1ZXJ5PSIgKyBlbmNvZGVVUklDb21wb25lbnQocXVlcnkucXVlcnkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgaW5kZXhOYW1lOiBxdWVyeS5pbmRleE5hbWUsCiAgICAgICAgICAgIHBhcmFtczogY2xpZW50Ll9nZXRTZWFyY2hQYXJhbXMocXVlcnkucGFyYW1zLCBwYXJhbXMpCiAgICAgICAgICB9OwogICAgICAgIH0pCiAgICAgIH07CiAgICAgIHZhciBKU09OUFBhcmFtcyA9IG1hcChwb3N0T2JqLnJlcXVlc3RzLCBmdW5jdGlvbiBwcmVwYXJlSlNPTlBQYXJhbXMocmVxdWVzdCwgcmVxdWVzdElkKSB7CiAgICAgICAgcmV0dXJuIHJlcXVlc3RJZCArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCgiLzEvaW5kZXhlcy8iICsgZW5jb2RlVVJJQ29tcG9uZW50KHJlcXVlc3QuaW5kZXhOYW1lKSArICI/IiArIHJlcXVlc3QucGFyYW1zKTsKICAgICAgfSkuam9pbigiJiIpOwogICAgICB2YXIgdXJsID0gIi8xL2luZGV4ZXMvKi9xdWVyaWVzIjsKICAgICAgaWYgKG9wdHMuc3RyYXRlZ3kgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHBvc3RPYmouc3RyYXRlZ3kgPSBvcHRzLnN0cmF0ZWd5OwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLl9qc29uUmVxdWVzdCh7CiAgICAgICAgY2FjaGU6IHRoaXMuY2FjaGUsCiAgICAgICAgbWV0aG9kOiAiUE9TVCIsCiAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgYm9keTogcG9zdE9iaiwKICAgICAgICBob3N0VHlwZTogInJlYWQiLAogICAgICAgIGZhbGxiYWNrOiB7CiAgICAgICAgICBtZXRob2Q6ICJHRVQiLAogICAgICAgICAgdXJsOiAiLzEvaW5kZXhlcy8qIiwKICAgICAgICAgIGJvZHk6IHsKICAgICAgICAgICAgcGFyYW1zOiBKU09OUFBhcmFtcwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrCiAgICAgIH0pOwogICAgfTsKICAgIEFsZ29saWFTZWFyY2hDb3JlLnByb3RvdHlwZS5zZWFyY2hGb3JGYWNldFZhbHVlcyA9IGZ1bmN0aW9uIChxdWVyaWVzKSB7CiAgICAgIHZhciBpc0FycmF5ID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KTsKICAgICAgdmFyIG1hcCA9IF9fd2VicGFja19yZXF1aXJlX18oNyk7CiAgICAgIHZhciB1c2FnZSA9ICJVc2FnZTogY2xpZW50LnNlYXJjaEZvckZhY2V0VmFsdWVzKFt7aW5kZXhOYW1lLCBwYXJhbXM6IHtmYWNldE5hbWUsIGZhY2V0UXVlcnksIC4uLnBhcmFtc319LCAuLi5xdWVyaWVzXSkiOwogICAgICBpZiAoIWlzQXJyYXkocXVlcmllcykpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IodXNhZ2UpOwogICAgICB9CiAgICAgIHZhciBjbGllbnQgPSB0aGlzOwogICAgICByZXR1cm4gY2xpZW50Ll9wcm9taXNlLmFsbChtYXAocXVlcmllcywgZnVuY3Rpb24gcGVyZm9ybVF1ZXJ5KHF1ZXJ5KSB7CiAgICAgICAgaWYgKCFxdWVyeSB8fCBxdWVyeS5pbmRleE5hbWUgPT09IHVuZGVmaW5lZCB8fCBxdWVyeS5wYXJhbXMuZmFjZXROYW1lID09PSB1bmRlZmluZWQgfHwgcXVlcnkucGFyYW1zLmZhY2V0UXVlcnkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHVzYWdlKTsKICAgICAgICB9CiAgICAgICAgdmFyIGNsb25lID0gX193ZWJwYWNrX3JlcXVpcmVfXygzKTsKICAgICAgICB2YXIgb21pdCA9IF9fd2VicGFja19yZXF1aXJlX18oMTQpOwogICAgICAgIHZhciBpbmRleE5hbWUgPSBxdWVyeS5pbmRleE5hbWU7CiAgICAgICAgdmFyIHBhcmFtcyA9IHF1ZXJ5LnBhcmFtczsKICAgICAgICB2YXIgZmFjZXROYW1lID0gcGFyYW1zLmZhY2V0TmFtZTsKICAgICAgICB2YXIgZmlsdGVyZWRQYXJhbXMgPSBvbWl0KGNsb25lKHBhcmFtcyksIGZ1bmN0aW9uIChrZXlOYW1lKSB7CiAgICAgICAgICByZXR1cm4ga2V5TmFtZSA9PT0gImZhY2V0TmFtZSI7CiAgICAgICAgfSk7CiAgICAgICAgdmFyIHNlYXJjaFBhcmFtZXRlcnMgPSBjbGllbnQuX2dldFNlYXJjaFBhcmFtcyhmaWx0ZXJlZFBhcmFtcywgIiIpOwogICAgICAgIHJldHVybiBjbGllbnQuX2pzb25SZXF1ZXN0KHsKICAgICAgICAgIGNhY2hlOiBjbGllbnQuY2FjaGUsCiAgICAgICAgICBtZXRob2Q6ICJQT1NUIiwKICAgICAgICAgIHVybDogIi8xL2luZGV4ZXMvIiArIGVuY29kZVVSSUNvbXBvbmVudChpbmRleE5hbWUpICsgIi9mYWNldHMvIiArIGVuY29kZVVSSUNvbXBvbmVudChmYWNldE5hbWUpICsgIi9xdWVyeSIsCiAgICAgICAgICBob3N0VHlwZTogInJlYWQiLAogICAgICAgICAgYm9keTogewogICAgICAgICAgICBwYXJhbXM6IHNlYXJjaFBhcmFtZXRlcnMKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSkpOwogICAgfTsKICAgIEFsZ29saWFTZWFyY2hDb3JlLnByb3RvdHlwZS5zZXRTZWN1cml0eVRhZ3MgPSBmdW5jdGlvbiAodGFncykgewogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHRhZ3MpID09PSAiW29iamVjdCBBcnJheV0iKSB7CiAgICAgICAgdmFyIHN0clRhZ3MgPSBbXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRhZ3MubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodGFnc1tpXSkgPT09ICJbb2JqZWN0IEFycmF5XSIpIHsKICAgICAgICAgICAgdmFyIG9yZWRUYWdzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdGFnc1tpXS5sZW5ndGg7ICsraikgewogICAgICAgICAgICAgIG9yZWRUYWdzLnB1c2godGFnc1tpXVtqXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3RyVGFncy5wdXNoKCIoIiArIG9yZWRUYWdzLmpvaW4oIiwiKSArICIpIik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdHJUYWdzLnB1c2godGFnc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRhZ3MgPSBzdHJUYWdzLmpvaW4oIiwiKTsKICAgICAgfQogICAgICB0aGlzLnNlY3VyaXR5VGFncyA9IHRhZ3M7CiAgICB9OwogICAgQWxnb2xpYVNlYXJjaENvcmUucHJvdG90eXBlLnNldFVzZXJUb2tlbiA9IGZ1bmN0aW9uICh1c2VyVG9rZW4pIHsKICAgICAgdGhpcy51c2VyVG9rZW4gPSB1c2VyVG9rZW47CiAgICB9OwogICAgQWxnb2xpYVNlYXJjaENvcmUucHJvdG90eXBlLmNsZWFyQ2FjaGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuY2FjaGUgPSB7fTsKICAgIH07CiAgICBBbGdvbGlhU2VhcmNoQ29yZS5wcm90b3R5cGUuc2V0UmVxdWVzdFRpbWVvdXQgPSBmdW5jdGlvbiAobWlsbGlzZWNvbmRzKSB7CiAgICAgIGlmIChtaWxsaXNlY29uZHMpIHsKICAgICAgICB0aGlzLl90aW1lb3V0cy5jb25uZWN0ID0gdGhpcy5fdGltZW91dHMucmVhZCA9IHRoaXMuX3RpbWVvdXRzLndyaXRlID0gbWlsbGlzZWNvbmRzOwogICAgICB9CiAgICB9OwogICAgQWxnb2xpYVNlYXJjaENvcmUucHJvdG90eXBlLnNldFRpbWVvdXRzID0gZnVuY3Rpb24gKHRpbWVvdXRzKSB7CiAgICAgIHRoaXMuX3RpbWVvdXRzID0gdGltZW91dHM7CiAgICB9OwogICAgQWxnb2xpYVNlYXJjaENvcmUucHJvdG90eXBlLmdldFRpbWVvdXRzID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5fdGltZW91dHM7CiAgICB9OwogICAgQWxnb2xpYVNlYXJjaENvcmUucHJvdG90eXBlLl9nZXRBcHBJZERhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBkYXRhID0gc3RvcmUuZ2V0KHRoaXMuYXBwbGljYXRpb25JRCk7CiAgICAgIGlmIChkYXRhICE9PSBudWxsKSB0aGlzLl9jYWNoZUFwcElkRGF0YShkYXRhKTsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9OwogICAgQWxnb2xpYVNlYXJjaENvcmUucHJvdG90eXBlLl9zZXRBcHBJZERhdGEgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICBkYXRhLmxhc3RDaGFuZ2UgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgICAgdGhpcy5fY2FjaGVBcHBJZERhdGEoZGF0YSk7CiAgICAgIHJldHVybiBzdG9yZS5zZXQodGhpcy5hcHBsaWNhdGlvbklELCBkYXRhKTsKICAgIH07CiAgICBBbGdvbGlhU2VhcmNoQ29yZS5wcm90b3R5cGUuX2NoZWNrQXBwSWREYXRhID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgZGF0YSA9IHRoaXMuX2dldEFwcElkRGF0YSgpOwogICAgICB2YXIgbm93ID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAgIGlmIChkYXRhID09PSBudWxsIHx8IG5vdyAtIGRhdGEubGFzdENoYW5nZSA+IFJFU0VUX0FQUF9EQVRBX1RJTUVSKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3Jlc2V0SW5pdGlhbEFwcElkRGF0YShkYXRhKTsKICAgICAgfQogICAgICByZXR1cm4gZGF0YTsKICAgIH07CiAgICBBbGdvbGlhU2VhcmNoQ29yZS5wcm90b3R5cGUuX3Jlc2V0SW5pdGlhbEFwcElkRGF0YSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIHZhciBuZXdEYXRhID0gZGF0YSB8fCB7fTsKICAgICAgbmV3RGF0YS5ob3N0SW5kZXhlcyA9IHsKICAgICAgICByZWFkOiAwLAogICAgICAgIHdyaXRlOiAwCiAgICAgIH07CiAgICAgIG5ld0RhdGEudGltZW91dE11bHRpcGxpZXIgPSAxOwogICAgICBuZXdEYXRhLnNodWZmbGVSZXN1bHQgPSBuZXdEYXRhLnNodWZmbGVSZXN1bHQgfHwgc2h1ZmZsZShbMSwgMiwgM10pOwogICAgICByZXR1cm4gdGhpcy5fc2V0QXBwSWREYXRhKG5ld0RhdGEpOwogICAgfTsKICAgIEFsZ29saWFTZWFyY2hDb3JlLnByb3RvdHlwZS5fY2FjaGVBcHBJZERhdGEgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICB0aGlzLl9ob3N0SW5kZXhlcyA9IGRhdGEuaG9zdEluZGV4ZXM7CiAgICAgIHRoaXMuX3RpbWVvdXRNdWx0aXBsaWVyID0gZGF0YS50aW1lb3V0TXVsdGlwbGllcjsKICAgICAgdGhpcy5fc2h1ZmZsZVJlc3VsdCA9IGRhdGEuc2h1ZmZsZVJlc3VsdDsKICAgIH07CiAgICBBbGdvbGlhU2VhcmNoQ29yZS5wcm90b3R5cGUuX3BhcnRpYWxBcHBJZERhdGFVcGRhdGUgPSBmdW5jdGlvbiAobmV3RGF0YSkgewogICAgICB2YXIgZm9yZWFjaCA9IF9fd2VicGFja19yZXF1aXJlX18oMik7CiAgICAgIHZhciBjdXJyZW50RGF0YSA9IHRoaXMuX2dldEFwcElkRGF0YSgpOwogICAgICBmb3JlYWNoKG5ld0RhdGEsIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgY3VycmVudERhdGFba2V5XSA9IHZhbHVlOwogICAgICB9KTsKICAgICAgcmV0dXJuIHRoaXMuX3NldEFwcElkRGF0YShjdXJyZW50RGF0YSk7CiAgICB9OwogICAgQWxnb2xpYVNlYXJjaENvcmUucHJvdG90eXBlLl9nZXRIb3N0QnlUeXBlID0gZnVuY3Rpb24gKGhvc3RUeXBlKSB7CiAgICAgIHJldHVybiB0aGlzLmhvc3RzW2hvc3RUeXBlXVt0aGlzLl9nZXRIb3N0SW5kZXhCeVR5cGUoaG9zdFR5cGUpXTsKICAgIH07CiAgICBBbGdvbGlhU2VhcmNoQ29yZS5wcm90b3R5cGUuX2dldFRpbWVvdXRNdWx0aXBsaWVyID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5fdGltZW91dE11bHRpcGxpZXI7CiAgICB9OwogICAgQWxnb2xpYVNlYXJjaENvcmUucHJvdG90eXBlLl9nZXRIb3N0SW5kZXhCeVR5cGUgPSBmdW5jdGlvbiAoaG9zdFR5cGUpIHsKICAgICAgcmV0dXJuIHRoaXMuX2hvc3RJbmRleGVzW2hvc3RUeXBlXTsKICAgIH07CiAgICBBbGdvbGlhU2VhcmNoQ29yZS5wcm90b3R5cGUuX3NldEhvc3RJbmRleEJ5VHlwZSA9IGZ1bmN0aW9uIChob3N0SW5kZXgsIGhvc3RUeXBlKSB7CiAgICAgIHZhciBjbG9uZSA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7CiAgICAgIHZhciBuZXdIb3N0SW5kZXhlcyA9IGNsb25lKHRoaXMuX2hvc3RJbmRleGVzKTsKICAgICAgbmV3SG9zdEluZGV4ZXNbaG9zdFR5cGVdID0gaG9zdEluZGV4OwogICAgICB0aGlzLl9wYXJ0aWFsQXBwSWREYXRhVXBkYXRlKHsKICAgICAgICBob3N0SW5kZXhlczogbmV3SG9zdEluZGV4ZXMKICAgICAgfSk7CiAgICAgIHJldHVybiBob3N0SW5kZXg7CiAgICB9OwogICAgQWxnb2xpYVNlYXJjaENvcmUucHJvdG90eXBlLl9pbmNyZW1lbnRIb3N0SW5kZXggPSBmdW5jdGlvbiAoaG9zdFR5cGUpIHsKICAgICAgcmV0dXJuIHRoaXMuX3NldEhvc3RJbmRleEJ5VHlwZSgodGhpcy5fZ2V0SG9zdEluZGV4QnlUeXBlKGhvc3RUeXBlKSArIDEpICUgdGhpcy5ob3N0c1tob3N0VHlwZV0ubGVuZ3RoLCBob3N0VHlwZSk7CiAgICB9OwogICAgQWxnb2xpYVNlYXJjaENvcmUucHJvdG90eXBlLl9pbmNyZW1lbnRUaW1lb3V0TXVsdGlwbGVyID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgdGltZW91dE11bHRpcGxpZXIgPSBNYXRoLm1heCh0aGlzLl90aW1lb3V0TXVsdGlwbGllciArIDEsIDQpOwogICAgICByZXR1cm4gdGhpcy5fcGFydGlhbEFwcElkRGF0YVVwZGF0ZSh7CiAgICAgICAgdGltZW91dE11bHRpcGxpZXI6IHRpbWVvdXRNdWx0aXBsaWVyCiAgICAgIH0pOwogICAgfTsKICAgIEFsZ29saWFTZWFyY2hDb3JlLnByb3RvdHlwZS5fZ2V0VGltZW91dHNGb3JSZXF1ZXN0ID0gZnVuY3Rpb24gKGhvc3RUeXBlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgY29ubmVjdDogdGhpcy5fdGltZW91dHMuY29ubmVjdCAqIHRoaXMuX3RpbWVvdXRNdWx0aXBsaWVyLAogICAgICAgIGNvbXBsZXRlOiB0aGlzLl90aW1lb3V0c1tob3N0VHlwZV0gKiB0aGlzLl90aW1lb3V0TXVsdGlwbGllcgogICAgICB9OwogICAgfTsKICAgIGZ1bmN0aW9uIHByZXBhcmVIb3N0KHByb3RvY29sKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiBwcmVwYXJlKGhvc3QpIHsKICAgICAgICByZXR1cm4gcHJvdG9jb2wgKyAiLy8iICsgaG9zdC50b0xvd2VyQ2FzZSgpOwogICAgICB9OwogICAgfQogICAgZnVuY3Rpb24gc2FmZUpTT05TdHJpbmdpZnkob2JqKSB7CiAgICAgIGlmIChBcnJheS5wcm90b3R5cGUudG9KU09OID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkob2JqKTsKICAgICAgfQogICAgICB2YXIgdG9KU09OID0gQXJyYXkucHJvdG90eXBlLnRvSlNPTjsKICAgICAgZGVsZXRlIEFycmF5LnByb3RvdHlwZS50b0pTT047CiAgICAgIHZhciBvdXQgPSBKU09OLnN0cmluZ2lmeShvYmopOwogICAgICBBcnJheS5wcm90b3R5cGUudG9KU09OID0gdG9KU09OOwogICAgICByZXR1cm4gb3V0OwogICAgfQogICAgZnVuY3Rpb24gc2h1ZmZsZShhcnJheSkgewogICAgICB2YXIgY3VycmVudEluZGV4ID0gYXJyYXkubGVuZ3RoOwogICAgICB2YXIgdGVtcG9yYXJ5VmFsdWU7CiAgICAgIHZhciByYW5kb21JbmRleDsKICAgICAgd2hpbGUgKGN1cnJlbnRJbmRleCAhPT0gMCkgewogICAgICAgIHJhbmRvbUluZGV4ID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogY3VycmVudEluZGV4KTsKICAgICAgICBjdXJyZW50SW5kZXggLT0gMTsKICAgICAgICB0ZW1wb3JhcnlWYWx1ZSA9IGFycmF5W2N1cnJlbnRJbmRleF07CiAgICAgICAgYXJyYXlbY3VycmVudEluZGV4XSA9IGFycmF5W3JhbmRvbUluZGV4XTsKICAgICAgICBhcnJheVtyYW5kb21JbmRleF0gPSB0ZW1wb3JhcnlWYWx1ZTsKICAgICAgfQogICAgICByZXR1cm4gYXJyYXk7CiAgICB9CiAgICBmdW5jdGlvbiByZW1vdmVDcmVkZW50aWFscyhoZWFkZXJzKSB7CiAgICAgIHZhciBuZXdIZWFkZXJzID0ge307CiAgICAgIGZvciAodmFyIGhlYWRlck5hbWUgaW4gaGVhZGVycykgewogICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoaGVhZGVycywgaGVhZGVyTmFtZSkpIHsKICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgIGlmIChoZWFkZXJOYW1lID09PSAieC1hbGdvbGlhLWFwaS1rZXkiIHx8IGhlYWRlck5hbWUgPT09ICJ4LWFsZ29saWEtYXBwbGljYXRpb24taWQiKSB7CiAgICAgICAgICAgIHZhbHVlID0gIioqaGlkZGVuIGZvciBzZWN1cml0eSBwdXJwb3NlcyoqIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbHVlID0gaGVhZGVyc1toZWFkZXJOYW1lXTsKICAgICAgICAgIH0KICAgICAgICAgIG5ld0hlYWRlcnNbaGVhZGVyTmFtZV0gPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG5ld0hlYWRlcnM7CiAgICB9CiAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cykgewogICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBleGl0UHJvbWlzZShmbiwgX3NldFRpbWVvdXQpIHsKICAgICAgX3NldFRpbWVvdXQoZm4sIDApOwogICAgfTsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICB2YXIgYnVpbGRTZWFyY2hNZXRob2QgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDEzKTsKICAgIHZhciBkZXByZWNhdGUgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMzKTsKICAgIHZhciBkZXByZWNhdGVkTWVzc2FnZSA9IF9fd2VicGFja19yZXF1aXJlX18oMzQpOwogICAgbW9kdWxlLmV4cG9ydHMgPSBJbmRleENvcmU7CiAgICBmdW5jdGlvbiBJbmRleENvcmUoYWxnb2xpYXNlYXJjaCwgaW5kZXhOYW1lKSB7CiAgICAgIHRoaXMuaW5kZXhOYW1lID0gaW5kZXhOYW1lOwogICAgICB0aGlzLmFzID0gYWxnb2xpYXNlYXJjaDsKICAgICAgdGhpcy50eXBlQWhlYWRBcmdzID0gbnVsbDsKICAgICAgdGhpcy50eXBlQWhlYWRWYWx1ZU9wdGlvbiA9IG51bGw7CiAgICAgIHRoaXMuY2FjaGUgPSB7fTsKICAgIH0KICAgIEluZGV4Q29yZS5wcm90b3R5cGUuY2xlYXJDYWNoZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5jYWNoZSA9IHt9OwogICAgfTsKICAgIEluZGV4Q29yZS5wcm90b3R5cGUuc2VhcmNoID0gYnVpbGRTZWFyY2hNZXRob2QoInF1ZXJ5Iik7CiAgICBJbmRleENvcmUucHJvdG90eXBlLnNpbWlsYXJTZWFyY2ggPSBidWlsZFNlYXJjaE1ldGhvZCgic2ltaWxhclF1ZXJ5Iik7CiAgICBJbmRleENvcmUucHJvdG90eXBlLmJyb3dzZSA9IGZ1bmN0aW9uIChxdWVyeSwgcXVlcnlQYXJhbWV0ZXJzLCBjYWxsYmFjaykgewogICAgICB2YXIgbWVyZ2UgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDM1KTsKICAgICAgdmFyIGluZGV4T2JqID0gdGhpczsKICAgICAgdmFyIHBhZ2U7CiAgICAgIHZhciBoaXRzUGVyUGFnZTsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDAgfHwgYXJndW1lbnRzLmxlbmd0aCA9PT0gMSAmJiB0eXBlb2YgYXJndW1lbnRzWzBdID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgcGFnZSA9IDA7CiAgICAgICAgY2FsbGJhY2sgPSBhcmd1bWVudHNbMF07CiAgICAgICAgcXVlcnkgPSB1bmRlZmluZWQ7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gIm51bWJlciIpIHsKICAgICAgICBwYWdlID0gYXJndW1lbnRzWzBdOwogICAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzWzFdID09PSAibnVtYmVyIikgewogICAgICAgICAgaGl0c1BlclBhZ2UgPSBhcmd1bWVudHNbMV07CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJndW1lbnRzWzFdID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBjYWxsYmFjayA9IGFyZ3VtZW50c1sxXTsKICAgICAgICAgIGhpdHNQZXJQYWdlID0gdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgICBxdWVyeSA9IHVuZGVmaW5lZDsKICAgICAgICBxdWVyeVBhcmFtZXRlcnMgPSB1bmRlZmluZWQ7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gIm9iamVjdCIpIHsKICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1sxXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgY2FsbGJhY2sgPSBhcmd1bWVudHNbMV07CiAgICAgICAgfQogICAgICAgIHF1ZXJ5UGFyYW1ldGVycyA9IGFyZ3VtZW50c1swXTsKICAgICAgICBxdWVyeSA9IHVuZGVmaW5lZDsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJndW1lbnRzWzBdID09PSAic3RyaW5nIiAmJiB0eXBlb2YgYXJndW1lbnRzWzFdID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgY2FsbGJhY2sgPSBhcmd1bWVudHNbMV07CiAgICAgICAgcXVlcnlQYXJhbWV0ZXJzID0gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIHF1ZXJ5UGFyYW1ldGVycyA9IG1lcmdlKHt9LCBxdWVyeVBhcmFtZXRlcnMgfHwge30sIHsKICAgICAgICBwYWdlOiBwYWdlLAogICAgICAgIGhpdHNQZXJQYWdlOiBoaXRzUGVyUGFnZSwKICAgICAgICBxdWVyeTogcXVlcnkKICAgICAgfSk7CiAgICAgIHZhciBwYXJhbXMgPSB0aGlzLmFzLl9nZXRTZWFyY2hQYXJhbXMocXVlcnlQYXJhbWV0ZXJzLCAiIik7CiAgICAgIHJldHVybiB0aGlzLmFzLl9qc29uUmVxdWVzdCh7CiAgICAgICAgbWV0aG9kOiAiUE9TVCIsCiAgICAgICAgdXJsOiAiLzEvaW5kZXhlcy8iICsgZW5jb2RlVVJJQ29tcG9uZW50KGluZGV4T2JqLmluZGV4TmFtZSkgKyAiL2Jyb3dzZSIsCiAgICAgICAgYm9keTogewogICAgICAgICAgcGFyYW1zOiBwYXJhbXMKICAgICAgICB9LAogICAgICAgIGhvc3RUeXBlOiAicmVhZCIsCiAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrCiAgICAgIH0pOwogICAgfTsKICAgIEluZGV4Q29yZS5wcm90b3R5cGUuYnJvd3NlRnJvbSA9IGZ1bmN0aW9uIChjdXJzb3IsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLmFzLl9qc29uUmVxdWVzdCh7CiAgICAgICAgbWV0aG9kOiAiUE9TVCIsCiAgICAgICAgdXJsOiAiLzEvaW5kZXhlcy8iICsgZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMuaW5kZXhOYW1lKSArICIvYnJvd3NlIiwKICAgICAgICBib2R5OiB7CiAgICAgICAgICBjdXJzb3I6IGN1cnNvcgogICAgICAgIH0sCiAgICAgICAgaG9zdFR5cGU6ICJyZWFkIiwKICAgICAgICBjYWxsYmFjazogY2FsbGJhY2sKICAgICAgfSk7CiAgICB9OwogICAgSW5kZXhDb3JlLnByb3RvdHlwZS5zZWFyY2hGb3JGYWNldFZhbHVlcyA9IGZ1bmN0aW9uIChwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBjbG9uZSA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7CiAgICAgIHZhciBvbWl0ID0gX193ZWJwYWNrX3JlcXVpcmVfXygxNCk7CiAgICAgIHZhciB1c2FnZSA9ICJVc2FnZTogaW5kZXguc2VhcmNoRm9yRmFjZXRWYWx1ZXMoe2ZhY2V0TmFtZSwgZmFjZXRRdWVyeSwgLi4ucGFyYW1zfVssIGNhbGxiYWNrXSkiOwogICAgICBpZiAocGFyYW1zLmZhY2V0TmFtZSA9PT0gdW5kZWZpbmVkIHx8IHBhcmFtcy5mYWNldFF1ZXJ5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IodXNhZ2UpOwogICAgICB9CiAgICAgIHZhciBmYWNldE5hbWUgPSBwYXJhbXMuZmFjZXROYW1lOwogICAgICB2YXIgZmlsdGVyZWRQYXJhbXMgPSBvbWl0KGNsb25lKHBhcmFtcyksIGZ1bmN0aW9uIChrZXlOYW1lKSB7CiAgICAgICAgcmV0dXJuIGtleU5hbWUgPT09ICJmYWNldE5hbWUiOwogICAgICB9KTsKICAgICAgdmFyIHNlYXJjaFBhcmFtZXRlcnMgPSB0aGlzLmFzLl9nZXRTZWFyY2hQYXJhbXMoZmlsdGVyZWRQYXJhbXMsICIiKTsKICAgICAgcmV0dXJuIHRoaXMuYXMuX2pzb25SZXF1ZXN0KHsKICAgICAgICBtZXRob2Q6ICJQT1NUIiwKICAgICAgICB1cmw6ICIvMS9pbmRleGVzLyIgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy5pbmRleE5hbWUpICsgIi9mYWNldHMvIiArIGVuY29kZVVSSUNvbXBvbmVudChmYWNldE5hbWUpICsgIi9xdWVyeSIsCiAgICAgICAgaG9zdFR5cGU6ICJyZWFkIiwKICAgICAgICBib2R5OiB7CiAgICAgICAgICBwYXJhbXM6IHNlYXJjaFBhcmFtZXRlcnMKICAgICAgICB9LAogICAgICAgIGNhbGxiYWNrOiBjYWxsYmFjawogICAgICB9KTsKICAgIH07CiAgICBJbmRleENvcmUucHJvdG90eXBlLnNlYXJjaEZhY2V0ID0gZGVwcmVjYXRlKGZ1bmN0aW9uIChwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLnNlYXJjaEZvckZhY2V0VmFsdWVzKHBhcmFtcywgY2FsbGJhY2spOwogICAgfSwgZGVwcmVjYXRlZE1lc3NhZ2UoImluZGV4LnNlYXJjaEZhY2V0KHBhcmFtc1ssIGNhbGxiYWNrXSkiLCAiaW5kZXguc2VhcmNoRm9yRmFjZXRWYWx1ZXMocGFyYW1zWywgY2FsbGJhY2tdKSIpKTsKICAgIEluZGV4Q29yZS5wcm90b3R5cGUuX3NlYXJjaCA9IGZ1bmN0aW9uIChwYXJhbXMsIHVybCwgY2FsbGJhY2ssIGFkZGl0aW9uYWxVQSkgewogICAgICByZXR1cm4gdGhpcy5hcy5fanNvblJlcXVlc3QoewogICAgICAgIGNhY2hlOiB0aGlzLmNhY2hlLAogICAgICAgIG1ldGhvZDogIlBPU1QiLAogICAgICAgIHVybDogdXJsIHx8ICIvMS9pbmRleGVzLyIgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy5pbmRleE5hbWUpICsgIi9xdWVyeSIsCiAgICAgICAgYm9keTogewogICAgICAgICAgcGFyYW1zOiBwYXJhbXMKICAgICAgICB9LAogICAgICAgIGhvc3RUeXBlOiAicmVhZCIsCiAgICAgICAgZmFsbGJhY2s6IHsKICAgICAgICAgIG1ldGhvZDogIkdFVCIsCiAgICAgICAgICB1cmw6ICIvMS9pbmRleGVzLyIgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy5pbmRleE5hbWUpLAogICAgICAgICAgYm9keTogewogICAgICAgICAgICBwYXJhbXM6IHBhcmFtcwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrLAogICAgICAgIGFkZGl0aW9uYWxVQTogYWRkaXRpb25hbFVBCiAgICAgIH0pOwogICAgfTsKICAgIEluZGV4Q29yZS5wcm90b3R5cGUuZ2V0T2JqZWN0ID0gZnVuY3Rpb24gKG9iamVjdElELCBhdHRycywgY2FsbGJhY2spIHsKICAgICAgdmFyIGluZGV4T2JqID0gdGhpczsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEgfHwgdHlwZW9mIGF0dHJzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgY2FsbGJhY2sgPSBhdHRyczsKICAgICAgICBhdHRycyA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgICB2YXIgcGFyYW1zID0gIiI7CiAgICAgIGlmIChhdHRycyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcGFyYW1zID0gIj9hdHRyaWJ1dGVzPSI7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhdHRycy5sZW5ndGg7ICsraSkgewogICAgICAgICAgaWYgKGkgIT09IDApIHsKICAgICAgICAgICAgcGFyYW1zICs9ICIsIjsKICAgICAgICAgIH0KICAgICAgICAgIHBhcmFtcyArPSBhdHRyc1tpXTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuYXMuX2pzb25SZXF1ZXN0KHsKICAgICAgICBtZXRob2Q6ICJHRVQiLAogICAgICAgIHVybDogIi8xL2luZGV4ZXMvIiArIGVuY29kZVVSSUNvbXBvbmVudChpbmRleE9iai5pbmRleE5hbWUpICsgIi8iICsgZW5jb2RlVVJJQ29tcG9uZW50KG9iamVjdElEKSArIHBhcmFtcywKICAgICAgICBob3N0VHlwZTogInJlYWQiLAogICAgICAgIGNhbGxiYWNrOiBjYWxsYmFjawogICAgICB9KTsKICAgIH07CiAgICBJbmRleENvcmUucHJvdG90eXBlLmdldE9iamVjdHMgPSBmdW5jdGlvbiAob2JqZWN0SURzLCBhdHRyaWJ1dGVzVG9SZXRyaWV2ZSwgY2FsbGJhY2spIHsKICAgICAgdmFyIGlzQXJyYXkgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpOwogICAgICB2YXIgbWFwID0gX193ZWJwYWNrX3JlcXVpcmVfXyg3KTsKICAgICAgdmFyIHVzYWdlID0gIlVzYWdlOiBpbmRleC5nZXRPYmplY3RzKGFycmF5T2ZPYmplY3RJRHNbLCBjYWxsYmFja10pIjsKICAgICAgaWYgKCFpc0FycmF5KG9iamVjdElEcykpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IodXNhZ2UpOwogICAgICB9CiAgICAgIHZhciBpbmRleE9iaiA9IHRoaXM7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxIHx8IHR5cGVvZiBhdHRyaWJ1dGVzVG9SZXRyaWV2ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIGNhbGxiYWNrID0gYXR0cmlidXRlc1RvUmV0cmlldmU7CiAgICAgICAgYXR0cmlidXRlc1RvUmV0cmlldmUgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgdmFyIGJvZHkgPSB7CiAgICAgICAgcmVxdWVzdHM6IG1hcChvYmplY3RJRHMsIGZ1bmN0aW9uIHByZXBhcmVSZXF1ZXN0KG9iamVjdElEKSB7CiAgICAgICAgICB2YXIgcmVxdWVzdCA9IHsKICAgICAgICAgICAgaW5kZXhOYW1lOiBpbmRleE9iai5pbmRleE5hbWUsCiAgICAgICAgICAgIG9iamVjdElEOiBvYmplY3RJRAogICAgICAgICAgfTsKICAgICAgICAgIGlmIChhdHRyaWJ1dGVzVG9SZXRyaWV2ZSkgewogICAgICAgICAgICByZXF1ZXN0LmF0dHJpYnV0ZXNUb1JldHJpZXZlID0gYXR0cmlidXRlc1RvUmV0cmlldmUuam9pbigiLCIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlcXVlc3Q7CiAgICAgICAgfSkKICAgICAgfTsKICAgICAgcmV0dXJuIHRoaXMuYXMuX2pzb25SZXF1ZXN0KHsKICAgICAgICBtZXRob2Q6ICJQT1NUIiwKICAgICAgICB1cmw6ICIvMS9pbmRleGVzLyovb2JqZWN0cyIsCiAgICAgICAgaG9zdFR5cGU6ICJyZWFkIiwKICAgICAgICBib2R5OiBib2R5LAogICAgICAgIGNhbGxiYWNrOiBjYWxsYmFjawogICAgICB9KTsKICAgIH07CiAgICBJbmRleENvcmUucHJvdG90eXBlLmFzID0gbnVsbDsKICAgIEluZGV4Q29yZS5wcm90b3R5cGUuaW5kZXhOYW1lID0gbnVsbDsKICAgIEluZGV4Q29yZS5wcm90b3R5cGUudHlwZUFoZWFkQXJncyA9IG51bGw7CiAgICBJbmRleENvcmUucHJvdG90eXBlLnR5cGVBaGVhZFZhbHVlT3B0aW9uID0gbnVsbDsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGRlcHJlY2F0ZShmbiwgbWVzc2FnZSkgewogICAgICB2YXIgd2FybmVkID0gZmFsc2U7CiAgICAgIGZ1bmN0aW9uIGRlcHJlY2F0ZWQoKSB7CiAgICAgICAgaWYgKCF3YXJuZWQpIHsKICAgICAgICAgIGNvbnNvbGUud2FybihtZXNzYWdlKTsKICAgICAgICAgIHdhcm5lZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICAgIHJldHVybiBkZXByZWNhdGVkOwogICAgfTsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGRlcHJlY2F0ZWRNZXNzYWdlKHByZXZpb3VzVXNhZ2UsIG5ld1VzYWdlKSB7CiAgICAgIHZhciBnaXRodWJBbmNob3JMaW5rID0gcHJldmlvdXNVc2FnZS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL1tcLlwoXCldL2csICIiKTsKICAgICAgcmV0dXJuICJhbGdvbGlhc2VhcmNoOiBgIiArIHByZXZpb3VzVXNhZ2UgKyAiYCB3YXMgcmVwbGFjZWQgYnkgYCIgKyBuZXdVc2FnZSArICJgLiBQbGVhc2Ugc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hbGdvbGlhL2FsZ29saWFzZWFyY2gtY2xpZW50LWphdmFzY3JpcHQvd2lraS9EZXByZWNhdGVkIyIgKyBnaXRodWJBbmNob3JMaW5rOwogICAgfTsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICB2YXIgZm9yZWFjaCA9IF9fd2VicGFja19yZXF1aXJlX18oMik7CiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIG1lcmdlKGRlc3RpbmF0aW9uKSB7CiAgICAgIHZhciBzb3VyY2VzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgZm9yZWFjaChzb3VyY2VzLCBmdW5jdGlvbiAoc291cmNlKSB7CiAgICAgICAgZm9yICh2YXIga2V5TmFtZSBpbiBzb3VyY2UpIHsKICAgICAgICAgIGlmIChzb3VyY2UuaGFzT3duUHJvcGVydHkoa2V5TmFtZSkpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBkZXN0aW5hdGlvbltrZXlOYW1lXSA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHNvdXJjZVtrZXlOYW1lXSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICBkZXN0aW5hdGlvbltrZXlOYW1lXSA9IG1lcmdlKHt9LCBkZXN0aW5hdGlvbltrZXlOYW1lXSwgc291cmNlW2tleU5hbWVdKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChzb3VyY2Vba2V5TmFtZV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIGRlc3RpbmF0aW9uW2tleU5hbWVdID0gc291cmNlW2tleU5hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIGRlc3RpbmF0aW9uOwogICAgfTsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgdmFyIGhhcyA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICB2YXIgdG9TdHIgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwogICAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwogICAgdmFyIGlzQXJncyA9IF9fd2VicGFja19yZXF1aXJlX18oMzcpOwogICAgdmFyIGlzRW51bWVyYWJsZSA9IE9iamVjdC5wcm90b3R5cGUucHJvcGVydHlJc0VudW1lcmFibGU7CiAgICB2YXIgaGFzRG9udEVudW1CdWcgPSAhaXNFbnVtZXJhYmxlLmNhbGwoewogICAgICB0b1N0cmluZzogbnVsbAogICAgfSwgInRvU3RyaW5nIik7CiAgICB2YXIgaGFzUHJvdG9FbnVtQnVnID0gaXNFbnVtZXJhYmxlLmNhbGwoZnVuY3Rpb24gKCkge30sICJwcm90b3R5cGUiKTsKICAgIHZhciBkb250RW51bXMgPSBbInRvU3RyaW5nIiwgInRvTG9jYWxlU3RyaW5nIiwgInZhbHVlT2YiLCAiaGFzT3duUHJvcGVydHkiLCAiaXNQcm90b3R5cGVPZiIsICJwcm9wZXJ0eUlzRW51bWVyYWJsZSIsICJjb25zdHJ1Y3RvciJdOwogICAgdmFyIGVxdWFsc0NvbnN0cnVjdG9yUHJvdG90eXBlID0gZnVuY3Rpb24gKG8pIHsKICAgICAgdmFyIGN0b3IgPSBvLmNvbnN0cnVjdG9yOwogICAgICByZXR1cm4gY3RvciAmJiBjdG9yLnByb3RvdHlwZSA9PT0gbzsKICAgIH07CiAgICB2YXIgZXhjbHVkZWRLZXlzID0gewogICAgICAkYXBwbGljYXRpb25DYWNoZTogdHJ1ZSwKICAgICAgJGNvbnNvbGU6IHRydWUsCiAgICAgICRleHRlcm5hbDogdHJ1ZSwKICAgICAgJGZyYW1lOiB0cnVlLAogICAgICAkZnJhbWVFbGVtZW50OiB0cnVlLAogICAgICAkZnJhbWVzOiB0cnVlLAogICAgICAkaW5uZXJIZWlnaHQ6IHRydWUsCiAgICAgICRpbm5lcldpZHRoOiB0cnVlLAogICAgICAkb3V0ZXJIZWlnaHQ6IHRydWUsCiAgICAgICRvdXRlcldpZHRoOiB0cnVlLAogICAgICAkcGFnZVhPZmZzZXQ6IHRydWUsCiAgICAgICRwYWdlWU9mZnNldDogdHJ1ZSwKICAgICAgJHBhcmVudDogdHJ1ZSwKICAgICAgJHNjcm9sbExlZnQ6IHRydWUsCiAgICAgICRzY3JvbGxUb3A6IHRydWUsCiAgICAgICRzY3JvbGxYOiB0cnVlLAogICAgICAkc2Nyb2xsWTogdHJ1ZSwKICAgICAgJHNlbGY6IHRydWUsCiAgICAgICR3ZWJraXRJbmRleGVkREI6IHRydWUsCiAgICAgICR3ZWJraXRTdG9yYWdlSW5mbzogdHJ1ZSwKICAgICAgJHdpbmRvdzogdHJ1ZQogICAgfTsKICAgIHZhciBoYXNBdXRvbWF0aW9uRXF1YWxpdHlCdWcgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh0eXBlb2Ygd2luZG93ID09PSAidW5kZWZpbmVkIikgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBmb3IgKHZhciBrIGluIHdpbmRvdykgewogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoIWV4Y2x1ZGVkS2V5c1siJCIgKyBrXSAmJiBoYXMuY2FsbCh3aW5kb3csIGspICYmIHdpbmRvd1trXSAhPT0gbnVsbCAmJiB0eXBlb2Ygd2luZG93W2tdID09PSAib2JqZWN0IikgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGVxdWFsc0NvbnN0cnVjdG9yUHJvdG90eXBlKHdpbmRvd1trXSk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9KCk7CiAgICB2YXIgZXF1YWxzQ29uc3RydWN0b3JQcm90b3R5cGVJZk5vdEJ1Z2d5ID0gZnVuY3Rpb24gKG8pIHsKICAgICAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICJ1bmRlZmluZWQiIHx8ICFoYXNBdXRvbWF0aW9uRXF1YWxpdHlCdWcpIHsKICAgICAgICByZXR1cm4gZXF1YWxzQ29uc3RydWN0b3JQcm90b3R5cGUobyk7CiAgICAgIH0KICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gZXF1YWxzQ29uc3RydWN0b3JQcm90b3R5cGUobyk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH07CiAgICB2YXIga2V5c1NoaW0gPSBmdW5jdGlvbiBrZXlzKG9iamVjdCkgewogICAgICB2YXIgaXNPYmplY3QgPSBvYmplY3QgIT09IG51bGwgJiYgdHlwZW9mIG9iamVjdCA9PT0gIm9iamVjdCI7CiAgICAgIHZhciBpc0Z1bmN0aW9uID0gdG9TdHIuY2FsbChvYmplY3QpID09PSAiW29iamVjdCBGdW5jdGlvbl0iOwogICAgICB2YXIgaXNBcmd1bWVudHMgPSBpc0FyZ3Mob2JqZWN0KTsKICAgICAgdmFyIGlzU3RyaW5nID0gaXNPYmplY3QgJiYgdG9TdHIuY2FsbChvYmplY3QpID09PSAiW29iamVjdCBTdHJpbmddIjsKICAgICAgdmFyIHRoZUtleXMgPSBbXTsKICAgICAgaWYgKCFpc09iamVjdCAmJiAhaXNGdW5jdGlvbiAmJiAhaXNBcmd1bWVudHMpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJPYmplY3Qua2V5cyBjYWxsZWQgb24gYSBub24tb2JqZWN0Iik7CiAgICAgIH0KICAgICAgdmFyIHNraXBQcm90byA9IGhhc1Byb3RvRW51bUJ1ZyAmJiBpc0Z1bmN0aW9uOwogICAgICBpZiAoaXNTdHJpbmcgJiYgb2JqZWN0Lmxlbmd0aCA+IDAgJiYgIWhhcy5jYWxsKG9iamVjdCwgMCkpIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iamVjdC5sZW5ndGg7ICsraSkgewogICAgICAgICAgdGhlS2V5cy5wdXNoKFN0cmluZyhpKSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChpc0FyZ3VtZW50cyAmJiBvYmplY3QubGVuZ3RoID4gMCkgewogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgb2JqZWN0Lmxlbmd0aDsgKytqKSB7CiAgICAgICAgICB0aGVLZXlzLnB1c2goU3RyaW5nKGopKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBvYmplY3QpIHsKICAgICAgICAgIGlmICghKHNraXBQcm90byAmJiBuYW1lID09PSAicHJvdG90eXBlIikgJiYgaGFzLmNhbGwob2JqZWN0LCBuYW1lKSkgewogICAgICAgICAgICB0aGVLZXlzLnB1c2goU3RyaW5nKG5hbWUpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGhhc0RvbnRFbnVtQnVnKSB7CiAgICAgICAgdmFyIHNraXBDb25zdHJ1Y3RvciA9IGVxdWFsc0NvbnN0cnVjdG9yUHJvdG90eXBlSWZOb3RCdWdneShvYmplY3QpOwogICAgICAgIGZvciAodmFyIGsgPSAwOyBrIDwgZG9udEVudW1zLmxlbmd0aDsgKytrKSB7CiAgICAgICAgICBpZiAoIShza2lwQ29uc3RydWN0b3IgJiYgZG9udEVudW1zW2tdID09PSAiY29uc3RydWN0b3IiKSAmJiBoYXMuY2FsbChvYmplY3QsIGRvbnRFbnVtc1trXSkpIHsKICAgICAgICAgICAgdGhlS2V5cy5wdXNoKGRvbnRFbnVtc1trXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGVLZXlzOwogICAgfTsKICAgIGtleXNTaGltLnNoaW0gPSBmdW5jdGlvbiBzaGltT2JqZWN0S2V5cygpIHsKICAgICAgaWYgKE9iamVjdC5rZXlzKSB7CiAgICAgICAgdmFyIGtleXNXb3Jrc1dpdGhBcmd1bWVudHMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gKE9iamVjdC5rZXlzKGFyZ3VtZW50cykgfHwgIiIpLmxlbmd0aCA9PT0gMjsKICAgICAgICB9KDEsIDIpOwogICAgICAgIGlmICgha2V5c1dvcmtzV2l0aEFyZ3VtZW50cykgewogICAgICAgICAgdmFyIG9yaWdpbmFsS2V5cyA9IE9iamVjdC5rZXlzOwogICAgICAgICAgT2JqZWN0LmtleXMgPSBmdW5jdGlvbiBrZXlzKG9iamVjdCkgewogICAgICAgICAgICBpZiAoaXNBcmdzKG9iamVjdCkpIHsKICAgICAgICAgICAgICByZXR1cm4gb3JpZ2luYWxLZXlzKHNsaWNlLmNhbGwob2JqZWN0KSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsS2V5cyhvYmplY3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBPYmplY3Qua2V5cyA9IGtleXNTaGltOwogICAgICB9CiAgICAgIHJldHVybiBPYmplY3Qua2V5cyB8fCBrZXlzU2hpbTsKICAgIH07CiAgICBtb2R1bGUuZXhwb3J0cyA9IGtleXNTaGltOwogIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICB2YXIgdG9TdHIgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwogICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBpc0FyZ3VtZW50cyh2YWx1ZSkgewogICAgICB2YXIgc3RyID0gdG9TdHIuY2FsbCh2YWx1ZSk7CiAgICAgIHZhciBpc0FyZ3MgPSBzdHIgPT09ICJbb2JqZWN0IEFyZ3VtZW50c10iOwogICAgICBpZiAoIWlzQXJncykgewogICAgICAgIGlzQXJncyA9IHN0ciAhPT0gIltvYmplY3QgQXJyYXldIiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHR5cGVvZiB2YWx1ZS5sZW5ndGggPT09ICJudW1iZXIiICYmIHZhbHVlLmxlbmd0aCA+PSAwICYmIHRvU3RyLmNhbGwodmFsdWUuY2FsbGVlKSA9PT0gIltvYmplY3QgRnVuY3Rpb25dIjsKICAgICAgfQogICAgICByZXR1cm4gaXNBcmdzOwogICAgfTsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAoZnVuY3Rpb24gKGdsb2JhbCkgewogICAgICB2YXIgZGVidWcgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDgpKCJhbGdvbGlhc2VhcmNoOnNyYy9ob3N0SW5kZXhTdGF0ZS5qcyIpOwogICAgICB2YXIgbG9jYWxTdG9yYWdlTmFtZXNwYWNlID0gImFsZ29saWFzZWFyY2gtY2xpZW50LWpzIjsKICAgICAgdmFyIHN0b3JlOwogICAgICB2YXIgbW9kdWxlU3RvcmUgPSB7CiAgICAgICAgc3RhdGU6IHt9LAogICAgICAgIHNldDogZnVuY3Rpb24gKGtleSwgZGF0YSkgewogICAgICAgICAgdGhpcy5zdGF0ZVtrZXldID0gZGF0YTsKICAgICAgICAgIHJldHVybiB0aGlzLnN0YXRlW2tleV07CiAgICAgICAgfSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnN0YXRlW2tleV0gfHwgbnVsbDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIHZhciBsb2NhbFN0b3JhZ2VTdG9yZSA9IHsKICAgICAgICBzZXQ6IGZ1bmN0aW9uIChrZXksIGRhdGEpIHsKICAgICAgICAgIG1vZHVsZVN0b3JlLnNldChrZXksIGRhdGEpOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIG5hbWVzcGFjZSA9IEpTT04ucGFyc2UoZ2xvYmFsLmxvY2FsU3RvcmFnZVtsb2NhbFN0b3JhZ2VOYW1lc3BhY2VdKTsKICAgICAgICAgICAgbmFtZXNwYWNlW2tleV0gPSBkYXRhOwogICAgICAgICAgICBnbG9iYWwubG9jYWxTdG9yYWdlW2xvY2FsU3RvcmFnZU5hbWVzcGFjZV0gPSBKU09OLnN0cmluZ2lmeShuYW1lc3BhY2UpOwogICAgICAgICAgICByZXR1cm4gbmFtZXNwYWNlW2tleV07CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBsb2NhbFN0b3JhZ2VGYWlsdXJlKGtleSwgZSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKGdsb2JhbC5sb2NhbFN0b3JhZ2VbbG9jYWxTdG9yYWdlTmFtZXNwYWNlXSlba2V5XSB8fCBudWxsOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gbG9jYWxTdG9yYWdlRmFpbHVyZShrZXksIGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgZnVuY3Rpb24gbG9jYWxTdG9yYWdlRmFpbHVyZShrZXksIGUpIHsKICAgICAgICBkZWJ1ZygibG9jYWxTdG9yYWdlIGZhaWxlZCB3aXRoIiwgZSk7CiAgICAgICAgY2xlYW51cCgpOwogICAgICAgIHN0b3JlID0gbW9kdWxlU3RvcmU7CiAgICAgICAgcmV0dXJuIHN0b3JlLmdldChrZXkpOwogICAgICB9CiAgICAgIHN0b3JlID0gc3VwcG9ydHNMb2NhbFN0b3JhZ2UoKSA/IGxvY2FsU3RvcmFnZVN0b3JlIDogbW9kdWxlU3RvcmU7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICAgIGdldDogZ2V0T3JTZXQsCiAgICAgICAgc2V0OiBnZXRPclNldCwKICAgICAgICBzdXBwb3J0c0xvY2FsU3RvcmFnZTogc3VwcG9ydHNMb2NhbFN0b3JhZ2UKICAgICAgfTsKICAgICAgZnVuY3Rpb24gZ2V0T3JTZXQoa2V5LCBkYXRhKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgIHJldHVybiBzdG9yZS5nZXQoa2V5KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0b3JlLnNldChrZXksIGRhdGEpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHN1cHBvcnRzTG9jYWxTdG9yYWdlKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoImxvY2FsU3RvcmFnZSIgaW4gZ2xvYmFsICYmIGdsb2JhbC5sb2NhbFN0b3JhZ2UgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKCFnbG9iYWwubG9jYWxTdG9yYWdlW2xvY2FsU3RvcmFnZU5hbWVzcGFjZV0pIHsKICAgICAgICAgICAgICBnbG9iYWwubG9jYWxTdG9yYWdlLnNldEl0ZW0obG9jYWxTdG9yYWdlTmFtZXNwYWNlLCBKU09OLnN0cmluZ2lmeSh7fSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0gY2F0Y2ggKF8pIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY2xlYW51cCgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgZ2xvYmFsLmxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGxvY2FsU3RvcmFnZU5hbWVzcGFjZSk7CiAgICAgICAgfSBjYXRjaCAoXykge30KICAgICAgfQogICAgfSkuY2FsbChleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKDQpKTsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICBleHBvcnRzID0gbW9kdWxlLmV4cG9ydHMgPSBjcmVhdGVEZWJ1Zy5kZWJ1ZyA9IGNyZWF0ZURlYnVnWyJkZWZhdWx0Il0gPSBjcmVhdGVEZWJ1ZzsKICAgIGV4cG9ydHMuY29lcmNlID0gY29lcmNlOwogICAgZXhwb3J0cy5kaXNhYmxlID0gZGlzYWJsZTsKICAgIGV4cG9ydHMuZW5hYmxlID0gZW5hYmxlOwogICAgZXhwb3J0cy5lbmFibGVkID0gZW5hYmxlZDsKICAgIGV4cG9ydHMuaHVtYW5pemUgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQwKTsKICAgIGV4cG9ydHMubmFtZXMgPSBbXTsKICAgIGV4cG9ydHMuc2tpcHMgPSBbXTsKICAgIGV4cG9ydHMuZm9ybWF0dGVycyA9IHt9OwogICAgdmFyIHByZXZUaW1lOwogICAgZnVuY3Rpb24gc2VsZWN0Q29sb3IobmFtZXNwYWNlKSB7CiAgICAgIHZhciBoYXNoID0gMCwKICAgICAgICBpOwogICAgICBmb3IgKGkgaW4gbmFtZXNwYWNlKSB7CiAgICAgICAgaGFzaCA9IChoYXNoIDw8IDUpIC0gaGFzaCArIG5hbWVzcGFjZS5jaGFyQ29kZUF0KGkpOwogICAgICAgIGhhc2ggfD0gMDsKICAgICAgfQogICAgICByZXR1cm4gZXhwb3J0cy5jb2xvcnNbTWF0aC5hYnMoaGFzaCkgJSBleHBvcnRzLmNvbG9ycy5sZW5ndGhdOwogICAgfQogICAgZnVuY3Rpb24gY3JlYXRlRGVidWcobmFtZXNwYWNlKSB7CiAgICAgIGZ1bmN0aW9uIGRlYnVnKCkgewogICAgICAgIGlmICghZGVidWcuZW5hYmxlZCkgcmV0dXJuOwogICAgICAgIHZhciBzZWxmID0gZGVidWc7CiAgICAgICAgdmFyIGN1cnIgPSArbmV3IERhdGUoKTsKICAgICAgICB2YXIgbXMgPSBjdXJyIC0gKHByZXZUaW1lIHx8IGN1cnIpOwogICAgICAgIHNlbGYuZGlmZiA9IG1zOwogICAgICAgIHNlbGYucHJldiA9IHByZXZUaW1lOwogICAgICAgIHNlbGYuY3VyciA9IGN1cnI7CiAgICAgICAgcHJldlRpbWUgPSBjdXJyOwogICAgICAgIHZhciBhcmdzID0gbmV3IEFycmF5KGFyZ3VtZW50cy5sZW5ndGgpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewogICAgICAgICAgYXJnc1tpXSA9IGFyZ3VtZW50c1tpXTsKICAgICAgICB9CiAgICAgICAgYXJnc1swXSA9IGV4cG9ydHMuY29lcmNlKGFyZ3NbMF0pOwogICAgICAgIGlmICgic3RyaW5nIiAhPT0gdHlwZW9mIGFyZ3NbMF0pIHsKICAgICAgICAgIGFyZ3MudW5zaGlmdCgiJU8iKTsKICAgICAgICB9CiAgICAgICAgdmFyIGluZGV4ID0gMDsKICAgICAgICBhcmdzWzBdID0gYXJnc1swXS5yZXBsYWNlKC8lKFthLXpBLVolXSkvZywgZnVuY3Rpb24gKG1hdGNoLCBmb3JtYXQpIHsKICAgICAgICAgIGlmIChtYXRjaCA9PT0gIiUlIikgcmV0dXJuIG1hdGNoOwogICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgIHZhciBmb3JtYXR0ZXIgPSBleHBvcnRzLmZvcm1hdHRlcnNbZm9ybWF0XTsKICAgICAgICAgIGlmICgiZnVuY3Rpb24iID09PSB0eXBlb2YgZm9ybWF0dGVyKSB7CiAgICAgICAgICAgIHZhciB2YWwgPSBhcmdzW2luZGV4XTsKICAgICAgICAgICAgbWF0Y2ggPSBmb3JtYXR0ZXIuY2FsbChzZWxmLCB2YWwpOwogICAgICAgICAgICBhcmdzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgIGluZGV4LS07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgfSk7CiAgICAgICAgZXhwb3J0cy5mb3JtYXRBcmdzLmNhbGwoc2VsZiwgYXJncyk7CiAgICAgICAgdmFyIGxvZ0ZuID0gZGVidWcubG9nIHx8IGV4cG9ydHMubG9nIHx8IGNvbnNvbGUubG9nLmJpbmQoY29uc29sZSk7CiAgICAgICAgbG9nRm4uYXBwbHkoc2VsZiwgYXJncyk7CiAgICAgIH0KICAgICAgZGVidWcubmFtZXNwYWNlID0gbmFtZXNwYWNlOwogICAgICBkZWJ1Zy5lbmFibGVkID0gZXhwb3J0cy5lbmFibGVkKG5hbWVzcGFjZSk7CiAgICAgIGRlYnVnLnVzZUNvbG9ycyA9IGV4cG9ydHMudXNlQ29sb3JzKCk7CiAgICAgIGRlYnVnLmNvbG9yID0gc2VsZWN0Q29sb3IobmFtZXNwYWNlKTsKICAgICAgaWYgKCJmdW5jdGlvbiIgPT09IHR5cGVvZiBleHBvcnRzLmluaXQpIHsKICAgICAgICBleHBvcnRzLmluaXQoZGVidWcpOwogICAgICB9CiAgICAgIHJldHVybiBkZWJ1ZzsKICAgIH0KICAgIGZ1bmN0aW9uIGVuYWJsZShuYW1lc3BhY2VzKSB7CiAgICAgIGV4cG9ydHMuc2F2ZShuYW1lc3BhY2VzKTsKICAgICAgZXhwb3J0cy5uYW1lcyA9IFtdOwogICAgICBleHBvcnRzLnNraXBzID0gW107CiAgICAgIHZhciBzcGxpdCA9ICh0eXBlb2YgbmFtZXNwYWNlcyA9PT0gInN0cmluZyIgPyBuYW1lc3BhY2VzIDogIiIpLnNwbGl0KC9bXHMsXSsvKTsKICAgICAgdmFyIGxlbiA9IHNwbGl0Lmxlbmd0aDsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgIGlmICghc3BsaXRbaV0pIGNvbnRpbnVlOwogICAgICAgIG5hbWVzcGFjZXMgPSBzcGxpdFtpXS5yZXBsYWNlKC9cKi9nLCAiLio/Iik7CiAgICAgICAgaWYgKG5hbWVzcGFjZXNbMF0gPT09ICItIikgewogICAgICAgICAgZXhwb3J0cy5za2lwcy5wdXNoKG5ldyBSZWdFeHAoIl4iICsgbmFtZXNwYWNlcy5zdWJzdHIoMSkgKyAiJCIpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZXhwb3J0cy5uYW1lcy5wdXNoKG5ldyBSZWdFeHAoIl4iICsgbmFtZXNwYWNlcyArICIkIikpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZGlzYWJsZSgpIHsKICAgICAgZXhwb3J0cy5lbmFibGUoIiIpOwogICAgfQogICAgZnVuY3Rpb24gZW5hYmxlZChuYW1lKSB7CiAgICAgIHZhciBpLCBsZW47CiAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGV4cG9ydHMuc2tpcHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBpZiAoZXhwb3J0cy5za2lwc1tpXS50ZXN0KG5hbWUpKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGV4cG9ydHMubmFtZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBpZiAoZXhwb3J0cy5uYW1lc1tpXS50ZXN0KG5hbWUpKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgZnVuY3Rpb24gY29lcmNlKHZhbCkgewogICAgICBpZiAodmFsIGluc3RhbmNlb2YgRXJyb3IpIHJldHVybiB2YWwuc3RhY2sgfHwgdmFsLm1lc3NhZ2U7CiAgICAgIHJldHVybiB2YWw7CiAgICB9CiAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cykgewogICAgdmFyIHMgPSAxZTM7CiAgICB2YXIgbSA9IHMgKiA2MDsKICAgIHZhciBoID0gbSAqIDYwOwogICAgdmFyIGQgPSBoICogMjQ7CiAgICB2YXIgeSA9IGQgKiAzNjUuMjU7CiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICh2YWwsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHZhciB0eXBlID0gdHlwZW9mIHZhbDsKICAgICAgaWYgKHR5cGUgPT09ICJzdHJpbmciICYmIHZhbC5sZW5ndGggPiAwKSB7CiAgICAgICAgcmV0dXJuIHBhcnNlKHZhbCk7CiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gIm51bWJlciIgJiYgaXNOYU4odmFsKSA9PT0gZmFsc2UpIHsKICAgICAgICByZXR1cm4gb3B0aW9ucy5sb25nID8gZm10TG9uZyh2YWwpIDogZm10U2hvcnQodmFsKTsKICAgICAgfQogICAgICB0aHJvdyBuZXcgRXJyb3IoInZhbCBpcyBub3QgYSBub24tZW1wdHkgc3RyaW5nIG9yIGEgdmFsaWQgbnVtYmVyLiB2YWw9IiArIEpTT04uc3RyaW5naWZ5KHZhbCkpOwogICAgfTsKICAgIGZ1bmN0aW9uIHBhcnNlKHN0cikgewogICAgICBzdHIgPSBTdHJpbmcoc3RyKTsKICAgICAgaWYgKHN0ci5sZW5ndGggPiAxMDApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIG1hdGNoID0gL14oKD86XGQrKT9cLj9cZCspICoobWlsbGlzZWNvbmRzP3xtc2Vjcz98bXN8c2Vjb25kcz98c2Vjcz98c3xtaW51dGVzP3xtaW5zP3xtfGhvdXJzP3xocnM/fGh8ZGF5cz98ZHx5ZWFycz98eXJzP3x5KT8kL2kuZXhlYyhzdHIpOwogICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBuID0gcGFyc2VGbG9hdChtYXRjaFsxXSk7CiAgICAgIHZhciB0eXBlID0gKG1hdGNoWzJdIHx8ICJtcyIpLnRvTG93ZXJDYXNlKCk7CiAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgIGNhc2UgInllYXJzIjoKICAgICAgICBjYXNlICJ5ZWFyIjoKICAgICAgICBjYXNlICJ5cnMiOgogICAgICAgIGNhc2UgInlyIjoKICAgICAgICBjYXNlICJ5IjoKICAgICAgICAgIHJldHVybiBuICogeTsKICAgICAgICBjYXNlICJkYXlzIjoKICAgICAgICBjYXNlICJkYXkiOgogICAgICAgIGNhc2UgImQiOgogICAgICAgICAgcmV0dXJuIG4gKiBkOwogICAgICAgIGNhc2UgImhvdXJzIjoKICAgICAgICBjYXNlICJob3VyIjoKICAgICAgICBjYXNlICJocnMiOgogICAgICAgIGNhc2UgImhyIjoKICAgICAgICBjYXNlICJoIjoKICAgICAgICAgIHJldHVybiBuICogaDsKICAgICAgICBjYXNlICJtaW51dGVzIjoKICAgICAgICBjYXNlICJtaW51dGUiOgogICAgICAgIGNhc2UgIm1pbnMiOgogICAgICAgIGNhc2UgIm1pbiI6CiAgICAgICAgY2FzZSAibSI6CiAgICAgICAgICByZXR1cm4gbiAqIG07CiAgICAgICAgY2FzZSAic2Vjb25kcyI6CiAgICAgICAgY2FzZSAic2Vjb25kIjoKICAgICAgICBjYXNlICJzZWNzIjoKICAgICAgICBjYXNlICJzZWMiOgogICAgICAgIGNhc2UgInMiOgogICAgICAgICAgcmV0dXJuIG4gKiBzOwogICAgICAgIGNhc2UgIm1pbGxpc2Vjb25kcyI6CiAgICAgICAgY2FzZSAibWlsbGlzZWNvbmQiOgogICAgICAgIGNhc2UgIm1zZWNzIjoKICAgICAgICBjYXNlICJtc2VjIjoKICAgICAgICBjYXNlICJtcyI6CiAgICAgICAgICByZXR1cm4gbjsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZm10U2hvcnQobXMpIHsKICAgICAgaWYgKG1zID49IGQpIHsKICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChtcyAvIGQpICsgImQiOwogICAgICB9CiAgICAgIGlmIChtcyA+PSBoKSB7CiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQobXMgLyBoKSArICJoIjsKICAgICAgfQogICAgICBpZiAobXMgPj0gbSkgewogICAgICAgIHJldHVybiBNYXRoLnJvdW5kKG1zIC8gbSkgKyAibSI7CiAgICAgIH0KICAgICAgaWYgKG1zID49IHMpIHsKICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChtcyAvIHMpICsgInMiOwogICAgICB9CiAgICAgIHJldHVybiBtcyArICJtcyI7CiAgICB9CiAgICBmdW5jdGlvbiBmbXRMb25nKG1zKSB7CiAgICAgIHJldHVybiBwbHVyYWwobXMsIGQsICJkYXkiKSB8fCBwbHVyYWwobXMsIGgsICJob3VyIikgfHwgcGx1cmFsKG1zLCBtLCAibWludXRlIikgfHwgcGx1cmFsKG1zLCBzLCAic2Vjb25kIikgfHwgbXMgKyAiIG1zIjsKICAgIH0KICAgIGZ1bmN0aW9uIHBsdXJhbChtcywgbiwgbmFtZSkgewogICAgICBpZiAobXMgPCBuKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChtcyA8IG4gKiAxLjUpIHsKICAgICAgICByZXR1cm4gTWF0aC5mbG9vcihtcyAvIG4pICsgIiAiICsgbmFtZTsKICAgICAgfQogICAgICByZXR1cm4gTWF0aC5jZWlsKG1zIC8gbikgKyAiICIgKyBuYW1lICsgInMiOwogICAgfQogIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICB2YXIgZ2xvYmFsID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0Mik7CiAgICB2YXIgUHJvbWlzZSA9IGdsb2JhbC5Qcm9taXNlIHx8IF9fd2VicGFja19yZXF1aXJlX18oNDMpLlByb21pc2U7CiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGNyZWF0ZUFsZ29saWFzZWFyY2goQWxnb2xpYVNlYXJjaCwgdWFTdWZmaXgpIHsKICAgICAgdmFyIGluaGVyaXRzID0gX193ZWJwYWNrX3JlcXVpcmVfXygxMik7CiAgICAgIHZhciBlcnJvcnMgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUpOwogICAgICB2YXIgaW5saW5lSGVhZGVycyA9IF9fd2VicGFja19yZXF1aXJlX18oNDQpOwogICAgICB2YXIganNvbnBSZXF1ZXN0ID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0Nik7CiAgICAgIHZhciBwbGFjZXMgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQ3KTsKICAgICAgdWFTdWZmaXggPSB1YVN1ZmZpeCB8fCAiIjsKICAgICAgaWYgKGZhbHNlKSB7CiAgICAgICAgcmVxdWlyZSgiZGVidWciKS5lbmFibGUoImFsZ29saWFzZWFyY2gqIik7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYWxnb2xpYXNlYXJjaChhcHBsaWNhdGlvbklELCBhcGlLZXksIG9wdHMpIHsKICAgICAgICB2YXIgY2xvbmVEZWVwID0gX193ZWJwYWNrX3JlcXVpcmVfXygzKTsKICAgICAgICBvcHRzID0gY2xvbmVEZWVwKG9wdHMgfHwge30pOwogICAgICAgIG9wdHMuX3VhID0gb3B0cy5fdWEgfHwgYWxnb2xpYXNlYXJjaC51YTsKICAgICAgICByZXR1cm4gbmV3IEFsZ29saWFTZWFyY2hCcm93c2VyKGFwcGxpY2F0aW9uSUQsIGFwaUtleSwgb3B0cyk7CiAgICAgIH0KICAgICAgYWxnb2xpYXNlYXJjaC52ZXJzaW9uID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0OCk7CiAgICAgIGFsZ29saWFzZWFyY2gudWEgPSAiQWxnb2xpYSBmb3IgdmFuaWxsYSBKYXZhU2NyaXB0ICIgKyB1YVN1ZmZpeCArIGFsZ29saWFzZWFyY2gudmVyc2lvbjsKICAgICAgYWxnb2xpYXNlYXJjaC5pbml0UGxhY2VzID0gcGxhY2VzKGFsZ29saWFzZWFyY2gpOwogICAgICBnbG9iYWwuX19hbGdvbGlhID0gewogICAgICAgIGRlYnVnOiBfX3dlYnBhY2tfcmVxdWlyZV9fKDgpLAogICAgICAgIGFsZ29saWFzZWFyY2g6IGFsZ29saWFzZWFyY2gKICAgICAgfTsKICAgICAgdmFyIHN1cHBvcnQgPSB7CiAgICAgICAgaGFzWE1MSHR0cFJlcXVlc3Q6ICJYTUxIdHRwUmVxdWVzdCIgaW4gZ2xvYmFsLAogICAgICAgIGhhc1hEb21haW5SZXF1ZXN0OiAiWERvbWFpblJlcXVlc3QiIGluIGdsb2JhbAogICAgICB9OwogICAgICBpZiAoc3VwcG9ydC5oYXNYTUxIdHRwUmVxdWVzdCkgewogICAgICAgIHN1cHBvcnQuY29ycyA9ICJ3aXRoQ3JlZGVudGlhbHMiIGluIG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIEFsZ29saWFTZWFyY2hCcm93c2VyKCkgewogICAgICAgIEFsZ29saWFTZWFyY2guYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgICBpbmhlcml0cyhBbGdvbGlhU2VhcmNoQnJvd3NlciwgQWxnb2xpYVNlYXJjaCk7CiAgICAgIEFsZ29saWFTZWFyY2hCcm93c2VyLnByb3RvdHlwZS5fcmVxdWVzdCA9IGZ1bmN0aW9uIHJlcXVlc3QodXJsLCBvcHRzKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIHdyYXBSZXF1ZXN0KHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgaWYgKCFzdXBwb3J0LmNvcnMgJiYgIXN1cHBvcnQuaGFzWERvbWFpblJlcXVlc3QpIHsKICAgICAgICAgICAgcmVqZWN0KG5ldyBlcnJvcnMuTmV0d29yaygiQ09SUyBub3Qgc3VwcG9ydGVkIikpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB1cmwgPSBpbmxpbmVIZWFkZXJzKHVybCwgb3B0cy5oZWFkZXJzKTsKICAgICAgICAgIHZhciBib2R5ID0gb3B0cy5ib2R5OwogICAgICAgICAgdmFyIHJlcSA9IHN1cHBvcnQuY29ycyA/IG5ldyBYTUxIdHRwUmVxdWVzdCgpIDogbmV3IFhEb21haW5SZXF1ZXN0KCk7CiAgICAgICAgICB2YXIgcmVxVGltZW91dDsKICAgICAgICAgIHZhciB0aW1lZE91dDsKICAgICAgICAgIHZhciBjb25uZWN0ZWQgPSBmYWxzZTsKICAgICAgICAgIHJlcVRpbWVvdXQgPSBzZXRUaW1lb3V0KG9uVGltZW91dCwgb3B0cy50aW1lb3V0cy5jb25uZWN0KTsKICAgICAgICAgIHJlcS5vbnByb2dyZXNzID0gb25Qcm9ncmVzczsKICAgICAgICAgIGlmICgib25yZWFkeXN0YXRlY2hhbmdlIiBpbiByZXEpIHJlcS5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBvblJlYWR5U3RhdGVDaGFuZ2U7CiAgICAgICAgICByZXEub25sb2FkID0gb25Mb2FkOwogICAgICAgICAgcmVxLm9uZXJyb3IgPSBvbkVycm9yOwogICAgICAgICAgaWYgKHJlcSBpbnN0YW5jZW9mIFhNTEh0dHBSZXF1ZXN0KSB7CiAgICAgICAgICAgIHJlcS5vcGVuKG9wdHMubWV0aG9kLCB1cmwsIHRydWUpOwogICAgICAgICAgICBpZiAob3B0cy5mb3JjZUF1dGhIZWFkZXJzKSB7CiAgICAgICAgICAgICAgcmVxLnNldFJlcXVlc3RIZWFkZXIoIngtYWxnb2xpYS1hcHBsaWNhdGlvbi1pZCIsIG9wdHMuaGVhZGVyc1sieC1hbGdvbGlhLWFwcGxpY2F0aW9uLWlkIl0pOwogICAgICAgICAgICAgIHJlcS5zZXRSZXF1ZXN0SGVhZGVyKCJ4LWFsZ29saWEtYXBpLWtleSIsIG9wdHMuaGVhZGVyc1sieC1hbGdvbGlhLWFwaS1rZXkiXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlcS5vcGVuKG9wdHMubWV0aG9kLCB1cmwpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHN1cHBvcnQuY29ycykgewogICAgICAgICAgICBpZiAoYm9keSkgewogICAgICAgICAgICAgIGlmIChvcHRzLm1ldGhvZCA9PT0gIlBPU1QiKSB7CiAgICAgICAgICAgICAgICByZXEuc2V0UmVxdWVzdEhlYWRlcigiY29udGVudC10eXBlIiwgImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXEuc2V0UmVxdWVzdEhlYWRlcigiY29udGVudC10eXBlIiwgImFwcGxpY2F0aW9uL2pzb24iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVxLnNldFJlcXVlc3RIZWFkZXIoImFjY2VwdCIsICJhcHBsaWNhdGlvbi9qc29uIik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYm9keSkgewogICAgICAgICAgICByZXEuc2VuZChib2R5KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlcS5zZW5kKCk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBvbkxvYWQoKSB7CiAgICAgICAgICAgIGlmICh0aW1lZE91dCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjbGVhclRpbWVvdXQocmVxVGltZW91dCk7CiAgICAgICAgICAgIHZhciBvdXQ7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgb3V0ID0gewogICAgICAgICAgICAgICAgYm9keTogSlNPTi5wYXJzZShyZXEucmVzcG9uc2VUZXh0KSwKICAgICAgICAgICAgICAgIHJlc3BvbnNlVGV4dDogcmVxLnJlc3BvbnNlVGV4dCwKICAgICAgICAgICAgICAgIHN0YXR1c0NvZGU6IHJlcS5zdGF0dXMsCiAgICAgICAgICAgICAgICBoZWFkZXJzOiByZXEuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzICYmIHJlcS5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKSB8fCB7fQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBvdXQgPSBuZXcgZXJyb3JzLlVucGFyc2FibGVKU09OKHsKICAgICAgICAgICAgICAgIG1vcmU6IHJlcS5yZXNwb25zZVRleHQKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3V0IGluc3RhbmNlb2YgZXJyb3JzLlVucGFyc2FibGVKU09OKSB7CiAgICAgICAgICAgICAgcmVqZWN0KG91dCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzb2x2ZShvdXQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBvbkVycm9yKGV2ZW50KSB7CiAgICAgICAgICAgIGlmICh0aW1lZE91dCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjbGVhclRpbWVvdXQocmVxVGltZW91dCk7CiAgICAgICAgICAgIHJlamVjdChuZXcgZXJyb3JzLk5ldHdvcmsoewogICAgICAgICAgICAgIG1vcmU6IGV2ZW50CiAgICAgICAgICAgIH0pKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG9uVGltZW91dCgpIHsKICAgICAgICAgICAgdGltZWRPdXQgPSB0cnVlOwogICAgICAgICAgICByZXEuYWJvcnQoKTsKICAgICAgICAgICAgcmVqZWN0KG5ldyBlcnJvcnMuUmVxdWVzdFRpbWVvdXQoKSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBvbkNvbm5lY3QoKSB7CiAgICAgICAgICAgIGNvbm5lY3RlZCA9IHRydWU7CiAgICAgICAgICAgIGNsZWFyVGltZW91dChyZXFUaW1lb3V0KTsKICAgICAgICAgICAgcmVxVGltZW91dCA9IHNldFRpbWVvdXQob25UaW1lb3V0LCBvcHRzLnRpbWVvdXRzLmNvbXBsZXRlKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG9uUHJvZ3Jlc3MoKSB7CiAgICAgICAgICAgIGlmICghY29ubmVjdGVkKSBvbkNvbm5lY3QoKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG9uUmVhZHlTdGF0ZUNoYW5nZSgpIHsKICAgICAgICAgICAgaWYgKCFjb25uZWN0ZWQgJiYgcmVxLnJlYWR5U3RhdGUgPiAxKSBvbkNvbm5lY3QoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfTsKICAgICAgQWxnb2xpYVNlYXJjaEJyb3dzZXIucHJvdG90eXBlLl9yZXF1ZXN0LmZhbGxiYWNrID0gZnVuY3Rpb24gcmVxdWVzdEZhbGxiYWNrKHVybCwgb3B0cykgewogICAgICAgIHVybCA9IGlubGluZUhlYWRlcnModXJsLCBvcHRzLmhlYWRlcnMpOwogICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiB3cmFwSnNvbnBSZXF1ZXN0KHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAganNvbnBSZXF1ZXN0KHVybCwgb3B0cywgZnVuY3Rpb24ganNvbnBSZXF1ZXN0RG9uZShlcnIsIGNvbnRlbnQpIHsKICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXNvbHZlKGNvbnRlbnQpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEFsZ29saWFTZWFyY2hCcm93c2VyLnByb3RvdHlwZS5fcHJvbWlzZSA9IHsKICAgICAgICByZWplY3Q6IGZ1bmN0aW9uIHJlamVjdFByb21pc2UodmFsKSB7CiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QodmFsKTsKICAgICAgICB9LAogICAgICAgIHJlc29sdmU6IGZ1bmN0aW9uIHJlc29sdmVQcm9taXNlKHZhbCkgewogICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh2YWwpOwogICAgICAgIH0sCiAgICAgICAgZGVsYXk6IGZ1bmN0aW9uIGRlbGF5UHJvbWlzZShtcykgewogICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIHJlc29sdmVPblRpbWVvdXQocmVzb2x2ZSkgewogICAgICAgICAgICBzZXRUaW1lb3V0KHJlc29sdmUsIG1zKTsKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYWxsOiBmdW5jdGlvbiBhbGwocHJvbWlzZXMpIHsKICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcyk7CiAgICAgICAgfQogICAgICB9OwogICAgICByZXR1cm4gYWxnb2xpYXNlYXJjaDsKICAgIH07CiAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgKGZ1bmN0aW9uIChnbG9iYWwpIHsKICAgICAgdmFyIHdpbjsKICAgICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgd2luID0gd2luZG93OwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBnbG9iYWwgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgd2luID0gZ2xvYmFsOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzZWxmICE9PSAidW5kZWZpbmVkIikgewogICAgICAgIHdpbiA9IHNlbGY7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd2luID0ge307CiAgICAgIH0KICAgICAgbW9kdWxlLmV4cG9ydHMgPSB3aW47CiAgICB9KS5jYWxsKGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18oNCkpOwogIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgIChmdW5jdGlvbiAocHJvY2VzcywgZ2xvYmFsKSB7CiAgICAgIChmdW5jdGlvbiAoZ2xvYmFsLCBmYWN0b3J5KSB7CiAgICAgICAgdHJ1ZSA/IG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpIDogdHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kID8gZGVmaW5lKGZhY3RvcnkpIDogZ2xvYmFsLkVTNlByb21pc2UgPSBmYWN0b3J5KCk7CiAgICAgIH0pKHRoaXMsIGZ1bmN0aW9uICgpIHsKICAgICAgICAidXNlIHN0cmljdCI7CgogICAgICAgIGZ1bmN0aW9uIG9iamVjdE9yRnVuY3Rpb24oeCkgewogICAgICAgICAgdmFyIHR5cGUgPSB0eXBlb2YgeDsKICAgICAgICAgIHJldHVybiB4ICE9PSBudWxsICYmICh0eXBlID09PSAib2JqZWN0IiB8fCB0eXBlID09PSAiZnVuY3Rpb24iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNGdW5jdGlvbih4KSB7CiAgICAgICAgICByZXR1cm4gdHlwZW9mIHggPT09ICJmdW5jdGlvbiI7CiAgICAgICAgfQogICAgICAgIHZhciBfaXNBcnJheSA9IHZvaWQgMDsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSkgewogICAgICAgICAgX2lzQXJyYXkgPSBBcnJheS5pc0FycmF5OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBfaXNBcnJheSA9IGZ1bmN0aW9uICh4KSB7CiAgICAgICAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoeCkgPT09ICJbb2JqZWN0IEFycmF5XSI7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgaXNBcnJheSA9IF9pc0FycmF5OwogICAgICAgIHZhciBsZW4gPSAwOwogICAgICAgIHZhciB2ZXJ0eE5leHQgPSB2b2lkIDA7CiAgICAgICAgdmFyIGN1c3RvbVNjaGVkdWxlckZuID0gdm9pZCAwOwogICAgICAgIHZhciBhc2FwID0gZnVuY3Rpb24gYXNhcChjYWxsYmFjaywgYXJnKSB7CiAgICAgICAgICBxdWV1ZVtsZW5dID0gY2FsbGJhY2s7CiAgICAgICAgICBxdWV1ZVtsZW4gKyAxXSA9IGFyZzsKICAgICAgICAgIGxlbiArPSAyOwogICAgICAgICAgaWYgKGxlbiA9PT0gMikgewogICAgICAgICAgICBpZiAoY3VzdG9tU2NoZWR1bGVyRm4pIHsKICAgICAgICAgICAgICBjdXN0b21TY2hlZHVsZXJGbihmbHVzaCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVGbHVzaCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBzZXRTY2hlZHVsZXIoc2NoZWR1bGVGbikgewogICAgICAgICAgY3VzdG9tU2NoZWR1bGVyRm4gPSBzY2hlZHVsZUZuOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRBc2FwKGFzYXBGbikgewogICAgICAgICAgYXNhcCA9IGFzYXBGbjsKICAgICAgICB9CiAgICAgICAgdmFyIGJyb3dzZXJXaW5kb3cgPSB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiA/IHdpbmRvdyA6IHVuZGVmaW5lZDsKICAgICAgICB2YXIgYnJvd3Nlckdsb2JhbCA9IGJyb3dzZXJXaW5kb3cgfHwge307CiAgICAgICAgdmFyIEJyb3dzZXJNdXRhdGlvbk9ic2VydmVyID0gYnJvd3Nlckdsb2JhbC5NdXRhdGlvbk9ic2VydmVyIHx8IGJyb3dzZXJHbG9iYWwuV2ViS2l0TXV0YXRpb25PYnNlcnZlcjsKICAgICAgICB2YXIgaXNOb2RlID0gdHlwZW9mIHNlbGYgPT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBwcm9jZXNzICE9PSAidW5kZWZpbmVkIiAmJiB7fS50b1N0cmluZy5jYWxsKHByb2Nlc3MpID09PSAiW29iamVjdCBwcm9jZXNzXSI7CiAgICAgICAgdmFyIGlzV29ya2VyID0gdHlwZW9mIFVpbnQ4Q2xhbXBlZEFycmF5ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgaW1wb3J0U2NyaXB0cyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIE1lc3NhZ2VDaGFubmVsICE9PSAidW5kZWZpbmVkIjsKICAgICAgICBmdW5jdGlvbiB1c2VOZXh0VGljaygpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBwcm9jZXNzLm5leHRUaWNrKGZsdXNoKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVZlcnR4VGltZXIoKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHZlcnR4TmV4dCAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB2ZXJ0eE5leHQoZmx1c2gpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVzZVNldFRpbWVvdXQoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlTXV0YXRpb25PYnNlcnZlcigpIHsKICAgICAgICAgIHZhciBpdGVyYXRpb25zID0gMDsKICAgICAgICAgIHZhciBvYnNlcnZlciA9IG5ldyBCcm93c2VyTXV0YXRpb25PYnNlcnZlcihmbHVzaCk7CiAgICAgICAgICB2YXIgbm9kZSA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCIiKTsKICAgICAgICAgIG9ic2VydmVyLm9ic2VydmUobm9kZSwgewogICAgICAgICAgICBjaGFyYWN0ZXJEYXRhOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIG5vZGUuZGF0YSA9IGl0ZXJhdGlvbnMgPSArK2l0ZXJhdGlvbnMgJSAyOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlTWVzc2FnZUNoYW5uZWwoKSB7CiAgICAgICAgICB2YXIgY2hhbm5lbCA9IG5ldyBNZXNzYWdlQ2hhbm5lbCgpOwogICAgICAgICAgY2hhbm5lbC5wb3J0MS5vbm1lc3NhZ2UgPSBmbHVzaDsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBjaGFubmVsLnBvcnQyLnBvc3RNZXNzYWdlKDApOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlU2V0VGltZW91dCgpIHsKICAgICAgICAgIHZhciBnbG9iYWxTZXRUaW1lb3V0ID0gc2V0VGltZW91dDsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBnbG9iYWxTZXRUaW1lb3V0KGZsdXNoLCAxKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBxdWV1ZSA9IG5ldyBBcnJheSgxZTMpOwogICAgICAgIGZ1bmN0aW9uIGZsdXNoKCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkgKz0gMikgewogICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBxdWV1ZVtpXTsKICAgICAgICAgICAgdmFyIGFyZyA9IHF1ZXVlW2kgKyAxXTsKICAgICAgICAgICAgY2FsbGJhY2soYXJnKTsKICAgICAgICAgICAgcXVldWVbaV0gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIHF1ZXVlW2kgKyAxXSA9IHVuZGVmaW5lZDsKICAgICAgICAgIH0KICAgICAgICAgIGxlbiA9IDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRWZXJ0eCgpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciB2ZXJ0eCA9IEZ1bmN0aW9uKCJyZXR1cm4gdGhpcyIpKCkucmVxdWlyZSgidmVydHgiKTsKICAgICAgICAgICAgdmVydHhOZXh0ID0gdmVydHgucnVuT25Mb29wIHx8IHZlcnR4LnJ1bk9uQ29udGV4dDsKICAgICAgICAgICAgcmV0dXJuIHVzZVZlcnR4VGltZXIoKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmV0dXJuIHVzZVNldFRpbWVvdXQoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHNjaGVkdWxlRmx1c2ggPSB2b2lkIDA7CiAgICAgICAgaWYgKGlzTm9kZSkgewogICAgICAgICAgc2NoZWR1bGVGbHVzaCA9IHVzZU5leHRUaWNrKCk7CiAgICAgICAgfSBlbHNlIGlmIChCcm93c2VyTXV0YXRpb25PYnNlcnZlcikgewogICAgICAgICAgc2NoZWR1bGVGbHVzaCA9IHVzZU11dGF0aW9uT2JzZXJ2ZXIoKTsKICAgICAgICB9IGVsc2UgaWYgKGlzV29ya2VyKSB7CiAgICAgICAgICBzY2hlZHVsZUZsdXNoID0gdXNlTWVzc2FnZUNoYW5uZWwoKTsKICAgICAgICB9IGVsc2UgaWYgKGJyb3dzZXJXaW5kb3cgPT09IHVuZGVmaW5lZCAmJiAiZnVuY3Rpb24iID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBzY2hlZHVsZUZsdXNoID0gYXR0ZW1wdFZlcnR4KCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNjaGVkdWxlRmx1c2ggPSB1c2VTZXRUaW1lb3V0KCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRoZW4ob25GdWxmaWxsbWVudCwgb25SZWplY3Rpb24pIHsKICAgICAgICAgIHZhciBwYXJlbnQgPSB0aGlzOwogICAgICAgICAgdmFyIGNoaWxkID0gbmV3IHRoaXMuY29uc3RydWN0b3Iobm9vcCk7CiAgICAgICAgICBpZiAoY2hpbGRbUFJPTUlTRV9JRF0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBtYWtlUHJvbWlzZShjaGlsZCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgX3N0YXRlID0gcGFyZW50Ll9zdGF0ZTsKICAgICAgICAgIGlmIChfc3RhdGUpIHsKICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gYXJndW1lbnRzW19zdGF0ZSAtIDFdOwogICAgICAgICAgICBhc2FwKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICByZXR1cm4gaW52b2tlQ2FsbGJhY2soX3N0YXRlLCBjaGlsZCwgY2FsbGJhY2ssIHBhcmVudC5fcmVzdWx0KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdWJzY3JpYmUocGFyZW50LCBjaGlsZCwgb25GdWxmaWxsbWVudCwgb25SZWplY3Rpb24pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlJDEob2JqZWN0KSB7CiAgICAgICAgICB2YXIgQ29uc3RydWN0b3IgPSB0aGlzOwogICAgICAgICAgaWYgKG9iamVjdCAmJiB0eXBlb2Ygb2JqZWN0ID09PSAib2JqZWN0IiAmJiBvYmplY3QuY29uc3RydWN0b3IgPT09IENvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJvbWlzZSA9IG5ldyBDb25zdHJ1Y3Rvcihub29wKTsKICAgICAgICAgIHJlc29sdmUocHJvbWlzZSwgb2JqZWN0KTsKICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH0KICAgICAgICB2YXIgUFJPTUlTRV9JRCA9IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cmluZygyKTsKICAgICAgICBmdW5jdGlvbiBub29wKCkge30KICAgICAgICB2YXIgUEVORElORyA9IHZvaWQgMDsKICAgICAgICB2YXIgRlVMRklMTEVEID0gMTsKICAgICAgICB2YXIgUkVKRUNURUQgPSAyOwogICAgICAgIHZhciBUUllfQ0FUQ0hfRVJST1IgPSB7CiAgICAgICAgICBlcnJvcjogbnVsbAogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gc2VsZkZ1bGZpbGxtZW50KCkgewogICAgICAgICAgcmV0dXJuIG5ldyBUeXBlRXJyb3IoIllvdSBjYW5ub3QgcmVzb2x2ZSBhIHByb21pc2Ugd2l0aCBpdHNlbGYiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2Fubm90UmV0dXJuT3duKCkgewogICAgICAgICAgcmV0dXJuIG5ldyBUeXBlRXJyb3IoIkEgcHJvbWlzZXMgY2FsbGJhY2sgY2Fubm90IHJldHVybiB0aGF0IHNhbWUgcHJvbWlzZS4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VGhlbihwcm9taXNlKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gcHJvbWlzZS50aGVuOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgVFJZX0NBVENIX0VSUk9SLmVycm9yID0gZXJyb3I7CiAgICAgICAgICAgIHJldHVybiBUUllfQ0FUQ0hfRVJST1I7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyeVRoZW4odGhlbiQkMSwgdmFsdWUsIGZ1bGZpbGxtZW50SGFuZGxlciwgcmVqZWN0aW9uSGFuZGxlcikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdGhlbiQkMS5jYWxsKHZhbHVlLCBmdWxmaWxsbWVudEhhbmRsZXIsIHJlamVjdGlvbkhhbmRsZXIpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlRm9yZWlnblRoZW5hYmxlKHByb21pc2UsIHRoZW5hYmxlLCB0aGVuJCQxKSB7CiAgICAgICAgICBhc2FwKGZ1bmN0aW9uIChwcm9taXNlKSB7CiAgICAgICAgICAgIHZhciBzZWFsZWQgPSBmYWxzZTsKICAgICAgICAgICAgdmFyIGVycm9yID0gdHJ5VGhlbih0aGVuJCQxLCB0aGVuYWJsZSwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgaWYgKHNlYWxlZCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzZWFsZWQgPSB0cnVlOwogICAgICAgICAgICAgIGlmICh0aGVuYWJsZSAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgIHJlc29sdmUocHJvbWlzZSwgdmFsdWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmdWxmaWxsKHByb21pc2UsIHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgICAgICBpZiAoc2VhbGVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNlYWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgcmVqZWN0KHByb21pc2UsIHJlYXNvbik7CiAgICAgICAgICAgIH0sICJTZXR0bGU6ICIgKyAocHJvbWlzZS5fbGFiZWwgfHwgIiB1bmtub3duIHByb21pc2UiKSk7CiAgICAgICAgICAgIGlmICghc2VhbGVkICYmIGVycm9yKSB7CiAgICAgICAgICAgICAgc2VhbGVkID0gdHJ1ZTsKICAgICAgICAgICAgICByZWplY3QocHJvbWlzZSwgZXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCBwcm9taXNlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlT3duVGhlbmFibGUocHJvbWlzZSwgdGhlbmFibGUpIHsKICAgICAgICAgIGlmICh0aGVuYWJsZS5fc3RhdGUgPT09IEZVTEZJTExFRCkgewogICAgICAgICAgICBmdWxmaWxsKHByb21pc2UsIHRoZW5hYmxlLl9yZXN1bHQpOwogICAgICAgICAgfSBlbHNlIGlmICh0aGVuYWJsZS5fc3RhdGUgPT09IFJFSkVDVEVEKSB7CiAgICAgICAgICAgIHJlamVjdChwcm9taXNlLCB0aGVuYWJsZS5fcmVzdWx0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN1YnNjcmliZSh0aGVuYWJsZSwgdW5kZWZpbmVkLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShwcm9taXNlLCB2YWx1ZSk7CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KHByb21pc2UsIHJlYXNvbik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVNYXliZVRoZW5hYmxlKHByb21pc2UsIG1heWJlVGhlbmFibGUsIHRoZW4kJDEpIHsKICAgICAgICAgIGlmIChtYXliZVRoZW5hYmxlLmNvbnN0cnVjdG9yID09PSBwcm9taXNlLmNvbnN0cnVjdG9yICYmIHRoZW4kJDEgPT09IHRoZW4gJiYgbWF5YmVUaGVuYWJsZS5jb25zdHJ1Y3Rvci5yZXNvbHZlID09PSByZXNvbHZlJDEpIHsKICAgICAgICAgICAgaGFuZGxlT3duVGhlbmFibGUocHJvbWlzZSwgbWF5YmVUaGVuYWJsZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodGhlbiQkMSA9PT0gVFJZX0NBVENIX0VSUk9SKSB7CiAgICAgICAgICAgICAgcmVqZWN0KHByb21pc2UsIFRSWV9DQVRDSF9FUlJPUi5lcnJvcik7CiAgICAgICAgICAgICAgVFJZX0NBVENIX0VSUk9SLmVycm9yID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGVuJCQxID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICBmdWxmaWxsKHByb21pc2UsIG1heWJlVGhlbmFibGUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24odGhlbiQkMSkpIHsKICAgICAgICAgICAgICBoYW5kbGVGb3JlaWduVGhlbmFibGUocHJvbWlzZSwgbWF5YmVUaGVuYWJsZSwgdGhlbiQkMSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZnVsZmlsbChwcm9taXNlLCBtYXliZVRoZW5hYmxlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlKHByb21pc2UsIHZhbHVlKSB7CiAgICAgICAgICBpZiAocHJvbWlzZSA9PT0gdmFsdWUpIHsKICAgICAgICAgICAgcmVqZWN0KHByb21pc2UsIHNlbGZGdWxmaWxsbWVudCgpKTsKICAgICAgICAgIH0gZWxzZSBpZiAob2JqZWN0T3JGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICAgICAgaGFuZGxlTWF5YmVUaGVuYWJsZShwcm9taXNlLCB2YWx1ZSwgZ2V0VGhlbih2YWx1ZSkpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZnVsZmlsbChwcm9taXNlLCB2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1Ymxpc2hSZWplY3Rpb24ocHJvbWlzZSkgewogICAgICAgICAgaWYgKHByb21pc2UuX29uZXJyb3IpIHsKICAgICAgICAgICAgcHJvbWlzZS5fb25lcnJvcihwcm9taXNlLl9yZXN1bHQpOwogICAgICAgICAgfQogICAgICAgICAgcHVibGlzaChwcm9taXNlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbChwcm9taXNlLCB2YWx1ZSkgewogICAgICAgICAgaWYgKHByb21pc2UuX3N0YXRlICE9PSBQRU5ESU5HKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHByb21pc2UuX3Jlc3VsdCA9IHZhbHVlOwogICAgICAgICAgcHJvbWlzZS5fc3RhdGUgPSBGVUxGSUxMRUQ7CiAgICAgICAgICBpZiAocHJvbWlzZS5fc3Vic2NyaWJlcnMubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIGFzYXAocHVibGlzaCwgcHJvbWlzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlamVjdChwcm9taXNlLCByZWFzb24pIHsKICAgICAgICAgIGlmIChwcm9taXNlLl9zdGF0ZSAhPT0gUEVORElORykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBwcm9taXNlLl9zdGF0ZSA9IFJFSkVDVEVEOwogICAgICAgICAgcHJvbWlzZS5fcmVzdWx0ID0gcmVhc29uOwogICAgICAgICAgYXNhcChwdWJsaXNoUmVqZWN0aW9uLCBwcm9taXNlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3Vic2NyaWJlKHBhcmVudCwgY2hpbGQsIG9uRnVsZmlsbG1lbnQsIG9uUmVqZWN0aW9uKSB7CiAgICAgICAgICB2YXIgX3N1YnNjcmliZXJzID0gcGFyZW50Ll9zdWJzY3JpYmVyczsKICAgICAgICAgIHZhciBsZW5ndGggPSBfc3Vic2NyaWJlcnMubGVuZ3RoOwogICAgICAgICAgcGFyZW50Ll9vbmVycm9yID0gbnVsbDsKICAgICAgICAgIF9zdWJzY3JpYmVyc1tsZW5ndGhdID0gY2hpbGQ7CiAgICAgICAgICBfc3Vic2NyaWJlcnNbbGVuZ3RoICsgRlVMRklMTEVEXSA9IG9uRnVsZmlsbG1lbnQ7CiAgICAgICAgICBfc3Vic2NyaWJlcnNbbGVuZ3RoICsgUkVKRUNURURdID0gb25SZWplY3Rpb247CiAgICAgICAgICBpZiAobGVuZ3RoID09PSAwICYmIHBhcmVudC5fc3RhdGUpIHsKICAgICAgICAgICAgYXNhcChwdWJsaXNoLCBwYXJlbnQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdWJsaXNoKHByb21pc2UpIHsKICAgICAgICAgIHZhciBzdWJzY3JpYmVycyA9IHByb21pc2UuX3N1YnNjcmliZXJzOwogICAgICAgICAgdmFyIHNldHRsZWQgPSBwcm9taXNlLl9zdGF0ZTsKICAgICAgICAgIGlmIChzdWJzY3JpYmVycy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkID0gdm9pZCAwLAogICAgICAgICAgICBjYWxsYmFjayA9IHZvaWQgMCwKICAgICAgICAgICAgZGV0YWlsID0gcHJvbWlzZS5fcmVzdWx0OwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdWJzY3JpYmVycy5sZW5ndGg7IGkgKz0gMykgewogICAgICAgICAgICBjaGlsZCA9IHN1YnNjcmliZXJzW2ldOwogICAgICAgICAgICBjYWxsYmFjayA9IHN1YnNjcmliZXJzW2kgKyBzZXR0bGVkXTsKICAgICAgICAgICAgaWYgKGNoaWxkKSB7CiAgICAgICAgICAgICAgaW52b2tlQ2FsbGJhY2soc2V0dGxlZCwgY2hpbGQsIGNhbGxiYWNrLCBkZXRhaWwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNhbGxiYWNrKGRldGFpbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHByb21pc2UuX3N1YnNjcmliZXJzLmxlbmd0aCA9IDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyeUNhdGNoKGNhbGxiYWNrLCBkZXRhaWwpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhkZXRhaWwpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBUUllfQ0FUQ0hfRVJST1IuZXJyb3IgPSBlOwogICAgICAgICAgICByZXR1cm4gVFJZX0NBVENIX0VSUk9SOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VDYWxsYmFjayhzZXR0bGVkLCBwcm9taXNlLCBjYWxsYmFjaywgZGV0YWlsKSB7CiAgICAgICAgICB2YXIgaGFzQ2FsbGJhY2sgPSBpc0Z1bmN0aW9uKGNhbGxiYWNrKSwKICAgICAgICAgICAgdmFsdWUgPSB2b2lkIDAsCiAgICAgICAgICAgIGVycm9yID0gdm9pZCAwLAogICAgICAgICAgICBzdWNjZWVkZWQgPSB2b2lkIDAsCiAgICAgICAgICAgIGZhaWxlZCA9IHZvaWQgMDsKICAgICAgICAgIGlmIChoYXNDYWxsYmFjaykgewogICAgICAgICAgICB2YWx1ZSA9IHRyeUNhdGNoKGNhbGxiYWNrLCBkZXRhaWwpOwogICAgICAgICAgICBpZiAodmFsdWUgPT09IFRSWV9DQVRDSF9FUlJPUikgewogICAgICAgICAgICAgIGZhaWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IgPSB2YWx1ZS5lcnJvcjsKICAgICAgICAgICAgICB2YWx1ZS5lcnJvciA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3VjY2VlZGVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvbWlzZSA9PT0gdmFsdWUpIHsKICAgICAgICAgICAgICByZWplY3QocHJvbWlzZSwgY2Fubm90UmV0dXJuT3duKCkpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsdWUgPSBkZXRhaWw7CiAgICAgICAgICAgIHN1Y2NlZWRlZCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocHJvbWlzZS5fc3RhdGUgIT09IFBFTkRJTkcpIHt9IGVsc2UgaWYgKGhhc0NhbGxiYWNrICYmIHN1Y2NlZWRlZCkgewogICAgICAgICAgICByZXNvbHZlKHByb21pc2UsIHZhbHVlKTsKICAgICAgICAgIH0gZWxzZSBpZiAoZmFpbGVkKSB7CiAgICAgICAgICAgIHJlamVjdChwcm9taXNlLCBlcnJvcik7CiAgICAgICAgICB9IGVsc2UgaWYgKHNldHRsZWQgPT09IEZVTEZJTExFRCkgewogICAgICAgICAgICBmdWxmaWxsKHByb21pc2UsIHZhbHVlKTsKICAgICAgICAgIH0gZWxzZSBpZiAoc2V0dGxlZCA9PT0gUkVKRUNURUQpIHsKICAgICAgICAgICAgcmVqZWN0KHByb21pc2UsIHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdGlhbGl6ZVByb21pc2UocHJvbWlzZSwgcmVzb2x2ZXIpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJlc29sdmVyKGZ1bmN0aW9uIHJlc29sdmVQcm9taXNlKHZhbHVlKSB7CiAgICAgICAgICAgICAgcmVzb2x2ZShwcm9taXNlLCB2YWx1ZSk7CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uIHJlamVjdFByb21pc2UocmVhc29uKSB7CiAgICAgICAgICAgICAgcmVqZWN0KHByb21pc2UsIHJlYXNvbik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZWplY3QocHJvbWlzZSwgZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpZCA9IDA7CiAgICAgICAgZnVuY3Rpb24gbmV4dElkKCkgewogICAgICAgICAgcmV0dXJuIGlkKys7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1ha2VQcm9taXNlKHByb21pc2UpIHsKICAgICAgICAgIHByb21pc2VbUFJPTUlTRV9JRF0gPSBpZCsrOwogICAgICAgICAgcHJvbWlzZS5fc3RhdGUgPSB1bmRlZmluZWQ7CiAgICAgICAgICBwcm9taXNlLl9yZXN1bHQgPSB1bmRlZmluZWQ7CiAgICAgICAgICBwcm9taXNlLl9zdWJzY3JpYmVycyA9IFtdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0aW9uRXJyb3IoKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEVycm9yKCJBcnJheSBNZXRob2RzIG11c3QgYmUgcHJvdmlkZWQgYW4gQXJyYXkiKTsKICAgICAgICB9CiAgICAgICAgdmFyIEVudW1lcmF0b3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBmdW5jdGlvbiBFbnVtZXJhdG9yKENvbnN0cnVjdG9yLCBpbnB1dCkgewogICAgICAgICAgICB0aGlzLl9pbnN0YW5jZUNvbnN0cnVjdG9yID0gQ29uc3RydWN0b3I7CiAgICAgICAgICAgIHRoaXMucHJvbWlzZSA9IG5ldyBDb25zdHJ1Y3Rvcihub29wKTsKICAgICAgICAgICAgaWYgKCF0aGlzLnByb21pc2VbUFJPTUlTRV9JRF0pIHsKICAgICAgICAgICAgICBtYWtlUHJvbWlzZSh0aGlzLnByb21pc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc0FycmF5KGlucHV0KSkgewogICAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gaW5wdXQubGVuZ3RoOwogICAgICAgICAgICAgIHRoaXMuX3JlbWFpbmluZyA9IGlucHV0Lmxlbmd0aDsKICAgICAgICAgICAgICB0aGlzLl9yZXN1bHQgPSBuZXcgQXJyYXkodGhpcy5sZW5ndGgpOwogICAgICAgICAgICAgIGlmICh0aGlzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgZnVsZmlsbCh0aGlzLnByb21pc2UsIHRoaXMuX3Jlc3VsdCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gdGhpcy5sZW5ndGggfHwgMDsKICAgICAgICAgICAgICAgIHRoaXMuX2VudW1lcmF0ZShpbnB1dCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcmVtYWluaW5nID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIGZ1bGZpbGwodGhpcy5wcm9taXNlLCB0aGlzLl9yZXN1bHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZWplY3QodGhpcy5wcm9taXNlLCB2YWxpZGF0aW9uRXJyb3IoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIEVudW1lcmF0b3IucHJvdG90eXBlLl9lbnVtZXJhdGUgPSBmdW5jdGlvbiBfZW51bWVyYXRlKGlucHV0KSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyB0aGlzLl9zdGF0ZSA9PT0gUEVORElORyAmJiBpIDwgaW5wdXQubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB0aGlzLl9lYWNoRW50cnkoaW5wdXRbaV0sIGkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgRW51bWVyYXRvci5wcm90b3R5cGUuX2VhY2hFbnRyeSA9IGZ1bmN0aW9uIF9lYWNoRW50cnkoZW50cnksIGkpIHsKICAgICAgICAgICAgdmFyIGMgPSB0aGlzLl9pbnN0YW5jZUNvbnN0cnVjdG9yOwogICAgICAgICAgICB2YXIgcmVzb2x2ZSQkMSA9IGMucmVzb2x2ZTsKICAgICAgICAgICAgaWYgKHJlc29sdmUkJDEgPT09IHJlc29sdmUkMSkgewogICAgICAgICAgICAgIHZhciBfdGhlbiA9IGdldFRoZW4oZW50cnkpOwogICAgICAgICAgICAgIGlmIChfdGhlbiA9PT0gdGhlbiAmJiBlbnRyeS5fc3RhdGUgIT09IFBFTkRJTkcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3NldHRsZWRBdChlbnRyeS5fc3RhdGUsIGksIGVudHJ5Ll9yZXN1bHQpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIF90aGVuICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9yZW1haW5pbmctLTsKICAgICAgICAgICAgICAgIHRoaXMuX3Jlc3VsdFtpXSA9IGVudHJ5OwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoYyA9PT0gUHJvbWlzZSQxKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJvbWlzZSA9IG5ldyBjKG5vb3ApOwogICAgICAgICAgICAgICAgaGFuZGxlTWF5YmVUaGVuYWJsZShwcm9taXNlLCBlbnRyeSwgX3RoZW4pOwogICAgICAgICAgICAgICAgdGhpcy5fd2lsbFNldHRsZUF0KHByb21pc2UsIGkpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl93aWxsU2V0dGxlQXQobmV3IGMoZnVuY3Rpb24gKHJlc29sdmUkJDEpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUkJDEoZW50cnkpOwogICAgICAgICAgICAgICAgfSksIGkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLl93aWxsU2V0dGxlQXQocmVzb2x2ZSQkMShlbnRyeSksIGkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgRW51bWVyYXRvci5wcm90b3R5cGUuX3NldHRsZWRBdCA9IGZ1bmN0aW9uIF9zZXR0bGVkQXQoc3RhdGUsIGksIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhpcy5wcm9taXNlOwogICAgICAgICAgICBpZiAocHJvbWlzZS5fc3RhdGUgPT09IFBFTkRJTkcpIHsKICAgICAgICAgICAgICB0aGlzLl9yZW1haW5pbmctLTsKICAgICAgICAgICAgICBpZiAoc3RhdGUgPT09IFJFSkVDVEVEKSB7CiAgICAgICAgICAgICAgICByZWplY3QocHJvbWlzZSwgdmFsdWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9yZXN1bHRbaV0gPSB2YWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuX3JlbWFpbmluZyA9PT0gMCkgewogICAgICAgICAgICAgIGZ1bGZpbGwocHJvbWlzZSwgdGhpcy5fcmVzdWx0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIEVudW1lcmF0b3IucHJvdG90eXBlLl93aWxsU2V0dGxlQXQgPSBmdW5jdGlvbiBfd2lsbFNldHRsZUF0KHByb21pc2UsIGkpIHsKICAgICAgICAgICAgdmFyIGVudW1lcmF0b3IgPSB0aGlzOwogICAgICAgICAgICBzdWJzY3JpYmUocHJvbWlzZSwgdW5kZWZpbmVkLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm4gZW51bWVyYXRvci5fc2V0dGxlZEF0KEZVTEZJTExFRCwgaSwgdmFsdWUpOwogICAgICAgICAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVudW1lcmF0b3IuX3NldHRsZWRBdChSRUpFQ1RFRCwgaSwgcmVhc29uKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIEVudW1lcmF0b3I7CiAgICAgICAgfSgpOwogICAgICAgIGZ1bmN0aW9uIGFsbChlbnRyaWVzKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEVudW1lcmF0b3IodGhpcywgZW50cmllcykucHJvbWlzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmFjZShlbnRyaWVzKSB7CiAgICAgICAgICB2YXIgQ29uc3RydWN0b3IgPSB0aGlzOwogICAgICAgICAgaWYgKCFpc0FycmF5KGVudHJpZXMpKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgQ29uc3RydWN0b3IoZnVuY3Rpb24gKF8sIHJlamVjdCkgewogICAgICAgICAgICAgIHJldHVybiByZWplY3QobmV3IFR5cGVFcnJvcigiWW91IG11c3QgcGFzcyBhbiBhcnJheSB0byByYWNlLiIpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbmV3IENvbnN0cnVjdG9yKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICB2YXIgbGVuZ3RoID0gZW50cmllcy5sZW5ndGg7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgQ29uc3RydWN0b3IucmVzb2x2ZShlbnRyaWVzW2ldKS50aGVuKHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVqZWN0JDEocmVhc29uKSB7CiAgICAgICAgICB2YXIgQ29uc3RydWN0b3IgPSB0aGlzOwogICAgICAgICAgdmFyIHByb21pc2UgPSBuZXcgQ29uc3RydWN0b3Iobm9vcCk7CiAgICAgICAgICByZWplY3QocHJvbWlzZSwgcmVhc29uKTsKICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBuZWVkc1Jlc29sdmVyKCkgewogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiWW91IG11c3QgcGFzcyBhIHJlc29sdmVyIGZ1bmN0aW9uIGFzIHRoZSBmaXJzdCBhcmd1bWVudCB0byB0aGUgcHJvbWlzZSBjb25zdHJ1Y3RvciIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBuZWVkc05ldygpIHsKICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkZhaWxlZCB0byBjb25zdHJ1Y3QgJ1Byb21pc2UnOiBQbGVhc2UgdXNlIHRoZSAnbmV3JyBvcGVyYXRvciwgdGhpcyBvYmplY3QgY29uc3RydWN0b3IgY2Fubm90IGJlIGNhbGxlZCBhcyBhIGZ1bmN0aW9uLiIpOwogICAgICAgIH0KICAgICAgICB2YXIgUHJvbWlzZSQxID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgZnVuY3Rpb24gUHJvbWlzZShyZXNvbHZlcikgewogICAgICAgICAgICB0aGlzW1BST01JU0VfSURdID0gbmV4dElkKCk7CiAgICAgICAgICAgIHRoaXMuX3Jlc3VsdCA9IHRoaXMuX3N0YXRlID0gdW5kZWZpbmVkOwogICAgICAgICAgICB0aGlzLl9zdWJzY3JpYmVycyA9IFtdOwogICAgICAgICAgICBpZiAobm9vcCAhPT0gcmVzb2x2ZXIpIHsKICAgICAgICAgICAgICB0eXBlb2YgcmVzb2x2ZXIgIT09ICJmdW5jdGlvbiIgJiYgbmVlZHNSZXNvbHZlcigpOwogICAgICAgICAgICAgIHRoaXMgaW5zdGFuY2VvZiBQcm9taXNlID8gaW5pdGlhbGl6ZVByb21pc2UodGhpcywgcmVzb2x2ZXIpIDogbmVlZHNOZXcoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgUHJvbWlzZS5wcm90b3R5cGUuY2F0Y2ggPSBmdW5jdGlvbiBfY2F0Y2gob25SZWplY3Rpb24pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudGhlbihudWxsLCBvblJlamVjdGlvbik7CiAgICAgICAgICB9OwogICAgICAgICAgUHJvbWlzZS5wcm90b3R5cGUuZmluYWxseSA9IGZ1bmN0aW9uIF9maW5hbGx5KGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhpczsKICAgICAgICAgICAgdmFyIGNvbnN0cnVjdG9yID0gcHJvbWlzZS5jb25zdHJ1Y3RvcjsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2UudGhlbihmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm4gY29uc3RydWN0b3IucmVzb2x2ZShjYWxsYmFjaygpKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwgZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgICAgIHJldHVybiBjb25zdHJ1Y3Rvci5yZXNvbHZlKGNhbGxiYWNrKCkpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhyb3cgcmVhc29uOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gUHJvbWlzZTsKICAgICAgICB9KCk7CiAgICAgICAgUHJvbWlzZSQxLnByb3RvdHlwZS50aGVuID0gdGhlbjsKICAgICAgICBQcm9taXNlJDEuYWxsID0gYWxsOwogICAgICAgIFByb21pc2UkMS5yYWNlID0gcmFjZTsKICAgICAgICBQcm9taXNlJDEucmVzb2x2ZSA9IHJlc29sdmUkMTsKICAgICAgICBQcm9taXNlJDEucmVqZWN0ID0gcmVqZWN0JDE7CiAgICAgICAgUHJvbWlzZSQxLl9zZXRTY2hlZHVsZXIgPSBzZXRTY2hlZHVsZXI7CiAgICAgICAgUHJvbWlzZSQxLl9zZXRBc2FwID0gc2V0QXNhcDsKICAgICAgICBQcm9taXNlJDEuX2FzYXAgPSBhc2FwOwogICAgICAgIGZ1bmN0aW9uIHBvbHlmaWxsKCkgewogICAgICAgICAgdmFyIGxvY2FsID0gdm9pZCAwOwogICAgICAgICAgaWYgKHR5cGVvZiBnbG9iYWwgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIGxvY2FsID0gZ2xvYmFsOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc2VsZiAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgbG9jYWwgPSBzZWxmOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBsb2NhbCA9IEZ1bmN0aW9uKCJyZXR1cm4gdGhpcyIpKCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInBvbHlmaWxsIGZhaWxlZCBiZWNhdXNlIGdsb2JhbCBvYmplY3QgaXMgdW5hdmFpbGFibGUgaW4gdGhpcyBlbnZpcm9ubWVudCIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgUCA9IGxvY2FsLlByb21pc2U7CiAgICAgICAgICBpZiAoUCkgewogICAgICAgICAgICB2YXIgcHJvbWlzZVRvU3RyaW5nID0gbnVsbDsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBwcm9taXNlVG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoUC5yZXNvbHZlKCkpOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgICAgICBpZiAocHJvbWlzZVRvU3RyaW5nID09PSAiW29iamVjdCBQcm9taXNlXSIgJiYgIVAuY2FzdCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbG9jYWwuUHJvbWlzZSA9IFByb21pc2UkMTsKICAgICAgICB9CiAgICAgICAgUHJvbWlzZSQxLnBvbHlmaWxsID0gcG9seWZpbGw7CiAgICAgICAgUHJvbWlzZSQxLlByb21pc2UgPSBQcm9taXNlJDE7CiAgICAgICAgcmV0dXJuIFByb21pc2UkMTsKICAgICAgfSk7CiAgICB9KS5jYWxsKGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18oOSksIF9fd2VicGFja19yZXF1aXJlX18oNCkpOwogIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICBtb2R1bGUuZXhwb3J0cyA9IGlubGluZUhlYWRlcnM7CiAgICB2YXIgZW5jb2RlID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0NSk7CiAgICBmdW5jdGlvbiBpbmxpbmVIZWFkZXJzKHVybCwgaGVhZGVycykgewogICAgICBpZiAoL1w/Ly50ZXN0KHVybCkpIHsKICAgICAgICB1cmwgKz0gIiYiOwogICAgICB9IGVsc2UgewogICAgICAgIHVybCArPSAiPyI7CiAgICAgIH0KICAgICAgcmV0dXJuIHVybCArIGVuY29kZShoZWFkZXJzKTsKICAgIH0KICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgdmFyIHN0cmluZ2lmeVByaW1pdGl2ZSA9IGZ1bmN0aW9uICh2KSB7CiAgICAgIHN3aXRjaCAodHlwZW9mIHYpIHsKICAgICAgICBjYXNlICJzdHJpbmciOgogICAgICAgICAgcmV0dXJuIHY7CiAgICAgICAgY2FzZSAiYm9vbGVhbiI6CiAgICAgICAgICByZXR1cm4gdiA/ICJ0cnVlIiA6ICJmYWxzZSI7CiAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgIHJldHVybiBpc0Zpbml0ZSh2KSA/IHYgOiAiIjsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuICIiOwogICAgICB9CiAgICB9OwogICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAob2JqLCBzZXAsIGVxLCBuYW1lKSB7CiAgICAgIHNlcCA9IHNlcCB8fCAiJiI7CiAgICAgIGVxID0gZXEgfHwgIj0iOwogICAgICBpZiAob2JqID09PSBudWxsKSB7CiAgICAgICAgb2JqID0gdW5kZWZpbmVkOwogICAgICB9CiAgICAgIGlmICh0eXBlb2Ygb2JqID09PSAib2JqZWN0IikgewogICAgICAgIHJldHVybiBtYXAob2JqZWN0S2V5cyhvYmopLCBmdW5jdGlvbiAoaykgewogICAgICAgICAgdmFyIGtzID0gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShrKSkgKyBlcTsKICAgICAgICAgIGlmIChpc0FycmF5KG9ialtrXSkpIHsKICAgICAgICAgICAgcmV0dXJuIG1hcChvYmpba10sIGZ1bmN0aW9uICh2KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGtzICsgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZSh2KSk7CiAgICAgICAgICAgIH0pLmpvaW4oc2VwKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBrcyArIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUob2JqW2tdKSk7CiAgICAgICAgICB9CiAgICAgICAgfSkuam9pbihzZXApOwogICAgICB9CiAgICAgIGlmICghbmFtZSkgcmV0dXJuICIiOwogICAgICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShuYW1lKSkgKyBlcSArIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUob2JqKSk7CiAgICB9OwogICAgdmFyIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5IHx8IGZ1bmN0aW9uICh4cykgewogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHhzKSA9PT0gIltvYmplY3QgQXJyYXldIjsKICAgIH07CiAgICBmdW5jdGlvbiBtYXAoeHMsIGYpIHsKICAgICAgaWYgKHhzLm1hcCkgcmV0dXJuIHhzLm1hcChmKTsKICAgICAgdmFyIHJlcyA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHhzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmVzLnB1c2goZih4c1tpXSwgaSkpOwogICAgICB9CiAgICAgIHJldHVybiByZXM7CiAgICB9CiAgICB2YXIgb2JqZWN0S2V5cyA9IE9iamVjdC5rZXlzIHx8IGZ1bmN0aW9uIChvYmopIHsKICAgICAgdmFyIHJlcyA9IFtdOwogICAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkpIHJlcy5wdXNoKGtleSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlczsKICAgIH07CiAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgInVzZSBzdHJpY3QiOwoKICAgIG1vZHVsZS5leHBvcnRzID0ganNvbnBSZXF1ZXN0OwogICAgdmFyIGVycm9ycyA9IF9fd2VicGFja19yZXF1aXJlX18oNSk7CiAgICB2YXIgSlNPTlBDb3VudGVyID0gMDsKICAgIGZ1bmN0aW9uIGpzb25wUmVxdWVzdCh1cmwsIG9wdHMsIGNiKSB7CiAgICAgIGlmIChvcHRzLm1ldGhvZCAhPT0gIkdFVCIpIHsKICAgICAgICBjYihuZXcgRXJyb3IoIk1ldGhvZCAiICsgb3B0cy5tZXRob2QgKyAiICIgKyB1cmwgKyAiIGlzIG5vdCBzdXBwb3J0ZWQgYnkgSlNPTlAuIikpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBvcHRzLmRlYnVnKCJKU09OUDogc3RhcnQiKTsKICAgICAgdmFyIGNiQ2FsbGVkID0gZmFsc2U7CiAgICAgIHZhciB0aW1lZE91dCA9IGZhbHNlOwogICAgICBKU09OUENvdW50ZXIgKz0gMTsKICAgICAgdmFyIGhlYWQgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaGVhZCIpWzBdOwogICAgICB2YXIgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CiAgICAgIHZhciBjYk5hbWUgPSAiYWxnb2xpYUpTT05QXyIgKyBKU09OUENvdW50ZXI7CiAgICAgIHZhciBkb25lID0gZmFsc2U7CiAgICAgIHdpbmRvd1tjYk5hbWVdID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICByZW1vdmVHbG9iYWxzKCk7CiAgICAgICAgaWYgKHRpbWVkT3V0KSB7CiAgICAgICAgICBvcHRzLmRlYnVnKCJKU09OUDogTGF0ZSBhbnN3ZXIsIGlnbm9yaW5nIik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNiQ2FsbGVkID0gdHJ1ZTsKICAgICAgICBjbGVhbigpOwogICAgICAgIGNiKG51bGwsIHsKICAgICAgICAgIGJvZHk6IGRhdGEsCiAgICAgICAgICByZXNwb25zZVRleHQ6IEpTT04uc3RyaW5naWZ5KGRhdGEpCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIHVybCArPSAiJmNhbGxiYWNrPSIgKyBjYk5hbWU7CiAgICAgIGlmIChvcHRzLmpzb25Cb2R5ICYmIG9wdHMuanNvbkJvZHkucGFyYW1zKSB7CiAgICAgICAgdXJsICs9ICImIiArIG9wdHMuanNvbkJvZHkucGFyYW1zOwogICAgICB9CiAgICAgIHZhciBvbnRpbWVvdXQgPSBzZXRUaW1lb3V0KHRpbWVvdXQsIG9wdHMudGltZW91dHMuY29tcGxldGUpOwogICAgICBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gcmVhZHlzdGF0ZWNoYW5nZTsKICAgICAgc2NyaXB0Lm9ubG9hZCA9IHN1Y2Nlc3M7CiAgICAgIHNjcmlwdC5vbmVycm9yID0gZXJyb3I7CiAgICAgIHNjcmlwdC5hc3luYyA9IHRydWU7CiAgICAgIHNjcmlwdC5kZWZlciA9IHRydWU7CiAgICAgIHNjcmlwdC5zcmMgPSB1cmw7CiAgICAgIGhlYWQuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKICAgICAgZnVuY3Rpb24gc3VjY2VzcygpIHsKICAgICAgICBvcHRzLmRlYnVnKCJKU09OUDogc3VjY2VzcyIpOwogICAgICAgIGlmIChkb25lIHx8IHRpbWVkT3V0KSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGRvbmUgPSB0cnVlOwogICAgICAgIGlmICghY2JDYWxsZWQpIHsKICAgICAgICAgIG9wdHMuZGVidWcoIkpTT05QOiBGYWlsLiBTY3JpcHQgbG9hZGVkIGJ1dCBkaWQgbm90IGNhbGwgdGhlIGNhbGxiYWNrIik7CiAgICAgICAgICBjbGVhbigpOwogICAgICAgICAgY2IobmV3IGVycm9ycy5KU09OUFNjcmlwdEZhaWwoKSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIHJlYWR5c3RhdGVjaGFuZ2UoKSB7CiAgICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA9PT0gImxvYWRlZCIgfHwgdGhpcy5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiKSB7CiAgICAgICAgICBzdWNjZXNzKCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNsZWFuKCkgewogICAgICAgIGNsZWFyVGltZW91dChvbnRpbWVvdXQpOwogICAgICAgIHNjcmlwdC5vbmxvYWQgPSBudWxsOwogICAgICAgIHNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsOwogICAgICAgIHNjcmlwdC5vbmVycm9yID0gbnVsbDsKICAgICAgICBoZWFkLnJlbW92ZUNoaWxkKHNjcmlwdCk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcmVtb3ZlR2xvYmFscygpIHsKICAgICAgICB0cnkgewogICAgICAgICAgZGVsZXRlIHdpbmRvd1tjYk5hbWVdOwogICAgICAgICAgZGVsZXRlIHdpbmRvd1tjYk5hbWUgKyAiX2xvYWRlZCJdOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHdpbmRvd1tjYk5hbWVdID0gd2luZG93W2NiTmFtZSArICJfbG9hZGVkIl0gPSB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIHRpbWVvdXQoKSB7CiAgICAgICAgb3B0cy5kZWJ1ZygiSlNPTlA6IFNjcmlwdCB0aW1lb3V0Iik7CiAgICAgICAgdGltZWRPdXQgPSB0cnVlOwogICAgICAgIGNsZWFuKCk7CiAgICAgICAgY2IobmV3IGVycm9ycy5SZXF1ZXN0VGltZW91dCgpKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBlcnJvcigpIHsKICAgICAgICBvcHRzLmRlYnVnKCJKU09OUDogU2NyaXB0IGVycm9yIik7CiAgICAgICAgaWYgKGRvbmUgfHwgdGltZWRPdXQpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY2xlYW4oKTsKICAgICAgICBjYihuZXcgZXJyb3JzLkpTT05QU2NyaXB0RXJyb3IoKSk7CiAgICAgIH0KICAgIH0KICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IGNyZWF0ZVBsYWNlc0NsaWVudDsKICAgIHZhciBidWlsZFNlYXJjaE1ldGhvZCA9IF9fd2VicGFja19yZXF1aXJlX18oMTMpOwogICAgZnVuY3Rpb24gY3JlYXRlUGxhY2VzQ2xpZW50KGFsZ29saWFzZWFyY2gpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIHBsYWNlcyhhcHBJRCwgYXBpS2V5LCBvcHRzKSB7CiAgICAgICAgdmFyIGNsb25lRGVlcCA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7CiAgICAgICAgb3B0cyA9IG9wdHMgJiYgY2xvbmVEZWVwKG9wdHMpIHx8IHt9OwogICAgICAgIG9wdHMuaG9zdHMgPSBvcHRzLmhvc3RzIHx8IFsicGxhY2VzLWRzbi5hbGdvbGlhLm5ldCIsICJwbGFjZXMtMS5hbGdvbGlhbmV0LmNvbSIsICJwbGFjZXMtMi5hbGdvbGlhbmV0LmNvbSIsICJwbGFjZXMtMy5hbGdvbGlhbmV0LmNvbSJdOwogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwIHx8IHR5cGVvZiBhcHBJRCA9PT0gIm9iamVjdCIgfHwgYXBwSUQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgYXBwSUQgPSAiIjsKICAgICAgICAgIGFwaUtleSA9ICIiOwogICAgICAgICAgb3B0cy5fYWxsb3dFbXB0eUNyZWRlbnRpYWxzID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgdmFyIGNsaWVudCA9IGFsZ29saWFzZWFyY2goYXBwSUQsIGFwaUtleSwgb3B0cyk7CiAgICAgICAgdmFyIGluZGV4ID0gY2xpZW50LmluaXRJbmRleCgicGxhY2VzIik7CiAgICAgICAgaW5kZXguc2VhcmNoID0gYnVpbGRTZWFyY2hNZXRob2QoInF1ZXJ5IiwgIi8xL3BsYWNlcy9xdWVyeSIpOwogICAgICAgIGluZGV4LmdldE9iamVjdCA9IGZ1bmN0aW9uIChvYmplY3RJRCwgY2FsbGJhY2spIHsKICAgICAgICAgIHJldHVybiB0aGlzLmFzLl9qc29uUmVxdWVzdCh7CiAgICAgICAgICAgIG1ldGhvZDogIkdFVCIsCiAgICAgICAgICAgIHVybDogIi8xL3BsYWNlcy8iICsgZW5jb2RlVVJJQ29tcG9uZW50KG9iamVjdElEKSwKICAgICAgICAgICAgaG9zdFR5cGU6ICJyZWFkIiwKICAgICAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrCiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIHJldHVybiBpbmRleDsKICAgICAgfTsKICAgIH0KICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgbW9kdWxlLmV4cG9ydHMgPSAiMy4zMC4wIjsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgbW9kdWxlLmV4cG9ydHMgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUwKTsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgdmFyIHplcHRvID0gX193ZWJwYWNrX3JlcXVpcmVfXygxNSk7CiAgICB2YXIgRE9NID0gX193ZWJwYWNrX3JlcXVpcmVfXygxKTsKICAgIERPTS5lbGVtZW50ID0gemVwdG87CiAgICB2YXIgXyA9IF9fd2VicGFja19yZXF1aXJlX18oMCk7CiAgICBfLmlzQXJyYXkgPSB6ZXB0by5pc0FycmF5OwogICAgXy5pc0Z1bmN0aW9uID0gemVwdG8uaXNGdW5jdGlvbjsKICAgIF8uaXNPYmplY3QgPSB6ZXB0by5pc1BsYWluT2JqZWN0OwogICAgXy5iaW5kID0gemVwdG8ucHJveHk7CiAgICBfLmVhY2ggPSBmdW5jdGlvbiAoY29sbGVjdGlvbiwgY2IpIHsKICAgICAgemVwdG8uZWFjaChjb2xsZWN0aW9uLCByZXZlcnNlQXJncyk7CiAgICAgIGZ1bmN0aW9uIHJldmVyc2VBcmdzKGluZGV4LCB2YWx1ZSkgewogICAgICAgIHJldHVybiBjYih2YWx1ZSwgaW5kZXgpOwogICAgICB9CiAgICB9OwogICAgXy5tYXAgPSB6ZXB0by5tYXA7CiAgICBfLm1peGluID0gemVwdG8uZXh0ZW5kOwogICAgXy5FdmVudCA9IHplcHRvLkV2ZW50OwogICAgdmFyIHR5cGVhaGVhZEtleSA9ICJhYUF1dG9jb21wbGV0ZSI7CiAgICB2YXIgVHlwZWFoZWFkID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1MSk7CiAgICB2YXIgRXZlbnRCdXMgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDE2KTsKICAgIGZ1bmN0aW9uIGF1dG9jb21wbGV0ZShzZWxlY3Rvciwgb3B0aW9ucywgZGF0YXNldHMsIHR5cGVhaGVhZE9iamVjdCkgewogICAgICBkYXRhc2V0cyA9IF8uaXNBcnJheShkYXRhc2V0cykgPyBkYXRhc2V0cyA6IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgICAgdmFyIGlucHV0cyA9IHplcHRvKHNlbGVjdG9yKS5lYWNoKGZ1bmN0aW9uIChpLCBpbnB1dCkgewogICAgICAgIHZhciAkaW5wdXQgPSB6ZXB0byhpbnB1dCk7CiAgICAgICAgdmFyIGV2ZW50QnVzID0gbmV3IEV2ZW50QnVzKHsKICAgICAgICAgIGVsOiAkaW5wdXQKICAgICAgICB9KTsKICAgICAgICB2YXIgdHlwZWFoZWFkID0gdHlwZWFoZWFkT2JqZWN0IHx8IG5ldyBUeXBlYWhlYWQoewogICAgICAgICAgaW5wdXQ6ICRpbnB1dCwKICAgICAgICAgIGV2ZW50QnVzOiBldmVudEJ1cywKICAgICAgICAgIGRyb3Bkb3duTWVudUNvbnRhaW5lcjogb3B0aW9ucy5kcm9wZG93bk1lbnVDb250YWluZXIsCiAgICAgICAgICBoaW50OiBvcHRpb25zLmhpbnQgPT09IHVuZGVmaW5lZCA/IHRydWUgOiAhIW9wdGlvbnMuaGludCwKICAgICAgICAgIG1pbkxlbmd0aDogb3B0aW9ucy5taW5MZW5ndGgsCiAgICAgICAgICBhdXRvc2VsZWN0OiBvcHRpb25zLmF1dG9zZWxlY3QsCiAgICAgICAgICBhdXRvc2VsZWN0T25CbHVyOiBvcHRpb25zLmF1dG9zZWxlY3RPbkJsdXIsCiAgICAgICAgICB0YWJBdXRvY29tcGxldGU6IG9wdGlvbnMudGFiQXV0b2NvbXBsZXRlLAogICAgICAgICAgb3Blbk9uRm9jdXM6IG9wdGlvbnMub3Blbk9uRm9jdXMsCiAgICAgICAgICB0ZW1wbGF0ZXM6IG9wdGlvbnMudGVtcGxhdGVzLAogICAgICAgICAgZGVidWc6IG9wdGlvbnMuZGVidWcsCiAgICAgICAgICBjbGVhck9uU2VsZWN0ZWQ6IG9wdGlvbnMuY2xlYXJPblNlbGVjdGVkLAogICAgICAgICAgY3NzQ2xhc3Nlczogb3B0aW9ucy5jc3NDbGFzc2VzLAogICAgICAgICAgZGF0YXNldHM6IGRhdGFzZXRzLAogICAgICAgICAga2V5Ym9hcmRTaG9ydGN1dHM6IG9wdGlvbnMua2V5Ym9hcmRTaG9ydGN1dHMsCiAgICAgICAgICBhcHBlbmRUbzogb3B0aW9ucy5hcHBlbmRUbywKICAgICAgICAgIGF1dG9XaWR0aDogb3B0aW9ucy5hdXRvV2lkdGgsCiAgICAgICAgICBhcmlhTGFiZWw6IG9wdGlvbnMuYXJpYUxhYmVsIHx8IGlucHV0LmdldEF0dHJpYnV0ZSgiYXJpYS1sYWJlbCIpCiAgICAgICAgfSk7CiAgICAgICAgJGlucHV0LmRhdGEodHlwZWFoZWFkS2V5LCB0eXBlYWhlYWQpOwogICAgICB9KTsKICAgICAgaW5wdXRzLmF1dG9jb21wbGV0ZSA9IHt9OwogICAgICBfLmVhY2goWyJvcGVuIiwgImNsb3NlIiwgImdldFZhbCIsICJzZXRWYWwiLCAiZGVzdHJveSIsICJnZXRXcmFwcGVyIl0sIGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgICBpbnB1dHMuYXV0b2NvbXBsZXRlW21ldGhvZF0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgbWV0aG9kQXJndW1lbnRzID0gYXJndW1lbnRzOwogICAgICAgICAgdmFyIHJlc3VsdDsKICAgICAgICAgIGlucHV0cy5lYWNoKGZ1bmN0aW9uIChqLCBpbnB1dCkgewogICAgICAgICAgICB2YXIgdHlwZWFoZWFkID0gemVwdG8oaW5wdXQpLmRhdGEodHlwZWFoZWFkS2V5KTsKICAgICAgICAgICAgcmVzdWx0ID0gdHlwZWFoZWFkW21ldGhvZF0uYXBwbHkodHlwZWFoZWFkLCBtZXRob2RBcmd1bWVudHMpOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH07CiAgICAgIH0pOwogICAgICByZXR1cm4gaW5wdXRzOwogICAgfQogICAgYXV0b2NvbXBsZXRlLnNvdXJjZXMgPSBUeXBlYWhlYWQuc291cmNlczsKICAgIGF1dG9jb21wbGV0ZS5lc2NhcGVIaWdobGlnaHRlZFN0cmluZyA9IF8uZXNjYXBlSGlnaGxpZ2h0ZWRTdHJpbmc7CiAgICB2YXIgd2FzQXV0b2NvbXBsZXRlU2V0ID0gImF1dG9jb21wbGV0ZSIgaW4gd2luZG93OwogICAgdmFyIG9sZEF1dG9jb21wbGV0ZSA9IHdpbmRvdy5hdXRvY29tcGxldGU7CiAgICBhdXRvY29tcGxldGUubm9Db25mbGljdCA9IGZ1bmN0aW9uIG5vQ29uZmxpY3QoKSB7CiAgICAgIGlmICh3YXNBdXRvY29tcGxldGVTZXQpIHsKICAgICAgICB3aW5kb3cuYXV0b2NvbXBsZXRlID0gb2xkQXV0b2NvbXBsZXRlOwogICAgICB9IGVsc2UgewogICAgICAgIGRlbGV0ZSB3aW5kb3cuYXV0b2NvbXBsZXRlOwogICAgICB9CiAgICAgIHJldHVybiBhdXRvY29tcGxldGU7CiAgICB9OwogICAgbW9kdWxlLmV4cG9ydHMgPSBhdXRvY29tcGxldGU7CiAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgInVzZSBzdHJpY3QiOwoKICAgIHZhciBhdHRyc0tleSA9ICJhYUF0dHJzIjsKICAgIHZhciBfID0gX193ZWJwYWNrX3JlcXVpcmVfXygwKTsKICAgIHZhciBET00gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDEpOwogICAgdmFyIEV2ZW50QnVzID0gX193ZWJwYWNrX3JlcXVpcmVfXygxNik7CiAgICB2YXIgSW5wdXQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUyKTsKICAgIHZhciBEcm9wZG93biA9IF9fd2VicGFja19yZXF1aXJlX18oNTkpOwogICAgdmFyIGh0bWwgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDE3KTsKICAgIHZhciBjc3MgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDExKTsKICAgIGZ1bmN0aW9uIFR5cGVhaGVhZChvKSB7CiAgICAgIHZhciAkbWVudTsKICAgICAgdmFyICRoaW50OwogICAgICBvID0gbyB8fCB7fTsKICAgICAgaWYgKCFvLmlucHV0KSB7CiAgICAgICAgXy5lcnJvcigibWlzc2luZyBpbnB1dCIpOwogICAgICB9CiAgICAgIHRoaXMuaXNBY3RpdmF0ZWQgPSBmYWxzZTsKICAgICAgdGhpcy5kZWJ1ZyA9ICEhby5kZWJ1ZzsKICAgICAgdGhpcy5hdXRvc2VsZWN0ID0gISFvLmF1dG9zZWxlY3Q7CiAgICAgIHRoaXMuYXV0b3NlbGVjdE9uQmx1ciA9ICEhby5hdXRvc2VsZWN0T25CbHVyOwogICAgICB0aGlzLm9wZW5PbkZvY3VzID0gISFvLm9wZW5PbkZvY3VzOwogICAgICB0aGlzLm1pbkxlbmd0aCA9IF8uaXNOdW1iZXIoby5taW5MZW5ndGgpID8gby5taW5MZW5ndGggOiAxOwogICAgICB0aGlzLmF1dG9XaWR0aCA9IG8uYXV0b1dpZHRoID09PSB1bmRlZmluZWQgPyB0cnVlIDogISFvLmF1dG9XaWR0aDsKICAgICAgdGhpcy5jbGVhck9uU2VsZWN0ZWQgPSAhIW8uY2xlYXJPblNlbGVjdGVkOwogICAgICB0aGlzLnRhYkF1dG9jb21wbGV0ZSA9IG8udGFiQXV0b2NvbXBsZXRlID09PSB1bmRlZmluZWQgPyB0cnVlIDogISFvLnRhYkF1dG9jb21wbGV0ZTsKICAgICAgby5oaW50ID0gISFvLmhpbnQ7CiAgICAgIGlmIChvLmhpbnQgJiYgby5hcHBlbmRUbykgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiW2F1dG9jb21wbGV0ZS5qc10gaGludCBhbmQgYXBwZW5kVG8gb3B0aW9ucyBjYW4ndCBiZSB1c2VkIGF0IHRoZSBzYW1lIHRpbWUiKTsKICAgICAgfQogICAgICB0aGlzLmNzcyA9IG8uY3NzID0gXy5taXhpbih7fSwgY3NzLCBvLmFwcGVuZFRvID8gY3NzLmFwcGVuZFRvIDoge30pOwogICAgICB0aGlzLmNzc0NsYXNzZXMgPSBvLmNzc0NsYXNzZXMgPSBfLm1peGluKHt9LCBjc3MuZGVmYXVsdENsYXNzZXMsIG8uY3NzQ2xhc3NlcyB8fCB7fSk7CiAgICAgIHRoaXMuY3NzQ2xhc3Nlcy5wcmVmaXggPSBvLmNzc0NsYXNzZXMuZm9ybWF0dGVkUHJlZml4ID0gXy5mb3JtYXRQcmVmaXgodGhpcy5jc3NDbGFzc2VzLnByZWZpeCwgdGhpcy5jc3NDbGFzc2VzLm5vUHJlZml4KTsKICAgICAgdGhpcy5saXN0Ym94SWQgPSBvLmxpc3Rib3hJZCA9IFt0aGlzLmNzc0NsYXNzZXMucm9vdCwgImxpc3Rib3giLCBfLmdldFVuaXF1ZUlkKCldLmpvaW4oIi0iKTsKICAgICAgdmFyIGRvbUVsdHMgPSBidWlsZERvbShvKTsKICAgICAgdGhpcy4kbm9kZSA9IGRvbUVsdHMud3JhcHBlcjsKICAgICAgdmFyICRpbnB1dCA9IHRoaXMuJGlucHV0ID0gZG9tRWx0cy5pbnB1dDsKICAgICAgJG1lbnUgPSBkb21FbHRzLm1lbnU7CiAgICAgICRoaW50ID0gZG9tRWx0cy5oaW50OwogICAgICBpZiAoby5kcm9wZG93bk1lbnVDb250YWluZXIpIHsKICAgICAgICBET00uZWxlbWVudChvLmRyb3Bkb3duTWVudUNvbnRhaW5lcikuY3NzKCJwb3NpdGlvbiIsICJyZWxhdGl2ZSIpLmFwcGVuZCgkbWVudS5jc3MoInRvcCIsICIwIikpOwogICAgICB9CiAgICAgICRpbnB1dC5vbigiYmx1ci5hYSIsIGZ1bmN0aW9uICgkZSkgewogICAgICAgIHZhciBhY3RpdmUgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50OwogICAgICAgIGlmIChfLmlzTXNpZSgpICYmICgkbWVudVswXSA9PT0gYWN0aXZlIHx8ICRtZW51WzBdLmNvbnRhaW5zKGFjdGl2ZSkpKSB7CiAgICAgICAgICAkZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgJGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CiAgICAgICAgICBfLmRlZmVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgJGlucHV0LmZvY3VzKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAkbWVudS5vbigibW91c2Vkb3duLmFhIiwgZnVuY3Rpb24gKCRlKSB7CiAgICAgICAgJGUucHJldmVudERlZmF1bHQoKTsKICAgICAgfSk7CiAgICAgIHRoaXMuZXZlbnRCdXMgPSBvLmV2ZW50QnVzIHx8IG5ldyBFdmVudEJ1cyh7CiAgICAgICAgZWw6ICRpbnB1dAogICAgICB9KTsKICAgICAgdGhpcy5kcm9wZG93biA9IG5ldyBUeXBlYWhlYWQuRHJvcGRvd24oewogICAgICAgIGFwcGVuZFRvOiBvLmFwcGVuZFRvLAogICAgICAgIHdyYXBwZXI6IHRoaXMuJG5vZGUsCiAgICAgICAgbWVudTogJG1lbnUsCiAgICAgICAgZGF0YXNldHM6IG8uZGF0YXNldHMsCiAgICAgICAgdGVtcGxhdGVzOiBvLnRlbXBsYXRlcywKICAgICAgICBjc3NDbGFzc2VzOiBvLmNzc0NsYXNzZXMsCiAgICAgICAgbWluTGVuZ3RoOiB0aGlzLm1pbkxlbmd0aAogICAgICB9KS5vblN5bmMoInN1Z2dlc3Rpb25DbGlja2VkIiwgdGhpcy5fb25TdWdnZXN0aW9uQ2xpY2tlZCwgdGhpcykub25TeW5jKCJjdXJzb3JNb3ZlZCIsIHRoaXMuX29uQ3Vyc29yTW92ZWQsIHRoaXMpLm9uU3luYygiY3Vyc29yUmVtb3ZlZCIsIHRoaXMuX29uQ3Vyc29yUmVtb3ZlZCwgdGhpcykub25TeW5jKCJvcGVuZWQiLCB0aGlzLl9vbk9wZW5lZCwgdGhpcykub25TeW5jKCJjbG9zZWQiLCB0aGlzLl9vbkNsb3NlZCwgdGhpcykub25TeW5jKCJzaG93biIsIHRoaXMuX29uU2hvd24sIHRoaXMpLm9uU3luYygiZW1wdHkiLCB0aGlzLl9vbkVtcHR5LCB0aGlzKS5vblN5bmMoInJlZHJhd24iLCB0aGlzLl9vblJlZHJhd24sIHRoaXMpLm9uQXN5bmMoImRhdGFzZXRSZW5kZXJlZCIsIHRoaXMuX29uRGF0YXNldFJlbmRlcmVkLCB0aGlzKTsKICAgICAgdGhpcy5pbnB1dCA9IG5ldyBUeXBlYWhlYWQuSW5wdXQoewogICAgICAgIGlucHV0OiAkaW5wdXQsCiAgICAgICAgaGludDogJGhpbnQKICAgICAgfSkub25TeW5jKCJmb2N1c2VkIiwgdGhpcy5fb25Gb2N1c2VkLCB0aGlzKS5vblN5bmMoImJsdXJyZWQiLCB0aGlzLl9vbkJsdXJyZWQsIHRoaXMpLm9uU3luYygiZW50ZXJLZXllZCIsIHRoaXMuX29uRW50ZXJLZXllZCwgdGhpcykub25TeW5jKCJ0YWJLZXllZCIsIHRoaXMuX29uVGFiS2V5ZWQsIHRoaXMpLm9uU3luYygiZXNjS2V5ZWQiLCB0aGlzLl9vbkVzY0tleWVkLCB0aGlzKS5vblN5bmMoInVwS2V5ZWQiLCB0aGlzLl9vblVwS2V5ZWQsIHRoaXMpLm9uU3luYygiZG93bktleWVkIiwgdGhpcy5fb25Eb3duS2V5ZWQsIHRoaXMpLm9uU3luYygibGVmdEtleWVkIiwgdGhpcy5fb25MZWZ0S2V5ZWQsIHRoaXMpLm9uU3luYygicmlnaHRLZXllZCIsIHRoaXMuX29uUmlnaHRLZXllZCwgdGhpcykub25TeW5jKCJxdWVyeUNoYW5nZWQiLCB0aGlzLl9vblF1ZXJ5Q2hhbmdlZCwgdGhpcykub25TeW5jKCJ3aGl0ZXNwYWNlQ2hhbmdlZCIsIHRoaXMuX29uV2hpdGVzcGFjZUNoYW5nZWQsIHRoaXMpOwogICAgICB0aGlzLl9iaW5kS2V5Ym9hcmRTaG9ydGN1dHMobyk7CiAgICAgIHRoaXMuX3NldExhbmd1YWdlRGlyZWN0aW9uKCk7CiAgICB9CiAgICBfLm1peGluKFR5cGVhaGVhZC5wcm90b3R5cGUsIHsKICAgICAgX2JpbmRLZXlib2FyZFNob3J0Y3V0czogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICBpZiAoIW9wdGlvbnMua2V5Ym9hcmRTaG9ydGN1dHMpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyICRpbnB1dCA9IHRoaXMuJGlucHV0OwogICAgICAgIHZhciBrZXlib2FyZFNob3J0Y3V0cyA9IFtdOwogICAgICAgIF8uZWFjaChvcHRpb25zLmtleWJvYXJkU2hvcnRjdXRzLCBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICBpZiAodHlwZW9mIGtleSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAga2V5ID0ga2V5LnRvVXBwZXJDYXNlKCkuY2hhckNvZGVBdCgwKTsKICAgICAgICAgIH0KICAgICAgICAgIGtleWJvYXJkU2hvcnRjdXRzLnB1c2goa2V5KTsKICAgICAgICB9KTsKICAgICAgICBET00uZWxlbWVudChkb2N1bWVudCkua2V5ZG93bihmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgIHZhciBlbHQgPSBldmVudC50YXJnZXQgfHwgZXZlbnQuc3JjRWxlbWVudDsKICAgICAgICAgIHZhciB0YWdOYW1lID0gZWx0LnRhZ05hbWU7CiAgICAgICAgICBpZiAoZWx0LmlzQ29udGVudEVkaXRhYmxlIHx8IHRhZ05hbWUgPT09ICJJTlBVVCIgfHwgdGFnTmFtZSA9PT0gIlNFTEVDVCIgfHwgdGFnTmFtZSA9PT0gIlRFWFRBUkVBIikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgd2hpY2ggPSBldmVudC53aGljaCB8fCBldmVudC5rZXlDb2RlOwogICAgICAgICAgaWYgKGtleWJvYXJkU2hvcnRjdXRzLmluZGV4T2Yod2hpY2gpID09PSAtMSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICAkaW5wdXQuZm9jdXMoKTsKICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgX29uU3VnZ2VzdGlvbkNsaWNrZWQ6IGZ1bmN0aW9uIG9uU3VnZ2VzdGlvbkNsaWNrZWQodHlwZSwgJGVsKSB7CiAgICAgICAgdmFyIGRhdHVtOwogICAgICAgIHZhciBjb250ZXh0ID0gewogICAgICAgICAgc2VsZWN0aW9uTWV0aG9kOiAiY2xpY2siCiAgICAgICAgfTsKICAgICAgICBpZiAoZGF0dW0gPSB0aGlzLmRyb3Bkb3duLmdldERhdHVtRm9yU3VnZ2VzdGlvbigkZWwpKSB7CiAgICAgICAgICB0aGlzLl9zZWxlY3QoZGF0dW0sIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgX29uQ3Vyc29yTW92ZWQ6IGZ1bmN0aW9uIG9uQ3Vyc29yTW92ZWQoZXZlbnQsIHVwZGF0ZUlucHV0KSB7CiAgICAgICAgdmFyIGRhdHVtID0gdGhpcy5kcm9wZG93bi5nZXREYXR1bUZvckN1cnNvcigpOwogICAgICAgIHZhciBjdXJyZW50Q3Vyc29ySWQgPSB0aGlzLmRyb3Bkb3duLmdldEN1cnJlbnRDdXJzb3IoKS5hdHRyKCJpZCIpOwogICAgICAgIHRoaXMuaW5wdXQuc2V0QWN0aXZlRGVzY2VuZGFudChjdXJyZW50Q3Vyc29ySWQpOwogICAgICAgIGlmIChkYXR1bSkgewogICAgICAgICAgaWYgKHVwZGF0ZUlucHV0KSB7CiAgICAgICAgICAgIHRoaXMuaW5wdXQuc2V0SW5wdXRWYWx1ZShkYXR1bS52YWx1ZSwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmV2ZW50QnVzLnRyaWdnZXIoImN1cnNvcmNoYW5nZWQiLCBkYXR1bS5yYXcsIGRhdHVtLmRhdGFzZXROYW1lKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIF9vbkN1cnNvclJlbW92ZWQ6IGZ1bmN0aW9uIG9uQ3Vyc29yUmVtb3ZlZCgpIHsKICAgICAgICB0aGlzLmlucHV0LnJlc2V0SW5wdXRWYWx1ZSgpOwogICAgICAgIHRoaXMuX3VwZGF0ZUhpbnQoKTsKICAgICAgICB0aGlzLmV2ZW50QnVzLnRyaWdnZXIoImN1cnNvcnJlbW92ZWQiKTsKICAgICAgfSwKICAgICAgX29uRGF0YXNldFJlbmRlcmVkOiBmdW5jdGlvbiBvbkRhdGFzZXRSZW5kZXJlZCgpIHsKICAgICAgICB0aGlzLl91cGRhdGVIaW50KCk7CiAgICAgICAgdGhpcy5ldmVudEJ1cy50cmlnZ2VyKCJ1cGRhdGVkIik7CiAgICAgIH0sCiAgICAgIF9vbk9wZW5lZDogZnVuY3Rpb24gb25PcGVuZWQoKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlSGludCgpOwogICAgICAgIHRoaXMuaW5wdXQuZXhwYW5kKCk7CiAgICAgICAgdGhpcy5ldmVudEJ1cy50cmlnZ2VyKCJvcGVuZWQiKTsKICAgICAgfSwKICAgICAgX29uRW1wdHk6IGZ1bmN0aW9uIG9uRW1wdHkoKSB7CiAgICAgICAgdGhpcy5ldmVudEJ1cy50cmlnZ2VyKCJlbXB0eSIpOwogICAgICB9LAogICAgICBfb25SZWRyYXduOiBmdW5jdGlvbiBvblJlZHJhd24oKSB7CiAgICAgICAgdGhpcy4kbm9kZS5jc3MoInRvcCIsIDAgKyAicHgiKTsKICAgICAgICB0aGlzLiRub2RlLmNzcygibGVmdCIsIDAgKyAicHgiKTsKICAgICAgICB2YXIgaW5wdXRSZWN0ID0gdGhpcy4kaW5wdXRbMF0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgaWYgKHRoaXMuYXV0b1dpZHRoKSB7CiAgICAgICAgICB0aGlzLiRub2RlLmNzcygid2lkdGgiLCBpbnB1dFJlY3Qud2lkdGggKyAicHgiKTsKICAgICAgICB9CiAgICAgICAgdmFyIHdyYXBwZXJSZWN0ID0gdGhpcy4kbm9kZVswXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICB2YXIgdG9wID0gaW5wdXRSZWN0LmJvdHRvbSAtIHdyYXBwZXJSZWN0LnRvcDsKICAgICAgICB0aGlzLiRub2RlLmNzcygidG9wIiwgdG9wICsgInB4Iik7CiAgICAgICAgdmFyIGxlZnQgPSBpbnB1dFJlY3QubGVmdCAtIHdyYXBwZXJSZWN0LmxlZnQ7CiAgICAgICAgdGhpcy4kbm9kZS5jc3MoImxlZnQiLCBsZWZ0ICsgInB4Iik7CiAgICAgICAgdGhpcy5ldmVudEJ1cy50cmlnZ2VyKCJyZWRyYXduIik7CiAgICAgIH0sCiAgICAgIF9vblNob3duOiBmdW5jdGlvbiBvblNob3duKCkgewogICAgICAgIHRoaXMuZXZlbnRCdXMudHJpZ2dlcigic2hvd24iKTsKICAgICAgICBpZiAodGhpcy5hdXRvc2VsZWN0KSB7CiAgICAgICAgICB0aGlzLmRyb3Bkb3duLmN1cnNvclRvcFN1Z2dlc3Rpb24oKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIF9vbkNsb3NlZDogZnVuY3Rpb24gb25DbG9zZWQoKSB7CiAgICAgICAgdGhpcy5pbnB1dC5jbGVhckhpbnQoKTsKICAgICAgICB0aGlzLmlucHV0LnJlbW92ZUFjdGl2ZURlc2NlbmRhbnQoKTsKICAgICAgICB0aGlzLmlucHV0LmNvbGxhcHNlKCk7CiAgICAgICAgdGhpcy5ldmVudEJ1cy50cmlnZ2VyKCJjbG9zZWQiKTsKICAgICAgfSwKICAgICAgX29uRm9jdXNlZDogZnVuY3Rpb24gb25Gb2N1c2VkKCkgewogICAgICAgIHRoaXMuaXNBY3RpdmF0ZWQgPSB0cnVlOwogICAgICAgIGlmICh0aGlzLm9wZW5PbkZvY3VzKSB7CiAgICAgICAgICB2YXIgcXVlcnkgPSB0aGlzLmlucHV0LmdldFF1ZXJ5KCk7CiAgICAgICAgICBpZiAocXVlcnkubGVuZ3RoID49IHRoaXMubWluTGVuZ3RoKSB7CiAgICAgICAgICAgIHRoaXMuZHJvcGRvd24udXBkYXRlKHF1ZXJ5KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uZW1wdHkoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZHJvcGRvd24ub3BlbigpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgX29uQmx1cnJlZDogZnVuY3Rpb24gb25CbHVycmVkKCkgewogICAgICAgIHZhciBjdXJzb3JEYXR1bTsKICAgICAgICB2YXIgdG9wU3VnZ2VzdGlvbkRhdHVtOwogICAgICAgIGN1cnNvckRhdHVtID0gdGhpcy5kcm9wZG93bi5nZXREYXR1bUZvckN1cnNvcigpOwogICAgICAgIHRvcFN1Z2dlc3Rpb25EYXR1bSA9IHRoaXMuZHJvcGRvd24uZ2V0RGF0dW1Gb3JUb3BTdWdnZXN0aW9uKCk7CiAgICAgICAgdmFyIGNvbnRleHQgPSB7CiAgICAgICAgICBzZWxlY3Rpb25NZXRob2Q6ICJibHVyIgogICAgICAgIH07CiAgICAgICAgaWYgKCF0aGlzLmRlYnVnKSB7CiAgICAgICAgICBpZiAodGhpcy5hdXRvc2VsZWN0T25CbHVyICYmIGN1cnNvckRhdHVtKSB7CiAgICAgICAgICAgIHRoaXMuX3NlbGVjdChjdXJzb3JEYXR1bSwgY29udGV4dCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYXV0b3NlbGVjdE9uQmx1ciAmJiB0b3BTdWdnZXN0aW9uRGF0dW0pIHsKICAgICAgICAgICAgdGhpcy5fc2VsZWN0KHRvcFN1Z2dlc3Rpb25EYXR1bSwgY29udGV4dCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmlzQWN0aXZhdGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uZW1wdHkoKTsKICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5jbG9zZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgX29uRW50ZXJLZXllZDogZnVuY3Rpb24gb25FbnRlcktleWVkKHR5cGUsICRlKSB7CiAgICAgICAgdmFyIGN1cnNvckRhdHVtOwogICAgICAgIHZhciB0b3BTdWdnZXN0aW9uRGF0dW07CiAgICAgICAgY3Vyc29yRGF0dW0gPSB0aGlzLmRyb3Bkb3duLmdldERhdHVtRm9yQ3Vyc29yKCk7CiAgICAgICAgdG9wU3VnZ2VzdGlvbkRhdHVtID0gdGhpcy5kcm9wZG93bi5nZXREYXR1bUZvclRvcFN1Z2dlc3Rpb24oKTsKICAgICAgICB2YXIgY29udGV4dCA9IHsKICAgICAgICAgIHNlbGVjdGlvbk1ldGhvZDogImVudGVyS2V5IgogICAgICAgIH07CiAgICAgICAgaWYgKGN1cnNvckRhdHVtKSB7CiAgICAgICAgICB0aGlzLl9zZWxlY3QoY3Vyc29yRGF0dW0sIGNvbnRleHQpOwogICAgICAgICAgJGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYXV0b3NlbGVjdCAmJiB0b3BTdWdnZXN0aW9uRGF0dW0pIHsKICAgICAgICAgIHRoaXMuX3NlbGVjdCh0b3BTdWdnZXN0aW9uRGF0dW0sIGNvbnRleHQpOwogICAgICAgICAgJGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIF9vblRhYktleWVkOiBmdW5jdGlvbiBvblRhYktleWVkKHR5cGUsICRlKSB7CiAgICAgICAgaWYgKCF0aGlzLnRhYkF1dG9jb21wbGV0ZSkgewogICAgICAgICAgdGhpcy5kcm9wZG93bi5jbG9zZSgpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgZGF0dW07CiAgICAgICAgdmFyIGNvbnRleHQgPSB7CiAgICAgICAgICBzZWxlY3Rpb25NZXRob2Q6ICJ0YWJLZXkiCiAgICAgICAgfTsKICAgICAgICBpZiAoZGF0dW0gPSB0aGlzLmRyb3Bkb3duLmdldERhdHVtRm9yQ3Vyc29yKCkpIHsKICAgICAgICAgIHRoaXMuX3NlbGVjdChkYXR1bSwgY29udGV4dCk7CiAgICAgICAgICAkZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLl9hdXRvY29tcGxldGUodHJ1ZSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBfb25Fc2NLZXllZDogZnVuY3Rpb24gb25Fc2NLZXllZCgpIHsKICAgICAgICB0aGlzLmRyb3Bkb3duLmNsb3NlKCk7CiAgICAgICAgdGhpcy5pbnB1dC5yZXNldElucHV0VmFsdWUoKTsKICAgICAgfSwKICAgICAgX29uVXBLZXllZDogZnVuY3Rpb24gb25VcEtleWVkKCkgewogICAgICAgIHZhciBxdWVyeSA9IHRoaXMuaW5wdXQuZ2V0UXVlcnkoKTsKICAgICAgICBpZiAodGhpcy5kcm9wZG93bi5pc0VtcHR5ICYmIHF1ZXJ5Lmxlbmd0aCA+PSB0aGlzLm1pbkxlbmd0aCkgewogICAgICAgICAgdGhpcy5kcm9wZG93bi51cGRhdGUocXVlcnkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmRyb3Bkb3duLm1vdmVDdXJzb3JVcCgpOwogICAgICAgIH0KICAgICAgICB0aGlzLmRyb3Bkb3duLm9wZW4oKTsKICAgICAgfSwKICAgICAgX29uRG93bktleWVkOiBmdW5jdGlvbiBvbkRvd25LZXllZCgpIHsKICAgICAgICB2YXIgcXVlcnkgPSB0aGlzLmlucHV0LmdldFF1ZXJ5KCk7CiAgICAgICAgaWYgKHRoaXMuZHJvcGRvd24uaXNFbXB0eSAmJiBxdWVyeS5sZW5ndGggPj0gdGhpcy5taW5MZW5ndGgpIHsKICAgICAgICAgIHRoaXMuZHJvcGRvd24udXBkYXRlKHF1ZXJ5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5kcm9wZG93bi5tb3ZlQ3Vyc29yRG93bigpOwogICAgICAgIH0KICAgICAgICB0aGlzLmRyb3Bkb3duLm9wZW4oKTsKICAgICAgfSwKICAgICAgX29uTGVmdEtleWVkOiBmdW5jdGlvbiBvbkxlZnRLZXllZCgpIHsKICAgICAgICBpZiAodGhpcy5kaXIgPT09ICJydGwiKSB7CiAgICAgICAgICB0aGlzLl9hdXRvY29tcGxldGUoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIF9vblJpZ2h0S2V5ZWQ6IGZ1bmN0aW9uIG9uUmlnaHRLZXllZCgpIHsKICAgICAgICBpZiAodGhpcy5kaXIgPT09ICJsdHIiKSB7CiAgICAgICAgICB0aGlzLl9hdXRvY29tcGxldGUoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIF9vblF1ZXJ5Q2hhbmdlZDogZnVuY3Rpb24gb25RdWVyeUNoYW5nZWQoZSwgcXVlcnkpIHsKICAgICAgICB0aGlzLmlucHV0LmNsZWFySGludElmSW52YWxpZCgpOwogICAgICAgIGlmIChxdWVyeS5sZW5ndGggPj0gdGhpcy5taW5MZW5ndGgpIHsKICAgICAgICAgIHRoaXMuZHJvcGRvd24udXBkYXRlKHF1ZXJ5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5kcm9wZG93bi5lbXB0eSgpOwogICAgICAgIH0KICAgICAgICB0aGlzLmRyb3Bkb3duLm9wZW4oKTsKICAgICAgICB0aGlzLl9zZXRMYW5ndWFnZURpcmVjdGlvbigpOwogICAgICB9LAogICAgICBfb25XaGl0ZXNwYWNlQ2hhbmdlZDogZnVuY3Rpb24gb25XaGl0ZXNwYWNlQ2hhbmdlZCgpIHsKICAgICAgICB0aGlzLl91cGRhdGVIaW50KCk7CiAgICAgICAgdGhpcy5kcm9wZG93bi5vcGVuKCk7CiAgICAgIH0sCiAgICAgIF9zZXRMYW5ndWFnZURpcmVjdGlvbjogZnVuY3Rpb24gc2V0TGFuZ3VhZ2VEaXJlY3Rpb24oKSB7CiAgICAgICAgdmFyIGRpciA9IHRoaXMuaW5wdXQuZ2V0TGFuZ3VhZ2VEaXJlY3Rpb24oKTsKICAgICAgICBpZiAodGhpcy5kaXIgIT09IGRpcikgewogICAgICAgICAgdGhpcy5kaXIgPSBkaXI7CiAgICAgICAgICB0aGlzLiRub2RlLmNzcygiZGlyZWN0aW9uIiwgZGlyKTsKICAgICAgICAgIHRoaXMuZHJvcGRvd24uc2V0TGFuZ3VhZ2VEaXJlY3Rpb24oZGlyKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIF91cGRhdGVIaW50OiBmdW5jdGlvbiB1cGRhdGVIaW50KCkgewogICAgICAgIHZhciBkYXR1bTsKICAgICAgICB2YXIgdmFsOwogICAgICAgIHZhciBxdWVyeTsKICAgICAgICB2YXIgZXNjYXBlZFF1ZXJ5OwogICAgICAgIHZhciBmcm9udE1hdGNoUmVnRXg7CiAgICAgICAgdmFyIG1hdGNoOwogICAgICAgIGRhdHVtID0gdGhpcy5kcm9wZG93bi5nZXREYXR1bUZvclRvcFN1Z2dlc3Rpb24oKTsKICAgICAgICBpZiAoZGF0dW0gJiYgdGhpcy5kcm9wZG93bi5pc1Zpc2libGUoKSAmJiAhdGhpcy5pbnB1dC5oYXNPdmVyZmxvdygpKSB7CiAgICAgICAgICB2YWwgPSB0aGlzLmlucHV0LmdldElucHV0VmFsdWUoKTsKICAgICAgICAgIHF1ZXJ5ID0gSW5wdXQubm9ybWFsaXplUXVlcnkodmFsKTsKICAgICAgICAgIGVzY2FwZWRRdWVyeSA9IF8uZXNjYXBlUmVnRXhDaGFycyhxdWVyeSk7CiAgICAgICAgICBmcm9udE1hdGNoUmVnRXggPSBuZXcgUmVnRXhwKCJeKD86IiArIGVzY2FwZWRRdWVyeSArICIpKC4rJCkiLCAiaSIpOwogICAgICAgICAgbWF0Y2ggPSBmcm9udE1hdGNoUmVnRXguZXhlYyhkYXR1bS52YWx1ZSk7CiAgICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgdGhpcy5pbnB1dC5zZXRIaW50KHZhbCArIG1hdGNoWzFdKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuaW5wdXQuY2xlYXJIaW50KCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuaW5wdXQuY2xlYXJIaW50KCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBfYXV0b2NvbXBsZXRlOiBmdW5jdGlvbiBhdXRvY29tcGxldGUobGF4Q3Vyc29yKSB7CiAgICAgICAgdmFyIGhpbnQ7CiAgICAgICAgdmFyIHF1ZXJ5OwogICAgICAgIHZhciBpc0N1cnNvckF0RW5kOwogICAgICAgIHZhciBkYXR1bTsKICAgICAgICBoaW50ID0gdGhpcy5pbnB1dC5nZXRIaW50KCk7CiAgICAgICAgcXVlcnkgPSB0aGlzLmlucHV0LmdldFF1ZXJ5KCk7CiAgICAgICAgaXNDdXJzb3JBdEVuZCA9IGxheEN1cnNvciB8fCB0aGlzLmlucHV0LmlzQ3Vyc29yQXRFbmQoKTsKICAgICAgICBpZiAoaGludCAmJiBxdWVyeSAhPT0gaGludCAmJiBpc0N1cnNvckF0RW5kKSB7CiAgICAgICAgICBkYXR1bSA9IHRoaXMuZHJvcGRvd24uZ2V0RGF0dW1Gb3JUb3BTdWdnZXN0aW9uKCk7CiAgICAgICAgICBpZiAoZGF0dW0pIHsKICAgICAgICAgICAgdGhpcy5pbnB1dC5zZXRJbnB1dFZhbHVlKGRhdHVtLnZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZXZlbnRCdXMudHJpZ2dlcigiYXV0b2NvbXBsZXRlZCIsIGRhdHVtLnJhdywgZGF0dW0uZGF0YXNldE5hbWUpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgX3NlbGVjdDogZnVuY3Rpb24gc2VsZWN0KGRhdHVtLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKHR5cGVvZiBkYXR1bS52YWx1ZSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIHRoaXMuaW5wdXQuc2V0UXVlcnkoZGF0dW0udmFsdWUpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5jbGVhck9uU2VsZWN0ZWQpIHsKICAgICAgICAgIHRoaXMuc2V0VmFsKCIiKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5pbnB1dC5zZXRJbnB1dFZhbHVlKGRhdHVtLnZhbHVlLCB0cnVlKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fc2V0TGFuZ3VhZ2VEaXJlY3Rpb24oKTsKICAgICAgICB2YXIgZXZlbnQgPSB0aGlzLmV2ZW50QnVzLnRyaWdnZXIoInNlbGVjdGVkIiwgZGF0dW0ucmF3LCBkYXR1bS5kYXRhc2V0TmFtZSwgY29udGV4dCk7CiAgICAgICAgaWYgKGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpID09PSBmYWxzZSkgewogICAgICAgICAgdGhpcy5kcm9wZG93bi5jbG9zZSgpOwogICAgICAgICAgXy5kZWZlcihfLmJpbmQodGhpcy5kcm9wZG93bi5lbXB0eSwgdGhpcy5kcm9wZG93bikpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgb3BlbjogZnVuY3Rpb24gb3BlbigpIHsKICAgICAgICBpZiAoIXRoaXMuaXNBY3RpdmF0ZWQpIHsKICAgICAgICAgIHZhciBxdWVyeSA9IHRoaXMuaW5wdXQuZ2V0SW5wdXRWYWx1ZSgpOwogICAgICAgICAgaWYgKHF1ZXJ5Lmxlbmd0aCA+PSB0aGlzLm1pbkxlbmd0aCkgewogICAgICAgICAgICB0aGlzLmRyb3Bkb3duLnVwZGF0ZShxdWVyeSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmRyb3Bkb3duLmVtcHR5KCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuZHJvcGRvd24ub3BlbigpOwogICAgICB9LAogICAgICBjbG9zZTogZnVuY3Rpb24gY2xvc2UoKSB7CiAgICAgICAgdGhpcy5kcm9wZG93bi5jbG9zZSgpOwogICAgICB9LAogICAgICBzZXRWYWw6IGZ1bmN0aW9uIHNldFZhbCh2YWwpIHsKICAgICAgICB2YWwgPSBfLnRvU3RyKHZhbCk7CiAgICAgICAgaWYgKHRoaXMuaXNBY3RpdmF0ZWQpIHsKICAgICAgICAgIHRoaXMuaW5wdXQuc2V0SW5wdXRWYWx1ZSh2YWwpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmlucHV0LnNldFF1ZXJ5KHZhbCk7CiAgICAgICAgICB0aGlzLmlucHV0LnNldElucHV0VmFsdWUodmFsLCB0cnVlKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fc2V0TGFuZ3VhZ2VEaXJlY3Rpb24oKTsKICAgICAgfSwKICAgICAgZ2V0VmFsOiBmdW5jdGlvbiBnZXRWYWwoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5wdXQuZ2V0UXVlcnkoKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgICB0aGlzLmlucHV0LmRlc3Ryb3koKTsKICAgICAgICB0aGlzLmRyb3Bkb3duLmRlc3Ryb3koKTsKICAgICAgICBkZXN0cm95RG9tU3RydWN0dXJlKHRoaXMuJG5vZGUsIHRoaXMuY3NzQ2xhc3Nlcyk7CiAgICAgICAgdGhpcy4kbm9kZSA9IG51bGw7CiAgICAgIH0sCiAgICAgIGdldFdyYXBwZXI6IGZ1bmN0aW9uIGdldFdyYXBwZXIoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZHJvcGRvd24uJGNvbnRhaW5lclswXTsKICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiBidWlsZERvbShvcHRpb25zKSB7CiAgICAgIHZhciAkaW5wdXQ7CiAgICAgIHZhciAkd3JhcHBlcjsKICAgICAgdmFyICRkcm9wZG93bjsKICAgICAgdmFyICRoaW50OwogICAgICAkaW5wdXQgPSBET00uZWxlbWVudChvcHRpb25zLmlucHV0KTsKICAgICAgJHdyYXBwZXIgPSBET00uZWxlbWVudChodG1sLndyYXBwZXIucmVwbGFjZSgiJVJPT1QlIiwgb3B0aW9ucy5jc3NDbGFzc2VzLnJvb3QpKS5jc3Mob3B0aW9ucy5jc3Mud3JhcHBlcik7CiAgICAgIGlmICghb3B0aW9ucy5hcHBlbmRUbyAmJiAkaW5wdXQuY3NzKCJkaXNwbGF5IikgPT09ICJibG9jayIgJiYgJGlucHV0LnBhcmVudCgpLmNzcygiZGlzcGxheSIpID09PSAidGFibGUiKSB7CiAgICAgICAgJHdyYXBwZXIuY3NzKCJkaXNwbGF5IiwgInRhYmxlLWNlbGwiKTsKICAgICAgfQogICAgICB2YXIgZHJvcGRvd25IdG1sID0gaHRtbC5kcm9wZG93bi5yZXBsYWNlKCIlUFJFRklYJSIsIG9wdGlvbnMuY3NzQ2xhc3Nlcy5wcmVmaXgpLnJlcGxhY2UoIiVEUk9QRE9XTl9NRU5VJSIsIG9wdGlvbnMuY3NzQ2xhc3Nlcy5kcm9wZG93bk1lbnUpOwogICAgICAkZHJvcGRvd24gPSBET00uZWxlbWVudChkcm9wZG93bkh0bWwpLmNzcyhvcHRpb25zLmNzcy5kcm9wZG93bikuYXR0cih7CiAgICAgICAgcm9sZTogImxpc3Rib3giLAogICAgICAgIGlkOiBvcHRpb25zLmxpc3Rib3hJZAogICAgICB9KTsKICAgICAgaWYgKG9wdGlvbnMudGVtcGxhdGVzICYmIG9wdGlvbnMudGVtcGxhdGVzLmRyb3Bkb3duTWVudSkgewogICAgICAgICRkcm9wZG93bi5odG1sKF8udGVtcGxhdGlmeShvcHRpb25zLnRlbXBsYXRlcy5kcm9wZG93bk1lbnUpKCkpOwogICAgICB9CiAgICAgICRoaW50ID0gJGlucHV0LmNsb25lKCkuY3NzKG9wdGlvbnMuY3NzLmhpbnQpLmNzcyhnZXRCYWNrZ3JvdW5kU3R5bGVzKCRpbnB1dCkpOwogICAgICAkaGludC52YWwoIiIpLmFkZENsYXNzKF8uY2xhc3NOYW1lKG9wdGlvbnMuY3NzQ2xhc3Nlcy5wcmVmaXgsIG9wdGlvbnMuY3NzQ2xhc3Nlcy5oaW50LCB0cnVlKSkucmVtb3ZlQXR0cigiaWQgbmFtZSBwbGFjZWhvbGRlciByZXF1aXJlZCIpLnByb3AoInJlYWRvbmx5IiwgdHJ1ZSkuYXR0cih7CiAgICAgICAgImFyaWEtaGlkZGVuIjogInRydWUiLAogICAgICAgIGF1dG9jb21wbGV0ZTogIm9mZiIsCiAgICAgICAgc3BlbGxjaGVjazogImZhbHNlIiwKICAgICAgICB0YWJpbmRleDogLTEKICAgICAgfSk7CiAgICAgIGlmICgkaGludC5yZW1vdmVEYXRhKSB7CiAgICAgICAgJGhpbnQucmVtb3ZlRGF0YSgpOwogICAgICB9CiAgICAgICRpbnB1dC5kYXRhKGF0dHJzS2V5LCB7CiAgICAgICAgImFyaWEtYXV0b2NvbXBsZXRlIjogJGlucHV0LmF0dHIoImFyaWEtYXV0b2NvbXBsZXRlIiksCiAgICAgICAgImFyaWEtZXhwYW5kZWQiOiAkaW5wdXQuYXR0cigiYXJpYS1leHBhbmRlZCIpLAogICAgICAgICJhcmlhLW93bnMiOiAkaW5wdXQuYXR0cigiYXJpYS1vd25zIiksCiAgICAgICAgYXV0b2NvbXBsZXRlOiAkaW5wdXQuYXR0cigiYXV0b2NvbXBsZXRlIiksCiAgICAgICAgZGlyOiAkaW5wdXQuYXR0cigiZGlyIiksCiAgICAgICAgcm9sZTogJGlucHV0LmF0dHIoInJvbGUiKSwKICAgICAgICBzcGVsbGNoZWNrOiAkaW5wdXQuYXR0cigic3BlbGxjaGVjayIpLAogICAgICAgIHN0eWxlOiAkaW5wdXQuYXR0cigic3R5bGUiKSwKICAgICAgICB0eXBlOiAkaW5wdXQuYXR0cigidHlwZSIpCiAgICAgIH0pOwogICAgICAkaW5wdXQuYWRkQ2xhc3MoXy5jbGFzc05hbWUob3B0aW9ucy5jc3NDbGFzc2VzLnByZWZpeCwgb3B0aW9ucy5jc3NDbGFzc2VzLmlucHV0LCB0cnVlKSkuYXR0cih7CiAgICAgICAgYXV0b2NvbXBsZXRlOiAib2ZmIiwKICAgICAgICBzcGVsbGNoZWNrOiBmYWxzZSwKICAgICAgICByb2xlOiAiY29tYm9ib3giLAogICAgICAgICJhcmlhLWF1dG9jb21wbGV0ZSI6IG9wdGlvbnMuZGF0YXNldHMgJiYgb3B0aW9ucy5kYXRhc2V0c1swXSAmJiBvcHRpb25zLmRhdGFzZXRzWzBdLmRpc3BsYXlLZXkgPyAiYm90aCIgOiAibGlzdCIsCiAgICAgICAgImFyaWEtZXhwYW5kZWQiOiAiZmFsc2UiLAogICAgICAgICJhcmlhLWxhYmVsIjogb3B0aW9ucy5hcmlhTGFiZWwsCiAgICAgICAgImFyaWEtb3ducyI6IG9wdGlvbnMubGlzdGJveElkCiAgICAgIH0pLmNzcyhvcHRpb25zLmhpbnQgPyBvcHRpb25zLmNzcy5pbnB1dCA6IG9wdGlvbnMuY3NzLmlucHV0V2l0aE5vSGludCk7CiAgICAgIHRyeSB7CiAgICAgICAgaWYgKCEkaW5wdXQuYXR0cigiZGlyIikpIHsKICAgICAgICAgICRpbnB1dC5hdHRyKCJkaXIiLCAiYXV0byIpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgJHdyYXBwZXIgPSBvcHRpb25zLmFwcGVuZFRvID8gJHdyYXBwZXIuYXBwZW5kVG8oRE9NLmVsZW1lbnQob3B0aW9ucy5hcHBlbmRUbykuZXEoMCkpLmVxKDApIDogJGlucHV0LndyYXAoJHdyYXBwZXIpLnBhcmVudCgpOwogICAgICAkd3JhcHBlci5wcmVwZW5kKG9wdGlvbnMuaGludCA/ICRoaW50IDogbnVsbCkuYXBwZW5kKCRkcm9wZG93bik7CiAgICAgIHJldHVybiB7CiAgICAgICAgd3JhcHBlcjogJHdyYXBwZXIsCiAgICAgICAgaW5wdXQ6ICRpbnB1dCwKICAgICAgICBoaW50OiAkaGludCwKICAgICAgICBtZW51OiAkZHJvcGRvd24KICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIGdldEJhY2tncm91bmRTdHlsZXMoJGVsKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgYmFja2dyb3VuZEF0dGFjaG1lbnQ6ICRlbC5jc3MoImJhY2tncm91bmQtYXR0YWNobWVudCIpLAogICAgICAgIGJhY2tncm91bmRDbGlwOiAkZWwuY3NzKCJiYWNrZ3JvdW5kLWNsaXAiKSwKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICRlbC5jc3MoImJhY2tncm91bmQtY29sb3IiKSwKICAgICAgICBiYWNrZ3JvdW5kSW1hZ2U6ICRlbC5jc3MoImJhY2tncm91bmQtaW1hZ2UiKSwKICAgICAgICBiYWNrZ3JvdW5kT3JpZ2luOiAkZWwuY3NzKCJiYWNrZ3JvdW5kLW9yaWdpbiIpLAogICAgICAgIGJhY2tncm91bmRQb3NpdGlvbjogJGVsLmNzcygiYmFja2dyb3VuZC1wb3NpdGlvbiIpLAogICAgICAgIGJhY2tncm91bmRSZXBlYXQ6ICRlbC5jc3MoImJhY2tncm91bmQtcmVwZWF0IiksCiAgICAgICAgYmFja2dyb3VuZFNpemU6ICRlbC5jc3MoImJhY2tncm91bmQtc2l6ZSIpCiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBkZXN0cm95RG9tU3RydWN0dXJlKCRub2RlLCBjc3NDbGFzc2VzKSB7CiAgICAgIHZhciAkaW5wdXQgPSAkbm9kZS5maW5kKF8uY2xhc3NOYW1lKGNzc0NsYXNzZXMucHJlZml4LCBjc3NDbGFzc2VzLmlucHV0KSk7CiAgICAgIF8uZWFjaCgkaW5wdXQuZGF0YShhdHRyc0tleSksIGZ1bmN0aW9uICh2YWwsIGtleSkgewogICAgICAgIGlmICh2YWwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgJGlucHV0LnJlbW92ZUF0dHIoa2V5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgJGlucHV0LmF0dHIoa2V5LCB2YWwpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgICRpbnB1dC5kZXRhY2goKS5yZW1vdmVDbGFzcyhfLmNsYXNzTmFtZShjc3NDbGFzc2VzLnByZWZpeCwgY3NzQ2xhc3Nlcy5pbnB1dCwgdHJ1ZSkpLmluc2VydEFmdGVyKCRub2RlKTsKICAgICAgaWYgKCRpbnB1dC5yZW1vdmVEYXRhKSB7CiAgICAgICAgJGlucHV0LnJlbW92ZURhdGEoYXR0cnNLZXkpOwogICAgICB9CiAgICAgICRub2RlLnJlbW92ZSgpOwogICAgfQogICAgVHlwZWFoZWFkLkRyb3Bkb3duID0gRHJvcGRvd247CiAgICBUeXBlYWhlYWQuSW5wdXQgPSBJbnB1dDsKICAgIFR5cGVhaGVhZC5zb3VyY2VzID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2MSk7CiAgICBtb2R1bGUuZXhwb3J0cyA9IFR5cGVhaGVhZDsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgdmFyIHNwZWNpYWxLZXlDb2RlTWFwOwogICAgc3BlY2lhbEtleUNvZGVNYXAgPSB7CiAgICAgIDk6ICJ0YWIiLAogICAgICAyNzogImVzYyIsCiAgICAgIDM3OiAibGVmdCIsCiAgICAgIDM5OiAicmlnaHQiLAogICAgICAxMzogImVudGVyIiwKICAgICAgMzg6ICJ1cCIsCiAgICAgIDQwOiAiZG93biIKICAgIH07CiAgICB2YXIgXyA9IF9fd2VicGFja19yZXF1aXJlX18oMCk7CiAgICB2YXIgRE9NID0gX193ZWJwYWNrX3JlcXVpcmVfXygxKTsKICAgIHZhciBFdmVudEVtaXR0ZXIgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDEwKTsKICAgIGZ1bmN0aW9uIElucHV0KG8pIHsKICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICB2YXIgb25CbHVyOwogICAgICB2YXIgb25Gb2N1czsKICAgICAgdmFyIG9uS2V5ZG93bjsKICAgICAgdmFyIG9uSW5wdXQ7CiAgICAgIG8gPSBvIHx8IHt9OwogICAgICBpZiAoIW8uaW5wdXQpIHsKICAgICAgICBfLmVycm9yKCJpbnB1dCBpcyBtaXNzaW5nIik7CiAgICAgIH0KICAgICAgb25CbHVyID0gXy5iaW5kKHRoaXMuX29uQmx1ciwgdGhpcyk7CiAgICAgIG9uRm9jdXMgPSBfLmJpbmQodGhpcy5fb25Gb2N1cywgdGhpcyk7CiAgICAgIG9uS2V5ZG93biA9IF8uYmluZCh0aGlzLl9vbktleWRvd24sIHRoaXMpOwogICAgICBvbklucHV0ID0gXy5iaW5kKHRoaXMuX29uSW5wdXQsIHRoaXMpOwogICAgICB0aGlzLiRoaW50ID0gRE9NLmVsZW1lbnQoby5oaW50KTsKICAgICAgdGhpcy4kaW5wdXQgPSBET00uZWxlbWVudChvLmlucHV0KS5vbigiYmx1ci5hYSIsIG9uQmx1cikub24oImZvY3VzLmFhIiwgb25Gb2N1cykub24oImtleWRvd24uYWEiLCBvbktleWRvd24pOwogICAgICBpZiAodGhpcy4kaGludC5sZW5ndGggPT09IDApIHsKICAgICAgICB0aGlzLnNldEhpbnQgPSB0aGlzLmdldEhpbnQgPSB0aGlzLmNsZWFySGludCA9IHRoaXMuY2xlYXJIaW50SWZJbnZhbGlkID0gXy5ub29wOwogICAgICB9CiAgICAgIGlmICghXy5pc01zaWUoKSkgewogICAgICAgIHRoaXMuJGlucHV0Lm9uKCJpbnB1dC5hYSIsIG9uSW5wdXQpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuJGlucHV0Lm9uKCJrZXlkb3duLmFhIGtleXByZXNzLmFhIGN1dC5hYSBwYXN0ZS5hYSIsIGZ1bmN0aW9uICgkZSkgewogICAgICAgICAgaWYgKHNwZWNpYWxLZXlDb2RlTWFwWyRlLndoaWNoIHx8ICRlLmtleUNvZGVdKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIF8uZGVmZXIoXy5iaW5kKHRoYXQuX29uSW5wdXQsIHRoYXQsICRlKSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgdGhpcy5xdWVyeSA9IHRoaXMuJGlucHV0LnZhbCgpOwogICAgICB0aGlzLiRvdmVyZmxvd0hlbHBlciA9IGJ1aWxkT3ZlcmZsb3dIZWxwZXIodGhpcy4kaW5wdXQpOwogICAgfQogICAgSW5wdXQubm9ybWFsaXplUXVlcnkgPSBmdW5jdGlvbiAoc3RyKSB7CiAgICAgIHJldHVybiAoc3RyIHx8ICIiKS5yZXBsYWNlKC9eXHMqL2csICIiKS5yZXBsYWNlKC9cc3syLH0vZywgIiAiKTsKICAgIH07CiAgICBfLm1peGluKElucHV0LnByb3RvdHlwZSwgRXZlbnRFbWl0dGVyLCB7CiAgICAgIF9vbkJsdXI6IGZ1bmN0aW9uIG9uQmx1cigpIHsKICAgICAgICB0aGlzLnJlc2V0SW5wdXRWYWx1ZSgpOwogICAgICAgIHRoaXMuJGlucHV0LnJlbW92ZUF0dHIoImFyaWEtYWN0aXZlZGVzY2VuZGFudCIpOwogICAgICAgIHRoaXMudHJpZ2dlcigiYmx1cnJlZCIpOwogICAgICB9LAogICAgICBfb25Gb2N1czogZnVuY3Rpb24gb25Gb2N1cygpIHsKICAgICAgICB0aGlzLnRyaWdnZXIoImZvY3VzZWQiKTsKICAgICAgfSwKICAgICAgX29uS2V5ZG93bjogZnVuY3Rpb24gb25LZXlkb3duKCRlKSB7CiAgICAgICAgdmFyIGtleU5hbWUgPSBzcGVjaWFsS2V5Q29kZU1hcFskZS53aGljaCB8fCAkZS5rZXlDb2RlXTsKICAgICAgICB0aGlzLl9tYW5hZ2VQcmV2ZW50RGVmYXVsdChrZXlOYW1lLCAkZSk7CiAgICAgICAgaWYgKGtleU5hbWUgJiYgdGhpcy5fc2hvdWxkVHJpZ2dlcihrZXlOYW1lLCAkZSkpIHsKICAgICAgICAgIHRoaXMudHJpZ2dlcihrZXlOYW1lICsgIktleWVkIiwgJGUpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgX29uSW5wdXQ6IGZ1bmN0aW9uIG9uSW5wdXQoKSB7CiAgICAgICAgdGhpcy5fY2hlY2tJbnB1dFZhbHVlKCk7CiAgICAgIH0sCiAgICAgIF9tYW5hZ2VQcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24gbWFuYWdlUHJldmVudERlZmF1bHQoa2V5TmFtZSwgJGUpIHsKICAgICAgICB2YXIgcHJldmVudERlZmF1bHQ7CiAgICAgICAgdmFyIGhpbnRWYWx1ZTsKICAgICAgICB2YXIgaW5wdXRWYWx1ZTsKICAgICAgICBzd2l0Y2ggKGtleU5hbWUpIHsKICAgICAgICAgIGNhc2UgInRhYiI6CiAgICAgICAgICAgIGhpbnRWYWx1ZSA9IHRoaXMuZ2V0SGludCgpOwogICAgICAgICAgICBpbnB1dFZhbHVlID0gdGhpcy5nZXRJbnB1dFZhbHVlKCk7CiAgICAgICAgICAgIHByZXZlbnREZWZhdWx0ID0gaGludFZhbHVlICYmIGhpbnRWYWx1ZSAhPT0gaW5wdXRWYWx1ZSAmJiAhd2l0aE1vZGlmaWVyKCRlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJ1cCI6CiAgICAgICAgICBjYXNlICJkb3duIjoKICAgICAgICAgICAgcHJldmVudERlZmF1bHQgPSAhd2l0aE1vZGlmaWVyKCRlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBwcmV2ZW50RGVmYXVsdCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAocHJldmVudERlZmF1bHQpIHsKICAgICAgICAgICRlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBfc2hvdWxkVHJpZ2dlcjogZnVuY3Rpb24gc2hvdWxkVHJpZ2dlcihrZXlOYW1lLCAkZSkgewogICAgICAgIHZhciB0cmlnZ2VyOwogICAgICAgIHN3aXRjaCAoa2V5TmFtZSkgewogICAgICAgICAgY2FzZSAidGFiIjoKICAgICAgICAgICAgdHJpZ2dlciA9ICF3aXRoTW9kaWZpZXIoJGUpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRyaWdnZXIgPSB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJpZ2dlcjsKICAgICAgfSwKICAgICAgX2NoZWNrSW5wdXRWYWx1ZTogZnVuY3Rpb24gY2hlY2tJbnB1dFZhbHVlKCkgewogICAgICAgIHZhciBpbnB1dFZhbHVlOwogICAgICAgIHZhciBhcmVFcXVpdmFsZW50OwogICAgICAgIHZhciBoYXNEaWZmZXJlbnRXaGl0ZXNwYWNlOwogICAgICAgIGlucHV0VmFsdWUgPSB0aGlzLmdldElucHV0VmFsdWUoKTsKICAgICAgICBhcmVFcXVpdmFsZW50ID0gYXJlUXVlcmllc0VxdWl2YWxlbnQoaW5wdXRWYWx1ZSwgdGhpcy5xdWVyeSk7CiAgICAgICAgaGFzRGlmZmVyZW50V2hpdGVzcGFjZSA9IGFyZUVxdWl2YWxlbnQgJiYgdGhpcy5xdWVyeSA/IHRoaXMucXVlcnkubGVuZ3RoICE9PSBpbnB1dFZhbHVlLmxlbmd0aCA6IGZhbHNlOwogICAgICAgIHRoaXMucXVlcnkgPSBpbnB1dFZhbHVlOwogICAgICAgIGlmICghYXJlRXF1aXZhbGVudCkgewogICAgICAgICAgdGhpcy50cmlnZ2VyKCJxdWVyeUNoYW5nZWQiLCB0aGlzLnF1ZXJ5KTsKICAgICAgICB9IGVsc2UgaWYgKGhhc0RpZmZlcmVudFdoaXRlc3BhY2UpIHsKICAgICAgICAgIHRoaXMudHJpZ2dlcigid2hpdGVzcGFjZUNoYW5nZWQiLCB0aGlzLnF1ZXJ5KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGZvY3VzOiBmdW5jdGlvbiBmb2N1cygpIHsKICAgICAgICB0aGlzLiRpbnB1dC5mb2N1cygpOwogICAgICB9LAogICAgICBibHVyOiBmdW5jdGlvbiBibHVyKCkgewogICAgICAgIHRoaXMuJGlucHV0LmJsdXIoKTsKICAgICAgfSwKICAgICAgZ2V0UXVlcnk6IGZ1bmN0aW9uIGdldFF1ZXJ5KCkgewogICAgICAgIHJldHVybiB0aGlzLnF1ZXJ5OwogICAgICB9LAogICAgICBzZXRRdWVyeTogZnVuY3Rpb24gc2V0UXVlcnkocXVlcnkpIHsKICAgICAgICB0aGlzLnF1ZXJ5ID0gcXVlcnk7CiAgICAgIH0sCiAgICAgIGdldElucHV0VmFsdWU6IGZ1bmN0aW9uIGdldElucHV0VmFsdWUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuJGlucHV0LnZhbCgpOwogICAgICB9LAogICAgICBzZXRJbnB1dFZhbHVlOiBmdW5jdGlvbiBzZXRJbnB1dFZhbHVlKHZhbHVlLCBzaWxlbnQpIHsKICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgdmFsdWUgPSB0aGlzLnF1ZXJ5OwogICAgICAgIH0KICAgICAgICB0aGlzLiRpbnB1dC52YWwodmFsdWUpOwogICAgICAgIGlmIChzaWxlbnQpIHsKICAgICAgICAgIHRoaXMuY2xlYXJIaW50KCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuX2NoZWNrSW5wdXRWYWx1ZSgpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZXhwYW5kOiBmdW5jdGlvbiBleHBhbmQoKSB7CiAgICAgICAgdGhpcy4kaW5wdXQuYXR0cigiYXJpYS1leHBhbmRlZCIsICJ0cnVlIik7CiAgICAgIH0sCiAgICAgIGNvbGxhcHNlOiBmdW5jdGlvbiBjb2xsYXBzZSgpIHsKICAgICAgICB0aGlzLiRpbnB1dC5hdHRyKCJhcmlhLWV4cGFuZGVkIiwgImZhbHNlIik7CiAgICAgIH0sCiAgICAgIHNldEFjdGl2ZURlc2NlbmRhbnQ6IGZ1bmN0aW9uIHNldEFjdGl2ZURlc2NlbmRhbnQoYWN0aXZlZGVzY2VuZGFudElkKSB7CiAgICAgICAgdGhpcy4kaW5wdXQuYXR0cigiYXJpYS1hY3RpdmVkZXNjZW5kYW50IiwgYWN0aXZlZGVzY2VuZGFudElkKTsKICAgICAgfSwKICAgICAgcmVtb3ZlQWN0aXZlRGVzY2VuZGFudDogZnVuY3Rpb24gcmVtb3ZlQWN0aXZlRGVzY2VuZGFudCgpIHsKICAgICAgICB0aGlzLiRpbnB1dC5yZW1vdmVBdHRyKCJhcmlhLWFjdGl2ZWRlc2NlbmRhbnQiKTsKICAgICAgfSwKICAgICAgcmVzZXRJbnB1dFZhbHVlOiBmdW5jdGlvbiByZXNldElucHV0VmFsdWUoKSB7CiAgICAgICAgdGhpcy5zZXRJbnB1dFZhbHVlKHRoaXMucXVlcnksIHRydWUpOwogICAgICB9LAogICAgICBnZXRIaW50OiBmdW5jdGlvbiBnZXRIaW50KCkgewogICAgICAgIHJldHVybiB0aGlzLiRoaW50LnZhbCgpOwogICAgICB9LAogICAgICBzZXRIaW50OiBmdW5jdGlvbiBzZXRIaW50KHZhbHVlKSB7CiAgICAgICAgdGhpcy4kaGludC52YWwodmFsdWUpOwogICAgICB9LAogICAgICBjbGVhckhpbnQ6IGZ1bmN0aW9uIGNsZWFySGludCgpIHsKICAgICAgICB0aGlzLnNldEhpbnQoIiIpOwogICAgICB9LAogICAgICBjbGVhckhpbnRJZkludmFsaWQ6IGZ1bmN0aW9uIGNsZWFySGludElmSW52YWxpZCgpIHsKICAgICAgICB2YXIgdmFsOwogICAgICAgIHZhciBoaW50OwogICAgICAgIHZhciB2YWxJc1ByZWZpeE9mSGludDsKICAgICAgICB2YXIgaXNWYWxpZDsKICAgICAgICB2YWwgPSB0aGlzLmdldElucHV0VmFsdWUoKTsKICAgICAgICBoaW50ID0gdGhpcy5nZXRIaW50KCk7CiAgICAgICAgdmFsSXNQcmVmaXhPZkhpbnQgPSB2YWwgIT09IGhpbnQgJiYgaGludC5pbmRleE9mKHZhbCkgPT09IDA7CiAgICAgICAgaXNWYWxpZCA9IHZhbCAhPT0gIiIgJiYgdmFsSXNQcmVmaXhPZkhpbnQgJiYgIXRoaXMuaGFzT3ZlcmZsb3coKTsKICAgICAgICBpZiAoIWlzVmFsaWQpIHsKICAgICAgICAgIHRoaXMuY2xlYXJIaW50KCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBnZXRMYW5ndWFnZURpcmVjdGlvbjogZnVuY3Rpb24gZ2V0TGFuZ3VhZ2VEaXJlY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICh0aGlzLiRpbnB1dC5jc3MoImRpcmVjdGlvbiIpIHx8ICJsdHIiKS50b0xvd2VyQ2FzZSgpOwogICAgICB9LAogICAgICBoYXNPdmVyZmxvdzogZnVuY3Rpb24gaGFzT3ZlcmZsb3coKSB7CiAgICAgICAgdmFyIGNvbnN0cmFpbnQgPSB0aGlzLiRpbnB1dC53aWR0aCgpIC0gMjsKICAgICAgICB0aGlzLiRvdmVyZmxvd0hlbHBlci50ZXh0KHRoaXMuZ2V0SW5wdXRWYWx1ZSgpKTsKICAgICAgICByZXR1cm4gdGhpcy4kb3ZlcmZsb3dIZWxwZXIud2lkdGgoKSA+PSBjb25zdHJhaW50OwogICAgICB9LAogICAgICBpc0N1cnNvckF0RW5kOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHZhbHVlTGVuZ3RoOwogICAgICAgIHZhciBzZWxlY3Rpb25TdGFydDsKICAgICAgICB2YXIgcmFuZ2U7CiAgICAgICAgdmFsdWVMZW5ndGggPSB0aGlzLiRpbnB1dC52YWwoKS5sZW5ndGg7CiAgICAgICAgc2VsZWN0aW9uU3RhcnQgPSB0aGlzLiRpbnB1dFswXS5zZWxlY3Rpb25TdGFydDsKICAgICAgICBpZiAoXy5pc051bWJlcihzZWxlY3Rpb25TdGFydCkpIHsKICAgICAgICAgIHJldHVybiBzZWxlY3Rpb25TdGFydCA9PT0gdmFsdWVMZW5ndGg7CiAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC5zZWxlY3Rpb24pIHsKICAgICAgICAgIHJhbmdlID0gZG9jdW1lbnQuc2VsZWN0aW9uLmNyZWF0ZVJhbmdlKCk7CiAgICAgICAgICByYW5nZS5tb3ZlU3RhcnQoImNoYXJhY3RlciIsIC12YWx1ZUxlbmd0aCk7CiAgICAgICAgICByZXR1cm4gdmFsdWVMZW5ndGggPT09IHJhbmdlLnRleHQubGVuZ3RoOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgICB0aGlzLiRoaW50Lm9mZigiLmFhIik7CiAgICAgICAgdGhpcy4kaW5wdXQub2ZmKCIuYWEiKTsKICAgICAgICB0aGlzLiRoaW50ID0gdGhpcy4kaW5wdXQgPSB0aGlzLiRvdmVyZmxvd0hlbHBlciA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgZnVuY3Rpb24gYnVpbGRPdmVyZmxvd0hlbHBlcigkaW5wdXQpIHsKICAgICAgcmV0dXJuIERPTS5lbGVtZW50KCc8cHJlIGFyaWEtaGlkZGVuPSJ0cnVlIj48L3ByZT4nKS5jc3MoewogICAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICAgIHZpc2liaWxpdHk6ICJoaWRkZW4iLAogICAgICAgIHdoaXRlU3BhY2U6ICJwcmUiLAogICAgICAgIGZvbnRGYW1pbHk6ICRpbnB1dC5jc3MoImZvbnQtZmFtaWx5IiksCiAgICAgICAgZm9udFNpemU6ICRpbnB1dC5jc3MoImZvbnQtc2l6ZSIpLAogICAgICAgIGZvbnRTdHlsZTogJGlucHV0LmNzcygiZm9udC1zdHlsZSIpLAogICAgICAgIGZvbnRWYXJpYW50OiAkaW5wdXQuY3NzKCJmb250LXZhcmlhbnQiKSwKICAgICAgICBmb250V2VpZ2h0OiAkaW5wdXQuY3NzKCJmb250LXdlaWdodCIpLAogICAgICAgIHdvcmRTcGFjaW5nOiAkaW5wdXQuY3NzKCJ3b3JkLXNwYWNpbmciKSwKICAgICAgICBsZXR0ZXJTcGFjaW5nOiAkaW5wdXQuY3NzKCJsZXR0ZXItc3BhY2luZyIpLAogICAgICAgIHRleHRJbmRlbnQ6ICRpbnB1dC5jc3MoInRleHQtaW5kZW50IiksCiAgICAgICAgdGV4dFJlbmRlcmluZzogJGlucHV0LmNzcygidGV4dC1yZW5kZXJpbmciKSwKICAgICAgICB0ZXh0VHJhbnNmb3JtOiAkaW5wdXQuY3NzKCJ0ZXh0LXRyYW5zZm9ybSIpCiAgICAgIH0pLmluc2VydEFmdGVyKCRpbnB1dCk7CiAgICB9CiAgICBmdW5jdGlvbiBhcmVRdWVyaWVzRXF1aXZhbGVudChhLCBiKSB7CiAgICAgIHJldHVybiBJbnB1dC5ub3JtYWxpemVRdWVyeShhKSA9PT0gSW5wdXQubm9ybWFsaXplUXVlcnkoYik7CiAgICB9CiAgICBmdW5jdGlvbiB3aXRoTW9kaWZpZXIoJGUpIHsKICAgICAgcmV0dXJuICRlLmFsdEtleSB8fCAkZS5jdHJsS2V5IHx8ICRlLm1ldGFLZXkgfHwgJGUuc2hpZnRLZXk7CiAgICB9CiAgICBtb2R1bGUuZXhwb3J0cyA9IElucHV0OwogIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICB2YXIgdHlwZXMgPSBbX193ZWJwYWNrX3JlcXVpcmVfXyg1NCksIF9fd2VicGFja19yZXF1aXJlX18oNTUpLCBfX3dlYnBhY2tfcmVxdWlyZV9fKDU2KSwgX193ZWJwYWNrX3JlcXVpcmVfXyg1NyksIF9fd2VicGFja19yZXF1aXJlX18oNTgpXTsKICAgIHZhciBkcmFpbmluZzsKICAgIHZhciBjdXJyZW50UXVldWU7CiAgICB2YXIgcXVldWVJbmRleCA9IC0xOwogICAgdmFyIHF1ZXVlID0gW107CiAgICB2YXIgc2NoZWR1bGVkID0gZmFsc2U7CiAgICBmdW5jdGlvbiBjbGVhblVwTmV4dFRpY2soKSB7CiAgICAgIGlmICghZHJhaW5pbmcgfHwgIWN1cnJlbnRRdWV1ZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBkcmFpbmluZyA9IGZhbHNlOwogICAgICBpZiAoY3VycmVudFF1ZXVlLmxlbmd0aCkgewogICAgICAgIHF1ZXVlID0gY3VycmVudFF1ZXVlLmNvbmNhdChxdWV1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcXVldWVJbmRleCA9IC0xOwogICAgICB9CiAgICAgIGlmIChxdWV1ZS5sZW5ndGgpIHsKICAgICAgICBuZXh0VGljaygpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBuZXh0VGljaygpIHsKICAgICAgaWYgKGRyYWluaW5nKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHNjaGVkdWxlZCA9IGZhbHNlOwogICAgICBkcmFpbmluZyA9IHRydWU7CiAgICAgIHZhciBsZW4gPSBxdWV1ZS5sZW5ndGg7CiAgICAgIHZhciB0aW1lb3V0ID0gc2V0VGltZW91dChjbGVhblVwTmV4dFRpY2spOwogICAgICB3aGlsZSAobGVuKSB7CiAgICAgICAgY3VycmVudFF1ZXVlID0gcXVldWU7CiAgICAgICAgcXVldWUgPSBbXTsKICAgICAgICB3aGlsZSAoY3VycmVudFF1ZXVlICYmICsrcXVldWVJbmRleCA8IGxlbikgewogICAgICAgICAgY3VycmVudFF1ZXVlW3F1ZXVlSW5kZXhdLnJ1bigpOwogICAgICAgIH0KICAgICAgICBxdWV1ZUluZGV4ID0gLTE7CiAgICAgICAgbGVuID0gcXVldWUubGVuZ3RoOwogICAgICB9CiAgICAgIGN1cnJlbnRRdWV1ZSA9IG51bGw7CiAgICAgIHF1ZXVlSW5kZXggPSAtMTsKICAgICAgZHJhaW5pbmcgPSBmYWxzZTsKICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgfQogICAgdmFyIHNjaGVkdWxlRHJhaW47CiAgICB2YXIgaSA9IC0xOwogICAgdmFyIGxlbiA9IHR5cGVzLmxlbmd0aDsKICAgIHdoaWxlICgrK2kgPCBsZW4pIHsKICAgICAgaWYgKHR5cGVzW2ldICYmIHR5cGVzW2ldLnRlc3QgJiYgdHlwZXNbaV0udGVzdCgpKSB7CiAgICAgICAgc2NoZWR1bGVEcmFpbiA9IHR5cGVzW2ldLmluc3RhbGwobmV4dFRpY2spOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBJdGVtKGZ1biwgYXJyYXkpIHsKICAgICAgdGhpcy5mdW4gPSBmdW47CiAgICAgIHRoaXMuYXJyYXkgPSBhcnJheTsKICAgIH0KICAgIEl0ZW0ucHJvdG90eXBlLnJ1biA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGZ1biA9IHRoaXMuZnVuOwogICAgICB2YXIgYXJyYXkgPSB0aGlzLmFycmF5OwogICAgICBzd2l0Y2ggKGFycmF5Lmxlbmd0aCkgewogICAgICAgIGNhc2UgMDoKICAgICAgICAgIHJldHVybiBmdW4oKTsKICAgICAgICBjYXNlIDE6CiAgICAgICAgICByZXR1cm4gZnVuKGFycmF5WzBdKTsKICAgICAgICBjYXNlIDI6CiAgICAgICAgICByZXR1cm4gZnVuKGFycmF5WzBdLCBhcnJheVsxXSk7CiAgICAgICAgY2FzZSAzOgogICAgICAgICAgcmV0dXJuIGZ1bihhcnJheVswXSwgYXJyYXlbMV0sIGFycmF5WzJdKTsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIGZ1bi5hcHBseShudWxsLCBhcnJheSk7CiAgICAgIH0KICAgIH07CiAgICBtb2R1bGUuZXhwb3J0cyA9IGltbWVkaWF0ZTsKICAgIGZ1bmN0aW9uIGltbWVkaWF0ZSh0YXNrKSB7CiAgICAgIHZhciBhcmdzID0gbmV3IEFycmF5KGFyZ3VtZW50cy5sZW5ndGggLSAxKTsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGFyZ3NbaSAtIDFdID0gYXJndW1lbnRzW2ldOwogICAgICAgIH0KICAgICAgfQogICAgICBxdWV1ZS5wdXNoKG5ldyBJdGVtKHRhc2ssIGFyZ3MpKTsKICAgICAgaWYgKCFzY2hlZHVsZWQgJiYgIWRyYWluaW5nKSB7CiAgICAgICAgc2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgICBzY2hlZHVsZURyYWluKCk7CiAgICAgIH0KICAgIH0KICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgKGZ1bmN0aW9uIChwcm9jZXNzKSB7CiAgICAgIGV4cG9ydHMudGVzdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHByb2Nlc3MgIT09ICJ1bmRlZmluZWQiICYmICFwcm9jZXNzLmJyb3dzZXI7CiAgICAgIH07CiAgICAgIGV4cG9ydHMuaW5zdGFsbCA9IGZ1bmN0aW9uIChmdW5jKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuYyk7CiAgICAgICAgfTsKICAgICAgfTsKICAgIH0pLmNhbGwoZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXyg5KSk7CiAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgInVzZSBzdHJpY3QiOwoKICAgIChmdW5jdGlvbiAoZ2xvYmFsKSB7CiAgICAgIHZhciBNdXRhdGlvbiA9IGdsb2JhbC5NdXRhdGlvbk9ic2VydmVyIHx8IGdsb2JhbC5XZWJLaXRNdXRhdGlvbk9ic2VydmVyOwogICAgICBleHBvcnRzLnRlc3QgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIE11dGF0aW9uOwogICAgICB9OwogICAgICBleHBvcnRzLmluc3RhbGwgPSBmdW5jdGlvbiAoaGFuZGxlKSB7CiAgICAgICAgdmFyIGNhbGxlZCA9IDA7CiAgICAgICAgdmFyIG9ic2VydmVyID0gbmV3IE11dGF0aW9uKGhhbmRsZSk7CiAgICAgICAgdmFyIGVsZW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIiIpOwogICAgICAgIG9ic2VydmVyLm9ic2VydmUoZWxlbWVudCwgewogICAgICAgICAgY2hhcmFjdGVyRGF0YTogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBlbGVtZW50LmRhdGEgPSBjYWxsZWQgPSArK2NhbGxlZCAlIDI7CiAgICAgICAgfTsKICAgICAgfTsKICAgIH0pLmNhbGwoZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXyg0KSk7CiAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgInVzZSBzdHJpY3QiOwoKICAgIChmdW5jdGlvbiAoZ2xvYmFsKSB7CiAgICAgIGV4cG9ydHMudGVzdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoZ2xvYmFsLnNldEltbWVkaWF0ZSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHlwZW9mIGdsb2JhbC5NZXNzYWdlQ2hhbm5lbCAhPT0gInVuZGVmaW5lZCI7CiAgICAgIH07CiAgICAgIGV4cG9ydHMuaW5zdGFsbCA9IGZ1bmN0aW9uIChmdW5jKSB7CiAgICAgICAgdmFyIGNoYW5uZWwgPSBuZXcgZ2xvYmFsLk1lc3NhZ2VDaGFubmVsKCk7CiAgICAgICAgY2hhbm5lbC5wb3J0MS5vbm1lc3NhZ2UgPSBmdW5jOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjaGFubmVsLnBvcnQyLnBvc3RNZXNzYWdlKDApOwogICAgICAgIH07CiAgICAgIH07CiAgICB9KS5jYWxsKGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18oNCkpOwogIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAoZnVuY3Rpb24gKGdsb2JhbCkgewogICAgICBleHBvcnRzLnRlc3QgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICJkb2N1bWVudCIgaW4gZ2xvYmFsICYmICJvbnJlYWR5c3RhdGVjaGFuZ2UiIGluIGdsb2JhbC5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgICAgfTsKICAgICAgZXhwb3J0cy5pbnN0YWxsID0gZnVuY3Rpb24gKGhhbmRsZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgc2NyaXB0RWwgPSBnbG9iYWwuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CiAgICAgICAgICBzY3JpcHRFbC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGhhbmRsZSgpOwogICAgICAgICAgICBzY3JpcHRFbC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsOwogICAgICAgICAgICBzY3JpcHRFbC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHNjcmlwdEVsKTsKICAgICAgICAgICAgc2NyaXB0RWwgPSBudWxsOwogICAgICAgICAgfTsKICAgICAgICAgIGdsb2JhbC5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoc2NyaXB0RWwpOwogICAgICAgICAgcmV0dXJuIGhhbmRsZTsKICAgICAgICB9OwogICAgICB9OwogICAgfSkuY2FsbChleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKDQpKTsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgZXhwb3J0cy50ZXN0ID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH07CiAgICBleHBvcnRzLmluc3RhbGwgPSBmdW5jdGlvbiAodCkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHNldFRpbWVvdXQodCwgMCk7CiAgICAgIH07CiAgICB9OwogIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICB2YXIgXyA9IF9fd2VicGFja19yZXF1aXJlX18oMCk7CiAgICB2YXIgRE9NID0gX193ZWJwYWNrX3JlcXVpcmVfXygxKTsKICAgIHZhciBFdmVudEVtaXR0ZXIgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDEwKTsKICAgIHZhciBEYXRhc2V0ID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2MCk7CiAgICB2YXIgY3NzID0gX193ZWJwYWNrX3JlcXVpcmVfXygxMSk7CiAgICBmdW5jdGlvbiBEcm9wZG93bihvKSB7CiAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgdmFyIG9uU3VnZ2VzdGlvbkNsaWNrOwogICAgICB2YXIgb25TdWdnZXN0aW9uTW91c2VFbnRlcjsKICAgICAgdmFyIG9uU3VnZ2VzdGlvbk1vdXNlTGVhdmU7CiAgICAgIG8gPSBvIHx8IHt9OwogICAgICBpZiAoIW8ubWVudSkgewogICAgICAgIF8uZXJyb3IoIm1lbnUgaXMgcmVxdWlyZWQiKTsKICAgICAgfQogICAgICBpZiAoIV8uaXNBcnJheShvLmRhdGFzZXRzKSAmJiAhXy5pc09iamVjdChvLmRhdGFzZXRzKSkgewogICAgICAgIF8uZXJyb3IoIjEgb3IgbW9yZSBkYXRhc2V0cyByZXF1aXJlZCIpOwogICAgICB9CiAgICAgIGlmICghby5kYXRhc2V0cykgewogICAgICAgIF8uZXJyb3IoImRhdGFzZXRzIGlzIHJlcXVpcmVkIik7CiAgICAgIH0KICAgICAgdGhpcy5pc09wZW4gPSBmYWxzZTsKICAgICAgdGhpcy5pc0VtcHR5ID0gdHJ1ZTsKICAgICAgdGhpcy5taW5MZW5ndGggPSBvLm1pbkxlbmd0aCB8fCAwOwogICAgICB0aGlzLnRlbXBsYXRlcyA9IHt9OwogICAgICB0aGlzLmFwcGVuZFRvID0gby5hcHBlbmRUbyB8fCBmYWxzZTsKICAgICAgdGhpcy5jc3MgPSBfLm1peGluKHt9LCBjc3MsIG8uYXBwZW5kVG8gPyBjc3MuYXBwZW5kVG8gOiB7fSk7CiAgICAgIHRoaXMuY3NzQ2xhc3NlcyA9IG8uY3NzQ2xhc3NlcyA9IF8ubWl4aW4oe30sIGNzcy5kZWZhdWx0Q2xhc3Nlcywgby5jc3NDbGFzc2VzIHx8IHt9KTsKICAgICAgdGhpcy5jc3NDbGFzc2VzLnByZWZpeCA9IG8uY3NzQ2xhc3Nlcy5mb3JtYXR0ZWRQcmVmaXggfHwgXy5mb3JtYXRQcmVmaXgodGhpcy5jc3NDbGFzc2VzLnByZWZpeCwgdGhpcy5jc3NDbGFzc2VzLm5vUHJlZml4KTsKICAgICAgb25TdWdnZXN0aW9uQ2xpY2sgPSBfLmJpbmQodGhpcy5fb25TdWdnZXN0aW9uQ2xpY2ssIHRoaXMpOwogICAgICBvblN1Z2dlc3Rpb25Nb3VzZUVudGVyID0gXy5iaW5kKHRoaXMuX29uU3VnZ2VzdGlvbk1vdXNlRW50ZXIsIHRoaXMpOwogICAgICBvblN1Z2dlc3Rpb25Nb3VzZUxlYXZlID0gXy5iaW5kKHRoaXMuX29uU3VnZ2VzdGlvbk1vdXNlTGVhdmUsIHRoaXMpOwogICAgICB2YXIgY3NzQ2xhc3MgPSBfLmNsYXNzTmFtZSh0aGlzLmNzc0NsYXNzZXMucHJlZml4LCB0aGlzLmNzc0NsYXNzZXMuc3VnZ2VzdGlvbik7CiAgICAgIHRoaXMuJG1lbnUgPSBET00uZWxlbWVudChvLm1lbnUpLm9uKCJtb3VzZWVudGVyLmFhIiwgY3NzQ2xhc3MsIG9uU3VnZ2VzdGlvbk1vdXNlRW50ZXIpLm9uKCJtb3VzZWxlYXZlLmFhIiwgY3NzQ2xhc3MsIG9uU3VnZ2VzdGlvbk1vdXNlTGVhdmUpLm9uKCJjbGljay5hYSIsIGNzc0NsYXNzLCBvblN1Z2dlc3Rpb25DbGljayk7CiAgICAgIHRoaXMuJGNvbnRhaW5lciA9IG8uYXBwZW5kVG8gPyBvLndyYXBwZXIgOiB0aGlzLiRtZW51OwogICAgICBpZiAoby50ZW1wbGF0ZXMgJiYgby50ZW1wbGF0ZXMuaGVhZGVyKSB7CiAgICAgICAgdGhpcy50ZW1wbGF0ZXMuaGVhZGVyID0gXy50ZW1wbGF0aWZ5KG8udGVtcGxhdGVzLmhlYWRlcik7CiAgICAgICAgdGhpcy4kbWVudS5wcmVwZW5kKHRoaXMudGVtcGxhdGVzLmhlYWRlcigpKTsKICAgICAgfQogICAgICBpZiAoby50ZW1wbGF0ZXMgJiYgby50ZW1wbGF0ZXMuZW1wdHkpIHsKICAgICAgICB0aGlzLnRlbXBsYXRlcy5lbXB0eSA9IF8udGVtcGxhdGlmeShvLnRlbXBsYXRlcy5lbXB0eSk7CiAgICAgICAgdGhpcy4kZW1wdHkgPSBET00uZWxlbWVudCgnPGRpdiBjbGFzcz0iJyArIF8uY2xhc3NOYW1lKHRoaXMuY3NzQ2xhc3Nlcy5wcmVmaXgsIHRoaXMuY3NzQ2xhc3Nlcy5lbXB0eSwgdHJ1ZSkgKyAnIj4nICsgIjwvZGl2PiIpOwogICAgICAgIHRoaXMuJG1lbnUuYXBwZW5kKHRoaXMuJGVtcHR5KTsKICAgICAgICB0aGlzLiRlbXB0eS5oaWRlKCk7CiAgICAgIH0KICAgICAgdGhpcy5kYXRhc2V0cyA9IF8ubWFwKG8uZGF0YXNldHMsIGZ1bmN0aW9uIChvRGF0YXNldCkgewogICAgICAgIHJldHVybiBpbml0aWFsaXplRGF0YXNldCh0aGF0LiRtZW51LCBvRGF0YXNldCwgby5jc3NDbGFzc2VzKTsKICAgICAgfSk7CiAgICAgIF8uZWFjaCh0aGlzLmRhdGFzZXRzLCBmdW5jdGlvbiAoZGF0YXNldCkgewogICAgICAgIHZhciByb290ID0gZGF0YXNldC5nZXRSb290KCk7CiAgICAgICAgaWYgKHJvb3QgJiYgcm9vdC5wYXJlbnQoKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHRoYXQuJG1lbnUuYXBwZW5kKHJvb3QpOwogICAgICAgIH0KICAgICAgICBkYXRhc2V0Lm9uU3luYygicmVuZGVyZWQiLCB0aGF0Ll9vblJlbmRlcmVkLCB0aGF0KTsKICAgICAgfSk7CiAgICAgIGlmIChvLnRlbXBsYXRlcyAmJiBvLnRlbXBsYXRlcy5mb290ZXIpIHsKICAgICAgICB0aGlzLnRlbXBsYXRlcy5mb290ZXIgPSBfLnRlbXBsYXRpZnkoby50ZW1wbGF0ZXMuZm9vdGVyKTsKICAgICAgICB0aGlzLiRtZW51LmFwcGVuZCh0aGlzLnRlbXBsYXRlcy5mb290ZXIoKSk7CiAgICAgIH0KICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBET00uZWxlbWVudCh3aW5kb3cpLnJlc2l6ZShmdW5jdGlvbiAoKSB7CiAgICAgICAgc2VsZi5fcmVkcmF3KCk7CiAgICAgIH0pOwogICAgfQogICAgXy5taXhpbihEcm9wZG93bi5wcm90b3R5cGUsIEV2ZW50RW1pdHRlciwgewogICAgICBfb25TdWdnZXN0aW9uQ2xpY2s6IGZ1bmN0aW9uIG9uU3VnZ2VzdGlvbkNsaWNrKCRlKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyKCJzdWdnZXN0aW9uQ2xpY2tlZCIsIERPTS5lbGVtZW50KCRlLmN1cnJlbnRUYXJnZXQpKTsKICAgICAgfSwKICAgICAgX29uU3VnZ2VzdGlvbk1vdXNlRW50ZXI6IGZ1bmN0aW9uIG9uU3VnZ2VzdGlvbk1vdXNlRW50ZXIoJGUpIHsKICAgICAgICB2YXIgZWx0ID0gRE9NLmVsZW1lbnQoJGUuY3VycmVudFRhcmdldCk7CiAgICAgICAgaWYgKGVsdC5oYXNDbGFzcyhfLmNsYXNzTmFtZSh0aGlzLmNzc0NsYXNzZXMucHJlZml4LCB0aGlzLmNzc0NsYXNzZXMuY3Vyc29yLCB0cnVlKSkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy5fcmVtb3ZlQ3Vyc29yKCk7CiAgICAgICAgdmFyIHN1Z2dlc3Rpb24gPSB0aGlzOwogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgc3VnZ2VzdGlvbi5fc2V0Q3Vyc29yKGVsdCwgZmFsc2UpOwogICAgICAgIH0sIDApOwogICAgICB9LAogICAgICBfb25TdWdnZXN0aW9uTW91c2VMZWF2ZTogZnVuY3Rpb24gb25TdWdnZXN0aW9uTW91c2VMZWF2ZSgkZSkgewogICAgICAgIGlmICgkZS5yZWxhdGVkVGFyZ2V0KSB7CiAgICAgICAgICB2YXIgZWx0ID0gRE9NLmVsZW1lbnQoJGUucmVsYXRlZFRhcmdldCk7CiAgICAgICAgICBpZiAoZWx0LmNsb3Nlc3QoIi4iICsgXy5jbGFzc05hbWUodGhpcy5jc3NDbGFzc2VzLnByZWZpeCwgdGhpcy5jc3NDbGFzc2VzLmN1cnNvciwgdHJ1ZSkpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLl9yZW1vdmVDdXJzb3IoKTsKICAgICAgICB0aGlzLnRyaWdnZXIoImN1cnNvclJlbW92ZWQiKTsKICAgICAgfSwKICAgICAgX29uUmVuZGVyZWQ6IGZ1bmN0aW9uIG9uUmVuZGVyZWQoZSwgcXVlcnkpIHsKICAgICAgICB0aGlzLmlzRW1wdHkgPSBfLmV2ZXJ5KHRoaXMuZGF0YXNldHMsIGlzRGF0YXNldEVtcHR5KTsKICAgICAgICBpZiAodGhpcy5pc0VtcHR5KSB7CiAgICAgICAgICBpZiAocXVlcnkubGVuZ3RoID49IHRoaXMubWluTGVuZ3RoKSB7CiAgICAgICAgICAgIHRoaXMudHJpZ2dlcigiZW1wdHkiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLiRlbXB0eSkgewogICAgICAgICAgICBpZiAocXVlcnkubGVuZ3RoIDwgdGhpcy5taW5MZW5ndGgpIHsKICAgICAgICAgICAgICB0aGlzLl9oaWRlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGh0bWwgPSB0aGlzLnRlbXBsYXRlcy5lbXB0eSh7CiAgICAgICAgICAgICAgICBxdWVyeTogdGhpcy5kYXRhc2V0c1swXSAmJiB0aGlzLmRhdGFzZXRzWzBdLnF1ZXJ5CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgdGhpcy4kZW1wdHkuaHRtbChodG1sKTsKICAgICAgICAgICAgICB0aGlzLiRlbXB0eS5zaG93KCk7CiAgICAgICAgICAgICAgdGhpcy5fc2hvdygpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKF8uYW55KHRoaXMuZGF0YXNldHMsIGhhc0VtcHR5VGVtcGxhdGUpKSB7CiAgICAgICAgICAgIGlmIChxdWVyeS5sZW5ndGggPCB0aGlzLm1pbkxlbmd0aCkgewogICAgICAgICAgICAgIHRoaXMuX2hpZGUoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLl9zaG93KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX2hpZGUoKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNPcGVuKSB7CiAgICAgICAgICBpZiAodGhpcy4kZW1wdHkpIHsKICAgICAgICAgICAgdGhpcy4kZW1wdHkuZW1wdHkoKTsKICAgICAgICAgICAgdGhpcy4kZW1wdHkuaGlkZSgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXJ5Lmxlbmd0aCA+PSB0aGlzLm1pbkxlbmd0aCkgewogICAgICAgICAgICB0aGlzLl9zaG93KCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl9oaWRlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMudHJpZ2dlcigiZGF0YXNldFJlbmRlcmVkIik7CiAgICAgICAgZnVuY3Rpb24gaXNEYXRhc2V0RW1wdHkoZGF0YXNldCkgewogICAgICAgICAgcmV0dXJuIGRhdGFzZXQuaXNFbXB0eSgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNFbXB0eVRlbXBsYXRlKGRhdGFzZXQpIHsKICAgICAgICAgIHJldHVybiBkYXRhc2V0LnRlbXBsYXRlcyAmJiBkYXRhc2V0LnRlbXBsYXRlcy5lbXB0eTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIF9oaWRlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy4kY29udGFpbmVyLmhpZGUoKTsKICAgICAgfSwKICAgICAgX3Nob3c6IGZ1bmN0aW9uICgpIHsKICAgICAgICB0aGlzLiRjb250YWluZXIuY3NzKCJkaXNwbGF5IiwgImJsb2NrIik7CiAgICAgICAgdGhpcy5fcmVkcmF3KCk7CiAgICAgICAgdGhpcy50cmlnZ2VyKCJzaG93biIpOwogICAgICB9LAogICAgICBfcmVkcmF3OiBmdW5jdGlvbiByZWRyYXcoKSB7CiAgICAgICAgaWYgKCF0aGlzLmlzT3BlbiB8fCAhdGhpcy5hcHBlbmRUbykgcmV0dXJuOwogICAgICAgIHRoaXMudHJpZ2dlcigicmVkcmF3biIpOwogICAgICB9LAogICAgICBfZ2V0U3VnZ2VzdGlvbnM6IGZ1bmN0aW9uIGdldFN1Z2dlc3Rpb25zKCkgewogICAgICAgIHJldHVybiB0aGlzLiRtZW51LmZpbmQoXy5jbGFzc05hbWUodGhpcy5jc3NDbGFzc2VzLnByZWZpeCwgdGhpcy5jc3NDbGFzc2VzLnN1Z2dlc3Rpb24pKTsKICAgICAgfSwKICAgICAgX2dldEN1cnNvcjogZnVuY3Rpb24gZ2V0Q3Vyc29yKCkgewogICAgICAgIHJldHVybiB0aGlzLiRtZW51LmZpbmQoXy5jbGFzc05hbWUodGhpcy5jc3NDbGFzc2VzLnByZWZpeCwgdGhpcy5jc3NDbGFzc2VzLmN1cnNvcikpLmZpcnN0KCk7CiAgICAgIH0sCiAgICAgIF9zZXRDdXJzb3I6IGZ1bmN0aW9uIHNldEN1cnNvcigkZWwsIHVwZGF0ZUlucHV0KSB7CiAgICAgICAgJGVsLmZpcnN0KCkuYWRkQ2xhc3MoXy5jbGFzc05hbWUodGhpcy5jc3NDbGFzc2VzLnByZWZpeCwgdGhpcy5jc3NDbGFzc2VzLmN1cnNvciwgdHJ1ZSkpLmF0dHIoImFyaWEtc2VsZWN0ZWQiLCAidHJ1ZSIpOwogICAgICAgIHRoaXMudHJpZ2dlcigiY3Vyc29yTW92ZWQiLCB1cGRhdGVJbnB1dCk7CiAgICAgIH0sCiAgICAgIF9yZW1vdmVDdXJzb3I6IGZ1bmN0aW9uIHJlbW92ZUN1cnNvcigpIHsKICAgICAgICB0aGlzLl9nZXRDdXJzb3IoKS5yZW1vdmVDbGFzcyhfLmNsYXNzTmFtZSh0aGlzLmNzc0NsYXNzZXMucHJlZml4LCB0aGlzLmNzc0NsYXNzZXMuY3Vyc29yLCB0cnVlKSkucmVtb3ZlQXR0cigiYXJpYS1zZWxlY3RlZCIpOwogICAgICB9LAogICAgICBfbW92ZUN1cnNvcjogZnVuY3Rpb24gbW92ZUN1cnNvcihpbmNyZW1lbnQpIHsKICAgICAgICB2YXIgJHN1Z2dlc3Rpb25zOwogICAgICAgIHZhciAkb2xkQ3Vyc29yOwogICAgICAgIHZhciBuZXdDdXJzb3JJbmRleDsKICAgICAgICB2YXIgJG5ld0N1cnNvcjsKICAgICAgICBpZiAoIXRoaXMuaXNPcGVuKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgICRvbGRDdXJzb3IgPSB0aGlzLl9nZXRDdXJzb3IoKTsKICAgICAgICAkc3VnZ2VzdGlvbnMgPSB0aGlzLl9nZXRTdWdnZXN0aW9ucygpOwogICAgICAgIHRoaXMuX3JlbW92ZUN1cnNvcigpOwogICAgICAgIG5ld0N1cnNvckluZGV4ID0gJHN1Z2dlc3Rpb25zLmluZGV4KCRvbGRDdXJzb3IpICsgaW5jcmVtZW50OwogICAgICAgIG5ld0N1cnNvckluZGV4ID0gKG5ld0N1cnNvckluZGV4ICsgMSkgJSAoJHN1Z2dlc3Rpb25zLmxlbmd0aCArIDEpIC0gMTsKICAgICAgICBpZiAobmV3Q3Vyc29ySW5kZXggPT09IC0xKSB7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoImN1cnNvclJlbW92ZWQiKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9IGVsc2UgaWYgKG5ld0N1cnNvckluZGV4IDwgLTEpIHsKICAgICAgICAgIG5ld0N1cnNvckluZGV4ID0gJHN1Z2dlc3Rpb25zLmxlbmd0aCAtIDE7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3NldEN1cnNvcigkbmV3Q3Vyc29yID0gJHN1Z2dlc3Rpb25zLmVxKG5ld0N1cnNvckluZGV4KSwgdHJ1ZSk7CiAgICAgICAgdGhpcy5fZW5zdXJlVmlzaWJsZSgkbmV3Q3Vyc29yKTsKICAgICAgfSwKICAgICAgX2Vuc3VyZVZpc2libGU6IGZ1bmN0aW9uIGVuc3VyZVZpc2libGUoJGVsKSB7CiAgICAgICAgdmFyIGVsVG9wOwogICAgICAgIHZhciBlbEJvdHRvbTsKICAgICAgICB2YXIgbWVudVNjcm9sbFRvcDsKICAgICAgICB2YXIgbWVudUhlaWdodDsKICAgICAgICBlbFRvcCA9ICRlbC5wb3NpdGlvbigpLnRvcDsKICAgICAgICBlbEJvdHRvbSA9IGVsVG9wICsgJGVsLmhlaWdodCgpICsgcGFyc2VJbnQoJGVsLmNzcygibWFyZ2luLXRvcCIpLCAxMCkgKyBwYXJzZUludCgkZWwuY3NzKCJtYXJnaW4tYm90dG9tIiksIDEwKTsKICAgICAgICBtZW51U2Nyb2xsVG9wID0gdGhpcy4kbWVudS5zY3JvbGxUb3AoKTsKICAgICAgICBtZW51SGVpZ2h0ID0gdGhpcy4kbWVudS5oZWlnaHQoKSArIHBhcnNlSW50KHRoaXMuJG1lbnUuY3NzKCJwYWRkaW5nLXRvcCIpLCAxMCkgKyBwYXJzZUludCh0aGlzLiRtZW51LmNzcygicGFkZGluZy1ib3R0b20iKSwgMTApOwogICAgICAgIGlmIChlbFRvcCA8IDApIHsKICAgICAgICAgIHRoaXMuJG1lbnUuc2Nyb2xsVG9wKG1lbnVTY3JvbGxUb3AgKyBlbFRvcCk7CiAgICAgICAgfSBlbHNlIGlmIChtZW51SGVpZ2h0IDwgZWxCb3R0b20pIHsKICAgICAgICAgIHRoaXMuJG1lbnUuc2Nyb2xsVG9wKG1lbnVTY3JvbGxUb3AgKyAoZWxCb3R0b20gLSBtZW51SGVpZ2h0KSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBjbG9zZTogZnVuY3Rpb24gY2xvc2UoKSB7CiAgICAgICAgaWYgKHRoaXMuaXNPcGVuKSB7CiAgICAgICAgICB0aGlzLmlzT3BlbiA9IGZhbHNlOwogICAgICAgICAgdGhpcy5fcmVtb3ZlQ3Vyc29yKCk7CiAgICAgICAgICB0aGlzLl9oaWRlKCk7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoImNsb3NlZCIpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgb3BlbjogZnVuY3Rpb24gb3BlbigpIHsKICAgICAgICBpZiAoIXRoaXMuaXNPcGVuKSB7CiAgICAgICAgICB0aGlzLmlzT3BlbiA9IHRydWU7CiAgICAgICAgICBpZiAoIXRoaXMuaXNFbXB0eSkgewogICAgICAgICAgICB0aGlzLl9zaG93KCk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnRyaWdnZXIoIm9wZW5lZCIpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2V0TGFuZ3VhZ2VEaXJlY3Rpb246IGZ1bmN0aW9uIHNldExhbmd1YWdlRGlyZWN0aW9uKGRpcikgewogICAgICAgIHRoaXMuJG1lbnUuY3NzKGRpciA9PT0gImx0ciIgPyB0aGlzLmNzcy5sdHIgOiB0aGlzLmNzcy5ydGwpOwogICAgICB9LAogICAgICBtb3ZlQ3Vyc29yVXA6IGZ1bmN0aW9uIG1vdmVDdXJzb3JVcCgpIHsKICAgICAgICB0aGlzLl9tb3ZlQ3Vyc29yKC0xKTsKICAgICAgfSwKICAgICAgbW92ZUN1cnNvckRvd246IGZ1bmN0aW9uIG1vdmVDdXJzb3JEb3duKCkgewogICAgICAgIHRoaXMuX21vdmVDdXJzb3IoKzEpOwogICAgICB9LAogICAgICBnZXREYXR1bUZvclN1Z2dlc3Rpb246IGZ1bmN0aW9uIGdldERhdHVtRm9yU3VnZ2VzdGlvbigkZWwpIHsKICAgICAgICB2YXIgZGF0dW0gPSBudWxsOwogICAgICAgIGlmICgkZWwubGVuZ3RoKSB7CiAgICAgICAgICBkYXR1bSA9IHsKICAgICAgICAgICAgcmF3OiBEYXRhc2V0LmV4dHJhY3REYXR1bSgkZWwpLAogICAgICAgICAgICB2YWx1ZTogRGF0YXNldC5leHRyYWN0VmFsdWUoJGVsKSwKICAgICAgICAgICAgZGF0YXNldE5hbWU6IERhdGFzZXQuZXh0cmFjdERhdGFzZXROYW1lKCRlbCkKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBkYXR1bTsKICAgICAgfSwKICAgICAgZ2V0Q3VycmVudEN1cnNvcjogZnVuY3Rpb24gZ2V0Q3VycmVudEN1cnNvcigpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZ2V0Q3Vyc29yKCkuZmlyc3QoKTsKICAgICAgfSwKICAgICAgZ2V0RGF0dW1Gb3JDdXJzb3I6IGZ1bmN0aW9uIGdldERhdHVtRm9yQ3Vyc29yKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldERhdHVtRm9yU3VnZ2VzdGlvbih0aGlzLl9nZXRDdXJzb3IoKS5maXJzdCgpKTsKICAgICAgfSwKICAgICAgZ2V0RGF0dW1Gb3JUb3BTdWdnZXN0aW9uOiBmdW5jdGlvbiBnZXREYXR1bUZvclRvcFN1Z2dlc3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGF0dW1Gb3JTdWdnZXN0aW9uKHRoaXMuX2dldFN1Z2dlc3Rpb25zKCkuZmlyc3QoKSk7CiAgICAgIH0sCiAgICAgIGN1cnNvclRvcFN1Z2dlc3Rpb246IGZ1bmN0aW9uIGN1cnNvclRvcFN1Z2dlc3Rpb24oKSB7CiAgICAgICAgdGhpcy5fc2V0Q3Vyc29yKHRoaXMuX2dldFN1Z2dlc3Rpb25zKCkuZmlyc3QoKSwgZmFsc2UpOwogICAgICB9LAogICAgICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShxdWVyeSkgewogICAgICAgIF8uZWFjaCh0aGlzLmRhdGFzZXRzLCB1cGRhdGVEYXRhc2V0KTsKICAgICAgICBmdW5jdGlvbiB1cGRhdGVEYXRhc2V0KGRhdGFzZXQpIHsKICAgICAgICAgIGRhdGFzZXQudXBkYXRlKHF1ZXJ5KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGVtcHR5OiBmdW5jdGlvbiBlbXB0eSgpIHsKICAgICAgICBfLmVhY2godGhpcy5kYXRhc2V0cywgY2xlYXJEYXRhc2V0KTsKICAgICAgICB0aGlzLmlzRW1wdHkgPSB0cnVlOwogICAgICAgIGZ1bmN0aW9uIGNsZWFyRGF0YXNldChkYXRhc2V0KSB7CiAgICAgICAgICBkYXRhc2V0LmNsZWFyKCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBpc1Zpc2libGU6IGZ1bmN0aW9uIGlzVmlzaWJsZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5pc09wZW4gJiYgIXRoaXMuaXNFbXB0eTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgICB0aGlzLiRtZW51Lm9mZigiLmFhIik7CiAgICAgICAgdGhpcy4kbWVudSA9IG51bGw7CiAgICAgICAgXy5lYWNoKHRoaXMuZGF0YXNldHMsIGRlc3Ryb3lEYXRhc2V0KTsKICAgICAgICBmdW5jdGlvbiBkZXN0cm95RGF0YXNldChkYXRhc2V0KSB7CiAgICAgICAgICBkYXRhc2V0LmRlc3Ryb3koKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgRHJvcGRvd24uRGF0YXNldCA9IERhdGFzZXQ7CiAgICBmdW5jdGlvbiBpbml0aWFsaXplRGF0YXNldCgkbWVudSwgb0RhdGFzZXQsIGNzc0NsYXNzZXMpIHsKICAgICAgcmV0dXJuIG5ldyBEcm9wZG93bi5EYXRhc2V0KF8ubWl4aW4oewogICAgICAgICRtZW51OiAkbWVudSwKICAgICAgICBjc3NDbGFzc2VzOiBjc3NDbGFzc2VzCiAgICAgIH0sIG9EYXRhc2V0KSk7CiAgICB9CiAgICBtb2R1bGUuZXhwb3J0cyA9IERyb3Bkb3duOwogIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICB2YXIgZGF0YXNldEtleSA9ICJhYURhdGFzZXQiOwogICAgdmFyIHZhbHVlS2V5ID0gImFhVmFsdWUiOwogICAgdmFyIGRhdHVtS2V5ID0gImFhRGF0dW0iOwogICAgdmFyIF8gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDApOwogICAgdmFyIERPTSA9IF9fd2VicGFja19yZXF1aXJlX18oMSk7CiAgICB2YXIgaHRtbCA9IF9fd2VicGFja19yZXF1aXJlX18oMTcpOwogICAgdmFyIGNzcyA9IF9fd2VicGFja19yZXF1aXJlX18oMTEpOwogICAgdmFyIEV2ZW50RW1pdHRlciA9IF9fd2VicGFja19yZXF1aXJlX18oMTApOwogICAgZnVuY3Rpb24gRGF0YXNldChvKSB7CiAgICAgIG8gPSBvIHx8IHt9OwogICAgICBvLnRlbXBsYXRlcyA9IG8udGVtcGxhdGVzIHx8IHt9OwogICAgICBpZiAoIW8uc291cmNlKSB7CiAgICAgICAgXy5lcnJvcigibWlzc2luZyBzb3VyY2UiKTsKICAgICAgfQogICAgICBpZiAoby5uYW1lICYmICFpc1ZhbGlkTmFtZShvLm5hbWUpKSB7CiAgICAgICAgXy5lcnJvcigiaW52YWxpZCBkYXRhc2V0IG5hbWU6ICIgKyBvLm5hbWUpOwogICAgICB9CiAgICAgIHRoaXMucXVlcnkgPSBudWxsOwogICAgICB0aGlzLl9pc0VtcHR5ID0gdHJ1ZTsKICAgICAgdGhpcy5oaWdobGlnaHQgPSAhIW8uaGlnaGxpZ2h0OwogICAgICB0aGlzLm5hbWUgPSB0eXBlb2Ygby5uYW1lID09PSAidW5kZWZpbmVkIiB8fCBvLm5hbWUgPT09IG51bGwgPyBfLmdldFVuaXF1ZUlkKCkgOiBvLm5hbWU7CiAgICAgIHRoaXMuc291cmNlID0gby5zb3VyY2U7CiAgICAgIHRoaXMuZGlzcGxheUZuID0gZ2V0RGlzcGxheUZuKG8uZGlzcGxheSB8fCBvLmRpc3BsYXlLZXkpOwogICAgICB0aGlzLmRlYm91bmNlID0gby5kZWJvdW5jZTsKICAgICAgdGhpcy5jYWNoZSA9IG8uY2FjaGUgIT09IGZhbHNlOwogICAgICB0aGlzLnRlbXBsYXRlcyA9IGdldFRlbXBsYXRlcyhvLnRlbXBsYXRlcywgdGhpcy5kaXNwbGF5Rm4pOwogICAgICB0aGlzLmNzcyA9IF8ubWl4aW4oe30sIGNzcywgby5hcHBlbmRUbyA/IGNzcy5hcHBlbmRUbyA6IHt9KTsKICAgICAgdGhpcy5jc3NDbGFzc2VzID0gby5jc3NDbGFzc2VzID0gXy5taXhpbih7fSwgY3NzLmRlZmF1bHRDbGFzc2VzLCBvLmNzc0NsYXNzZXMgfHwge30pOwogICAgICB0aGlzLmNzc0NsYXNzZXMucHJlZml4ID0gby5jc3NDbGFzc2VzLmZvcm1hdHRlZFByZWZpeCB8fCBfLmZvcm1hdFByZWZpeCh0aGlzLmNzc0NsYXNzZXMucHJlZml4LCB0aGlzLmNzc0NsYXNzZXMubm9QcmVmaXgpOwogICAgICB2YXIgY2xhenogPSBfLmNsYXNzTmFtZSh0aGlzLmNzc0NsYXNzZXMucHJlZml4LCB0aGlzLmNzc0NsYXNzZXMuZGF0YXNldCk7CiAgICAgIHRoaXMuJGVsID0gby4kbWVudSAmJiBvLiRtZW51LmZpbmQoY2xhenogKyAiLSIgKyB0aGlzLm5hbWUpLmxlbmd0aCA+IDAgPyBET00uZWxlbWVudChvLiRtZW51LmZpbmQoY2xhenogKyAiLSIgKyB0aGlzLm5hbWUpWzBdKSA6IERPTS5lbGVtZW50KGh0bWwuZGF0YXNldC5yZXBsYWNlKCIlQ0xBU1MlIiwgdGhpcy5uYW1lKS5yZXBsYWNlKCIlUFJFRklYJSIsIHRoaXMuY3NzQ2xhc3Nlcy5wcmVmaXgpLnJlcGxhY2UoIiVEQVRBU0VUJSIsIHRoaXMuY3NzQ2xhc3Nlcy5kYXRhc2V0KSk7CiAgICAgIHRoaXMuJG1lbnUgPSBvLiRtZW51OwogICAgICB0aGlzLmNsZWFyQ2FjaGVkU3VnZ2VzdGlvbnMoKTsKICAgIH0KICAgIERhdGFzZXQuZXh0cmFjdERhdGFzZXROYW1lID0gZnVuY3Rpb24gZXh0cmFjdERhdGFzZXROYW1lKGVsKSB7CiAgICAgIHJldHVybiBET00uZWxlbWVudChlbCkuZGF0YShkYXRhc2V0S2V5KTsKICAgIH07CiAgICBEYXRhc2V0LmV4dHJhY3RWYWx1ZSA9IGZ1bmN0aW9uIGV4dHJhY3RWYWx1ZShlbCkgewogICAgICByZXR1cm4gRE9NLmVsZW1lbnQoZWwpLmRhdGEodmFsdWVLZXkpOwogICAgfTsKICAgIERhdGFzZXQuZXh0cmFjdERhdHVtID0gZnVuY3Rpb24gZXh0cmFjdERhdHVtKGVsKSB7CiAgICAgIHZhciBkYXR1bSA9IERPTS5lbGVtZW50KGVsKS5kYXRhKGRhdHVtS2V5KTsKICAgICAgaWYgKHR5cGVvZiBkYXR1bSA9PT0gInN0cmluZyIpIHsKICAgICAgICBkYXR1bSA9IEpTT04ucGFyc2UoZGF0dW0pOwogICAgICB9CiAgICAgIHJldHVybiBkYXR1bTsKICAgIH07CiAgICBfLm1peGluKERhdGFzZXQucHJvdG90eXBlLCBFdmVudEVtaXR0ZXIsIHsKICAgICAgX3JlbmRlcjogZnVuY3Rpb24gcmVuZGVyKHF1ZXJ5LCBzdWdnZXN0aW9ucykgewogICAgICAgIGlmICghdGhpcy4kZWwpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgIHZhciBoYXNTdWdnZXN0aW9uczsKICAgICAgICB2YXIgcmVuZGVyQXJncyA9IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgICAgICB0aGlzLiRlbC5lbXB0eSgpOwogICAgICAgIGhhc1N1Z2dlc3Rpb25zID0gc3VnZ2VzdGlvbnMgJiYgc3VnZ2VzdGlvbnMubGVuZ3RoOwogICAgICAgIHRoaXMuX2lzRW1wdHkgPSAhaGFzU3VnZ2VzdGlvbnM7CiAgICAgICAgaWYgKCFoYXNTdWdnZXN0aW9ucyAmJiB0aGlzLnRlbXBsYXRlcy5lbXB0eSkgewogICAgICAgICAgdGhpcy4kZWwuaHRtbChnZXRFbXB0eUh0bWwuYXBwbHkodGhpcywgcmVuZGVyQXJncykpLnByZXBlbmQodGhhdC50ZW1wbGF0ZXMuaGVhZGVyID8gZ2V0SGVhZGVySHRtbC5hcHBseSh0aGlzLCByZW5kZXJBcmdzKSA6IG51bGwpLmFwcGVuZCh0aGF0LnRlbXBsYXRlcy5mb290ZXIgPyBnZXRGb290ZXJIdG1sLmFwcGx5KHRoaXMsIHJlbmRlckFyZ3MpIDogbnVsbCk7CiAgICAgICAgfSBlbHNlIGlmIChoYXNTdWdnZXN0aW9ucykgewogICAgICAgICAgdGhpcy4kZWwuaHRtbChnZXRTdWdnZXN0aW9uc0h0bWwuYXBwbHkodGhpcywgcmVuZGVyQXJncykpLnByZXBlbmQodGhhdC50ZW1wbGF0ZXMuaGVhZGVyID8gZ2V0SGVhZGVySHRtbC5hcHBseSh0aGlzLCByZW5kZXJBcmdzKSA6IG51bGwpLmFwcGVuZCh0aGF0LnRlbXBsYXRlcy5mb290ZXIgPyBnZXRGb290ZXJIdG1sLmFwcGx5KHRoaXMsIHJlbmRlckFyZ3MpIDogbnVsbCk7CiAgICAgICAgfSBlbHNlIGlmIChzdWdnZXN0aW9ucyAmJiAhQXJyYXkuaXNBcnJheShzdWdnZXN0aW9ucykpIHsKICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoInN1Z2dlc3Rpb25zIG11c3QgYmUgYW4gYXJyYXkiKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuJG1lbnUpIHsKICAgICAgICAgIHRoaXMuJG1lbnUuYWRkQ2xhc3ModGhpcy5jc3NDbGFzc2VzLnByZWZpeCArIChoYXNTdWdnZXN0aW9ucyA/ICJ3aXRoIiA6ICJ3aXRob3V0IikgKyAiLSIgKyB0aGlzLm5hbWUpLnJlbW92ZUNsYXNzKHRoaXMuY3NzQ2xhc3Nlcy5wcmVmaXggKyAoaGFzU3VnZ2VzdGlvbnMgPyAid2l0aG91dCIgOiAid2l0aCIpICsgIi0iICsgdGhpcy5uYW1lKTsKICAgICAgICB9CiAgICAgICAgdGhpcy50cmlnZ2VyKCJyZW5kZXJlZCIsIHF1ZXJ5KTsKICAgICAgICBmdW5jdGlvbiBnZXRFbXB0eUh0bWwoKSB7CiAgICAgICAgICB2YXIgYXJncyA9IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgICAgICAgIGFyZ3MgPSBbewogICAgICAgICAgICBxdWVyeTogcXVlcnksCiAgICAgICAgICAgIGlzRW1wdHk6IHRydWUKICAgICAgICAgIH1dLmNvbmNhdChhcmdzKTsKICAgICAgICAgIHJldHVybiB0aGF0LnRlbXBsYXRlcy5lbXB0eS5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3VnZ2VzdGlvbnNIdG1sKCkgewogICAgICAgICAgdmFyIGFyZ3MgPSBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICAgICAgICB2YXIgJHN1Z2dlc3Rpb25zOwogICAgICAgICAgdmFyIG5vZGVzOwogICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgdmFyIHN1Z2dlc3Rpb25zSHRtbCA9IGh0bWwuc3VnZ2VzdGlvbnMucmVwbGFjZSgiJVBSRUZJWCUiLCB0aGlzLmNzc0NsYXNzZXMucHJlZml4KS5yZXBsYWNlKCIlU1VHR0VTVElPTlMlIiwgdGhpcy5jc3NDbGFzc2VzLnN1Z2dlc3Rpb25zKTsKICAgICAgICAgICRzdWdnZXN0aW9ucyA9IERPTS5lbGVtZW50KHN1Z2dlc3Rpb25zSHRtbCkuY3NzKHRoaXMuY3NzLnN1Z2dlc3Rpb25zKTsKICAgICAgICAgIG5vZGVzID0gXy5tYXAoc3VnZ2VzdGlvbnMsIGdldFN1Z2dlc3Rpb25Ob2RlKTsKICAgICAgICAgICRzdWdnZXN0aW9ucy5hcHBlbmQuYXBwbHkoJHN1Z2dlc3Rpb25zLCBub2Rlcyk7CiAgICAgICAgICByZXR1cm4gJHN1Z2dlc3Rpb25zOwogICAgICAgICAgZnVuY3Rpb24gZ2V0U3VnZ2VzdGlvbk5vZGUoc3VnZ2VzdGlvbikgewogICAgICAgICAgICB2YXIgJGVsOwogICAgICAgICAgICB2YXIgc3VnZ2VzdGlvbkh0bWwgPSBodG1sLnN1Z2dlc3Rpb24ucmVwbGFjZSgiJVBSRUZJWCUiLCBzZWxmLmNzc0NsYXNzZXMucHJlZml4KS5yZXBsYWNlKCIlU1VHR0VTVElPTiUiLCBzZWxmLmNzc0NsYXNzZXMuc3VnZ2VzdGlvbik7CiAgICAgICAgICAgICRlbCA9IERPTS5lbGVtZW50KHN1Z2dlc3Rpb25IdG1sKS5hdHRyKHsKICAgICAgICAgICAgICByb2xlOiAib3B0aW9uIiwKICAgICAgICAgICAgICBpZDogWyJvcHRpb24iLCBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxZTgpXS5qb2luKCItIikKICAgICAgICAgICAgfSkuYXBwZW5kKHRoYXQudGVtcGxhdGVzLnN1Z2dlc3Rpb24uYXBwbHkodGhpcywgW3N1Z2dlc3Rpb25dLmNvbmNhdChhcmdzKSkpOwogICAgICAgICAgICAkZWwuZGF0YShkYXRhc2V0S2V5LCB0aGF0Lm5hbWUpOwogICAgICAgICAgICAkZWwuZGF0YSh2YWx1ZUtleSwgdGhhdC5kaXNwbGF5Rm4oc3VnZ2VzdGlvbikgfHwgdW5kZWZpbmVkKTsKICAgICAgICAgICAgJGVsLmRhdGEoZGF0dW1LZXksIEpTT04uc3RyaW5naWZ5KHN1Z2dlc3Rpb24pKTsKICAgICAgICAgICAgJGVsLmNoaWxkcmVuKCkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgRE9NLmVsZW1lbnQodGhpcykuY3NzKHNlbGYuY3NzLnN1Z2dlc3Rpb25DaGlsZCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gJGVsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIZWFkZXJIdG1sKCkgewogICAgICAgICAgdmFyIGFyZ3MgPSBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICAgICAgICBhcmdzID0gW3sKICAgICAgICAgICAgcXVlcnk6IHF1ZXJ5LAogICAgICAgICAgICBpc0VtcHR5OiAhaGFzU3VnZ2VzdGlvbnMKICAgICAgICAgIH1dLmNvbmNhdChhcmdzKTsKICAgICAgICAgIHJldHVybiB0aGF0LnRlbXBsYXRlcy5oZWFkZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZvb3Rlckh0bWwoKSB7CiAgICAgICAgICB2YXIgYXJncyA9IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgICAgICAgIGFyZ3MgPSBbewogICAgICAgICAgICBxdWVyeTogcXVlcnksCiAgICAgICAgICAgIGlzRW1wdHk6ICFoYXNTdWdnZXN0aW9ucwogICAgICAgICAgfV0uY29uY2F0KGFyZ3MpOwogICAgICAgICAgcmV0dXJuIHRoYXQudGVtcGxhdGVzLmZvb3Rlci5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGdldFJvb3Q6IGZ1bmN0aW9uIGdldFJvb3QoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuJGVsOwogICAgICB9LAogICAgICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShxdWVyeSkgewogICAgICAgIGZ1bmN0aW9uIGhhbmRsZVN1Z2dlc3Rpb25zKHN1Z2dlc3Rpb25zKSB7CiAgICAgICAgICBpZiAoIXRoaXMuY2FuY2VsZWQgJiYgcXVlcnkgPT09IHRoaXMucXVlcnkpIHsKICAgICAgICAgICAgdmFyIGV4dHJhQXJncyA9IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgICAgdGhpcy5jYWNoZVN1Z2dlc3Rpb25zKHF1ZXJ5LCBzdWdnZXN0aW9ucywgZXh0cmFBcmdzKTsKICAgICAgICAgICAgdGhpcy5fcmVuZGVyLmFwcGx5KHRoaXMsIFtxdWVyeSwgc3VnZ2VzdGlvbnNdLmNvbmNhdChleHRyYUFyZ3MpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5xdWVyeSA9IHF1ZXJ5OwogICAgICAgIHRoaXMuY2FuY2VsZWQgPSBmYWxzZTsKICAgICAgICBpZiAodGhpcy5zaG91bGRGZXRjaEZyb21DYWNoZShxdWVyeSkpIHsKICAgICAgICAgIGhhbmRsZVN1Z2dlc3Rpb25zLmFwcGx5KHRoaXMsIFt0aGlzLmNhY2hlZFN1Z2dlc3Rpb25zXS5jb25jYXQodGhpcy5jYWNoZWRSZW5kZXJFeHRyYUFyZ3MpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgdmFyIGV4ZWNTb3VyY2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICghdGhhdC5jYW5jZWxlZCkgewogICAgICAgICAgICAgIHRoYXQuc291cmNlKHF1ZXJ5LCBoYW5kbGVTdWdnZXN0aW9ucy5iaW5kKHRoYXQpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIGlmICh0aGlzLmRlYm91bmNlKSB7CiAgICAgICAgICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB0aGF0LmRlYm91bmNlVGltZW91dCA9IG51bGw7CiAgICAgICAgICAgICAgZXhlY1NvdXJjZSgpOwogICAgICAgICAgICB9OwogICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5kZWJvdW5jZVRpbWVvdXQpOwogICAgICAgICAgICB0aGlzLmRlYm91bmNlVGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHRoaXMuZGVib3VuY2UpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZXhlY1NvdXJjZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgY2FjaGVTdWdnZXN0aW9uczogZnVuY3Rpb24gY2FjaGVTdWdnZXN0aW9ucyhxdWVyeSwgc3VnZ2VzdGlvbnMsIGV4dHJhQXJncykgewogICAgICAgIHRoaXMuY2FjaGVkUXVlcnkgPSBxdWVyeTsKICAgICAgICB0aGlzLmNhY2hlZFN1Z2dlc3Rpb25zID0gc3VnZ2VzdGlvbnM7CiAgICAgICAgdGhpcy5jYWNoZWRSZW5kZXJFeHRyYUFyZ3MgPSBleHRyYUFyZ3M7CiAgICAgIH0sCiAgICAgIHNob3VsZEZldGNoRnJvbUNhY2hlOiBmdW5jdGlvbiBzaG91bGRGZXRjaEZyb21DYWNoZShxdWVyeSkgewogICAgICAgIHJldHVybiB0aGlzLmNhY2hlICYmIHRoaXMuY2FjaGVkUXVlcnkgPT09IHF1ZXJ5ICYmIHRoaXMuY2FjaGVkU3VnZ2VzdGlvbnMgJiYgdGhpcy5jYWNoZWRTdWdnZXN0aW9ucy5sZW5ndGg7CiAgICAgIH0sCiAgICAgIGNsZWFyQ2FjaGVkU3VnZ2VzdGlvbnM6IGZ1bmN0aW9uIGNsZWFyQ2FjaGVkU3VnZ2VzdGlvbnMoKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuY2FjaGVkUXVlcnk7CiAgICAgICAgZGVsZXRlIHRoaXMuY2FjaGVkU3VnZ2VzdGlvbnM7CiAgICAgICAgZGVsZXRlIHRoaXMuY2FjaGVkUmVuZGVyRXh0cmFBcmdzOwogICAgICB9LAogICAgICBjYW5jZWw6IGZ1bmN0aW9uIGNhbmNlbCgpIHsKICAgICAgICB0aGlzLmNhbmNlbGVkID0gdHJ1ZTsKICAgICAgfSwKICAgICAgY2xlYXI6IGZ1bmN0aW9uIGNsZWFyKCkgewogICAgICAgIHRoaXMuY2FuY2VsKCk7CiAgICAgICAgdGhpcy4kZWwuZW1wdHkoKTsKICAgICAgICB0aGlzLnRyaWdnZXIoInJlbmRlcmVkIiwgIiIpOwogICAgICB9LAogICAgICBpc0VtcHR5OiBmdW5jdGlvbiBpc0VtcHR5KCkgewogICAgICAgIHJldHVybiB0aGlzLl9pc0VtcHR5OwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICAgIHRoaXMuY2xlYXJDYWNoZWRTdWdnZXN0aW9ucygpOwogICAgICAgIHRoaXMuJGVsID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiBnZXREaXNwbGF5Rm4oZGlzcGxheSkgewogICAgICBkaXNwbGF5ID0gZGlzcGxheSB8fCAidmFsdWUiOwogICAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKGRpc3BsYXkpID8gZGlzcGxheSA6IGRpc3BsYXlGbjsKICAgICAgZnVuY3Rpb24gZGlzcGxheUZuKG9iaikgewogICAgICAgIHJldHVybiBvYmpbZGlzcGxheV07CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGdldFRlbXBsYXRlcyh0ZW1wbGF0ZXMsIGRpc3BsYXlGbikgewogICAgICByZXR1cm4gewogICAgICAgIGVtcHR5OiB0ZW1wbGF0ZXMuZW1wdHkgJiYgXy50ZW1wbGF0aWZ5KHRlbXBsYXRlcy5lbXB0eSksCiAgICAgICAgaGVhZGVyOiB0ZW1wbGF0ZXMuaGVhZGVyICYmIF8udGVtcGxhdGlmeSh0ZW1wbGF0ZXMuaGVhZGVyKSwKICAgICAgICBmb290ZXI6IHRlbXBsYXRlcy5mb290ZXIgJiYgXy50ZW1wbGF0aWZ5KHRlbXBsYXRlcy5mb290ZXIpLAogICAgICAgIHN1Z2dlc3Rpb246IHRlbXBsYXRlcy5zdWdnZXN0aW9uIHx8IHN1Z2dlc3Rpb25UZW1wbGF0ZQogICAgICB9OwogICAgICBmdW5jdGlvbiBzdWdnZXN0aW9uVGVtcGxhdGUoY29udGV4dCkgewogICAgICAgIHJldHVybiAiPHA+IiArIGRpc3BsYXlGbihjb250ZXh0KSArICI8L3A+IjsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gaXNWYWxpZE5hbWUoc3RyKSB7CiAgICAgIHJldHVybiAvXltfYS16QS1aMC05LV0rJC8udGVzdChzdHIpOwogICAgfQogICAgbW9kdWxlLmV4cG9ydHMgPSBEYXRhc2V0OwogIH0sIGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgaGl0czogX193ZWJwYWNrX3JlcXVpcmVfXyg2MiksCiAgICAgIHBvcHVsYXJJbjogX193ZWJwYWNrX3JlcXVpcmVfXyg2MykKICAgIH07CiAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgInVzZSBzdHJpY3QiOwoKICAgIHZhciBfID0gX193ZWJwYWNrX3JlcXVpcmVfXygwKTsKICAgIHZhciB2ZXJzaW9uID0gX193ZWJwYWNrX3JlcXVpcmVfXygxOCk7CiAgICB2YXIgcGFyc2VBbGdvbGlhQ2xpZW50VmVyc2lvbiA9IF9fd2VicGFja19yZXF1aXJlX18oMTkpOwogICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBzZWFyY2goaW5kZXgsIHBhcmFtcykgewogICAgICB2YXIgYWxnb2xpYVZlcnNpb24gPSBwYXJzZUFsZ29saWFDbGllbnRWZXJzaW9uKGluZGV4LmFzLl91YSk7CiAgICAgIGlmIChhbGdvbGlhVmVyc2lvbiAmJiBhbGdvbGlhVmVyc2lvblswXSA+PSAzICYmIGFsZ29saWFWZXJzaW9uWzFdID4gMjApIHsKICAgICAgICBwYXJhbXMgPSBwYXJhbXMgfHwge307CiAgICAgICAgcGFyYW1zLmFkZGl0aW9uYWxVQSA9ICJhdXRvY29tcGxldGUuanMgIiArIHZlcnNpb247CiAgICAgIH0KICAgICAgcmV0dXJuIHNvdXJjZUZuOwogICAgICBmdW5jdGlvbiBzb3VyY2VGbihxdWVyeSwgY2IpIHsKICAgICAgICBpbmRleC5zZWFyY2gocXVlcnksIHBhcmFtcywgZnVuY3Rpb24gKGVycm9yLCBjb250ZW50KSB7CiAgICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgICAgXy5lcnJvcihlcnJvci5tZXNzYWdlKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgY2IoY29udGVudC5oaXRzLCBjb250ZW50KTsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgdmFyIF8gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDApOwogICAgdmFyIHZlcnNpb24gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDE4KTsKICAgIHZhciBwYXJzZUFsZ29saWFDbGllbnRWZXJzaW9uID0gX193ZWJwYWNrX3JlcXVpcmVfXygxOSk7CiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIHBvcHVsYXJJbihpbmRleCwgcGFyYW1zLCBkZXRhaWxzLCBvcHRpb25zKSB7CiAgICAgIHZhciBhbGdvbGlhVmVyc2lvbiA9IHBhcnNlQWxnb2xpYUNsaWVudFZlcnNpb24oaW5kZXguYXMuX3VhKTsKICAgICAgaWYgKGFsZ29saWFWZXJzaW9uICYmIGFsZ29saWFWZXJzaW9uWzBdID49IDMgJiYgYWxnb2xpYVZlcnNpb25bMV0gPiAyMCkgewogICAgICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTsKICAgICAgICBwYXJhbXMuYWRkaXRpb25hbFVBID0gImF1dG9jb21wbGV0ZS5qcyAiICsgdmVyc2lvbjsKICAgICAgfQogICAgICBpZiAoIWRldGFpbHMuc291cmNlKSB7CiAgICAgICAgcmV0dXJuIF8uZXJyb3IoIk1pc3NpbmcgJ3NvdXJjZScga2V5Iik7CiAgICAgIH0KICAgICAgdmFyIHNvdXJjZSA9IF8uaXNGdW5jdGlvbihkZXRhaWxzLnNvdXJjZSkgPyBkZXRhaWxzLnNvdXJjZSA6IGZ1bmN0aW9uIChoaXQpIHsKICAgICAgICByZXR1cm4gaGl0W2RldGFpbHMuc291cmNlXTsKICAgICAgfTsKICAgICAgaWYgKCFkZXRhaWxzLmluZGV4KSB7CiAgICAgICAgcmV0dXJuIF8uZXJyb3IoIk1pc3NpbmcgJ2luZGV4JyBrZXkiKTsKICAgICAgfQogICAgICB2YXIgZGV0YWlsc0luZGV4ID0gZGV0YWlscy5pbmRleDsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHJldHVybiBzb3VyY2VGbjsKICAgICAgZnVuY3Rpb24gc291cmNlRm4ocXVlcnksIGNiKSB7CiAgICAgICAgaW5kZXguc2VhcmNoKHF1ZXJ5LCBwYXJhbXMsIGZ1bmN0aW9uIChlcnJvciwgY29udGVudCkgewogICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgIF8uZXJyb3IoZXJyb3IubWVzc2FnZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjb250ZW50LmhpdHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgZmlyc3QgPSBjb250ZW50LmhpdHNbMF07CiAgICAgICAgICAgIHZhciBkZXRhaWxzUGFyYW1zID0gXy5taXhpbih7CiAgICAgICAgICAgICAgaGl0c1BlclBhZ2U6IDAKICAgICAgICAgICAgfSwgZGV0YWlscyk7CiAgICAgICAgICAgIGRlbGV0ZSBkZXRhaWxzUGFyYW1zLnNvdXJjZTsKICAgICAgICAgICAgZGVsZXRlIGRldGFpbHNQYXJhbXMuaW5kZXg7CiAgICAgICAgICAgIHZhciBkZXRhaWxzQWxnb2xpYVZlcnNpb24gPSBwYXJzZUFsZ29saWFDbGllbnRWZXJzaW9uKGRldGFpbHNJbmRleC5hcy5fdWEpOwogICAgICAgICAgICBpZiAoZGV0YWlsc0FsZ29saWFWZXJzaW9uICYmIGRldGFpbHNBbGdvbGlhVmVyc2lvblswXSA+PSAzICYmIGRldGFpbHNBbGdvbGlhVmVyc2lvblsxXSA+IDIwKSB7CiAgICAgICAgICAgICAgcGFyYW1zLmFkZGl0aW9uYWxVQSA9ICJhdXRvY29tcGxldGUuanMgIiArIHZlcnNpb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGV0YWlsc0luZGV4LnNlYXJjaChzb3VyY2UoZmlyc3QpLCBkZXRhaWxzUGFyYW1zLCBmdW5jdGlvbiAoZXJyb3IyLCBjb250ZW50MikgewogICAgICAgICAgICAgIGlmIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIF8uZXJyb3IoZXJyb3IyLm1lc3NhZ2UpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgc3VnZ2VzdGlvbnMgPSBbXTsKICAgICAgICAgICAgICBpZiAob3B0aW9ucy5pbmNsdWRlQWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgbGFiZWwgPSBvcHRpb25zLmFsbFRpdGxlIHx8ICJBbGwgZGVwYXJ0bWVudHMiOwogICAgICAgICAgICAgICAgc3VnZ2VzdGlvbnMucHVzaChfLm1peGluKHsKICAgICAgICAgICAgICAgICAgZmFjZXQ6IHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbGFiZWwsCiAgICAgICAgICAgICAgICAgICAgY291bnQ6IGNvbnRlbnQyLm5iSGl0cwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCBfLmNsb25lRGVlcChmaXJzdCkpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgXy5lYWNoKGNvbnRlbnQyLmZhY2V0cywgZnVuY3Rpb24gKHZhbHVlcywgZmFjZXQpIHsKICAgICAgICAgICAgICAgIF8uZWFjaCh2YWx1ZXMsIGZ1bmN0aW9uIChjb3VudCwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgc3VnZ2VzdGlvbnMucHVzaChfLm1peGluKHsKICAgICAgICAgICAgICAgICAgICBmYWNldDogewogICAgICAgICAgICAgICAgICAgICAgZmFjZXQ6IGZhY2V0LAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgY291bnQ6IGNvdW50CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9LCBfLmNsb25lRGVlcChmaXJzdCkpKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgY29udGVudC5oaXRzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICBzdWdnZXN0aW9ucy5wdXNoKGNvbnRlbnQuaGl0c1tpXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNiKHN1Z2dlc3Rpb25zLCBjb250ZW50KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGNiKFtdKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICB9LCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgICB2YWx1ZTogdHJ1ZQogICAgfSk7CiAgICB2YXIgcHJlZml4ID0gImFsZ29saWEtZG9jc2VhcmNoIjsKICAgIHZhciBzdWdnZXN0aW9uUHJlZml4ID0gcHJlZml4ICsgIi1zdWdnZXN0aW9uIjsKICAgIHZhciBmb290ZXJQcmVmaXggPSBwcmVmaXggKyAiLWZvb3RlciI7CiAgICB2YXIgdGVtcGxhdGVzID0gewogICAgICBzdWdnZXN0aW9uOiAnXG4gIDxhIGNsYXNzPSInICsgc3VnZ2VzdGlvblByZWZpeCArICJcbiAgICB7eyNpc0NhdGVnb3J5SGVhZGVyfX0iICsgc3VnZ2VzdGlvblByZWZpeCArICJfX21haW57ey9pc0NhdGVnb3J5SGVhZGVyfX1cbiAgICB7eyNpc1N1YkNhdGVnb3J5SGVhZGVyfX0iICsgc3VnZ2VzdGlvblByZWZpeCArICdfX3NlY29uZGFyeXt7L2lzU3ViQ2F0ZWdvcnlIZWFkZXJ9fVxuICAgICJcbiAgICBhcmlhLWxhYmVsPSJMaW5rIHRvIHRoZSByZXN1bHQiXG4gICAgaHJlZj0ie3t7dXJsfX19IlxuICAgID5cbiAgICA8ZGl2IGNsYXNzPSInICsgc3VnZ2VzdGlvblByZWZpeCArICctLWNhdGVnb3J5LWhlYWRlciI+XG4gICAgICAgIDxzcGFuIGNsYXNzPSInICsgc3VnZ2VzdGlvblByZWZpeCArICctLWNhdGVnb3J5LWhlYWRlci1sdmwwIj57e3tjYXRlZ29yeX19fTwvc3Bhbj5cbiAgICA8L2Rpdj5cbiAgICA8ZGl2IGNsYXNzPSInICsgc3VnZ2VzdGlvblByZWZpeCArICctLXdyYXBwZXIiPlxuICAgICAgPGRpdiBjbGFzcz0iJyArIHN1Z2dlc3Rpb25QcmVmaXggKyAnLS1zdWJjYXRlZ29yeS1jb2x1bW4iPlxuICAgICAgICA8c3BhbiBjbGFzcz0iJyArIHN1Z2dlc3Rpb25QcmVmaXggKyAnLS1zdWJjYXRlZ29yeS1jb2x1bW4tdGV4dCI+e3t7c3ViY2F0ZWdvcnl9fX08L3NwYW4+XG4gICAgICA8L2Rpdj5cbiAgICAgIHt7I2lzVGV4dE9yU3ViY2F0ZWdvcnlOb25FbXB0eX19XG4gICAgICA8ZGl2IGNsYXNzPSInICsgc3VnZ2VzdGlvblByZWZpeCArICctLWNvbnRlbnQiPlxuICAgICAgICA8ZGl2IGNsYXNzPSInICsgc3VnZ2VzdGlvblByZWZpeCArICctLXN1YmNhdGVnb3J5LWlubGluZSI+e3t7c3ViY2F0ZWdvcnl9fX08L2Rpdj5cbiAgICAgICAgPGRpdiBjbGFzcz0iJyArIHN1Z2dlc3Rpb25QcmVmaXggKyAnLS10aXRsZSI+e3t7dGl0bGV9fX08L2Rpdj5cbiAgICAgICAge3sjdGV4dH19PGRpdiBjbGFzcz0iJyArIHN1Z2dlc3Rpb25QcmVmaXggKyAnLS10ZXh0Ij57e3t0ZXh0fX19PC9kaXY+e3svdGV4dH19XG4gICAgICA8L2Rpdj5cbiAgICAgIHt7L2lzVGV4dE9yU3ViY2F0ZWdvcnlOb25FbXB0eX19XG4gICAgPC9kaXY+XG4gIDwvYT5cbiAgJywKICAgICAgc3VnZ2VzdGlvblNpbXBsZTogJ1xuICA8ZGl2IGNsYXNzPSInICsgc3VnZ2VzdGlvblByZWZpeCArICJcbiAgICB7eyNpc0NhdGVnb3J5SGVhZGVyfX0iICsgc3VnZ2VzdGlvblByZWZpeCArICJfX21haW57ey9pc0NhdGVnb3J5SGVhZGVyfX1cbiAgICB7eyNpc1N1YkNhdGVnb3J5SGVhZGVyfX0iICsgc3VnZ2VzdGlvblByZWZpeCArICdfX3NlY29uZGFyeXt7L2lzU3ViQ2F0ZWdvcnlIZWFkZXJ9fVxuICAgIHN1Z2dlc3Rpb24tbGF5b3V0LXNpbXBsZVxuICAiPlxuICAgIDxkaXYgY2xhc3M9IicgKyBzdWdnZXN0aW9uUHJlZml4ICsgJy0tY2F0ZWdvcnktaGVhZGVyIj5cbiAgICAgICAge3teaXNMdmwwfX1cbiAgICAgICAgPHNwYW4gY2xhc3M9IicgKyBzdWdnZXN0aW9uUHJlZml4ICsgIi0tY2F0ZWdvcnktaGVhZGVyLWx2bDAgIiArIHN1Z2dlc3Rpb25QcmVmaXggKyAnLS1jYXRlZ29yeS1oZWFkZXItaXRlbSI+e3t7Y2F0ZWdvcnl9fX08L3NwYW4+XG4gICAgICAgICAge3teaXNMdmwxfX1cbiAgICAgICAgICB7e15pc0x2bDFFbXB0eU9yRHVwbGljYXRlfX1cbiAgICAgICAgICA8c3BhbiBjbGFzcz0iJyArIHN1Z2dlc3Rpb25QcmVmaXggKyAiLS1jYXRlZ29yeS1oZWFkZXItbHZsMSAiICsgc3VnZ2VzdGlvblByZWZpeCArICctLWNhdGVnb3J5LWhlYWRlci1pdGVtIj5cbiAgICAgICAgICAgICAge3t7c3ViY2F0ZWdvcnl9fX1cbiAgICAgICAgICA8L3NwYW4+XG4gICAgICAgICAge3svaXNMdmwxRW1wdHlPckR1cGxpY2F0ZX19XG4gICAgICAgICAge3svaXNMdmwxfX1cbiAgICAgICAge3svaXNMdmwwfX1cbiAgICAgICAgPGRpdiBjbGFzcz0iJyArIHN1Z2dlc3Rpb25QcmVmaXggKyAiLS10aXRsZSAiICsgc3VnZ2VzdGlvblByZWZpeCArICctLWNhdGVnb3J5LWhlYWRlci1pdGVtIj5cbiAgICAgICAgICAgIHt7I2lzTHZsMn19XG4gICAgICAgICAgICAgICAge3t7dGl0bGV9fX1cbiAgICAgICAgICAgIHt7L2lzTHZsMn19XG4gICAgICAgICAgICB7eyNpc0x2bDF9fVxuICAgICAgICAgICAgICAgIHt7e3N1YmNhdGVnb3J5fX19XG4gICAgICAgICAgICB7ey9pc0x2bDF9fVxuICAgICAgICAgICAge3sjaXNMdmwwfX1cbiAgICAgICAgICAgICAgICB7e3tjYXRlZ29yeX19fVxuICAgICAgICAgICAge3svaXNMdmwwfX1cbiAgICAgICAgPC9kaXY+XG4gICAgPC9kaXY+XG4gICAgPGRpdiBjbGFzcz0iJyArIHN1Z2dlc3Rpb25QcmVmaXggKyAnLS13cmFwcGVyIj5cbiAgICAgIHt7I3RleHR9fVxuICAgICAgPGRpdiBjbGFzcz0iJyArIHN1Z2dlc3Rpb25QcmVmaXggKyAnLS1jb250ZW50Ij5cbiAgICAgICAgPGRpdiBjbGFzcz0iJyArIHN1Z2dlc3Rpb25QcmVmaXggKyAnLS10ZXh0Ij57e3t0ZXh0fX19PC9kaXY+XG4gICAgICA8L2Rpdj5cbiAgICAgIHt7L3RleHR9fVxuICAgIDwvZGl2PlxuICA8L2Rpdj5cbiAgJywKICAgICAgZm9vdGVyOiAnXG4gICAgPGRpdiBjbGFzcz0iJyArIGZvb3RlclByZWZpeCArICciPlxuICAgICAgU2VhcmNoIGJ5IDxhIGNsYXNzPSInICsgZm9vdGVyUHJlZml4ICsgJy0tbG9nbyIgaHJlZj0iaHR0cHM6Ly93d3cuYWxnb2xpYS5jb20vZG9jc2VhcmNoIj5BbGdvbGlhPC9hPlxuICAgIDwvZGl2PlxuICAnLAogICAgICBlbXB0eTogJ1xuICA8ZGl2IGNsYXNzPSInICsgc3VnZ2VzdGlvblByZWZpeCArICciPlxuICAgIDxkaXYgY2xhc3M9IicgKyBzdWdnZXN0aW9uUHJlZml4ICsgJy0td3JhcHBlciI+XG4gICAgICAgIDxkaXYgY2xhc3M9IicgKyBzdWdnZXN0aW9uUHJlZml4ICsgIi0tY29udGVudCAiICsgc3VnZ2VzdGlvblByZWZpeCArICctLW5vLXJlc3VsdHMiPlxuICAgICAgICAgICAgPGRpdiBjbGFzcz0iJyArIHN1Z2dlc3Rpb25QcmVmaXggKyAnLS10aXRsZSI+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iJyArIHN1Z2dlc3Rpb25QcmVmaXggKyAnLS10ZXh0Ij5cbiAgICAgICAgICAgICAgICAgICAgTm8gcmVzdWx0cyBmb3VuZCBmb3IgcXVlcnkgPGI+Int7cXVlcnl9fSI8L2I+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgPC9kaXY+XG4gICAgPC9kaXY+XG4gIDwvZGl2PlxuICAnLAogICAgICBzZWFyY2hCb3g6ICdcbiAgPGZvcm0gbm92YWxpZGF0ZT0ibm92YWxpZGF0ZSIgb25zdWJtaXQ9InJldHVybiBmYWxzZTsiIGNsYXNzPSJzZWFyY2hib3giPlxuICAgIDxkaXYgcm9sZT0ic2VhcmNoIiBjbGFzcz0ic2VhcmNoYm94X193cmFwcGVyIj5cbiAgICAgIDxpbnB1dCBpZD0iZG9jc2VhcmNoIiB0eXBlPSJzZWFyY2giIG5hbWU9InNlYXJjaCIgcGxhY2Vob2xkZXI9IlNlYXJjaCB0aGUgZG9jcyIgYXV0b2NvbXBsZXRlPSJvZmYiIHJlcXVpcmVkPSJyZXF1aXJlZCIgY2xhc3M9InNlYXJjaGJveF9faW5wdXQiLz5cbiAgICAgIDxidXR0b24gdHlwZT0ic3VibWl0IiB0aXRsZT0iU3VibWl0IHlvdXIgc2VhcmNoIHF1ZXJ5LiIgY2xhc3M9InNlYXJjaGJveF9fc3VibWl0IiA+XG4gICAgICAgIDxzdmcgd2lkdGg9MTIgaGVpZ2h0PTEyIHJvbGU9ImltZyIgYXJpYS1sYWJlbD0iU2VhcmNoIj5cbiAgICAgICAgICA8dXNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazpocmVmPSIjc2J4LWljb24tc2VhcmNoLTEzIj48L3VzZT5cbiAgICAgICAgPC9zdmc+XG4gICAgICA8L2J1dHRvbj5cbiAgICAgIDxidXR0b24gdHlwZT0icmVzZXQiIHRpdGxlPSJDbGVhciB0aGUgc2VhcmNoIHF1ZXJ5LiIgY2xhc3M9InNlYXJjaGJveF9fcmVzZXQgaGlkZSI+XG4gICAgICAgIDxzdmcgd2lkdGg9MTIgaGVpZ2h0PTEyIHJvbGU9ImltZyIgYXJpYS1sYWJlbD0iUmVzZXQiPlxuICAgICAgICAgIDx1c2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOmhyZWY9IiNzYngtaWNvbi1jbGVhci0zIj48L3VzZT5cbiAgICAgICAgPC9zdmc+XG4gICAgICA8L2J1dHRvbj5cbiAgICA8L2Rpdj5cbjwvZm9ybT5cblxuPGRpdiBjbGFzcz0ic3ZnLWljb25zIiBzdHlsZT0iaGVpZ2h0OiAwOyB3aWR0aDogMDsgcG9zaXRpb246IGFic29sdXRlOyB2aXNpYmlsaXR5OiBoaWRkZW4iPlxuICA8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+XG4gICAgPHN5bWJvbCBpZD0ic2J4LWljb24tY2xlYXItMyIgdmlld0JveD0iMCAwIDQwIDQwIj48cGF0aCBkPSJNMTYuMjI4IDIwTDEuODg2IDUuNjU3IDAgMy43NzIgMy43NzIgMGwxLjg4NSAxLjg4NkwyMCAxNi4yMjggMzQuMzQzIDEuODg2IDM2LjIyOCAwIDQwIDMuNzcybC0xLjg4NiAxLjg4NUwyMy43NzIgMjBsMTQuMzQyIDE0LjM0M0w0MCAzNi4yMjggMzYuMjI4IDQwbC0xLjg4NS0xLjg4NkwyMCAyMy43NzIgNS42NTcgMzguMTE0IDMuNzcyIDQwIDAgMzYuMjI4bDEuODg2LTEuODg1TDE2LjIyOCAyMHoiIGZpbGwtcnVsZT0iZXZlbm9kZCI+PC9zeW1ib2w+XG4gICAgPHN5bWJvbCBpZD0ic2J4LWljb24tc2VhcmNoLTEzIiB2aWV3Qm94PSIwIDAgNDAgNDAiPjxwYXRoIGQ9Ik0yNi44MDYgMjkuMDEyYTE2LjMxMiAxNi4zMTIgMCAwIDEtMTAuNDI3IDMuNzQ2QzcuMzMyIDMyLjc1OCAwIDI1LjQyNSAwIDE2LjM3OCAwIDcuMzM0IDcuMzMzIDAgMTYuMzggMGM5LjA0NSAwIDE2LjM3OCA3LjMzMyAxNi4zNzggMTYuMzggMCAzLjk2LTEuNDA2IDcuNTkzLTMuNzQ2IDEwLjQyNkwzOS41NDcgMzcuMzRjLjYwNy42MDguNjEgMS41OS0uMDA0IDIuMjAzYTEuNTYgMS41NiAwIDAgMS0yLjIwMi4wMDRMMjYuODA3IDI5LjAxMnptLTEwLjQyNy42MjdjNy4zMjIgMCAxMy4yNi01LjkzOCAxMy4yNi0xMy4yNiAwLTcuMzI0LTUuOTM4LTEzLjI2LTEzLjI2LTEzLjI2LTcuMzI0IDAtMTMuMjYgNS45MzYtMTMuMjYgMTMuMjYgMCA3LjMyMiA1LjkzNiAxMy4yNiAxMy4yNiAxMy4yNnoiIGZpbGwtcnVsZT0iZXZlbm9kZCI+PC9zeW1ib2w+XG4gIDwvc3ZnPlxuPC9kaXY+XG4gICcKICAgIH07CiAgICBleHBvcnRzLmRlZmF1bHQgPSB0ZW1wbGF0ZXM7CiAgfSwgZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewogICAgInVzZSBzdHJpY3QiOwoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgICAgdmFsdWU6IHRydWUKICAgIH0pOwogICAgdmFyIF90eXBlb2YgPSB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBTeW1ib2wuaXRlcmF0b3IgPT09ICJzeW1ib2wiID8gZnVuY3Rpb24gKG9iaikgewogICAgICByZXR1cm4gdHlwZW9mIG9iajsKICAgIH0gOiBmdW5jdGlvbiAob2JqKSB7CiAgICAgIHJldHVybiBvYmogJiYgdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBvYmouY29uc3RydWN0b3IgPT09IFN5bWJvbCAmJiBvYmogIT09IFN5bWJvbC5wcm90b3R5cGUgPyAic3ltYm9sIiA6IHR5cGVvZiBvYmo7CiAgICB9OwogICAgdmFyIF96ZXB0byA9IF9fd2VicGFja19yZXF1aXJlX18oMjApOwogICAgdmFyIF96ZXB0bzIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF96ZXB0byk7CiAgICBmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgewogICAgICByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogewogICAgICAgIGRlZmF1bHQ6IG9iagogICAgICB9OwogICAgfQogICAgdmFyIHV0aWxzID0gewogICAgICBtZXJnZUtleVdpdGhQYXJlbnQ6IGZ1bmN0aW9uIG1lcmdlS2V5V2l0aFBhcmVudChvYmplY3QsIHByb3BlcnR5KSB7CiAgICAgICAgaWYgKG9iamVjdFtwcm9wZXJ0eV0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgICB9CiAgICAgICAgaWYgKF90eXBlb2Yob2JqZWN0W3Byb3BlcnR5XSkgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgIH0KICAgICAgICB2YXIgbmV3T2JqZWN0ID0gX3plcHRvMi5kZWZhdWx0LmV4dGVuZCh7fSwgb2JqZWN0LCBvYmplY3RbcHJvcGVydHldKTsKICAgICAgICBkZWxldGUgbmV3T2JqZWN0W3Byb3BlcnR5XTsKICAgICAgICByZXR1cm4gbmV3T2JqZWN0OwogICAgICB9LAogICAgICBncm91cEJ5OiBmdW5jdGlvbiBncm91cEJ5KGNvbGxlY3Rpb24sIHByb3BlcnR5KSB7CiAgICAgICAgdmFyIG5ld0NvbGxlY3Rpb24gPSB7fTsKICAgICAgICBfemVwdG8yLmRlZmF1bHQuZWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbiAoaW5kZXgsIGl0ZW0pIHsKICAgICAgICAgIGlmIChpdGVtW3Byb3BlcnR5XSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiW2dyb3VwQnldOiBPYmplY3QgaGFzIG5vIGtleSAiICsgcHJvcGVydHkpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGtleSA9IGl0ZW1bcHJvcGVydHldOwogICAgICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGtleSA9IGtleS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwobmV3Q29sbGVjdGlvbiwga2V5KSkgewogICAgICAgICAgICBuZXdDb2xsZWN0aW9uW2tleV0gPSBbXTsKICAgICAgICAgIH0KICAgICAgICAgIG5ld0NvbGxlY3Rpb25ba2V5XS5wdXNoKGl0ZW0pOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBuZXdDb2xsZWN0aW9uOwogICAgICB9LAogICAgICB2YWx1ZXM6IGZ1bmN0aW9uIHZhbHVlcyhvYmplY3QpIHsKICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMob2JqZWN0KS5tYXAoZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgcmV0dXJuIG9iamVjdFtrZXldOwogICAgICAgIH0pOwogICAgICB9LAogICAgICBmbGF0dGVuOiBmdW5jdGlvbiBmbGF0dGVuKGFycmF5KSB7CiAgICAgICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgICAgICBhcnJheS5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICByZXN1bHRzLnB1c2godmFsdWUpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YWx1ZS5mb3JFYWNoKGZ1bmN0aW9uIChzdWJ2YWx1ZSkgewogICAgICAgICAgICByZXN1bHRzLnB1c2goc3VidmFsdWUpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgIH0sCiAgICAgIGZsYXR0ZW5BbmRGbGFnRmlyc3Q6IGZ1bmN0aW9uIGZsYXR0ZW5BbmRGbGFnRmlyc3Qob2JqZWN0LCBmbGFnKSB7CiAgICAgICAgdmFyIHZhbHVlcyA9IHRoaXMudmFsdWVzKG9iamVjdCkubWFwKGZ1bmN0aW9uIChjb2xsZWN0aW9uKSB7CiAgICAgICAgICByZXR1cm4gY29sbGVjdGlvbi5tYXAoZnVuY3Rpb24gKGl0ZW0sIGluZGV4KSB7CiAgICAgICAgICAgIGl0ZW1bZmxhZ10gPSBpbmRleCA9PT0gMDsKICAgICAgICAgICAgcmV0dXJuIGl0ZW07CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdGhpcy5mbGF0dGVuKHZhbHVlcyk7CiAgICAgIH0sCiAgICAgIGNvbXBhY3Q6IGZ1bmN0aW9uIGNvbXBhY3QoYXJyYXkpIHsKICAgICAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgICAgIGFycmF5LmZvckVhY2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICBpZiAoIXZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdHMucHVzaCh2YWx1ZSk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgIH0sCiAgICAgIGdldEhpZ2hsaWdodGVkVmFsdWU6IGZ1bmN0aW9uIGdldEhpZ2hsaWdodGVkVmFsdWUob2JqZWN0LCBwcm9wZXJ0eSkgewogICAgICAgIGlmIChvYmplY3QuX2hpZ2hsaWdodFJlc3VsdCAmJiBvYmplY3QuX2hpZ2hsaWdodFJlc3VsdC5oaWVyYXJjaHlfY2FtZWwgJiYgb2JqZWN0Ll9oaWdobGlnaHRSZXN1bHQuaGllcmFyY2h5X2NhbWVsW3Byb3BlcnR5XSAmJiBvYmplY3QuX2hpZ2hsaWdodFJlc3VsdC5oaWVyYXJjaHlfY2FtZWxbcHJvcGVydHldLm1hdGNoTGV2ZWwgJiYgb2JqZWN0Ll9oaWdobGlnaHRSZXN1bHQuaGllcmFyY2h5X2NhbWVsW3Byb3BlcnR5XS5tYXRjaExldmVsICE9PSAibm9uZSIgJiYgb2JqZWN0Ll9oaWdobGlnaHRSZXN1bHQuaGllcmFyY2h5X2NhbWVsW3Byb3BlcnR5XS52YWx1ZSkgewogICAgICAgICAgcmV0dXJuIG9iamVjdC5faGlnaGxpZ2h0UmVzdWx0LmhpZXJhcmNoeV9jYW1lbFtwcm9wZXJ0eV0udmFsdWU7CiAgICAgICAgfQogICAgICAgIGlmIChvYmplY3QuX2hpZ2hsaWdodFJlc3VsdCAmJiBvYmplY3QuX2hpZ2hsaWdodFJlc3VsdCAmJiBvYmplY3QuX2hpZ2hsaWdodFJlc3VsdFtwcm9wZXJ0eV0gJiYgb2JqZWN0Ll9oaWdobGlnaHRSZXN1bHRbcHJvcGVydHldLnZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gb2JqZWN0Ll9oaWdobGlnaHRSZXN1bHRbcHJvcGVydHldLnZhbHVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb2JqZWN0W3Byb3BlcnR5XTsKICAgICAgfSwKICAgICAgZ2V0U25pcHBldGVkVmFsdWU6IGZ1bmN0aW9uIGdldFNuaXBwZXRlZFZhbHVlKG9iamVjdCwgcHJvcGVydHkpIHsKICAgICAgICBpZiAoIW9iamVjdC5fc25pcHBldFJlc3VsdCB8fCAhb2JqZWN0Ll9zbmlwcGV0UmVzdWx0W3Byb3BlcnR5XSB8fCAhb2JqZWN0Ll9zbmlwcGV0UmVzdWx0W3Byb3BlcnR5XS52YWx1ZSkgewogICAgICAgICAgcmV0dXJuIG9iamVjdFtwcm9wZXJ0eV07CiAgICAgICAgfQogICAgICAgIHZhciBzbmlwcGV0ID0gb2JqZWN0Ll9zbmlwcGV0UmVzdWx0W3Byb3BlcnR5XS52YWx1ZTsKICAgICAgICBpZiAoc25pcHBldFswXSAhPT0gc25pcHBldFswXS50b1VwcGVyQ2FzZSgpKSB7CiAgICAgICAgICBzbmlwcGV0ID0gIuKApiIgKyBzbmlwcGV0OwogICAgICAgIH0KICAgICAgICBpZiAoWyIuIiwgIiEiLCAiPyJdLmluZGV4T2Yoc25pcHBldFtzbmlwcGV0Lmxlbmd0aCAtIDFdKSA9PT0gLTEpIHsKICAgICAgICAgIHNuaXBwZXQgPSBzbmlwcGV0ICsgIuKApiI7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzbmlwcGV0OwogICAgICB9LAogICAgICBkZWVwQ2xvbmU6IGZ1bmN0aW9uIGRlZXBDbG9uZShvYmplY3QpIHsKICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShvYmplY3QpKTsKICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuZGVmYXVsdCA9IHV0aWxzOwogIH1dKTsKfSk7"},null]}